define(["dojo/dom","dojo/dom-construct","dojo/on","dojo/dom","dojo/dom-style","dojox/validate/web","dijit/registry","modules/HashController","modules/EventsController","views/story/StoryModel","views/story/StoryConfig","dojo/_base/array","esri/map","esri/dijit/Geocoder","esri/toolbars/edit","esri/dijit/BasemapGallery","esri/toolbars/draw","esri/graphic","esri/Color","esri/symbols/SimpleMarkerSymbol","esri/symbols/PictureMarkerSymbol","dijit/layout/ContentPane","dijit/TitlePane","esri/layers/FeatureLayer","esri/InfoTemplate","esri/geometry/webMercatorUtils","dojo/parser","esri/urlUtils","utils/Analytics"],function(e,t,o,e,r,a,i,s,n,l,c,d,m,u,p,y,v,g,f,b,h,w,D,I,T,S,M,E,j){var G={},F=!1,L="storyView",x={viewId:L,viewName:"story"};return G.init=function(){return F?(console.log(x),n.switchToView(x),j.sendPageview("/"+window.location.href.split("#")[1],x.viewName),void 0):(F=!0,require(["dojo/text!views/story/story.html"],function(t){e.byId(L).innerHTML=t,M.parse(e.byId("storyInnerContainer")).then(function(){G.createMap(),n.switchToView(x),l.applyBindings(L)})}),j.sendPageview("/"+window.location.href.split("#")[1],x.viewName),void 0)},G.createMap=function(){G.map=new m("storiesMap",{zoom:4,basemap:"satellite",minZoom:3,maxZoom:18,center:[115,0]});var e=new y({showArcGISBasemaps:!0,map:G.map},"basemapGallery");e.startup(),dojo.connect(e,"onError",function(e){console.log(e)});var r=G.map.on("load",function(){r.remove(),G.initToolbar();var e={url:"http://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer",name:"World Geocoder",placeholder:"Search for a location"};geocoder=new u({map:G.map,arcgisGeocoder:e,searchDelay:200,autoComplete:!0},"esri-geocoder-widget-story"),geocoder.startup();var a=new I(l.vm.storiesURL2,{id:"storiesLayer",outFields:["*"]});a.setVisibility(!1);var i=function(){console.log(l.vm.attachSuccess)},s=function(){console.log(l.vm.attachFailure)};a.on("edits-complete",function(e){if(l.vm.inputFilesSelector().length>1)for(var o=$(".uploadInput"),r=e.adds[0].objectId,n=document.login,c=l.vm.inputFilesSelector().length-1;c>0;c--)a.addAttachment(r,n,i,s),t.destroy(o[c-1]);a.refresh()}),G.map.addLayer(a),document.getElementById("stackContainer").onscroll=function(){G.map.resize()},o(G.map,"click",function(e){G.testFix(e)})})},G.testFix=function(e){require(["esri/geometry/ScreenPoint","esri/geometry/screenUtils"],function(t,o){var r=new t(e.layerX,e.layerY),a=o.toMapPoint(G.map.extent,G.map.width,G.map.height,r);window.mapPoint=a,window.map=G.map,G.addGraphic(a)})},G.initToolbar=function(){tb=new v(G.map),tb.activate("point"),o(e.byId("storiesMap"),"mouseover",function(){G.map.resize()}),o(e.byId("storiesMap"),"mouseout",function(){G.map.resize()})},G.addGraphic=function(t){G.map.graphics.clear(),G.map.resize();var o=new h({angle:0,xoffset:0,yoffset:10,type:"esriPMS",url:c.markerJSONUrl,imageData:c.markerJSONImageData,contentType:"image/png",width:24,height:24}),r=new g(t,o);G.map.graphics.add(r),l.vm.pointGeom(r);var a=r.getDojoShape(),i=new dojox.gfx.Moveable(a);G.map.enableMapNavigation();var s=l.vm.storyTitleData();s||(s=e.byId("storyTitleInput").placeholder);dojo.connect(i,"onMoveStop",function(){var e=a.getTransform(),t=r.geometry,o=G.map.toMap(G.map.toScreen(t).offset(e.dx,e.dy));a.setTransform(null);{var i=S.xyToLngLat(o.x,o.y);i[0].toFixed(3),i[1].toFixed(3)}r.setGeometry(o),l.vm.pointGeom(r),console.log(l.vm.pointGeom())})},G.initEditing=function(){var e=G.map.getLayersVisibleAtScale(),t=e[1],o=new p(G.map);o.on("deactivate",function(e){e.info.isModified&&t.applyEdits(null,[e.graphic],null)})},G.handleFileChange=function(e,t){var o=(t.currentTarget.files[0].name,t.currentTarget);$(o).css("opacity","0");l.vm.mediaListData();l.vm.inputFilesSelector.push({display:!0,name:t.currentTarget.files[0].name})},G.handleAttachmentRemove=function(e,o){for(var r=0,a=$(".uploadInput"),i=0;i<a.length;i++)a[i].files.length>0&&o.currentTarget.firstChild.data===a[i].files[0].name&&(t.destroy(a[i]),r=i,console.log("destroyed"));var a=$(".uploadInput");l.vm.inputFilesSelector.remove(l.vm.inputFilesSelector()[r]),0==r&&o.target.remove()},G.handleUpload=function(){if(honeyPotValue=e.byId("verifyEmailForStory").value)return console.log("honeyPot!"),void 0;var o=l.vm.pointGeom(),r=l.vm.storyEmailData(),i=l.vm.storyTitleData(),s=l.vm.storyVideoData(),n=!0;if(!o)return alert(l.vm.noMapPoint),void 0;if(a.isEmailAddress(r)&&!s||a.isEmailAddress(r)&&a.isUrl(s)?($("#storyEmailInput").css("border-color","#c0c0c0"),$("#requiredEmail").css("color","#464052"),$("#storyVideoInput").css("border-color","#c0c0c0"),$(".storyHeader").css("color","#464052")):(n=!1,a.isEmailAddress(r)?($("#storyEmailInput").css("border-color","#c0c0c0"),$("#requiredEmail").css("color","#464052")):($("#storyEmailInput").css("border-color","red"),$("#requiredEmail").css("color","red")),!a.isUrl(s)&&s?($("#storyVideoInput").css("border-color","red"),$("#videoHeader").css("color","red")):($("#storyVideoInput").css("border-color","#c0c0c0"),$(".storyHeader").css("color","#464052"))),!n)return alert(l.vm.formInvalidText),void 0;if(!l.vm.storyTitleData())return $("#storyTitleInput").css("border-color","red"),$("#requiredTitle").css("color","red"),alert(l.vm.stopSubmissionText),void 0;$("#storyTitleInput").css("border-color","#c0c0c0"),$("#requiredTitle").css("color","#464052"),o.attributes={},l.vm.storyLocationData()&&(o.attributes.Location=l.vm.storyLocationData());var c=$("#storyDateInput").datepicker("getDate"),d=c.getDate(),m=c.getMonth()+1,u=c.getFullYear(),p=m+"/"+d+"/"+u;l.vm.storyDetailsData()&&(o.attributes.Details=l.vm.storyDetailsData()),s&&(o.attributes.Video=s),l.vm.storyNameData()&&(o.attributes.Name=l.vm.storyNameData()),o.attributes.Date=p,o.attributes.Title=i,o.attributes.Email=r,o.attributes.Publish="Y";var y=G.map.getLayer("storiesLayer"),v=function(){alert(l.vm.submitSuccess),l.vm.storyTitleData(null),l.vm.pointGeom(null),l.vm.storyLocationData(null),l.vm.dateObserv(null),l.vm.storyDetailsData(null),l.vm.storyVideoData(null),l.vm.storyMediaData(null),l.vm.storyNameData(null),l.vm.storyEmailData(null),e.byId("storyForm").reset();for(var o=$(".uploadInput"),r=$(".uploadList"),a=0;a<o.length;a++)a<o.length-1&&(t.destroy(o[a]),t.destroy(r[a]));require(["views/map/MapConfig","modules/EventsController"],function(e,t){e.storiesBool=!0,t.goToMap()})},g=function(){alert(l.vm.submitFailure)};j.sendEvent("Submit","click","User Story","User is submitting a story via the Story Page."),y.applyEdits([o],null,null,v,g)},G.toggleBasemapGallery=function(){l.set("showBasemapGallery",!l.get("showBasemapGallery"))},G.toTitleCase=function(e){return e.replace(/\w*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})},G.reportAnalyticsHelper=function(e,t,o){ga("A.send","event",e,t,o),ga("B.send","event",e,t,o),ga("C.send","event",e,t,o)},G});