define(["dojo/on","dojo/dom","dojo/query","dojo/dom-construct","dojo/number","dojo/dom-class","dojo/_base/array","dojo/_base/fx","dojo/promise/all","dojo/Deferred","dojo/dom-style","dojo/dom-geometry","dojo/date","esri/map","esri/config","esri/dijit/HomeButton","esri/geometry/Point","esri/dijit/BasemapGallery","esri/dijit/Basemap","esri/dijit/BasemapLayer","esri/dijit/LocateButton","esri/dijit/Geocoder","esri/dijit/Legend","esri/dijit/Scalebar","esri/layers/ArcGISDynamicMapServiceLayer","esri/layers/ArcGISImageServiceLayer","esri/layers/TiledMapServiceLayer","esri/layers/ImageParameters","esri/layers/FeatureLayer","esri/geometry/webMercatorUtils","esri/geometry/Extent","esri/geometry/Polygon","esri/InfoTemplate","esri/dijit/PopupTemplate","esri/graphic","esri/urlUtils","esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleFillSymbol","esri/symbols/SimpleLineSymbol","esri/renderers/SimpleRenderer","esri/renderers/ClassBreaksRenderer","esri/renderers/smartMapping","esri/Color","dijit/registry","views/map/MapConfig","views/map/MapModel","views/map/LayerController","views/map/WindyController","views/map/clusterfeaturelayer","views/map/Finder","views/report/ReportOptionsController","utils/DijitFactory","modules/EventsController","esri/request","esri/tasks/query","esri/tasks/QueryTask","esri/tasks/RelationshipQuery","esri/tasks/PrintTask","esri/tasks/PrintParameters","esri/tasks/PrintTemplate","views/map/DigitalGlobeTiledLayer","views/map/DigitalGlobeServiceLayer","views/map/BurnScarTiledLayer","views/map/Uploader","views/map/DrawTool","modules/HashController","esri/layers/GraphicsLayer","esri/layers/ImageServiceParameters","dijit/Dialog","utils/Helper","dojo/aspect"],function(e,a,r,t,i,o,n,s,l,d,c,p,y,g,m,u,h,f,b,v,w,L,I,D,k,x,S,T,A,O,C,F,E,_,P,M,G,H,Y,j,B,N,R,V,W,U,z,J,Q,q,Z,X,K,ea,aa,ra,ta,ia,oa,na,sa,la,da,ca,pa,ya,ma,ua,ha,fa){var ba={},va=!1,wa={viewId:"mapView",viewName:"map"},La=[],Ia=new H(H.STYLE_SOLID,new Y(Y.STYLE_SOLID,new R("yellow"),5),new R([255,255,0,0]));return ba.mapExtentPausable,ba.init=function(){var e=this;return va?(ba.map.resize(),K.switchToView(wa),ba.fromStories(),void ba.checkBubble()):(va=!0,void require(["dojo/text!views/map/map.html","dojo/ready"],function(r,t){a.byId(wa.viewId).innerHTML=r,fa.showLoader("map","map-blocker"),K.switchToView(wa),t(function(){U.applyBindings("map-view"),addthis.init(),e.addConfigurations(),$("#footerView").hide(),e.createMap(),setTimeout(function(){e.checkBubble(),e.fromStories()},1e3)})}))},ba.centerChange=function(){if(ba.map){var a=O.webMercatorToGeographic(ba.map.extent),r=i.round(a.getCenter().x,2),t=i.round(a.getCenter().y,2),o=ba.map.getLevel(),n=ya.newState,s=parseFloat(n.x)!=r||parseFloat(n.y)!=t||parseInt(n.l)!=o;if(s){ba.mapExtentPausable.pause(),e.once(ba.map,"extent-change",function(){ba.mapExtentPausable.resume()});var l=O.geographicToWebMercator(new h(parseFloat(n.x),parseFloat(n.y)));ba.map.centerAndZoom(l,parseInt(n.l))}}},ba.addConfigurations=function(){var e=W.proxies,a=document.location.href,r="/proxy/proxy.ashx";for(var t in e)0===a.indexOf(t)&&(r=e[t],m.defaults.io.proxyUrl=e[t]);M.addProxyRule({urlPrefix:"https://services.digitalglobe.com/",proxyUrl:r}),M.addProxyRule({urlPrefix:W.landsat8.prefix,proxyUrl:r}),m.defaults.io.corsEnabledServers.push(W.windData.domain)},ba.createMap=function(){var a=this;X.buildDijits(W.reportOptionsDijits),X.buildDijits(W.accordionDijits);var r=ya.newState.x,t=ya.newState.y,o=ya.newState.l;ba.map=new g("map",{center:[r,t],zoom:o,basemap:W.mapOptions.basemap,minZoom:W.mapOptions.minZoom,maxZoom:W.mapOptions.maxZoom,sliderPosition:W.mapOptions.sliderPosition,force3DTransforms:!0,navigationMode:"css-transforms"}),window.map=ba.map,ba.map.on("load",function(){$("#firesDateTo").datepicker("option","minDate","+0m -7d"),$("#noaaDateFrom").datepicker("setDate","10/22/2014"),$("#indoDateFrom").datepicker("setDate","1/1/2013"),ba.map.graphics.clear(),U.vm.windPicker(),V.byId("fires-map-accordion").resize(),J.setMap(ba.map),z.setMap(ba.map),q.setMap(ba.map),ca.setMap(ba.map),pa.init(map),a.addWidgets(),a.bindEvents(),a.addLayers(),q.setupInfowindowListeners(),e.once(ba.map,"update-end",function(){ba.map.centerAt(new h(r,t)).then(function(){setTimeout(function(){ba.mapExtentPausable.resume()},1e3)})}),ba.map.resize()}),ba.mapExtentPausable=e.pausable(ba.map,"extent-change",function(e){var a=(e.delta,O.webMercatorToGeographic(e.extent)),r=(e.levelChange,e.lod),t=(e.target,i.round(a.getCenter().x,2)),o=i.round(a.getCenter().y,2);ya.updateHash({x:t,y:o,l:r.level}),"on"==dijit.byId("digital-globe-checkbox").getValue()&&ba.updateImageryList()}),ba.mapExtentPausable.pause()},ba.checkBubble=function(){console.log("checking bubble"),W.digitalGlobe.navigationBool&&(V.byId("digital-globe-checkbox").setValue(!0),V.byId("fires-map-accordion").selectChild(V.byId("imagery-panel")),W.digitalGlobe.navigationBool=!1)},ba.fromStories=function(){console.log("Checking out user stories"),W.storiesBool&&(V.byId("fire-stories-checkbox").setValue(!0),V.byId("fires-map-accordion").selectChild(V.byId("social-media-panel")),W.storiesBool=!1)},ba.updateImageryList=function(){U.vm.digitalGlobeInView.removeAll();var e=ba.map.extent,a=ba.map.getLayer("Digital_Globe_Bounding_Boxes");La=[];for(var r=dijit.byId("timeSliderDG").thumbIndexes,t=dijit.byId("timeSliderDG").timeStops,i=moment(t[r[0]]).tz("Asia/Jakarta"),o=moment(t[r[1]]).tz("Asia/Jakarta"),s=0;s<a.graphics.length;s++)e.intersects(a.graphics[s].geometry)&&La.push(a.graphics[s]);n.forEach(La,function(e){var a=moment(e.attributes.AcquisitionDate).tz("Asia/Jakarta");if(a>=i&&o>=a){var a=moment(e.attributes.AcquisitionDate).tz("Asia/Jakarta");e.attributes.AcquisitionDate=a.format("YYYY/MM/DD");var r="<a class='popup-link' data-bucket='"+e.attributes.SensorName+"_id_"+e.attributes.OBJECTID+"'>"+a.format("YYYY/MM/DD")+"</a>",t="<a class='popup-link' data-bucket='"+e.attributes.SensorName+"_id_"+e.attributes.OBJECTID+"'>"+e.attributes.SensorName+"</a>";e.attributes.formattedDatePrefix1=r,e.attributes.formattedDatePrefix2=t,U.vm.digitalGlobeInView.push({feature:e,selected:e.attributes.OBJECTID==U.vm.selectedImageryID()})}}),U.vm.digitalGlobeInView.sort(function(e,a){return e.feature.attributes.AcquisitionDate==a.feature.attributes.AcquisitionDate?0:e.feature.attributes.AcquisitionDate>a.feature.attributes.AcquisitionDate?-1:1})},ba.showDigitalGlobe=function(e){var a=U.vm.digitalGlobeInView();U.vm.digitalGlobeInView([]),n.forEach(a,function(a){a.selected=a==e?!0:!1,U.vm.digitalGlobeInView.push(a)}),U.vm.selectedImageryID(e.feature.attributes.OBJECTID),z.showDigitalGlobeImagery(e)},ba.imageryZoom=function(e){var a=ba.map.getLayer("Digital_Globe_Bounding_Boxes_Highlight");a.clear(),ba.map.setExtent(e.feature.geometry.getExtent())},ba.handleImageryOver=function(e){var a=new P(e.feature.geometry),r=ba.map.getLayer("Digital_Globe_Bounding_Boxes_Highlight");r.add(a)},ba.handleImageryOut=function(){var e=ba.map.getLayer("Digital_Globe_Bounding_Boxes_Highlight");e.clear()},ba.setSmartRenderer=function(e){switch(e){case"Choose one":ba.map.graphics.clear();var a,r,t;a=ba.map.getLayer("firesClusters"),a.hide(),t=ba.map.getLayer("hexFires"),t.hide(),r=ba.map.getLayer("newFires"),r.hide();break;case"Heat map":ba.map.graphics.clear();var a,r,t;a=ba.map.getLayer("firesClusters"),a.hide(),t=ba.map.getLayer("hexFires"),t.hide(),r=ba.map.getLayer("newFires"),r.show();break;case"Proportional symbols":ba.map.graphics.clear();var r,a,t;r=ba.map.getLayer("newFires"),r.hide(),t=ba.map.getLayer("hexFires"),t.hide(),a=ba.map.getLayer("firesClusters"),a.show();break;case"Hex bin":ba.setHexBinRender()}},ba.setHexBinRender=function(){function e(){console.log("createQuery!");var e=ba.map.extent,a={rings:[[[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin],[e.xmin,e.ymax]]],spatialReference:e.spatialReference},r=new F(a),t=new aa;return t.returnGeometry=!0,t.where="1=1",t.outSpatialReference=ba.map.spatialReference,t.geometry=r,t.outFields=["*"],t}var a,r;a=ba.map.getLayer("firesClusters"),a.hide(),r=ba.map.getLayer("newFires"),r.hide(),ba.tessellationInfo={},ba.tessellationInfo.origin={},ba.tessellationInfo.hexagonOrientation="NS",ba.tessellationInfo.hexagonRadius=1e3,ba.tessellationInfo.type="hexagon";var t,i=5e4;t=new H(H.STYLE_SOLID,new Y(Y.STYLE_SOLID,new R([255,0,0,.75]),1),new R([255,255,0,0]));var o=ba.map.extent,n=.5*i,s=i*Math.cos(Math.PI*(30/180)),l=2*s;ba.tessellationInfo.origin.x=o.xmin,ba.tessellationInfo.origin.y=o.ymin;var d=parseInt((o.ymax-o.ymin)/l+.5)+1,c=parseInt((o.xmax-o.xmin)/(i+n)+.5)+1;console.log("rows: "+d+" cols: "+c+" ");for(var p=(new Date).getTime(),y=0,g=0,m=0;c>m;m++)for(var u=0;d>u;u++){var f,b,v=m%2;0==v?(f=m*(i+n)+o.xmin,b=u*l+o.ymin):(f=m*(i+n)+o.xmin,b=u*l+s+o.ymin);var w=f+i,L=b,I=f+n,D=b+s,k=f-n,x=b+s,S=f-i,T=b,A=f-n,O=b-s,C=f+n,E=b-s,_=new F(ba.map.spatialReference);_.addRing([[w,L],[I,D],[k,x],[S,T],[A,O],[C,E],[w,L]]);var M=(new h(f,b,ba.map.spatialReference),"ID-"+m+"-"+u),G={count:0,id:M},j=new P(_,t,G);ba.map.graphics.add(j)}var B=(new Date).getTime();console.log("elapsed time: "+(B-p)/1e3+" s"," count1: "+y+" count2: "+g);var N=(new ta,ba.map.getLayer("hexFires"));fa.showLoader("map","map-blocker"),N.queryFeatures(e(),function(e){function a(e,a){console.log("updateTessellationLayer!"),console.log(e.length+" features");for(var r=0,t=ba.map.graphics.graphics.length,i=ba.map.graphics.graphics,o=0;t>o;o++){for(var n=0;n<a.length;n++)i[o].geometry.contains(a[n].geometry)&&i[o].attributes.count++;r=r>i[o].attributes.count?r:i[o].attributes.count}console.log("max weight: "+r);for(var s=0;t>s;s++){var l=i[s].attributes.count/r*.8;i[s].symbol=new H(H.STYLE_SOLID,null,new R([255,0,0,l]))}ba.map.graphics.redraw()}fa.hideLoader("map-blocker"),console.log("# of features: "+e.features.length);for(var r,t,i,o,n,s=(new Date).getTime(),l=[],d=.5*ba.tessellationInfo.hexagonRadius,c=ba.tessellationInfo.hexagonRadius*Math.cos(Math.PI*(30/180)),p=2*c,y=ba.tessellationInfo.hexagonRadius+d,g=0;g<e.features.length;g++){n=e.features[g],i=n.geometry,r=parseInt((i.x-ba.tessellationInfo.origin.x)/y),t=parseInt((i.y-ba.tessellationInfo.origin.y)/p);var m,u,h,f=r%2;0===f?(m={x:r*y+ba.tessellationInfo.origin.x,y:t*p+ba.tessellationInfo.origin.y},u={x:r*y+ba.tessellationInfo.origin.x,y:(t+1)*p+ba.tessellationInfo.origin.y},h={x:(r+1)*y+ba.tessellationInfo.origin.x,y:(t+.5)*p+ba.tessellationInfo.origin.y}):(m={x:r*y+ba.tessellationInfo.origin.x,y:(t+.5)*p+ba.tessellationInfo.origin.y},u={x:(r+1)*y+ba.tessellationInfo.origin.x,y:t*p+ba.tessellationInfo.origin.y},h={x:(r+1)*y+ba.tessellationInfo.origin.x,y:(t+1)*p+ba.tessellationInfo.origin.y});var b=(i.x-m.x)*(i.x-m.x)+(i.y-m.y)*(i.y-m.y),v=(i.x-u.x)*(i.x-u.x)+(i.y-u.y)*(i.y-u.y),w=(i.x-h.x)*(i.x-h.x)+(i.y-h.y)*(i.y-h.y);o=0===f?v>=b&&w>=b?"ID-"+r+"-"+t:b>=v&&w>=v?"ID-"+r+"-"+(t+1):"ID-"+(r+1)+"-"+t:v>=b&&w>=b?"ID-"+r+"-"+t:b>=v&&w>=v?"ID-"+(r+1)+"-"+t:"ID-"+(r+1)+"-"+(t+1);for(var L=void 0,I=0;I<l.length;I++)if(l[I].id===o){l[I].attributes.count=l[I].attributes.count+1,L=l[I];break}var D={};L||(D.count=1,L={id:o,attributes:D},l.push(L))}a(l,e.features);var k=(new Date).getTime();console.log("# of grids: "+l.length+" elapsed time: "+(k-s)/1e3+" s")})},ba.resizeMapPanel=function(e){1==e?($("#control-panel").css("width","2px"),$(".map-container").css("left","2px"),$("#leftPaneToggle").html("+"),$("#latLongHUD").css("left","100px"),$("div.scalebar_bottom-left.esriScalebar").css("left","119px"),$("#map").css("left","2px"),$("#control-panel").css("background-color","#ecc53d"),ba.map.resize(),U.vm.toggleMapPane(!1)):($("#control-panel").css("width","320px"),$(".map-container").css("left","320px"),$("#leftPaneToggle").html("-"),$("#map").css("left","320px"),$("#latLongHUD").css("left","0px"),$("div.scalebar_bottom-left.esriScalebar").css("left","19px"),$("#control-panel").css("background-color","transparent"),ba.map.resize(),U.vm.toggleMapPane(!0)),$("#leftPaneToggle").hide(),$("#latLongHUD").hide(),$("div.scalebar_bottom-left.esriScalebar").hide(),$("#control-panel > div.report-link-container").hide(),setTimeout(function(){$("#latLongHUD").show(),$("#leftPaneToggle").show(),$("div.scalebar_bottom-left.esriScalebar").show(),$("#control-panel > div.report-link-container").show()},1e3)},ba.removeAnalysisFromHash=function(){z.updateLayersInHash("remove","Get_Fires_Analysis")},ba.addWidgets=function(){var r,i,o,n,s,l,d,c=[];r=new D({map:ba.map,scalebarUnit:"metric"}),t.create("div",{id:"home-button","class":"home-button"},document.querySelector(".esriSimpleSliderIncrementButton"),"after"),l=new u({map:ba.map},"home-button"),l.startup(),i=new b({layers:[new v({url:W.mapOptions.darkGrayCanvas})],id:"darkgray",title:"Dark Gray Canvas",thumbnailUrl:"app/images/darkGreyThumb.jpg"});var p=new b({layers:[new v({url:"http://a.tiles.mapbox.com/v4/devseed.3100ad78/{level}/{col}/{row}.png?access_token=pk.eyJ1IjoiZGV2c2VlZCIsImEiOiJnUi1mbkVvIn0.018aLhX0Mb0tdtaT2QNe2Q",type:"WebTiledLayer"}),new v({url:"http://a.tiles.mapbox.com/v4/devseed.841fc333/{level}/{col}/{row}.png?access_token=pk.eyJ1IjoiZGV2c2VlZCIsImEiOiJnUi1mbkVvIn0.018aLhX0Mb0tdtaT2QNe2Q",type:"WebTiledLayer"})],id:"newBM",title:"New BM",thumbnailUrl:"app/images/darkGreyThumb.jpg"});c.push(p),d=new f({map:ba.map,basemaps:c,showArcGISBasemaps:!0},"basemap-gallery"),d.startup(),n=new w({map:ba.map,highlightLocation:!1},"location-widget"),n.startup(),o=new L({map:ba.map},"esri-geocoder-widget"),o.startup(),s=new I({map:ba.map,layerInfos:[],autoUpdate:!0},"legend"),s.startup();var y=function(){U.get("showBasemapGallery")&&U.set("showBasemapGallery",!1),U.get("showShareContainer")&&U.set("showShareContainer",!1),U.get("showAlertContainer")&&U.set("showAlertContainer",!1),U.set("showLocatorWidgets",!U.get("showLocatorWidgets"))},g=function(){U.get("showLocatorWidgets")&&U.set("showLocatorWidgets",!1),U.get("showShareContainer")&&U.set("showShareContainer",!1),U.get("showAlertContainer")&&U.set("showAlertContainer",!1),U.set("showBasemapGallery",!U.get("showBasemapGallery"))},m=function(){U.get("showLocatorWidgets")&&U.set("showLocatorWidgets",!1),U.get("showBasemapGallery")&&U.set("showBasemapGallery",!1),U.set("showShareContainer",!U.get("showShareContainer"))},h=function(){U.get("showLocatorWidgets")&&U.set("showLocatorWidgets",!1),U.get("showBasemapGallery")&&U.set("showBasemapGallery",!1),U.get("showShareContainer")&&U.set("showShareContainer",!1),U.set("showAlertContainer",!U.get("showAlertContainer"))},k=function(){U.set("showDrawTools",!1),$("#drawFeatures").css("background-color","#444"),U.set("showUploadTools",!U.get("showUploadTools")),U.get("showUploadTools")?$("#uploadFeatures").css("background-color","#e7002f"):$("#uploadFeatures").css("background-color","#444"),pa.isActive()&&pa.deactivateToolbar()},x=function(){U.set("showUploadTools",!1),$("#uploadFeatures").css("background-color","#444"),U.set("showDrawTools",!U.get("showDrawTools")),U.get("showDrawTools")?$("#drawFeatures").css("background-color","#e7002f"):$("#drawFeatures").css("background-color","#444")};e(a.byId("locator-widget-button"),"click",y),e(a.byId("basemap-gallery-button"),"click",g),e(a.byId("share-button"),"click",m),e(a.byId("alert-button"),"click",h),e(a.byId("uploadFeatures"),"click",k),e(a.byId("drawFeatures"),"click",x),e(a.byId("uploadForm"),"change",ca.beginUpload.bind(ca)),this.initTransparency()},ba.initTransparency=function(){["forest-transparency-slider","conservation-transparency-slider","land-cover-transparency-slider"].map(function(e){dijit.byId(e).set("value",70)})},ba.bindEvents=function(){var i=this;e(a.byId("dms-search"),"change",function(e){var a=e.target?e.target.checked:e.srcElement.checked;a&&(U.set("showDMSInputs",!0),U.set("showLatLongInputs",!1))}),e(a.byId("lat-long-search"),"change",function(e){var a=e.target?e.target.checked:e.srcElement.checked;a&&(U.set("showLatLongInputs",!0),U.set("showDMSInputs",!1))}),e(ba.map,"mouse-move",function(e){U.set("currentLatitude",e.mapPoint.getLatitude().toFixed(4)),U.set("currentLongitude",e.mapPoint.getLongitude().toFixed(4))}),e(ba.map,"click",function(e){q.selectTomnodFeatures(e)}),e(ba.map.graphics,"click",function(e){e.graphic&&q.selectUploadOrDrawnGraphics(e)}),e(V.byId("confidence-fires-checkbox"),"change",function(e){z.updateFiresLayer(!0),z.updateOtherFiresLayers(e),e&&i.reportAnalyticsHelper("layer","option","The user toggled the Active Fires only show high confidence fires option on.")}),e(V.byId("twitter-conversations-checkbox"),"change",function(){var e=V.byId("twitter-conversations-checkbox").checked;z.toggleLayerVisibility(W.tweetLayer.id,e),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Twitter Conversations layer on.")}),e(V.byId("fire-stories-checkbox"),"change",function(){var e=V.byId("fire-stories-checkbox").checked;z.toggleLayerVisibility(W.fireStories.id,e),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Fire Stories layer on.")}),e(V.byId("fires-checkbox"),"change",function(){var e=V.byId("fires-checkbox").checked;z.toggleLayerVisibility(W.firesLayer.id,e),U.vm.showActiveFiresButtons(e),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Active Fires layer on.")}),e(V.byId("air-quality-checkbox"),"change",function(e){return z.toggleLayerVisibility(W.airQualityLayer.id,e),e?($("#airDate").datepicker("setDate","+0m +0d"),ba.map.getLayer(W.airQualityLayer.id).setVisibleLayers([0]),i.reportAnalyticsHelper("layer","toggle","The user toggled the Air Quality layer on."),U.vm.showReportOptionsAIR(!0),void 0):void U.vm.showReportOptionsAIR(!1)}),e(V.byId("tomnod-checkbox"),"change",function(e){z.toggleLayerVisibility(W.tomnodLayer.id,e),z.toggleLayerVisibility(W.tomnodLayer.sel_id,e),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Tomnod layer on.")}),e(V.byId("indonesia-fires"),"change",function(e){console.log(e),z.toggleMapServiceLayerVisibility(ba.map.getLayer(W.indonesiaLayers.id),W.indonesiaLayers.layerIds.indonesiaFires,e)}),e(V.byId("noaa-fires-18"),"change",function(e){z.toggleMapServiceLayerVisibility(ba.map.getLayer(W.indonesiaLayers.id),W.indonesiaLayers.layerIds.noaa18,e)}),e(V.byId("burned-scars-checkbox"),"change",function(e){z.toggleLayerVisibility(W.burnScarLayer.id,e),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Burn Scars layer on.")}),e(V.byId("landsat-image-checkbox"),"change",function(){var e=V.byId("landsat-image-checkbox").checked;z.toggleLayerVisibility(W.landsat8.id,e),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Latest Landsat 8 Imagery layer on.")}),V.byId("windy-layer-checkbox").on("change",function(e){J.toggleWindLayer(e),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Wind direction layer on.")}),V.byId("digital-globe-checkbox").on("change",function(e){z.toggleDigitalGlobeLayer(e),U.vm.showReportOptionsDigitalGlobe(e),e&&(setTimeout(function(){dijit.byId("digital-globe-footprints-checkbox").set("value","true",!1)},0),i.reportAnalyticsHelper("layer","toggle","The user toggled the Digital Globe - First Look layer on."))}),V.byId("digital-globe-footprints-checkbox").on("change",function(e){z.toggleDigitalGlobeLayer(e,"footprints"),ba.updateImageryList()}),V.byId("provinces-checkbox").on("change",function(e){z.adjustOverlaysLayer(),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Provinces overlay layer on.")}),V.byId("districts-checkbox").on("change",function(e){z.adjustOverlaysLayer(),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Districts overlay layer on.")}),V.byId("subdistricts-checkbox").on("change",function(e){z.adjustOverlaysLayer(),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Subdistricts overlay layer on.")}),V.byId("villages-checkbox").on("change",function(e){z.adjustOverlaysLayer(),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Villages overlay layer on.")}),e(a.byId("search-option-go-button"),"click",function(){q.searchAreaByCoordinates(),i.reportAnalyticsHelper("widget","search","The user searched for location by latitude/longitude or Degrees/Minutes/Seconds.")}),e(a.byId("print-button"),"click",function(){i.printMap(),i.reportAnalyticsHelper("widget","print","The user clicked the print widget to print the map.")}),e(a.byId("report-link"),"click",function(){U.vm.showReportOptions(!0),U.vm.reportAOIs().length<1&&Z.populate_select(),i.reportAnalyticsHelper("widget","report","The user clicked Get Fires Analysis to generate an report with the latest analysis."),console.log("In hash");var e=ya.getHash();-1===e.lyrs.indexOf("Get_Fires_Analysis")&&(console.log("Changing hash"),z.updateLayersInHash("add","lyrs","Get_Fires_Analysis"))}),e(a.byId("noaa-fires-18"),"click",function(){if("false"==this.getAttribute("aria-checked")){var e=a.byId("indonesia-fires");return"false"==e.getAttribute("aria-checked")&&(ba.map.getLayer("IndonesiaFires").visible=!1,console.log("Should disable pop-ups")),void U.vm.showReportOptionsNOAA(!1)}U.vm.showReportOptionsNOAA(!0),Z.populate_select()}),e(a.byId("indonesia-fires"),"click",function(){if("false"==this.getAttribute("aria-checked")){var e=a.byId("noaa-fires-18");return"false"==e.getAttribute("aria-checked")&&(ba.map.getLayer("IndonesiaFires").visible=!1,console.log("Should disable pop-ups")),void U.vm.showReportOptionsINDO(!1)}U.vm.showReportOptionsINDO(!0),Z.populate_select()}),e(a.byId("windy-layer-checkbox"),"click",function(){return"false"==this.getAttribute("aria-checked")?void U.vm.showReportOptionsWIND(!1):(U.vm.showReportOptionsWIND(!0),void Z.populate_select())}),e(a.byId("updateNOAA"),"click",function(){var e=U.vm.noaaObservFrom(),a=U.vm.noaaObservTo(),r=$("#noaaDateFrom").datepicker("getDate"),t=$("#noaaDateTo").datepicker("getDate");a=moment(t).add(1,"day"),e=moment(r).tz("Asia/Jakarta").format("M/D/YYYY"),a=moment(a._d).tz("Asia/Jakarta").format("M/D/YYYY");var i=e.replace(/\//g,"-"),o=a.replace(/\//g,"-"),n=z.getTimeDefinition("Date",i,o);z.updateDynamicMapServiceLayerDefinition(ba.map.getLayer(W.indonesiaLayers.id),W.indonesiaLayers.layerIds.noaa18,n)}),e(a.byId("updateINDO"),"click",function(){var e=U.vm.indoObservFrom(),a=U.vm.indoObservTo(),r=$("#indoDateFrom").datepicker("getDate"),t=$("#indoDateTo").datepicker("getDate");a=moment(t).add(1,"day"),e=moment(r).tz("Asia/Jakarta").format("M/D/YYYY"),a=moment(a._d).tz("Asia/Jakarta").format("M/D/YYYY");var i=e.replace(/\//g,"-"),o=(a.replace(/\//g,"-"),z.getTimeDefinition("ACQ_DATE",i,a));V.byId("confidence-archive-checkbox").checked&&(o=[o,W.firesLayer.highConfidence].join(" AND ")),z.updateDynamicMapServiceLayerDefinition(ba.map.getLayer(W.indonesiaLayers.id),W.indonesiaLayers.layerIds.indonesiaFires,o)}),e(V.byId("confidence-archive-checkbox"),"change",function(e){console.log("confidence",e);var a=e?W.firesLayer.highConfidence:"",r=ba.map.getLayer(W.indonesiaLayers.id),t=W.indonesiaLayers.layerIds.indonesiaFires,i=r.layerDefinitions,o=i[t];if(e)var n=void 0!=o?[o,a].join(" AND "):a;else var n=o.replace(" AND "+W.firesLayer.highConfidence,a).replace(W.firesLayer.highConfidence,a);z.updateDynamicMapServiceLayerDefinition(ba.map.getLayer(W.indonesiaLayers.id),W.indonesiaLayers.layerIds.indonesiaFires,n)}),e(V.byId("activate-smart-checkbox"),"change",function(e){var a=ba.map.getLayer("Active_Fires");if(e===!0)a.hide(),ba.setSmartRenderer(U.vm.smartRendererName());else{a.show(),ba.map.graphics.clear();var r,t,i;r=ba.map.getLayer("newFires"),r.hide(),t=ba.map.getLayer("firesClusters"),t.hide(),i=ba.map.getLayer("firesClusters"),i.hide()}}),e(a.byId("updateWIND"),"click",function(){var e=(U.vm.windObserv(),$("#windDate").datepicker("getDate")),a=moment(e).tz("Asia/Jakarta").format("MM/DD/YYYY"),r=U.vm.timeOfDay(),t=a.split("/"),i=t[2].toString()+t[0].toString()+t[1].toString();console.log(i);var o="http://suitability-mapper.s3.amazonaws.com/wind/archive/wind-surface-level-gfs-"+i+r+".1-0.gz.json";J.deactivateWindLayer(),J.activateWindLayer(o)}),e(a.byId("updateAIR"),"click",function(){var e=$("#airDate").datepicker("getDate"),a=new Date;if(a.setHours(0,0,0,0),e.getTime()==a.getTime()){var r=ba.map.getLayer(W.airQualityLayer.id);return void r.setVisibleLayers([0])}var t=moment(e).format("YYYY/MM/DD"),i=moment(e).add("days",1).format("YYYY/MM/DD"),o=z.getTimeDefinition("dateUpdated",t,i);z.updateDynamicMapServiceLayerDefinition(ba.map.getLayer(W.airQualityLayer.id),1,o)}),e(a.byId("embedShare"),"click",function(){i.showEmbedCode()}),e(a.byId("clear-search-pins"),"click",this.clearSearchPins),e(a.byId("legend-widget-title"),"click",this.toggleLegend),V.byId("forest-transparency-slider").on("change",function(e){z.setTransparency(W.forestUseLayers.id,e)}),V.byId("land-cover-transparency-slider").on("change",function(e){z.setTransparency(W.landCoverLayers.id,e)}),V.byId("conservation-transparency-slider").on("change",function(e){z.setTransparency(W.conservationLayers.id,e)}),r(".active-fires-options").forEach(function(a){e(a,"click",i.toggleFireOption.bind(i))}),r(".esriPopupWrapper").forEach(function(r){t.create("div",{id:"close-icon","class":"close-icon"},r),e(a.byId("close-icon"),"click",function(){ba.map.infoWindow.hide(),$("#uploadCustomGraphic").length>0&&$("#uploadCustomGraphic").remove()})}),e(ba.map.infoWindow,"hide",function(){ba.map.infoWindow.clearFeatures()}),r("#forest-use-panel div.checkbox-container div input").forEach(function(e){o.add(e,"forest-use-layers-option")}),r("#conservation-panel div.checkbox-container div input").forEach(function(e){o.add(e,"conservation-layers-option")}),r("#land-cover-panel div.checkbox-container div input").forEach(function(e){"land-cover-radios"===e.name&&o.add(e,"land-cover-layers-option")}),r("#forest-use-panel div.checkbox-container div input").forEach(function(a){e(a,"change",function(e){z.updateAdditionalVisibleLayers("forest-use-layers-option",W.forestUseLayers);var a=e.target?e.target:e.srcElement;a.checked})}),r(".conservation-layers-option").forEach(function(a){e(a,"change",function(e){z.updateAdditionalVisibleLayers("conservation-layers-option",W.conservationLayers);var a=e.target?e.target:e.srcElement;a.checked})}),r(".land-cover-layers-option").forEach(function(a){e(a,"change",function(e){z.updateLandCoverLayers(e);var a=e.target?e.target:e.srcElement;if(a.checked){var t=r("#land-cover-panel .dijitChecked")[0].parentNode.children[1];if(t.innerHTML.length>0){var o=t.innerHTML;-1===o.search("None")&&i.reportAnalyticsHelper("layer","toggle","The user toggled the "+o+" layer on")}}})}),r("#primary-forests-options input").forEach(function(a){e(a,"change",function(e){z.updatePrimaryForestsLayer(!0);var a=e.target?e.target:e.srcElement;if(a.checked&&a.labels.length>0){var r=a.labels[0].innerHTML;-1===r.search("Primary")&&(r="Primary Forests "+r),i.reportAnalyticsHelper("layer","toggle","The user toggled the "+r+" layer on")}})})},ba.addLayers=function(){var a,r,t,i,o,s,l,d,c,p,y,g,m,u,h,f,b,v,w=this;a=new T,a.format="png32",a.layerIds=W.conservationLayers.defaultLayers,a.layerOption=T.LAYER_OPTION_SHOW,r=new k(W.conservationLayers.url,{imageParameters:a,id:W.conservationLayers.id,visible:!1}),indonesiaParams=new T,indonesiaParams.format="png32",indonesiaParams.layerIds=W.indonesiaLayers.defaultLayers,indonesiaParams.layerOption=T.LAYER_OPTION_SHOW,indonesiaLayer=new k(W.indonesiaLayers.url,{imageParameters:indonesiaParams,id:W.indonesiaLayers.id,visible:!1}),s=new T,s.format="png32",s.layerIds=W.landCoverLayers.defaultLayers,s.layerOption=T.LAYER_OPTION_SHOW,l=new k(W.landCoverLayers.url,{imageParameters:s,id:W.landCoverLayers.id,visible:!1}),c=new T,c.format="png32",c.layerIds=W.forestUseLayers.defaultLayers,c.layerOption=T.LAYER_OPTION_SHOW,p=new k(W.forestUseLayers.url,{imageParameters:c,id:W.forestUseLayers.id,visible:!1}),y=new x(W.treeCoverLayer.url,{id:W.treeCoverLayer.id,visible:!1}),t=new T,t.format="png32",t.layerIds=W.primaryForestsLayer.defaultLayers,t.layerOption=T.LAYER_OPTION_SHOW,i=new k(W.primaryForestsLayer.url,{imageParameters:t,id:W.primaryForestsLayer.id,visible:!1}),h=new x(W.landsat8.url,{id:W.landsat8.id,visible:!1}),v=W.digitalGlobe,o=v.mosaics.map(function(e){return new x(v.imagedir+e+"/ImageServer",{id:e,visible:!1})}),dglyrs=o,g=new k(W.overlaysLayer.url,{id:W.overlaysLayer.id,visible:!1}),d=new k(W.airQualityLayer.url,{id:W.airQualityLayer.id,visible:!1}),tomnodParams=new T,tomnodParams.layerIds=W.tomnodLayer.defaultLayers,tomnodParams.layerOption=T.LAYER_OPTION_SHOW,u=new k(W.tomnodLayer.url,{imageParameters:tomnodParams,id:W.tomnodLayer.id,visible:!1});var L=new E("${name}",q.getTomnodInfoWindow),I=new A(W.tomnodLayer.url+"/"+W.tomnodLayer.defaultLayers[0],{mode:A.MODE_SELECTION,infoTemplate:L,outFields:["*"],id:W.tomnodLayer.sel_id}),D=new A("http://gis-potico.wri.org/arcgis/rest/services/Fires/Global_Fires/MapServer/4",{mode:A.MODE_ONDEMAND,id:"newFires",visible:!1,outFields:"*"}),S=new A("http://gis-potico.wri.org/arcgis/rest/services/Fires/Global_Fires/MapServer/4",{mode:A.MODE_ONDEMAND,id:"hexFires",visible:!1,outFields:"*"}),O=new G("circle",9,new Y(Y.STYLE_SOLID,new R([255,255,255,1]),1),new R([254,182,62,1])),C=(new G("circle",16,new Y(Y.STYLE_SOLID,new R([102,0,0,.85]),3),new R([255,255,255,1])),new Q({url:"http://gis-potico.wri.org/arcgis/rest/services/Fires/Global_Fires/MapServer/4",distance:95,id:"firesClusters",labelColor:"#fff",resolution:ba.map.extent.getWidth()/ba.map.width,singleSymbol:O,useDefaultSymbol:!1,zoomOnClick:!0,showSingles:!0,visible:!1,objectIdField:"FID",outFields:["ACQ_DATE","CONFIDENCE"]}));C.on("update-end",function(){C._clusterData=layer._clusterData.filter(function(){})});var F=new B(O,"clusterCount"),P=new G("circle",10,new Y(Y.STYLE_SOLID,new R([212,116,60,.5]),15),new R([212,116,60,.75])),M=new G("circle",25,new Y(Y.STYLE_SOLID,new R([178,70,37,.5]),15),new R([178,70,37,.75])),H=new G("circle",35,new Y(Y.STYLE_SOLID,new R([144,24,13,.5]),15),new R([144,24,13,.75])),$=new G("circle",55,new Y(Y.STYLE_SOLID,new R([102,0,0,.5]),15),new R([102,0,0,.75]));F.addBreak(2,50,P),F.addBreak(50,250,M),F.addBreak(250,1e3,H),F.addBreak(1e3,5e4,$),C.setRenderer(F),m=new da(W.burnScarLayer.url,W.burnScarLayer.id),f=new T,f.format="png32",f.layerIds=W.firesLayer.defaultLayers,f.layerOption=T.LAYER_OPTION_SHOW,b=new k(W.firesLayer.url,{imageParameters:f,id:W.firesLayer.id,visible:!1}),tweetLayer=new A(W.tweetLayer.url,{mode:A.MODE_ONDEMAND,id:W.tweetLayer.id,visible:!1,outFields:["*"]});new _({title:"{Title}",fieldInfos:[{fieldName:"Date",label:"Date",format:{dateFormat:"shortDate"},visible:!0},{fieldName:"Details",label:"Details",visible:!0},{fieldName:"Video",label:"Video",visible:!0},{fieldName:"Name",label:"Name",visible:!0}],showAttachments:!0});fireStories=new A(W.fireStories.url,{mode:A.MODE_ONDEMAND,id:W.fireStories.id,visible:!1,outFields:["*"],hasAttachments:!0,definitionExpression:"Publish = 'Y'"});var U={layerDefinition:{geometryType:"esriGeometryPolygon",fields:[]},featureSet:null},J=new A(U,{id:W.digitalGlobe.graphicsLayerId,visible:!1}),Z=new ma(U,{id:W.digitalGlobe.graphicsLayerHighlight,visible:!0}),X=new j(Ia);Z.setRenderer(X),N.createHeatmapRenderer({layer:D,blurRadius:5,basemap:ba.map.getBasemap()}).then(function(e){var a=ba.map.getLayer("newFires");a.setRenderer(e.renderer)}),dglyr=J;var K=[y,l,i,J,Z].concat(o).concat([r,m,u,p,g,tweetLayer,fireStories,d,I,D,C,S,indonesiaLayer,b]);e.once(ba.map,"layers-add-result",function(e){w.enableLayersFromHash();var a=n.map(e.layers,function(e){return{layer:e.layer}});a=n.filter(a,function(e){var a=e.layer.url?e.layer.url.search("ImageServer")<0:!1,r=!(e.layer.id===I.id);return a&&r}),fa.hideLoader("map-blocker"),V.byId("legend").refresh(a)}),ba.map.addLayers(K),ba.map.addLayer(h),g.on("load",z.setOverlayLayerOrder),m.on("error",this.layerAddError),h.on("error",this.layerAddError),y.on("error",this.layerAddError),i.on("error",this.layerAddError),r.on("error",this.layerAddError),l.on("error",this.layerAddError),g.on("error",this.layerAddError),p.on("error",this.layerAddError),b.on("error",this.layerAddError),fireStories.on("error",this.layerAddError),d.on("error",this.layerAddError),h.on("load",function(){ba.map.reorderLayer(h,1)
})},ba.layerAddError=function(e){require(["modules/ErrorController"],function(a){a.show(10,"Error adding Layer : <br> "+e.target.url)})},ba.removeCustomFeatures=function(){ba.map.graphics.clear(),U.vm.customFeaturesArray([]),U.vm.customFeaturesPresence(!1)},ba.toggleFireOption=function(e){var a=e.target?e.target:e.srcElement;r(".selected-fire-option").forEach(function(e){o.remove(e,"selected-fire-option")}),o.add(a,"selected-fire-option"),z.updateFiresLayer();var t,i=$("#confidence-fires-checkbox").attr("aria-checked");t="true"==i?!0:!1,console.log(t),z.updateOtherFiresLayers(t)},ba.enableLayersFromHash=function(){function r(){V.byId("fires-checkbox").set("checked",!0),z.updateLayersInHash("add",W.firesLayer.id,W.firesLayer.id)}function t(r,t){if(void 0!==r&&""!==r)if(void 0===t)p[r]&&(o=p[r].id,V.byId(o)&&(V.byId(o).set("checked",!0),e.emit(a.byId(o),"change",{})));else{n=p[r],s=t.split(",");for(var i=0,l=s.length;l>i;i++)if(o=n[s[i]].id,"[object Array]"===Object.prototype.toString.call(o))for(var d=0,c=o.length;c>d;d++)V.byId(o[d])&&(V.byId(o[d]).set("checked",!0),e.emit(a.byId(o[d]),"change",{}));else V.byId(o)&&(V.byId(o).set("checked",!0),e.emit(a.byId(o),"change",{}))}}var i,o,n,s,l=ya.getHash(),d=l.lyrs,c=d.split(":"),p=W.layersCheckboxes;if(void 0===d)return void r();if(1===c.length&&""===c[0])return void r();for(var y=0,g=c.length;g>y;y++)i=c[y].split("/"),t(i[0],i[1]);var m=ya.getHash();m.lyrs.indexOf("Get_Fires_Analysis")>-1&&(console.log("Updating from hash"),$("#report-link").click())},ba.clearSearchPins=function(){ba.map.graphics.clear(),U.set("showClearPinsOption",!1)},ba.toggleLegend=function(){var e=a.byId("legend-widget-container"),r=e.offsetHeight-2===280?30:280;s.animateProperty({node:e,properties:{height:r},duration:500}).play(),30===r?o.add("legend-widget-title","legend-closed"):o.remove("legend-widget-title","legend-closed")},ba.printMap=function(){var a=document.getElementsByTagName("body")[0];o.add("print-button","loading"),o.add(a,"map-view-print"),V.byId("stackContainer").resize(),V.byId("mapView").resize(),ba.map.resize(),e.once(ba.map,"resize",function(){setTimeout(function(){window.print(),o.remove("print-button","loading"),o.remove(a,"map-view-print"),ba.map.resize(),setTimeout(function(){V.byId("stackContainer").resize()},1e3)},2e3)})},ba.reportAnalyticsHelper=function(e,a,r){ga("A.send","event",e,a,r),ga("B.send","event",e,a,r),ga("C.send","event",e,a,r)},ba.showEmbedCode=function(){V.byId("embedCodeShareDialog")&&V.byId("embedCodeShareDialog").destroy();var e,r="<iframe src='"+window.location+"' height='600' width='900'></iframe>",t=new ha({title:"Embed Code",style:"width: 350px",id:"embedCodeShareDialog",content:'Copy the code below to embed in your site. (Ctrl+C on PC and Cmd+C on Mac)<div class=\'dijitDialogPaneActionBar\'><input id="embedInput" type="text" value="'+r+'" autofocus /></div>'});e=function(){t.destroy()},t.show(),a.byId("embedInput").select(),t.on("cancel",function(){e()})},ba});