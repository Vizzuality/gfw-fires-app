define(["dojo/on","dojo/dom","dojo/query","dojo/dom-construct","dojo/number","dojo/dom-class","dojo/_base/array","dojo/_base/fx","dojo/promise/all","dojo/Deferred","dojo/dom-style","dojo/dom-geometry","dojo/date","esri/map","esri/config","esri/dijit/HomeButton","esri/geometry/Point","esri/dijit/BasemapGallery","esri/dijit/Basemap","esri/dijit/BasemapLayer","esri/dijit/LocateButton","esri/dijit/Geocoder","esri/dijit/Legend","esri/dijit/Scalebar","esri/layers/ArcGISDynamicMapServiceLayer","esri/layers/ArcGISImageServiceLayer","esri/layers/TiledMapServiceLayer","esri/layers/ImageParameters","esri/layers/FeatureLayer","esri/geometry/webMercatorUtils","esri/geometry/Extent","esri/geometry/Polygon","esri/InfoTemplate","esri/dijit/PopupTemplate","esri/graphic","esri/urlUtils","esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleFillSymbol","esri/symbols/SimpleLineSymbol","esri/renderers/SimpleRenderer","esri/renderers/ClassBreaksRenderer","esri/renderers/smartMapping","esri/Color","dijit/registry","views/map/MapConfig","views/map/MapModel","views/map/LayerController","views/map/WindyController","views/map/clusterfeaturelayer","views/map/Finder","views/report/ReportOptionsController","utils/DijitFactory","modules/EventsController","esri/request","esri/tasks/query","esri/tasks/QueryTask","esri/tasks/RelationshipQuery","esri/tasks/PrintTask","esri/tasks/PrintParameters","esri/tasks/PrintTemplate","views/map/DigitalGlobeTiledLayer","views/map/DigitalGlobeServiceLayer","views/map/BurnScarTiledLayer","views/map/Uploader","views/map/DrawTool","modules/HashController","esri/layers/GraphicsLayer","esri/layers/ImageServiceParameters","dijit/Dialog","utils/Helper","dojo/aspect","utils/Analytics"],function(e,t,a,r,i,o,n,s,l,d,c,p,u,m,y,g,h,f,b,v,w,L,I,D,k,S,C,A,x,T,O,E,F,_,N,P,R,H,M,j,Y,G,B,W,U,V,z,J,Q,q,Z,K,X,et,tt,at,rt,it,ot,nt,st,lt,dt,ct,pt,ut,mt,yt,gt,ht,ft,bt){var vt={},wt=!1,Lt={viewId:"mapView",viewName:"map"},It=[],Dt=new H(H.STYLE_SOLID,new M(M.STYLE_SOLID,new B("yellow"),5),new B([255,255,0,0]));return vt.mapExtentPausable,vt.init=function(){var e=this;return wt?(vt.map.resize(),X.switchToView(Lt),vt.fromStories(),vt.checkBubble(),bt.sendPageview("/"+window.location.href.split("#")[1],"map"),void 0):(wt=!0,require(["dojo/text!views/map/map.html","dojo/ready"],function(a,r){t.byId(Lt.viewId).innerHTML=a,X.switchToView(Lt),r(function(){V.applyBindings("map-view"),addthis.init(),e.addConfigurations(),$("#footerView").hide(),e.createMap(),setTimeout(function(){e.checkBubble(),e.fromStories(),ht.showLoader("clusterCircle","cluster-blocker")},1e3)})}),bt.sendPageview("/"+window.location.href.split("#")[1],"map"),void 0)},vt.centerChange=function(){if(vt.map){var t=T.webMercatorToGeographic(vt.map.extent),a=i.round(t.getCenter().x,2),r=i.round(t.getCenter().y,2),o=vt.map.getLevel(),n=ut.newState,s=parseFloat(n.x)!=a||parseFloat(n.y)!=r||parseInt(n.l)!=o;if(s){vt.mapExtentPausable.pause(),e.once(vt.map,"extent-change",function(){vt.mapExtentPausable.resume()});var l=T.geographicToWebMercator(new h(parseFloat(n.x),parseFloat(n.y)));vt.map.centerAndZoom(l,parseInt(n.l))}}},vt.addConfigurations=function(){var e=U.proxies,t=document.location.href,a="/proxy/proxy.php";for(var r in e)0===t.indexOf(r)&&(a=e[r],y.defaults.io.proxyUrl=e[r]);P.addProxyRule({urlPrefix:"https://services.digitalglobe.com/",proxyUrl:a}),y.defaults.io.corsEnabledServers.push(U.windData.domain)},vt.createMap=function(){var t=this;K.buildDijits(U.reportOptionsDijits),K.buildDijits(U.accordionDijits);var a=ut.newState.x,r=ut.newState.y,o=ut.newState.l,n=U.basemapReverseLookup[ut.newState.b];vt.map=new m("map",{center:[a,r],zoom:o||U.mapOptions.initalZoom,basemap:n||U.mapOptions.basemap,minZoom:U.mapOptions.minZoom,maxZoom:U.mapOptions.maxZoom,sliderPosition:U.mapOptions.sliderPosition,force3DTransforms:!0,navigationMode:"css-transforms"}),window.map=vt.map,vt.map.on("load",function(){$("#firesDateTo").datepicker("option","minDate","+0m -7d"),$("#noaaDateFrom").datepicker("setDate","10/22/2014"),$("#indoDateFrom").datepicker("setDate","1/1/2013"),vt.map.graphics.clear(),V.vm.windPicker(),W.byId("fires-map-accordion").resize(),J.setMap(vt.map),z.setMap(vt.map),q.setMap(vt.map),ct.setMap(vt.map),pt.init(map),t.addWidgets(),t.bindEvents(),t.addLayers(),q.setupInfowindowListeners(),e.once(vt.map,"update-end",function(){vt.map.centerAt(new h(a,r)).then(function(){setTimeout(function(){vt.mapExtentPausable.resume()},1e3)})}),vt.map.resize()}),vt.mapExtentPausable=e.pausable(vt.map,"extent-change",function(e){var t=(e.delta,T.webMercatorToGeographic(e.extent)),a=(e.levelChange,e.lod),r=(e.target,i.round(t.getCenter().x,2)),o=i.round(t.getCenter().y,2);ut.updateHash({x:r,y:o,l:a.level}),"on"==dijit.byId("digital-globe-checkbox").getValue()&&vt.updateImageryList()}),vt.mapExtentPausable.pause()},vt.checkBubble=function(){console.log("checking bubble"),U.digitalGlobe.navigationBool&&(W.byId("digital-globe-checkbox").setValue(!0),W.byId("fires-map-accordion").selectChild(W.byId("imagery-panel")),U.digitalGlobe.navigationBool=!1)},vt.fromStories=function(){console.log("Checking out user stories"),U.storiesBool&&(W.byId("fire-stories-checkbox").setValue(!0),W.byId("fires-map-accordion").selectChild(W.byId("social-media-panel")),U.storiesBool=!1)},vt.updateImageryList=function(){V.vm.digitalGlobeInView.removeAll();var e=vt.map.extent,t=vt.map.getLayer("Digital_Globe_Bounding_Boxes");It=[];for(var a,r=dijit.byId("timeSliderDG").thumbIndexes,i=dijit.byId("timeSliderDG").timeStops,o=moment(i[r[0]]).tz("Asia/Jakarta"),s=moment(i[r[1]]).tz("Asia/Jakarta"),l=0;l<t.graphics.length;l++)e.intersects(t.graphics[l].geometry)&&It.push(t.graphics[l]);n.forEach(It,function(e){var t=moment(e.attributes.AcquisitionDate).tz("Asia/Jakarta");if(t>=o&&s>=t){var t=moment(e.attributes.AcquisitionDate).tz("Asia/Jakarta");e.attributes.AcquisitionDate=t.format("YYYY/MM/DD");var r="<a class='popup-link' data-bucket='"+e.attributes.SensorName+"_id_"+e.attributes.OBJECTID+"'>"+t.format("YYYY/MM/DD")+"</a>",i="<a class='popup-link' data-bucket='"+e.attributes.SensorName+"_id_"+e.attributes.OBJECTID+"'>"+e.attributes.SensorName+"</a>";e.attributes.formattedDatePrefix1=r,e.attributes.formattedDatePrefix2=i,a=ht.getDigitalGlobeUniqueId(e),V.vm.digitalGlobeInView.push({feature:e,selected:a===V.vm.selectedImageryID()})}}),V.vm.digitalGlobeInView.sort(function(e,t){return e.feature.attributes.AcquisitionDate==t.feature.attributes.AcquisitionDate?0:e.feature.attributes.AcquisitionDate>t.feature.attributes.AcquisitionDate?-1:1})},vt.showDigitalGlobe=function(e){var t=V.vm.digitalGlobeInView();V.vm.digitalGlobeInView([]),n.forEach(t,function(t){t.selected=t==e?!0:!1,V.vm.digitalGlobeInView.push(t)});var a=ht.getDigitalGlobeUniqueId(e.feature);V.vm.selectedImageryID(a),vt.map.infoWindow.hide(),z.showDigitalGlobeImagery(e)},vt.imageryZoom=function(e){var t=vt.map.getLayer("Digital_Globe_Bounding_Boxes_Highlight");t.clear(),vt.map.setExtent(e.feature.geometry.getExtent())},vt.handleImageryOver=function(e){var t=new N(e.feature.geometry),a=vt.map.getLayer("Digital_Globe_Bounding_Boxes_Highlight");a.add(t)},vt.handleImageryOut=function(){var e=vt.map.getLayer("Digital_Globe_Bounding_Boxes_Highlight");e.clear()},vt.removeLoaderFromClusters=function(){$("#clusterCircle").addClass("hoverSmart"),ht.hideLoader("cluster-blocker")},vt.blockClusters=function(){$("#clusterCircle").removeClass("hoverSmart"),$("#clusterCircle").css("pointer-events","none"),ht.createBlocker("clusterCircle","cluster-denier")},vt.getClassJenks=function(e,t){for(var a=t.sort(function(e,t){return e-t}),r=[],i=0,o=a.length+1;o>i;i++){for(var n=[],s=0,l=e+1;l>s;s++)n.push(0);r.push(n)}for(var d=[],c=0,p=a.length+1;p>c;c++){for(var u=[],m=0,y=e+1;y>m;m++)u.push(0);d.push(u)}for(var g=1,h=e+1;h>g;g++){r[0][g]=1,d[0][g]=0;for(var f=1,b=a.length+1;b>f;f++)d[f][g]=1/0;var v=0}for(var w=2,L=a.length+1;L>w;w++){for(var I=0,D=0,k=0,S=1,C=w+1;C>S;S++){var A=w-S+1,x=parseFloat(a[A-1]);D+=x*x,I+=x,k+=1,v=D-I*I/k;var T=A-1;if(0!=T)for(var O=2,E=e+1;E>O;O++)d[w][O]>=v+d[T][O-1]&&(r[w][O]=A,d[w][O]=v+d[T][O-1])}r[w][1]=1,d[w][1]=v}var F=a.length,_=[];for(c=0;e>=c;c++)_.push(0);_[e]=parseFloat(a[a.length-1]),_[0]=parseFloat(a[0]);for(var N=e;N>=2;){var P=parseInt(r[F][N]-2);_[N-1]=a[P],F=parseInt(r[F][N]-1),N-=1}return _[0]==_[1]&&(_[0]=0),_},vt.setSmartRenderer=function(e){switch(e){case"Heat map":var t,a;a=vt.map.getLayer("newFires"),a.show(),t=vt.map.getLayer("firesClusters"),t.hide();break;case"Proportional symbols":t=vt.map.getLayer("firesClusters"),t.show();var a,t;a=vt.map.getLayer("newFires"),a.hide()}},vt.resizeMapPanel=function(e){1==e?($("#control-panel").css("width","2px"),$(".map-container").css("left","2px"),$("#leftPaneToggle").html("+"),$("#latLongHUD").css("left","100px"),$("div.scalebar_bottom-left.esriScalebar").css("left","119px"),$("#map").css("left","2px"),$("#control-panel").css("background-color","#ecc53d"),vt.map.resize(),V.vm.toggleMapPane(!1)):($("#control-panel").css("width","320px"),$(".map-container").css("left","320px"),$("#leftPaneToggle").html("-"),$("#map").css("left","320px"),$("#latLongHUD").css("left","0px"),$("div.scalebar_bottom-left.esriScalebar").css("left","19px"),$("#control-panel").css("background-color","transparent"),vt.map.resize(),V.vm.toggleMapPane(!0)),$("#leftPaneToggle").hide(),$("#latLongHUD").hide(),$("div.scalebar_bottom-left.esriScalebar").hide(),$("#control-panel > div.report-link-container").hide(),setTimeout(function(){$("#latLongHUD").show(),$("#leftPaneToggle").show(),$("div.scalebar_bottom-left.esriScalebar").show(),$("#control-panel > div.report-link-container").show()},1e3)},vt.removeAnalysisFromHash=function(){z.updateLayersInHash("remove","Get_Fires_Analysis")},vt.addWidgets=function(){var i,o,n,s,l,d,c=[];i=new D({map:vt.map,scalebarUnit:"metric"}),r.create("div",{id:"home-button","class":"home-button"},document.querySelector(".esriSimpleSliderIncrementButton"),"after"),l=new g({map:vt.map},"home-button"),l.startup();var p=new b({layers:[new v({url:"https://api.tiles.mapbox.com/v4/wri.c974eefc/${level}/${col}/${row}.png?access_token=pk.eyJ1Ijoid3JpIiwiYSI6IjU3NWNiNGI4Njc4ODk4MmIyODFkYmJmM2NhNDgxMWJjIn0.v1tciCeBElMdpnrikGDrPg",type:"WebTiledLayer"}),new v({url:"https://api.tiles.mapbox.com/v4/wri.acf5a04e/${level}/${col}/${row}.png?access_token=pk.eyJ1Ijoid3JpIiwiYSI6IjU3NWNiNGI4Njc4ODk4MmIyODFkYmJmM2NhNDgxMWJjIn0.v1tciCeBElMdpnrikGDrPg",type:"WebTiledLayer"})],id:"newBM",title:"WRI",thumbnailUrl:"app/images/devSeed.png"});c.push(p),d=new f({map:vt.map,basemaps:c,showArcGISBasemaps:!0},"basemap-gallery"),d.startup(),n=new w({map:vt.map,highlightLocation:!1},"location-widget"),n.startup(),o=new L({map:vt.map},"esri-geocoder-widget"),o.startup(),s=new I({map:vt.map,layerInfos:[],autoUpdate:!0},"legend"),s.startup();var u=function(e){e.preventDefault();require(["dijit/Dialog","dojo/on","dojo/_base/lang"],function(e){var t="<p>"+U.text.firesConfidenceDialog.text+"</p>",a=new e({title:U.text.firesConfidenceDialog.title.toUpperCase(),style:"height: 310px; width: 415px;",id:"highConfidenceDialog",draggable:!1,hide:function(){a.destroy()}});a.setContent(t),a.show(),$("body").on("click",function(e){e.target.classList.contains("dijitDialogUnderlay")&&(a.hide(),$("body").off("click"))})})},m=function(){V.get("showBasemapGallery")&&V.set("showBasemapGallery",!1),V.get("showShareContainer")&&V.set("showShareContainer",!1),V.get("showAlertContainer")&&V.set("showAlertContainer",!1),V.set("showLocatorWidgets",!V.get("showLocatorWidgets"))},y=function(){V.get("showLocatorWidgets")&&V.set("showLocatorWidgets",!1),V.get("showShareContainer")&&V.set("showShareContainer",!1),V.get("showAlertContainer")&&V.set("showAlertContainer",!1),V.set("showBasemapGallery",!V.get("showBasemapGallery"))},h=function(){V.get("showLocatorWidgets")&&V.set("showLocatorWidgets",!1),V.get("showBasemapGallery")&&V.set("showBasemapGallery",!1),V.set("showShareContainer",!V.get("showShareContainer"))},k=function(){V.get("showLocatorWidgets")&&V.set("showLocatorWidgets",!1),V.get("showBasemapGallery")&&V.set("showBasemapGallery",!1),V.get("showShareContainer")&&V.set("showShareContainer",!1),V.set("showAlertContainer",!V.get("showAlertContainer"))},S=function(){V.set("showDrawTools",!1),$("#drawFeatures").css("background-color","#444"),V.set("showUploadTools",!V.get("showUploadTools")),V.get("showUploadTools")?$("#uploadFeatures").css("background-color","#e7002f"):$("#uploadFeatures").css("background-color","#444"),pt.isActive()&&pt.deactivateToolbar()},C=function(){V.set("showUploadTools",!1),$("#uploadFeatures").css("background-color","#444"),V.set("showDrawTools",!V.get("showDrawTools")),V.get("showDrawTools")?$("#drawFeatures").css("background-color","#e7002f"):$("#drawFeatures").css("background-color","#444")},A=function(){ut.updateHash({b:d.getSelected().title})};a(".high-confidence-info").forEach(function(e){$(e).on("click",u)}),e(t.byId("locator-widget-button"),"click",m),e(t.byId("basemap-gallery-button"),"click",y),e(t.byId("share-button"),"click",h),e(t.byId("alert-button"),"click",k),e(t.byId("uploadFeatures"),"click",S),e(t.byId("drawFeatures"),"click",C),e(t.byId("uploadForm"),"change",ct.beginUpload.bind(ct)),d.on("selection-change",A),this.initTransparency()},vt.initTransparency=function(){["forest-transparency-slider","conservation-transparency-slider","land-cover-transparency-slider"].map(function(e){dijit.byId(e).set("value",70)})},vt.bindEvents=function(){var i=this;e(t.byId("dms-search"),"change",function(e){var t=e.target?e.target.checked:e.srcElement.checked;t&&(V.set("showDMSInputs",!0),V.set("showLatLongInputs",!1))}),e(t.byId("lat-long-search"),"change",function(e){var t=e.target?e.target.checked:e.srcElement.checked;t&&(V.set("showLatLongInputs",!0),V.set("showDMSInputs",!1))}),e(vt.map,"mouse-move",function(e){V.set("currentLatitude",e.mapPoint.getLatitude().toFixed(4)),V.set("currentLongitude",e.mapPoint.getLongitude().toFixed(4))}),e(vt.map,"click",function(e){q.identifyInfoWindows(e)}),e(vt.map.graphics,"click",function(e){console.log(e),e.graphic&&q.selectUploadOrDrawnGraphics(e)}),e(W.byId("confidence-fires-checkbox"),"change",function(e){z.updateFiresLayer(!0);var t=z.updateOtherFiresLayers();t&&vt.setSmartRenderer(V.vm.smartRendererName()),e&&i.reportAnalyticsHelper("layer","option","The user toggled the Active Fires only show high confidence fires option on.")}),e(W.byId("twitter-conversations-checkbox"),"change",function(){var e=W.byId("twitter-conversations-checkbox").checked;z.toggleLayerVisibility(U.tweetLayer.id,e),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Twitter Conversations layer on.")}),e(W.byId("fire-stories-checkbox"),"change",function(){var e=W.byId("fire-stories-checkbox").checked;z.toggleLayerVisibility(U.fireStories.id,e),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Fire Stories layer on.")}),e(W.byId("fires-checkbox"),"change",function(){var e=W.byId("fires-checkbox").checked;if(z.toggleLayerVisibility(U.firesLayer.id,e),V.vm.showActiveFiresButtons(e),e)i.reportAnalyticsHelper("layer","toggle","The user toggled the Active Fires layer on.");else{V.vm.smartRendererName("Choose one");var t=vt.map.getLayer("firesClusters");t.hide();var a=vt.map.getLayer("newFires");a.hide(),$("#heatCircle").css("box-shadow","0 0 0 3px #ddd"),$("#clusterCircle").css("box-shadow","0 0 0 3px #ddd"),$("#hexCircle").css("box-shadow","0 0 0 3px #ddd")}}),e(W.byId("air-quality-checkbox"),"change",function(e){return z.toggleLayerVisibility(U.airQualityLayer.id,e),e?($("#airDate").datepicker("setDate","+0m +0d"),vt.map.getLayer(U.airQualityLayer.id).setVisibleLayers([0]),i.reportAnalyticsHelper("layer","toggle","The user toggled the Air Quality layer on."),V.vm.showReportOptionsAIR(!0),void 0):(V.vm.showReportOptionsAIR(!1),void 0)}),e(W.byId("tomnod-checkbox"),"change",function(e){z.toggleLayerVisibility(U.tomnodLayer.id,e),z.toggleLayerVisibility(U.tomnodLayer.sel_id,e),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Tomnod layer on.")}),e(W.byId("indonesia-fires"),"change",function(e){console.log(e),z.toggleMapServiceLayerVisibility(vt.map.getLayer(U.indonesiaLayers.id),U.indonesiaLayers.layerIds.indonesiaFires,e)}),e(W.byId("noaa-fires-18"),"change",function(e){z.toggleMapServiceLayerVisibility(vt.map.getLayer(U.indonesiaLayers.id),U.indonesiaLayers.layerIds.noaa18,e)}),e(W.byId("landsat-image-checkbox"),"change",function(){var e=W.byId("landsat-image-checkbox").checked;z.toggleLayerVisibility(U.landsat8.id,e),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Latest Landsat 8 Imagery layer on.")}),W.byId("windy-layer-checkbox").on("change",function(e){J.toggleWindLayer(e),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Wind direction layer on.")}),W.byId("digital-globe-checkbox").on("change",function(e){z.toggleDigitalGlobeLayer(e),V.vm.showReportOptionsDigitalGlobe(e),e&&(setTimeout(function(){dijit.byId("digital-globe-footprints-checkbox").set("value","true",!1)},0),i.reportAnalyticsHelper("layer","toggle","The user toggled the Digital Globe - First Look layer on."))}),W.byId("digital-globe-footprints-checkbox").on("change",function(e){z.toggleDigitalGlobeLayer(e,"footprints"),vt.updateImageryList()}),W.byId("provinces-checkbox").on("change",function(e){z.adjustOverlaysLayer(),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Provinces overlay layer on.")}),W.byId("districts-checkbox").on("change",function(e){z.adjustOverlaysLayer(),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Districts overlay layer on.")}),W.byId("subdistricts-checkbox").on("change",function(e){z.adjustOverlaysLayer(),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Subdistricts overlay layer on.")}),W.byId("villages-checkbox").on("change",function(e){z.adjustOverlaysLayer(),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Villages overlay layer on.")}),e(t.byId("search-option-go-button"),"click",function(){q.searchAreaByCoordinates(),i.reportAnalyticsHelper("widget","search","The user searched for location by latitude/longitude or Degrees/Minutes/Seconds.")}),e(t.byId("print-button"),"click",function(){i.printMap(),i.reportAnalyticsHelper("widget","print","The user clicked the print widget to print the map.")}),e(t.byId("report-link"),"click",function(){V.vm.showReportOptions(!0),V.vm.reportAOIs().length<1&&Z.populate_select(),i.reportAnalyticsHelper("widget","report","The user clicked Get Fires Analysis to generate an report with the latest analysis."),console.log("In hash");var e=ut.getHash();-1===e.lyrs.indexOf("Get_Fires_Analysis")&&(console.log("Changing hash"),z.updateLayersInHash("add","lyrs","Get_Fires_Analysis"))}),e(W.byId("fire-risk-checkbox"),"change",function(e){z.toggleLayerVisibility(U.fireRiskLayer.id,e),e?(V.vm.showReportOptionsRisk(!0),i.reportAnalyticsHelper("layer","toggle","The user toggled the Fire Risk layer on.")):V.vm.showReportOptionsRisk(!1)}),e(t.byId("noaa-fires-18"),"click",function(){if("false"==this.getAttribute("aria-checked")){var e=t.byId("indonesia-fires");return"false"==e.getAttribute("aria-checked")&&(vt.map.getLayer("IndonesiaFires").visible=!1,console.log("Should disable pop-ups")),V.vm.showReportOptionsNOAA(!1),void 0}V.vm.showReportOptionsNOAA(!0),Z.populate_select()}),e(t.byId("indonesia-fires"),"click",function(){if("false"==this.getAttribute("aria-checked")){var e=t.byId("noaa-fires-18");return"false"==e.getAttribute("aria-checked")&&(vt.map.getLayer("IndonesiaFires").visible=!1,console.log("Should disable pop-ups")),V.vm.showReportOptionsINDO(!1),void 0}V.vm.showReportOptionsINDO(!0),Z.populate_select()}),e(t.byId("windy-layer-checkbox"),"click",function(){return"false"==this.getAttribute("aria-checked")?(V.vm.showReportOptionsWIND(!1),void 0):(V.vm.showReportOptionsWIND(!0),Z.populate_select(),void 0)}),e(t.byId("updateNOAA"),"click",function(){var e=V.vm.noaaObservFrom(),t=V.vm.noaaObservTo(),a=$("#noaaDateFrom").datepicker("getDate"),r=$("#noaaDateTo").datepicker("getDate");t=moment(r).add(1,"day"),e=moment(a).tz("Asia/Jakarta").format("M/D/YYYY"),t=moment(t._d).tz("Asia/Jakarta").format("M/D/YYYY");var i=e.replace(/\//g,"-"),o=t.replace(/\//g,"-"),n=z.getTimeDefinition("Date",i,o);z.updateDynamicMapServiceLayerDefinition(vt.map.getLayer(U.indonesiaLayers.id),U.indonesiaLayers.layerIds.noaa18,n)}),e(t.byId("updateRisk"),"click",function(){i.setFireRiskDefinition()}),e(t.byId("updateINDO"),"click",function(){var e=V.vm.indoObservFrom(),t=V.vm.indoObservTo(),a=$("#indoDateFrom").datepicker("getDate"),r=$("#indoDateTo").datepicker("getDate");t=moment(r).add(1,"day"),e=moment(a).tz("Asia/Jakarta").format("M/D/YYYY"),t=moment(t._d).tz("Asia/Jakarta").format("M/D/YYYY");var i=e.replace(/\//g,"-"),o=(t.replace(/\//g,"-"),z.getTimeDefinition("ACQ_DATE",i,t));W.byId("confidence-archive-checkbox").checked&&(o=[o,U.firesLayer.highConfidence].join(" AND ")),z.updateDynamicMapServiceLayerDefinition(vt.map.getLayer(U.indonesiaLayers.id),U.indonesiaLayers.layerIds.indonesiaFires,o)}),e(W.byId("confidence-archive-checkbox"),"change",function(e){console.log("confidence",e);var t=e?U.firesLayer.highConfidence:"",a=vt.map.getLayer(U.indonesiaLayers.id),r=U.indonesiaLayers.layerIds.indonesiaFires,i=a.layerDefinitions,o=i[r];if(e)var n=void 0!=o?[o,t].join(" AND "):t;else var n=o.replace(" AND "+U.firesLayer.highConfidence,t).replace(U.firesLayer.highConfidence,t);z.updateDynamicMapServiceLayerDefinition(vt.map.getLayer(U.indonesiaLayers.id),U.indonesiaLayers.layerIds.indonesiaFires,n)}),a(".smartRelative").forEach(function(t){e(t,"click",function(){var e=vt.map.getLayer("Active_Fires");if($("#heatCircle").css("box-shadow","0 0 0 3px #ddd"),$("#clusterCircle").css("box-shadow","0 0 0 3px #ddd"),$("#hexCircle").css("box-shadow","0 0 0 3px #ddd"),"hexCircle"==this.id&&"Hex bin"==V.vm.smartRendererName()||"clusterCircle"==this.id&&"Proportional symbols"==V.vm.smartRendererName()||"heatCircle"==this.id&&"Heat map"==V.vm.smartRendererName()){var t=vt.map.getLayer("newFires");t.hide();var a=vt.map.getLayer("firesClusters");return a.hide(),e.show(),V.vm.smartRendererName("Choose one"),void 0}if("heatCircle"==this.id)vt.setSmartRenderer("Heat map"),V.vm.smartRendererName("Heat map");else if("clusterCircle"==this.id)vt.setSmartRenderer("Proportional symbols"),V.vm.smartRendererName("Proportional symbols");else{if("hexCircle"!=this.id)return;vt.setSmartRenderer("Hex bin"),V.vm.smartRendererName("Hex bin")}$(this).css("box-shadow","0 0 0 3px #e98300"),e.hide()})}),e(t.byId("updateWIND"),"click",function(){var e=(V.vm.windObserv(),$("#windDate").datepicker("getDate")),t=moment(e).tz("Asia/Jakarta").format("MM/DD/YYYY"),a=V.vm.timeOfDay(),r=t.split("/"),i=r[2].toString()+r[0].toString()+r[1].toString();console.log(i);var o="http://suitability-mapper.s3.amazonaws.com/wind/archive/wind-surface-level-gfs-"+i+a+".1-0.gz.json";J.deactivateWindLayer(),J.activateWindLayer(o)}),e(t.byId("updateAIR"),"click",function(){var e=$("#airDate").datepicker("getDate"),t=new Date;if(t.setHours(0,0,0,0),e.getTime()==t.getTime()){var a=vt.map.getLayer(U.airQualityLayer.id);return a.setVisibleLayers([0]),void 0}var r=moment(e).format("MM/DD/YYYY"),i=r.split("/");i[0]=parseInt(i[0]),i[1]=parseInt(i[1]),r=i.join("/");var o="Date LIKE '"+r+"%'";z.updateDynamicMapServiceLayerDefinition(vt.map.getLayer(U.airQualityLayer.id),1,o)}),e(t.byId("embedShare"),"click",function(){i.showEmbedCode()}),e(t.byId("clear-search-pins"),"click",this.clearSearchPins),e(t.byId("legend-widget-title"),"click",this.toggleLegend),W.byId("forest-transparency-slider").on("change",function(e){z.setTransparency(U.forestUseLayers.id,e)}),W.byId("forest-transparency-slider").on("change",function(e){z.setTransparency(U.landUseLayers.id,e)}),W.byId("land-cover-transparency-slider").on("change",function(e){z.setTransparency(U.landCoverLayers.id,e)}),W.byId("conservation-transparency-slider").on("change",function(e){z.setTransparency(U.conservationLayers.id,e)}),a(".active-fires-options").forEach(function(t){e(t,"click",i.toggleFireOption.bind(i))}),a(".esriPopupWrapper").forEach(function(a){r.create("div",{id:"close-icon","class":"close-icon"},a),e(t.byId("close-icon"),"click",function(){vt.map.infoWindow.hide(),$("#uploadCustomGraphic").length>0&&$("#uploadCustomGraphic").remove()})}),e(vt.map.infoWindow,"hide",function(){vt.map.infoWindow.clearFeatures()}),a("#forest-use-panel div.checkbox-container div input").forEach(function(e){"rspo-oil-palm-checkbox"==e.id||"indicative-moratorium-checkbox"==e.id?o.add(e,"forest-use-layers-option"):o.add(e,"land-use-layers-option")}),a("#conservation-panel div.checkbox-container div input").forEach(function(e){o.add(e,"conservation-layers-option")}),a("#land-cover-panel div.checkbox-container div input").forEach(function(e){"land-cover-radios"===e.name&&o.add(e,"land-cover-layers-option")}),a("#forest-use-panel div.checkbox-container div input").forEach(function(t){e(t,"change",function(e){var t=e.target?e.target:e.srcElement;t.classList.contains("forest-use-layers-option")?(console.log("frest"),z.updateAdditionalVisibleLayers("forest-use-layers-option",U.forestUseLayers)):t.classList.contains("land-use-layers-option")&&(console.log("land"),z.updateAdditionalVisibleLayers("land-use-layers-option",U.landUseLayers))})}),a(".conservation-layers-option").forEach(function(t){e(t,"change",function(e){z.updateAdditionalVisibleLayers("conservation-layers-option",U.conservationLayers);var t=e.target?e.target:e.srcElement;t.checked})}),a(".land-cover-layers-option").forEach(function(t){e(t,"change",function(e){z.updateLandCoverLayers(e);var t=e.target?e.target:e.srcElement;if(t.checked){var r=a("#land-cover-panel .dijitChecked")[0].parentNode.children[1];if(r.innerHTML.length>0){var o=r.innerHTML;-1===o.search("None")&&i.reportAnalyticsHelper("layer","toggle","The user toggled the "+o+" layer on")}}})}),a("#primary-forests-options input").forEach(function(t){e(t,"change",function(e){z.updatePrimaryForestsLayer(!0);var t=e.target?e.target:e.srcElement;if(t.checked&&t.labels.length>0){var a=t.labels[0].innerHTML;-1===a.search("Primary")&&(a="Primary Forests "+a),i.reportAnalyticsHelper("layer","toggle","The user toggled the "+a+" layer on")}})})},vt.addLayers=function(){var t,a,r,i,o,s,l,d,c,p,u,m,y,g,h,f,b,v,w,L,I,D=this;t=new A,t.format="png32",t.layerIds=U.conservationLayers.defaultLayers,t.layerOption=A.LAYER_OPTION_SHOW,a=new k(U.conservationLayers.url,{imageParameters:t,id:U.conservationLayers.id,visible:!1}),indonesiaParams=new A,indonesiaParams.format="png32",indonesiaParams.layerIds=U.indonesiaLayers.defaultLayers,indonesiaParams.layerOption=A.LAYER_OPTION_SHOW,indonesiaLayer=new k(U.indonesiaLayers.url,{imageParameters:indonesiaParams,id:U.indonesiaLayers.id,visible:!1}),s=new A,s.format="png32",s.layerIds=U.landCoverLayers.defaultLayers,s.layerOption=A.LAYER_OPTION_SHOW,l=new k(U.landCoverLayers.url,{imageParameters:s,id:U.landCoverLayers.id,visible:!1}),c=new A,c.format="png32",c.layerIds=U.forestUseLayers.defaultLayers,c.layerOption=A.LAYER_OPTION_SHOW,p=new k(U.forestUseLayers.url,{imageParameters:c,id:U.forestUseLayers.id,visible:!1}),u=new A,u.format="png32",u.layerIds=U.landUseLayers.defaultLayers,u.layerOption=A.LAYER_OPTION_SHOW,m=new k(U.landUseLayers.url,{imageParameters:u,id:U.landUseLayers.id,visible:!1}),y=new S(U.treeCoverLayer.url,{id:U.treeCoverLayer.id,visible:!1}),g=new S(U.fireRiskLayer.url,{id:U.fireRiskLayer.id,visible:!1}),r=new A,r.format="png32",r.layerIds=U.primaryForestsLayer.defaultLayers,r.layerOption=A.LAYER_OPTION_SHOW,i=new k(U.primaryForestsLayer.url,{imageParameters:r,id:U.primaryForestsLayer.id,visible:!1}),v=new S(U.landsat8.url,{id:U.landsat8.id,visible:!1}),I=U.digitalGlobe,o=I.imageServices.map(function(e){return new S(e.url,{id:e.id,visible:!1})}),dglyrs=o,h=new k(U.overlaysLayer.url,{id:U.overlaysLayer.id,visible:!1}),d=new k(U.airQualityLayer.url,{id:U.airQualityLayer.id,visible:!1}),tomnodParams=new A,tomnodParams.layerIds=U.tomnodLayer.defaultLayers,tomnodParams.layerOption=A.LAYER_OPTION_SHOW,b=new k(U.tomnodLayer.url,{imageParameters:tomnodParams,id:U.tomnodLayer.id,visible:!1});var C=new F("${name}",q.getTomnodInfoWindow),T=new x(U.tomnodLayer.url+"/"+U.tomnodLayer.defaultLayers[0],{mode:x.MODE_SELECTION,infoTemplate:C,outFields:["*"],id:U.tomnodLayer.sel_id}),O=new x(U.firesLayer.smartURL,{mode:x.MODE_ONDEMAND,id:"newFires",visible:!1,outFields:"*"}),E=new R("circle",9,new M(M.STYLE_SOLID,new B([255,255,255,1]),1),new B([254,182,62,1])),N=(new R("circle",16,new M(M.STYLE_SOLID,new B([102,0,0,.85]),3),new B([255,255,255,1])),new Q({url:U.firesLayer.smartURL,distance:95,id:"firesClusters",labelColor:"#fff",resolution:vt.map.extent.getWidth()/vt.map.width,singleSymbol:E,useDefaultSymbol:!1,zoomOnClick:!0,showSingles:!0,visible:!1,objectIdField:"FID",outFields:["ACQ_DATE","CONFIDENCE","BRIGHTNESS"]}));N.on("clusters-shown",function(){var e=new Date;if(!map.clusterDataOnce&&this._clusterData.length>0){var e=new Date,t=e.setDate(e.getDate()-3),a=e.setDate(e.getDate()-2),r=e.setDate(e.getDate()-1);map.clusterData={},map.clusterData.fullData=this._clusterData,map.clusterData.past72=this._clusterData.filter(function(e){return e.attributes.ACQ_DATE<t}),map.clusterData.past48=this._clusterData.filter(function(e){return e.attributes.ACQ_DATE<a}),map.clusterData.past24=this._clusterData.filter(function(e){return e.attributes.ACQ_DATE<r}),map.clusterData.highConfidence=this._clusterData.filter(function(e){return e.attributes.CONFIDENCE>=30&&e.attributes.BRIGHTNESS>=330}),map.clusterData.highConfidencepast72=this._clusterData.filter(function(e){return e.attributes.ACQ_DATE<t&&e.attributes.CONFIDENCE>=30&&e.attributes.BRIGHTNESS>=330}),map.clusterData.highConfidencepast48=this._clusterData.filter(function(e){return e.attributes.ACQ_DATE<a&&e.attributes.CONFIDENCE>=30&&e.attributes.BRIGHTNESS>=330}),map.clusterData.highConfidencepast24=this._clusterData.filter(function(e){return e.attributes.ACQ_DATE<r&&e.attributes.CONFIDENCE>=30&&e.attributes.BRIGHTNESS>=330}),map.clusterDataOnce=!0}});var P=new Y(E,"clusterCount"),H=new R("circle",10,new M(M.STYLE_SOLID,new B([212,116,60,.5]),15),new B([212,116,60,.75])),$=new R("circle",25,new M(M.STYLE_SOLID,new B([178,70,37,.5]),15),new B([178,70,37,.75])),V=new R("circle",35,new M(M.STYLE_SOLID,new B([144,24,13,.5]),15),new B([144,24,13,.75])),J=new R("circle",55,new M(M.STYLE_SOLID,new B([102,0,0,.5]),15),new B([102,0,0,.75]));P.addBreak(2,50,H),P.addBreak(50,250,$),P.addBreak(250,1e3,V),P.addBreak(1e3,5e4,J),N.setRenderer(P),f=new dt(U.burnScarLayer.url,U.burnScarLayer.id),w=new A,w.format="png32",w.layerIds=U.firesLayer.defaultLayers,w.layerOption=A.LAYER_OPTION_SHOW,L=new k(U.firesLayer.url,{imageParameters:w,id:U.firesLayer.id,visible:!1}),tweetLayer=new x(U.tweetLayer.url,{mode:x.MODE_ONDEMAND,id:U.tweetLayer.id,visible:!1,outFields:["*"]});new _({title:"{Title}",fieldInfos:[{fieldName:"Date",label:"Date",format:{dateFormat:"shortDate"},visible:!0},{fieldName:"Details",label:"Details",visible:!0},{fieldName:"Video",label:"Video",visible:!0},{fieldName:"Name",label:"Name",visible:!0}],showAttachments:!0});fireStories=new x(U.fireStories.url,{mode:x.MODE_ONDEMAND,id:U.fireStories.id,visible:!1,outFields:["*"],hasAttachments:!0,definitionExpression:"Publish = 'Y'"});var Z={layerDefinition:{geometryType:"esriGeometryPolygon",fields:[]},featureSet:null},K=new x(Z,{id:U.digitalGlobe.graphicsLayerId,visible:!1}),X=new mt(Z,{id:U.digitalGlobe.graphicsLayerHighlight,visible:!0}),et=new j(Dt);X.setRenderer(et),G.createHeatmapRenderer({layer:O,blurRadius:5,basemap:vt.map.getBasemap()}).then(function(e){var t=vt.map.getLayer("newFires");t.setRenderer(e.renderer)}),dglyr=K;var tt=[y,g,l,i,K,X].concat(o).concat([a,f,b,p,m,h,tweetLayer,fireStories,d,T,O,N,indonesiaLayer,L]);e.once(vt.map,"layers-add-result",function(e){D.setFireRiskDefinition(),D.enableLayersFromHash();
var t=n.map(e.layers,function(e){return{layer:e.layer}});t=n.filter(t,function(e){"firesClusters"===e.layer.id&&(e.title="Heat Map");var t=e.layer.url?e.layer.url.search("ImageServer")<0:!1,a=!(e.layer.id===T.id);return t&&a}),W.byId("legend").refresh(t)}),vt.map.addLayers(tt),vt.map.addLayer(v),h.on("load",z.setOverlayLayerOrder),f.on("error",this.layerAddError),v.on("error",this.layerAddError),y.on("error",this.layerAddError),g.on("error",this.layerAddError),i.on("error",this.layerAddError),a.on("error",this.layerAddError),l.on("error",this.layerAddError),h.on("error",this.layerAddError),p.on("error",this.layerAddError),m.on("error",this.layerAddError),L.on("error",this.layerAddError),N.on("error",this.layerAddError),fireStories.on("error",this.layerAddError),d.on("error",this.layerAddError),v.on("load",function(){vt.map.reorderLayer(v,1)})},vt.removeCustomFeatures=function(){vt.map.graphics.clear(),V.vm.customFeaturesArray([]),V.vm.customFeaturesPresence(!1)},vt.toggleFireOption=function(e){var r=e.target?e.target:e.srcElement;a(".selected-fire-option").forEach(function(e){o.remove(e,"selected-fire-option")}),o.add(r,"selected-fire-option"),z.updateFiresLayer();var i=z.updateOtherFiresLayers();i&&vt.setSmartRenderer(V.vm.smartRendererName()),V.vm.currentFireTime(r.id),q.updateFirePopSelection(t.byId(r.id+"-pop"))},vt.setFireRiskDefinition=function(){function e(e){var t=e.split("/");return new Date(t[2],t[0]-1,t[1])}function t(e,t){return Math.round((t-e)/864e5)+1}function a(e){return 0!=(3&e)?!1:e%100!=0||e%400==0}var r=V.vm.fireRiskObserv(),i=$("#fireRiskDate").datepicker("getDate");r=moment(i).tz("Asia/Jakarta").format("M/D/YYYY");var o=i.getFullYear(),n=new Date(o+" 01 01"),s=moment(n).tz("Asia/Jakarta").format("M/D/YYYY"),l=t(e(s),e(r)),d=i.getMonth();d>1&&a(o)&&l++,l=1===l.toString().length?"00"+l.toString():2===l.toString().length?"0"+l.toString():l.toString(),console.log(l);var c=o.toString()+l+"_IDN_FireRisk";console.log("Name = '"+c+"'");var p=vt.map.getLayer(U.fireRiskLayer.id);p.setDefinitionExpression("Name = '"+c+"'")},vt.enableLayersFromHash=function(){function a(){W.byId("fires-checkbox").set("checked",!0),z.updateLayersInHash("add",U.firesLayer.id,U.firesLayer.id)}function r(a,r){if(void 0!==a&&""!==a)if(void 0===r)p[a]&&(o=p[a].id,W.byId(o)&&(W.byId(o).set("checked",!0),e.emit(t.byId(o),"change",{})));else{n=p[a],s=r.split(",");for(var i=0,l=s.length;l>i;i++)if(o=n[s[i]].id,"[object Array]"===Object.prototype.toString.call(o))for(var d=0,c=o.length;c>d;d++)W.byId(o[d])&&(W.byId(o[d]).set("checked",!0),e.emit(t.byId(o[d]),"change",{}));else W.byId(o)&&(W.byId(o).set("checked",!0),e.emit(t.byId(o),"change",{}))}}var i,o,n,s,l=ut.getHash(),d=l.lyrs,c=d.split(":"),p=U.layersCheckboxes;if(void 0===d)return a(),void 0;if(1===c.length&&""===c[0])return a(),void 0;for(var u=0,m=c.length;m>u;u++)i=c[u].split("/"),r(i[0],i[1]);var y=ut.getHash();y.lyrs.indexOf("Get_Fires_Analysis")>-1&&(console.log("Updating from hash"),$("#report-link").click())},vt.clearSearchPins=function(){vt.map.graphics.clear(),V.set("showClearPinsOption",!1)},vt.toggleLegend=function(){var e=t.byId("legend-widget-container"),a=e.offsetHeight-2===280?30:280;s.animateProperty({node:e,properties:{height:a},duration:500}).play(),30===a?o.add("legend-widget-title","legend-closed"):o.remove("legend-widget-title","legend-closed")},vt.printMap=function(){var t=document.getElementsByTagName("body")[0];o.add("print-button","loading"),o.add(t,"map-view-print"),W.byId("stackContainer").resize(),W.byId("mapView").resize(),vt.map.resize(),e.once(vt.map,"resize",function(){setTimeout(function(){window.print(),o.remove("print-button","loading"),o.remove(t,"map-view-print"),vt.map.resize(),setTimeout(function(){W.byId("stackContainer").resize()},1e3)},2e3)})},vt.reportAnalyticsHelper=function(e,t,a){ga("A.send","event",e,t,a),ga("B.send","event",e,t,a),ga("C.send","event",e,t,a)},vt.showEmbedCode=function(){W.byId("embedCodeShareDialog")&&W.byId("embedCodeShareDialog").destroy();var e,a="<iframe src='"+window.location+"' height='600' width='900'></iframe>",r=new gt({title:"Embed Code",style:"width: 350px",id:"embedCodeShareDialog",content:'Copy the code below to embed in your site. (Ctrl+C on PC and Cmd+C on Mac)<div class=\'dijitDialogPaneActionBar\'><input id="embedInput" type="text" value="'+a+'" autofocus /></div>'});e=function(){r.destroy()},r.show(),t.byId("embedInput").select(),r.on("cancel",function(){e()}),bt.sendPageview("/"+window.location.href.split("#")[1],"map")},vt});