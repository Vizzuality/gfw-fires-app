define(["dojo/dom","dojo/_base/array","dojo/on","dojo/query","dojo/Deferred","dojo/promise/all","esri/layers/FeatureLayer","esri/graphic","esri/request","esri/tasks/ImageServiceIdentifyParameters","esri/tasks/ImageServiceIdentifyTask","esri/layers/RasterFunction","esri/InfoTemplate","esri/geometry/Point","esri/geometry/webMercatorUtils","esri/symbols/PictureMarkerSymbol","views/map/MapConfig","views/map/MapModel","views/map/LayerController","esri/tasks/IdentifyTask","esri/tasks/IdentifyParameters","esri/tasks/query","esri/tasks/QueryTask","esri/geometry/Circle"],function(t,e,i,a,r,n,o,s,d,u,c,l,f,m,y,g,p,b,w,v,h,I,L){var D;return{setMap:function(t){D=t,window.PopupDateFormat=function(t){return new Date(t)}},clickNext:"",searchAreaByCoordinates:function(){var i,a,r,n,o={},d=!1,u="You did not enter a valid value.  Please check that your location values are all filled in and nubmers only.",c=new g("app/images/RedStickpin.png",32,32),l={},f=function(t){return d||(d=isNaN(parseInt(t))),isNaN(parseInt(t))?0:parseInt(t)},p=function(){var t=0;return e.forEach(D.graphics.graphics,function(e){e.attributes&&e.attributes.locatorValue&&(t=Math.max(t,parseInt(e.attributes.locatorValue)))}),t};b.get("showDMSInputs")?(o.dlat=f(t.byId("degreesLatInput").value),o.mlat=f(t.byId("minutesLatInput").value),o.slat=f(t.byId("secondsLatInput").value),o.dlon=f(t.byId("degreesLonInput").value),o.mlon=f(t.byId("minutesLonInput").value),o.slon=f(t.byId("secondsLonInput").value),i=o.dlat+o.mlat/60+o.slat/3600,a=o.dlon+o.mlon/60+o.slon/3600):(i=f(t.byId("latitudeInput").value),a=f(t.byId("longitudeInput").value)),d?alert(u):(r=y.geographicToWebMercator(new m(a,i)),l.locatorValue=p(),l.id="LOCATOR_"+l.locatorValue,n=new s(r,c,l),D.graphics.add(n),D.centerAndZoom(r,7),b.set("showClearPinsOption",!0))},fetchTwitterData:function(t){var e=t.target?t.target:t.srcElement;!e.checked},mapClick:function(i){var a=D;if(forestUseLayer=a.getLayer(p.forestUseLayers.id),conservationLayers=a.getLayer(p.conservationLayers.id),visLayers=[],isVisLayers=forestUseLayer.visibleLayers.indexOf(10)>-1||conservationLayers.visibleLayers.indexOf(25)>-1||forestUseLayer.visibleLayers.indexOf(26)>-1||forestUseLayer.visibleLayers.indexOf(27)>-1||forestUseLayer.visibleLayers.indexOf(28)>-1||forestUseLayer.visibleLayers.indexOf(32)>-1,visible=forestUseLayer.visible,e.forEach(forestUseLayer.visibleLayers,function(t){visLayers.push(t)}),e.forEach(conservationLayers.visibleLayers,function(t){visLayers.push(t)}),Array.prototype.move=function(t,e){this.splice(e,0,this.splice(t,1)[0])},visLayers.move(visLayers.indexOf(27),0),isVisLayers){var r=new v(forestUseLayer.url);identifyParams=new h,identifyParams.tolerance=3,identifyParams.returnGeometry=!0,identifyParams.layerIds=visLayers,identifyParams.width=a.width,identifyParams.height=a.height,identifyParams.geometry=i.mapPoint,identifyParams.mapExtent=a.extent,r.execute(identifyParams,function(e){var r=e[0];r&&(content=void 0===t.byId("close-icon")?"<div id='closePopup' class='close-icon'></div><table id='infoWindowTable'>":"<table id='infoWindowTable'>",25==r.layerId?(content+="<tr class='infoName'><td colspan='2'>"+r.feature.attributes.NAME+"</td></tr>",content+="<tr><td>Local Name</td><td>"+r.feature.attributes.ORIG_NAME+"</td></tr>",content+="<tr><td>Legal Designation</td><td>"+r.feature.attributes.DESIG_ENG+"</td></tr>",content+="<tr><td>WDPA ID</td><td>"+r.feature.attributes.WDPAID+"</td></tr>"):27==r.layerId?(content+="<tr class='infoName'><td colspan='2'>"+r.feature.attributes.NAME+"</td></tr>",content+="<tr><td>Concession Type</td><td>"+r.feature.attributes.TYPE+"</td></tr>",content+="<tr><td>Country</td><td>"+r.feature.attributes.Country+"</td></tr>",content+="<tr><td>Certification Status</td><td>"+r.feature.attributes.CERT_STAT+"</td></tr>",content+="<tr><td>GIS Calculated Area (ha)</td><td>"+r.feature.attributes.AREA_HA+"</td></tr>",content+="<tr><td>Certificate ID</td><td>"+r.feature.attributes.Certificat+"</td></tr>",content+="<tr><td>Certificate Issue Date</td><td>"+r.feature.attributes.Issued+"</td></tr>",content+="<tr><td>Certificate Expiry Date</td><td>"+r.feature.attributes.Expired+"</td></tr>",content+="<tr><td>Mill name</td><td>"+r.feature.attributes.Mill+"</td></tr>",content+="<tr><td>Mill location</td><td>"+r.feature.attributes.Location+"</td></tr>",content+="<tr><td>Mill capacity (t/hour)</td><td>"+r.feature.attributes.Capacity+"</td></tr>",content+="<tr><td>Certified CPO (mt)</td><td>"+r.feature.attributes.CPO+"</td></tr>",content+="<tr><td>Certified PK (mt)</td><td>"+r.feature.attributes.PK+"</td></tr>",content+="<tr><td>Estate Suppliers</td><td>"+r.feature.attributes.Estate+"</td></tr>",content+="<tr><td>Estate Area (ha)</td><td>"+r.feature.attributes.Estate_1+"</td></tr>",content+="<tr><td>Outgrower Area (ha)</td><td>"+r.feature.attributes.Outgrowe+"</td></tr>",content+="<tr><td>Scheme Smallholder Area (ha)</td><td>"+r.feature.attributes.SH+"</td></tr>"):(content+="<tr class='infoName'><td colspan='2'>"+r.feature.attributes.NAME+"</td></tr>",content+="<tr><td>Concession Type</td><td>"+r.feature.attributes.TYPE+"</td></tr>",content+="<tr><td>Country</td><td>"+r.feature.attributes.Country+"</td></tr>",content+="<tr><td>Certification Status</td><td>"+r.feature.attributes.CERT_STAT+"</td></tr>",content+="<tr><td>GIS Calculated Area (ha)</td><td>"+r.feature.attributes.AREA_HA+"</td></tr>"),content+="<tr><td>Source: </td><td>"+(r.feature.attributes.Source||"N/A")+"</td></tr>",content+="</table>",a.infoWindow.setContent(content),a.infoWindow.show(i.mapPoint))},function(t){console.dir(t)})}},getTomnodInfoWindow:function(t){var e=p.tomnodLayer,i=(e.url,t),a="";if(i){var r=new Date(i.attributes.ImageAquisitionDate),n=r.getMonth()+1,o=r.getDate(),s=r.getFullYear();return r=n+"/"+o+"/"+s,executeReturned=!1,a+=" <div><h3>"+i.attributes.name+"</h3></div>",a+="<tr><td><img src='"+e.chipBucket+i.attributes.ChipLink,a+="' style='width:300px' /></tc></tr>",a+="<div><strong>Image Acquisition Date:</strong> "+r+"</div>",a+="<div><strong>Confirmation:</strong> "+i.attributes.Confirmation+" people</div>",a+="<div><b>Crowd Rank:</b> "+i.attributes.CrowdRank+"%</div>",a+="<a href='"+i.attributes.ImageLink,a+="' target='_blank'>See this point on ",a+="<img style='height:20px;width:100px;' src='app/images/tomnod_logo.png'></div>"}},selectTomnodFeatures:function(i){var r=p.tomnodLayer,n=(t.byId("landsat-image-checkbox"),this),s=r.url,d=new v(s),u=new h,c=(new L(s),new I),l=i.mapPoint,f=(a(".selected-fire-option")[0],new Date,new Date,[]);if(!D.getLayer(r.id).visible){n.getActiveFiresInfoWindow(i),n.getArchiveFiresInfoWindow(i);var m=t.byId("noaa-fires-18"),y=t.byId("indonesia-fires"),g=t.byId("fires-checkbox");return"true"==m.getAttribute("aria-checked")&&"true"==y.getAttribute("aria-checked")||"true"==m.getAttribute("aria-checked")&&"true"==g.getAttribute("aria-checked")?setTimeout(function(){D.infoWindow.isShowing||n.getArchiveNoaaInfoWindow(i)},800):n.getArchiveNoaaInfoWindow(i),void setTimeout(function(){D.infoWindow.isShowing||n.getDigitalGlobeInfoWindow(i)},400)}u.geometry=l,u.tolerance=3,u.returnGeometry=!1,u.layerDefinitions=f,u.mapExtent=D.extent,u.layerIds=[8],c.where="OBJECTID in (",c.returnGeometry=!1,c.outFields=["OBJECTID","ChipLink","CrowdRank","Confirmation","name","ImageLink"];var b=[];d.execute(u,function(t){return e.forEach(t,function(t){b.push(t.feature.attributes.OBJECTID)}),b.length<1?(D.infoWindow.setFeatures(void 0),n.getActiveFiresInfoWindow(i),n.getDigitalGlobeInfoWindow(i),n.getArchiveFiresInfoWindow(i),void n.getArchiveNoaaInfoWindow(i)):(D.infoWindow.resize(340,500),c.where+=b.join(",")+")",selected_features=D.getLayer(p.tomnodLayer.sel_id).selectFeatures(c,o.SELECTION_NEW),void selected_features.then(function(t){D.infoWindow.setFeatures(t),D.infoWindow.resize(340,500),D.infoWindow.show(i.mapPoint)}))},function(){n.mapClick(i)})},getActiveFiresInfoWindow:function(t){var i=p.firesLayer,r=this,n=i.url,o=new v(n),s=new h,d=t.mapPoint,u=!0,c=a(".selected-fire-option")[0],l=new Date,f=new Date,m="",y="",g=[];if(!D.getLayer(i.id).visible)return void r.mapClick(t);switch(c.id){case"fires72":l.setDate(l.getDate()-4),f.setDate(f.getDate()-3);break;case"fires48":l.setDate(l.getDate()-3),f.setDate(f.getDate()-2);break;case"fires24":l.setDate(l.getDate()-2),f.setDate(f.getDate()-1);break;default:l.setDate(l.getDate()-8),f.setDate(f.getDate()-7)}y=l.getFullYear()+"-"+(l.getMonth()+1)+"-"+l.getDate()+" "+l.getHours()+":"+l.getMinutes()+":"+l.getSeconds(),m=f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate()+" "+f.getHours()+":"+f.getMinutes()+":"+f.getSeconds();for(var b=0,w=p.firesLayer.defaultLayers.length;w>b;b++)g[b]="ACQ_DATE > date '"+y+"'";s.geometry=d,s.tolerance=3,s.returnGeometry=!1,s.layerDefinitions=g,s.mapExtent=D.extent,s.layerOption=h.LAYER_OPTION_VISIBLE;var I="</div><table id='infoWindowTable'>";o.execute(s,function(a){var n=D,o=a[0];o?(u=!1,I+="<tr class='infoName'><td colspan='3'>Active Fires</td><td colspan='2'></td></tr>",e.forEach(i.query.fields,function(t){I+="<tr><td colspan='3'>"+t.label+"</td>",I+="<td colspan='2'>"+o.feature.attributes[t.name]+"</td></tr>"}),I+="</table>",n.infoWindow.setContent(I),n.infoWindow.resize(270,140),n.infoWindow.show(d)):r.mapClick(t)},function(){r.mapClick(t)})},getArchiveFiresInfoWindow:function(i){var a=p.indonesiaLayers,r=this,n=a.url,o=new v(n),s=new h,d=i.mapPoint,u=!0,c=(new Date,new Date,t.byId("indonesia-fires"));if(!D.getLayer(a.id).visible||1!=c.checked)return void r.mapClick(i);s.layerDefinitions=D.getLayer(a.id).layerDefinitions,s.geometry=d,s.tolerance=3,s.returnGeometry=!1,s.mapExtent=D.extent,s.layerOption=h.LAYER_OPTION_ALL,s.layerIds=[0];var l=(D.getLayer(a.id),"</div><table id='infoWindowTable'>");o.execute(s,function(t){var n=D,o=t[0];if(o){if(2==o.layerId)return;u=!1,l+="<tr class='infoName'><strong>NASA archived fires for Indonesia</strong></tr>",e.forEach(a.query.fields,function(t){l+="<tr><td colspan='3'>"+t.label+"</td>",l+="<td colspan='2'>"+o.feature.attributes[t.name]+"</td></tr>"}),l+="</table>",n.infoWindow.setContent(l),n.infoWindow.resize(270,140),n.infoWindow.show(d)}else r.mapClick(i)},function(){r.mapClick(i)})},getLandsatInfoWindow:function(t){var i=p.landsat8,a=new u,r=new c(i.url);a.geometry=t.mapPoint,a.returnCatalogItems=!0,a.f="json",a.returnGeometry=!0,a.renderingRule=new l({rasterFunction:"Stretch",rasterFunctionArguments:{StretchType:6,DRA:!0,Gamma:[1.4,1.4,1.4],UseGamma:!0,MinPercent:.5,MaxPercent:.5},outputPixelType:"U8"}),a.pixelSizeX=100,a.pixelSizeY=100,r.execute(a,function(i){e.forEach(i.catalogItems.features,function(t){t.infoTemplate=new f("Acquisition Date","<tr><td>${AcquisitionDate: PopupDateFormat}</td></td>")}),D.infoWindow.setFeatures(i.catalogItems.features),D.infoWindow.show(t.mapPoint)},function(t){console.dir(t)})},getArchiveNoaaInfoWindow:function(e){var i=p.indonesiaLayers,a=this,r=i.url,n=new v(r),o=new h,s=e.mapPoint,d=!0,u=(new Date,new Date,t.byId("noaa-fires-18"));if("false"!=u.getAttribute("aria-checked")){if(!D.getLayer("IndonesiaFires").visible)return void a.mapClick(e);o.geometry=s,o.tolerance=3,o.returnGeometry=!1,o.mapExtent=D.extent,o.layerOption=h.LAYER_OPTION_ALL,o.layerIds=[9];{D.getLayer(i.id)}n.execute(o,function(t){var i=D,r=t[0];if(r){if(2==r.layerId)return;d=!1;var n=r.feature.attributes.Date,o=n.split(" "),o=o[0],u="</div><table id='infoWindowTable'>";u+="<tr class='infoName'><strong>NOAA-18 fires</strong></tr>",u+="<tr><td colspan='3'>DATE</td>",u+="<td colspan='2'>"+o+"</td></tr>",u+="</table>",i.infoWindow.setContent(u),i.infoWindow.resize(170,50),i.infoWindow.show(s)}else a.mapClick(e)},function(){a.mapClick(e)})}},getNOAAFiresInfoWindow:function(t){{var i=p.indonesiaLayers,a=this,r=i.url,n=new v(r),o=new h,s=t.mapPoint,d=!0;new Date,new Date}if(!D.getLayer(i.id).visible)return void a.mapClick(t);o.geometry=s,o.tolerance=10,o.returnGeometry=!1,o.mapExtent=D.extent,o.layerOption=h.LAYER_OPTION_ALL;var u="</div><table id='infoWindowTable'>";n.execute(o,function(r){var n=D,o=r[0];o?(d=!1,u+="<tr class='infoName'><strong>NASA archived fires for Indonesia</strong></tr>",e.forEach(i.query.fields,function(t){u+="<tr><td colspan='3'>"+t.label+"</td>",u+="<td colspan='2'>"+o.feature.attributes[t.name]+"</td></tr>"}),u+="</table>",n.infoWindow.setContent(u),n.infoWindow.show(s)):(console.log("No result returned!"),a.mapClick(t))},function(){a.mapClick(t)})},getDigitalGlobeInfoWindow:function(o){var s=(p.digitalGlobe,D.getLayer(p.digitalGlobe.graphicsLayerId),new I);if((!o.graphic||"Digital_Globe"===o.graphic.attributes.Layer)&&void 0!==o.graphic){s.geometry=o.graphic.geometry,s.where="Category = 1",s.returnGeometry=!1,s.outFields=["*"];var d,u=(n(p.digitalGlobe.mosaics.map(function(t){var e=new r;s.geometry=o.graphic.geometry,s.returnGeometry=!1,s.outFields=["*"];var i=new L(p.digitalGlobe.imagedir+t+"/ImageServer");return i.execute(s,function(t){e.resolve(t.features)},function(){e.resolve([])}),e.promise})).then(function(r){var n="",o=[],s=dijit.byId("timeSliderDG").thumbIndexes,u=dijit.byId("timeSliderDG").timeStops,c=moment(u[s[0]]).tz("Asia/Jakarta"),y=moment(u[s[1]]).tz("Asia/Jakarta");r.map(function(t){t.map(function(t){o.push(t)})}),o.sort(function(t,e){return t.attributes.AcquisitionDate==e.attributes.AcquisitionDate?0:t.attributes.AcquisitionDate>e.attributes.AcquisitionDate?-1:1}),n+="<p>Click a date below to see the imagery.</p><ul class='popup-list'><li><strong>Date <span class='satelliteColumn'>Satellite</span></strong></li>",e.forEach(o,function(t){var e=moment(t.attributes.AcquisitionDate).tz("Asia/Jakarta");e>=c&&y>=e&&(n+="<li><a class='popup-link' data-bucket='"+t.attributes.SensorName+"_id_"+t.attributes.OBJECTID+"'> "+e.format("YYYY/MM/DD")+"  <span class='satelliteColumn' data-bucket='"+t.attributes.SensorName+"_id_"+t.attributes.OBJECTID+"'>"+t.attributes.SensorName+"</span></a></li>")}),n+="</ul><a class='custom-zoom-to' id='custom-zoom-to'>Zoom To</a>",D.infoWindow.setContent(n),D.infoWindow.resize(270,500),D.infoWindow.show(l),d=0,a(".contentPane .popup-link").forEach(function(t,e){f.push(i(t,"click",function(t){var i=t.target?t.target:t.srcElement,a=i.dataset?i.dataset.bucket:i.getAttribute("data-bucket");$("#imageryWindow > table > tbody > tr").each(function(){$(this).removeClass("imageryRowSelected");var t=this.firstElementChild;t=$(t).html(),t=$(t).attr("data-bucket"),a==t&&$(this).addClass("imageryRowSelected")});var r=a.split("_"),n={};n.feature={},n.feature.attributes={},n.feature.attributes.SensorName=r[0],n.feature.attributes.OBJECTID=r[2],w.showDigitalGlobeImagery(n),d=e}))}),f.push(i(t.byId("custom-zoom-to"),"click",function(){var t=new m(o[d].attributes.CenterX,o[d].attributes.CenterY,D.spatialReference);D.centerAndZoom(t,12)})),i.once(D.infoWindow,"hide",function(){e.forEach(f,function(t){t.remove()})})}),p.digitalGlobe.identifyUrl),c=(new v(u),new h),l=o.mapPoint,f=[];c.geometry=l,c.tolerance=3,c.returnGeometry=!0,c.mapExtent=D.extent,c.layerOption=h.LAYER_OPTION_VISIBLE,c.layerIds=[0]}},getFireTweetsInfoWindow:function(t){D.infoWindow.anchor="ANCHOR_UPPERRIGHT";var e=t.attributes,i="<table><tr><td>";return i+="<td><img src='"+e.UserProfileImage+"'/></td>",i+="<td>"+e.UserName+"</td></tr>",i+="<p>"+e.Text+"</p>",i+="<p>"+e.Date+"</p>",console.log(i),i},getFireStoriesInfoWindow:function(t){D.infoWindow.anchor="ANCHOR_UPPERRIGHT";var e=t.attributes,i="<table>";for(var a in e)e[a]&&"OBJECTID"!=a&&(i+="<tr><td>"+a+": "+e[a]+"</td></tr>");return i+="</div>"}}});