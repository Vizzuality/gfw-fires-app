define(["dojo/dom","dojo/_base/array","dojo/on","dojo/query","dojo/Deferred","dojo/promise/all","dojo/request/xhr","dojo/dom-attr","dojo/keys","esri/layers/FeatureLayer","esri/graphic","esri/request","esri/tasks/ImageServiceIdentifyParameters","esri/tasks/ImageServiceIdentifyTask","esri/layers/RasterFunction","esri/InfoTemplate","esri/dijit/PopupTemplate","esri/geometry/Point","esri/geometry/webMercatorUtils","esri/symbols/PictureMarkerSymbol","main/Config","views/map/MapConfig","views/map/MapModel","views/map/LayerController","esri/tasks/IdentifyTask","esri/tasks/IdentifyParameters","esri/tasks/query","esri/tasks/QueryTask","esri/geometry/Circle","utils/Analytics","esri/geometry/geometryEngine"],function(e,t,r,i,a,n,o,s,u,d,l,c,f,m,b,p,y,h,g,v,w,I,L,A,E,C,S,T,D,k,P){var x;return{setMap:function(e){x=e,window.PopupDateFormat=function(e){return new Date(e)}},clickNext:"",searchAreaByCoordinates:function(){var r,i,a,n,o={},s=!1,u="You did not enter a valid value.  Please check that your location values are all filled in and nubmers only.",d=new v("app/images/RedStickpin.png",32,32),c={},f=function(e){return s||(s=isNaN(parseInt(e))),isNaN(parseInt(e))?0:parseInt(e)},m=function(){var e=0;return t.forEach(x.graphics.graphics,function(t){t.attributes&&t.attributes.locatorValue&&(e=Math.max(e,parseInt(t.attributes.locatorValue)))}),e};L.get("showDMSInputs")?(o.dlat=f(e.byId("degreesLatInput").value),o.mlat=f(e.byId("minutesLatInput").value),o.slat=f(e.byId("secondsLatInput").value),o.dlon=f(e.byId("degreesLonInput").value),o.mlon=f(e.byId("minutesLonInput").value),o.slon=f(e.byId("secondsLonInput").value),r=o.dlat+o.mlat/60+o.slat/3600,i=o.dlon+o.mlon/60+o.slon/3600):(r=f(e.byId("latitudeInput").value),i=f(e.byId("longitudeInput").value)),s?alert(u):(a=g.geographicToWebMercator(new h(i,r)),c.locatorValue=m(),c.id="LOCATOR_"+c.locatorValue,n=new l(a,d,c),x.graphics.add(n),x.centerAndZoom(a,7),L.set("showClearPinsOption",!0))},fetchTwitterData:function(e){var t=e.target?e.target:e.srcElement;!t.checked},mapClick:function(e){console.log("Map Click event!"),$("#uploadCustomGraphic").length>0&&$("#uploadCustomGraphic").remove();var r=x,i=this,a=e.mapPoint,o=[],s=[];r.infoWindow.clearFeatures(),overlaysLayer=r.getLayer(I.overlaysLayer.id),overlaysLayer&&overlaysLayer.visible&&o.push(i.identifyOverlays(a)),forestUseLayer=r.getLayer(I.forestUseLayers.id),forestUseLayer&&forestUseLayer.visible&&o.push(i.identifyForestUse(a)),conservationLayers=r.getLayer(I.conservationLayers.id),conservationLayers&&conservationLayers.visible&&o.push(i.identifyConservation(a)),fireStoryLayer=r.getLayer(I.fireStories.id),fireStoryLayer&&fireStoryLayer.visible&&o.push(i.identifyFireStories(a)),fireTweets=r.getLayer(I.tweetLayer.id),fireTweets&&fireTweets.visible&&o.push(i.identifyFireTweets(a)),console.log(o),0!==o.length&&n(o).then(function(e){t.forEach(e,function(e){switch(console.log(e),e.layer){case"Overlays_Layer":s=s.concat(i.setOverlaysTemplates(e.features));break;case"Forest_Use":s=s.concat(i.setForestUseTemplates(e.features));break;case"Conservation":s=s.concat(i.setConservationTemplates(e.features));break;case"Fire_Stories":return s=s.concat(i.getFireStoriesInfoWindow(e.features)),void 0;case"Fire_Tweets":s=s.concat(i.getFireTweetsInfoWindow(e.features))}}),s.length>0&&(r.infoWindow.setFeatures(s),r.infoWindow.show(a))})},identifyOverlays:function(e){var t=new a,r=new E(I.overlaysLayer.url),i=new C;return i.tolerance=3,i.maxAllowableOffset=100,i.returnGeometry=!0,i.width=x.width,i.height=x.height,i.geometry=e,i.mapExtent=x.extent,i.layerIds=x.getLayer(I.overlaysLayer.id).visibleLayers,i.layerOption=C.LAYER_OPTION_VISIBLE,r.execute(i,function(e){e.length>0?t.resolve({layer:I.overlaysLayer.id,features:e}):t.resolve(!1)},function(){t.resolve(!1)}),t.promise},identifyForestUse:function(e){var t=new a,r=new E(I.forestUseLayers.url),i=new C;return i.tolerance=3,i.returnGeometry=!0,i.width=x.width,i.height=x.height,i.geometry=e,i.mapExtent=x.extent,i.layerIds=x.getLayer(I.forestUseLayers.id).visibleLayers,i.layerOption=C.LAYER_OPTION_VISIBLE,r.execute(i,function(e){e.length>0?t.resolve({layer:I.forestUseLayers.id,features:e}):t.resolve(!1)},function(){t.resolve(!1)}),t.promise},identifyConservation:function(e){var t=new a,r=new E(I.conservationLayers.url),i=new C;return i.tolerance=3,i.returnGeometry=!0,i.width=x.width,i.height=x.height,i.geometry=e,i.mapExtent=x.extent,i.layerIds=x.getLayer(I.conservationLayers.id).visibleLayers,i.layerOption=C.LAYER_OPTION_VISIBLE,r.execute(i,function(e){e.length>0?t.resolve({layer:I.conservationLayers.id,features:e}):t.resolve(!1)},function(){t.resolve(!1)}),t.promise},identifyFireStories:function(e){var t=I.fireStories.url.split("/10");t=t[0];var r=new a,i=new E(t),n=new C;return n.tolerance=5,n.returnGeometry=!1,n.width=x.width,n.height=x.height,n.geometry=e,n.mapExtent=x.extent,n.layerIds=[10],n.layerOption=C.LAYER_OPTION_VISIBLE,i.execute(n,function(e){e.length>0?r.resolve({layer:"Fire_Stories",features:e}):r.resolve(!1)},function(){r.resolve(!1)}),r.promise},identifyFireTweets:function(e){var t=I.tweetLayer.url.split("/3");t=t[0];var r=new a,i=new E(t),n=new C;return n.tolerance=5,n.returnGeometry=!1,n.width=x.width,n.height=x.height,n.geometry=e,n.mapExtent=x.extent,n.layerIds=[3],n.layerOption=C.LAYER_OPTION_VISIBLE,i.execute(n,function(e){e.length>0?r.resolve({layer:"Fire_Tweets",features:e}):r.resolve(!1)},function(){r.resolve(!1)}),r.promise},setOverlaysTemplates:function(e){var r,i=[];return t.forEach(e,function(e){1===e.layerId?(r=new p("Village: "+e.value,"<table><tr><td>Subdistrict:</td><td>"+e.feature.attributes.SUBDISTRIC+"</td></tr><tr><td>District:</td><td>"+e.feature.attributes.DISTRICT+"</td></tr><tr style='height:10px;'></tr></table>"),e.feature.attributes.ALERTS_LABEL=e.value):2===e.layerId?(r=new p("Subdistrict: "+e.value,"<table><tr><td>District:</td><td>"+e.feature.attributes.DISTRICT+"</td></tr><tr><td>Province:</td><td>"+e.feature.attributes.PROVINCE+"</td></tr><tr style='height:10px;'></tr></table>"),e.feature.attributes.ALERTS_LABEL=e.value):3===e.layerId?(r=new p("District: "+e.feature.attributes.DISTRICT,"<table><tr><td>Province:</td><td>"+e.feature.attributes.PROVINCE+"</td></tr><tr><td>Island:</td><td>"+e.feature.attributes.ISLAND+"</td></tr><tr style='height:10px;'></tr></table>"),e.feature.attributes.ALERTS_LABEL=e.feature.attributes.DISTRICT):(r=new p("Province: "+e.value,"<table><tr><td>Island:</td><td>"+e.feature.attributes.ISLAND+"</td></tr><tr style='height:10px;'></tr></table>"),e.feature.attributes.ALERTS_LABEL=e.value),e.feature.setInfoTemplate(r),i.push(e.feature)}),0==$("#uploadCustomGraphic").length&&$(".sizer > .actionsPane").append("<div id='uploadCustomGraphic' class='uploadCustomGraphic'>Subscribe</div>"),i},setForestUseTemplates:function(e){var r,i=[];return t.forEach(e,function(e){if(27===e.layerId)r=new p("<strong>"+e.value+"</strong>","<table><tr><td>Concession Type</td><td>"+e.feature.attributes.TYPE+"</td></tr><tr><td>Country</td><td>"+e.feature.attributes.Country+"</td></tr><tr><td>Certification Status</td><td>"+e.feature.attributes.CERT_STAT+"</td></tr><tr><td>GIS Calculated Area (ha)</td><td>"+e.feature.attributes.AREA_HA+"</td></tr><tr><td>Certificate ID</td><td>"+e.feature.attributes.Certificat+"</td></tr><tr><td>Certificate Issue Date</td><td>"+e.feature.attributes.Issued+"</td></tr><tr><td>Certificate Expiry Date</td><td>"+e.feature.attributes.Expired+"</td></tr><tr><td>Mill name</td><td>"+e.feature.attributes.Mill+"</td></tr><tr><td>Mill location</td><td>"+e.feature.attributes.Location+"</td></tr><tr><td>Mill capacity (t/hour)</td><td>"+e.feature.attributes.Capacity+"</td></tr><tr><td>Certified CPO (mt)</td><td>"+e.feature.attributes.CPO+"</td></tr><tr><td>Certified PK (mt)</td><td>"+e.feature.attributes.PK+"</td></tr><tr><td>Estate Suppliers</td><td>"+e.feature.attributes.Estate+"</td></tr><tr><td>Estate Area (ha)</td><td>"+e.feature.attributes.Estate_1+"</td></tr><tr><td>Outgrower Area (ha)</td><td>"+e.feature.attributes.Outgrowe+"</td></tr><tr><td>Scheme Smallholder Area (ha)</td><td>"+e.feature.attributes.SH+"</td></tr><tr><td>Source: </td><td>"+(e.feature.attributes.Source||"N/A")+"</td></tr><tr style='height:10px;'></tr></table>"),e.feature.attributes.ALERTS_LABEL=e.value;else{if(16===e.layerId)return;10===e.layerId?(r=new p("<strong>"+e.value+"</strong>","<table><tr><td>Concession Type</td><td>"+e.feature.attributes.TYPE+"</td></tr><tr><td>Country</td><td>"+e.feature.attributes.Country+"</td></tr><tr><td>Certification Status</td><td>"+e.feature.attributes.CERT_STAT+"</td></tr><tr><td>GIS Calculated Area (ha)</td><td>"+e.feature.attributes.AREA_HA+"</td></tr><tr><td>Source: </td><td>"+(e.feature.attributes.Source||"N/A")+"</td></tr><tr style='height:10px;'></tr></table>"),e.feature.attributes.ALERTS_LABEL=e.value):28===e.layerId?(r=new p("<strong>"+e.value+"</strong>","<table><tr><td>Concession Type</td><td>"+e.feature.attributes.TYPE+"</td></tr><tr><td>Country</td><td>"+e.feature.attributes.Country+"</td></tr><tr><td>Certification Status</td><td>"+e.feature.attributes.CERT_STAT+"</td></tr><tr><td>GIS Calculated Area (ha)</td><td>"+e.feature.attributes.AREA_HA+"</td></tr><tr><td>Source: </td><td>"+(e.feature.attributes.Source||"N/A")+"</td></tr><tr style='height:10px;'></tr></table>"),e.feature.attributes.ALERTS_LABEL=e.value):32===e.layerId&&(r=new p("<strong>"+e.value+"</strong>","<table><tr><td>Concession Type</td><td>"+e.feature.attributes.TYPE+"</td></tr><tr><td>Country</td><td>"+e.feature.attributes.Country+"</td></tr><tr><td>Certification Status</td><td>"+e.feature.attributes.CERT_STAT+"</td></tr><tr><td>GIS Calculated Area (ha)</td><td>"+e.feature.attributes.AREA_HA+"</td></tr><tr><td>Source: </td><td>"+(e.feature.attributes.Source||"N/A")+"</td></tr><tr style='height:10px;'></tr></table>"),e.feature.attributes.ALERTS_LABEL=e.value)}e.feature.setInfoTemplate(r),i.push(e.feature)}),0==$("#uploadCustomGraphic").length&&$(".sizer > .actionsPane").append("<div id='uploadCustomGraphic' class='uploadCustomGraphic'>Subscribe</div>"),i},setConservationTemplates:function(e){var r,i=[];return t.forEach(e,function(e){r=new p("Protected Areas ","<table><tr class='infoName'><td colspan='2'>"+e.feature.attributes.NAME+"</td></tr><tr><td>Local Name</td><td>"+e.feature.attributes.ORIG_NAME+"</td></tr><tr><td>Legal Designation</td><td>"+e.feature.attributes.DESIG_ENG+"</td></tr><tr><td>WDPA ID</td><td>"+e.feature.attributes.WDPAID+"</td></tr><tr style='height:10px;'></tr></table>"),e.feature.attributes.ALERTS_LABEL=e.value,e.feature.setInfoTemplate(r),i.push(e.feature)}),0==$("#uploadCustomGraphic").length&&$(".sizer > .actionsPane").append("<div id='uploadCustomGraphic' class='uploadCustomGraphic'>Subscribe</div>"),i},getTomnodInfoWindow:function(e){var t=I.tomnodLayer,r=(t.url,e),i="";if(r){var a=new Date(r.attributes.ImageAquisitionDate),n=a.getMonth()+1,o=a.getDate(),s=a.getFullYear();return a=n+"/"+o+"/"+s,executeReturned=!1,i+=" <div><h3>"+r.attributes.name+"</h3></div>",i+="<tr><td><img src='"+t.chipBucket+r.attributes.ChipLink,i+="' style='width:300px' /></tc></tr>",i+="<div><strong>Image Acquisition Date:</strong> "+a+"</div>",i+="<div><strong>Confirmation:</strong> "+r.attributes.Confirmation+" people</div>",i+="<div><b>Crowd Rank:</b> "+r.attributes.CrowdRank+"%</div>",i+="<a href='"+r.attributes.ImageLink,i+="' target='_blank'>See this point on ",i+="<img style='height:20px;width:100px;' src='app/images/tomnod_logo.png'></div>"}},selectTomnodFeatures:function(r){var a=I.tomnodLayer,n=(e.byId("landsat-image-checkbox"),this),o=a.url,s=new E(o),u=new C,l=(new T(o),new S),c=r.mapPoint,f=(i(".selected-fire-option")[0],new Date,new Date,[]);if(!x.getLayer(a.id).visible){n.getActiveFiresInfoWindow(r),n.getArchiveFiresInfoWindow(r);var m=e.byId("noaa-fires-18"),b=e.byId("indonesia-fires"),p=e.byId("fires-checkbox");return"true"==m.getAttribute("aria-checked")&&"true"==b.getAttribute("aria-checked")||"true"==m.getAttribute("aria-checked")&&"true"==p.getAttribute("aria-checked")?setTimeout(function(){x.infoWindow.isShowing||n.getArchiveNoaaInfoWindow(r)},800):n.getArchiveNoaaInfoWindow(r),setTimeout(function(){x.infoWindow.isShowing||n.getDigitalGlobeInfoWindow(r)},400),void 0}u.geometry=c,u.tolerance=3,u.returnGeometry=!1,u.layerDefinitions=f,u.mapExtent=x.extent,u.layerIds=[8],l.where="OBJECTID in (",l.returnGeometry=!1,l.outFields=["OBJECTID","ChipLink","CrowdRank","Confirmation","name","ImageLink"];var y=[];s.execute(u,function(e){return t.forEach(e,function(e){y.push(e.feature.attributes.OBJECTID)}),y.length<1?(x.infoWindow.setFeatures(void 0),n.getActiveFiresInfoWindow(r),n.getDigitalGlobeInfoWindow(r),n.getArchiveFiresInfoWindow(r),n.getArchiveNoaaInfoWindow(r),void 0):(x.infoWindow.resize(340,500),l.where+=y.join(",")+")",selected_features=x.getLayer(I.tomnodLayer.sel_id).selectFeatures(l,d.SELECTION_NEW),selected_features.then(function(e){x.infoWindow.setFeatures(e),x.infoWindow.resize(340,500),x.infoWindow.show(r.mapPoint)}),void 0)},function(){n.mapClick(r)})},getActiveFiresInfoWindow:function(e){var r=I.firesLayer,a=this,n=r.url,o=new E(n),s=new C,u=e.mapPoint,d=!0,l=i(".selected-fire-option")[0],c=new Date,f=new Date,m="",b="",p=[];if(!x.getLayer(r.id).visible)return a.mapClick(e),void 0;switch(l.id){case"fires72":c.setDate(c.getDate()-4),f.setDate(f.getDate()-3);break;case"fires48":c.setDate(c.getDate()-3),f.setDate(f.getDate()-2);break;case"fires24":c.setDate(c.getDate()-2),f.setDate(f.getDate()-1);break;default:c.setDate(c.getDate()-8),f.setDate(f.getDate()-7)}b=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate()+" "+c.getHours()+":"+c.getMinutes()+":"+c.getSeconds(),m=f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate()+" "+f.getHours()+":"+f.getMinutes()+":"+f.getSeconds();for(var y=0,h=I.firesLayer.defaultLayers.length;h>y;y++)p[y]="ACQ_DATE > date '"+b+"'";s.geometry=u,s.tolerance=3,s.returnGeometry=!1,s.layerDefinitions=p,s.mapExtent=x.extent,s.layerOption=C.LAYER_OPTION_VISIBLE;var g="</div><table id='infoWindowTable'>";o.execute(s,function(i){var n=x,o=i[0];o?(d=!1,g+="<tr class='infoName'><td colspan='3'>Active Fires</td><td colspan='2'></td></tr>",t.forEach(r.query.fields,function(e){g+="<tr><td colspan='3'>"+e.label+"</td>",g+="<td colspan='2'>"+o.feature.attributes[e.name]+"</td></tr>"}),g+="</table>",n.infoWindow.setContent(g),n.infoWindow.resize(270,140),n.infoWindow.show(u)):a.mapClick(e)},function(){a.mapClick(e)})},getArchiveFiresInfoWindow:function(r){var i=I.indonesiaLayers,a=this,n=i.url,o=new E(n),s=new C,u=r.mapPoint,d=!0,l=(new Date,new Date,e.byId("indonesia-fires"));if(!x.getLayer(i.id).visible||1!=l.checked)return a.mapClick(r),void 0;s.layerDefinitions=x.getLayer(i.id).layerDefinitions,s.geometry=u,s.tolerance=3,s.returnGeometry=!1,s.mapExtent=x.extent,s.layerOption=C.LAYER_OPTION_ALL,s.layerIds=[0];var c=(x.getLayer(i.id),"</div><table id='infoWindowTable'>");o.execute(s,function(e){var n=x,o=e[0];if(o){if(2==o.layerId)return;d=!1,c+="<tr class='infoName'><strong>NASA archived fires for Indonesia</strong></tr>",t.forEach(i.query.fields,function(e){c+="<tr><td colspan='3'>"+e.label+"</td>",c+="<td colspan='2'>"+o.feature.attributes[e.name]+"</td></tr>"}),c+="</table>",n.infoWindow.setContent(c),n.infoWindow.resize(270,140),n.infoWindow.show(u)}else a.mapClick(r)},function(){a.mapClick(r)})},getLandsatInfoWindow:function(e){var r=I.landsat8,i=new f,a=new m(r.url);i.geometry=e.mapPoint,i.returnCatalogItems=!0,i.f="json",i.returnGeometry=!0,i.renderingRule=new b({rasterFunction:"Stretch",rasterFunctionArguments:{StretchType:6,DRA:!0,Gamma:[1.4,1.4,1.4],UseGamma:!0,MinPercent:.5,MaxPercent:.5},outputPixelType:"U8"}),i.pixelSizeX=100,i.pixelSizeY=100,a.execute(i,function(r){t.forEach(r.catalogItems.features,function(e){e.infoTemplate=new p("Acquisition Date","<tr><td>${AcquisitionDate: PopupDateFormat}</td></td>")}),x.infoWindow.setFeatures(r.catalogItems.features),x.infoWindow.show(e.mapPoint)},function(e){console.dir(e)})},getArchiveNoaaInfoWindow:function(t){var r=I.indonesiaLayers,i=this,a=r.url,n=new E(a),o=new C,s=t.mapPoint,u=!0,d=(new Date,new Date,e.byId("noaa-fires-18"));if("false"!=d.getAttribute("aria-checked")&&x.getLayer("IndonesiaFires").visible){o.geometry=s,o.tolerance=3,o.returnGeometry=!1,o.mapExtent=x.extent,o.layerOption=C.LAYER_OPTION_ALL,o.layerIds=[9];{x.getLayer(r.id)}n.execute(o,function(e){var r=x,a=e[0];if(a){if(2==a.layerId)return;u=!1;var n=a.feature.attributes.Date,o=n.split(" "),o=o[0],d="</div><table id='infoWindowTable'>";d+="<tr class='infoName'><strong>NOAA-18 fires</strong></tr>",d+="<tr><td colspan='3'>DATE</td>",d+="<td colspan='2'>"+o+"</td></tr>",d+="</table>",r.infoWindow.setContent(d),r.infoWindow.resize(170,50),r.infoWindow.show(s)}else i.mapClick(t)},function(){i.mapClick(t)})}},getNOAAFiresInfoWindow:function(e){{var r=I.indonesiaLayers,i=this,a=r.url,n=new E(a),o=new C,s=e.mapPoint,u=!0;new Date,new Date}if(!x.getLayer(r.id).visible)return i.mapClick(e),void 0;o.geometry=s,o.tolerance=10,o.returnGeometry=!1,o.mapExtent=x.extent,o.layerOption=C.LAYER_OPTION_ALL;var d="</div><table id='infoWindowTable'>";n.execute(o,function(a){var n=x,o=a[0];o?(u=!1,d+="<tr class='infoName'><strong>NASA archived fires for Indonesia</strong></tr>",t.forEach(r.query.fields,function(e){d+="<tr><td colspan='3'>"+e.label+"</td>",d+="<td colspan='2'>"+o.feature.attributes[e.name]+"</td></tr>"}),d+="</table>",n.infoWindow.setContent(d),n.infoWindow.show(s)):(console.log("No result returned!"),i.mapClick(e))},function(){i.mapClick(e)})},getDigitalGlobeInfoWindow:function(o){var s=(I.digitalGlobe,x.getLayer(I.digitalGlobe.graphicsLayerId),new S);if((!o.graphic||"Digital_Globe"===o.graphic.attributes.Layer)&&void 0!==o.graphic){s.geometry=o.graphic.geometry,s.where="Category = 1",s.returnGeometry=!1,s.outFields=["*"];var u,d=(n(I.digitalGlobe.imageServices.map(function(e){var r=new a;s.geometry=o.graphic.geometry,s.returnGeometry=!1,s.outFields=["AcquisitionDate","SensorName","OBJECTID","CenterX","CenterY"];var i=new T(e.url);return function(e){i.execute(s,function(i){t.forEach(i.features,function(t){t.attributes.LayerId=e.id}),r.resolve(i.features)},function(){r.resolve([])})}(e),r.promise})).then(function(a){var n="",o=[],s=dijit.byId("timeSliderDG").thumbIndexes,d=dijit.byId("timeSliderDG").timeStops,l=moment(d[s[0]]).tz("Asia/Jakarta"),m=moment(d[s[1]]).tz("Asia/Jakarta");a.map(function(e){e.map(function(e){o.push(e)})}),console.dir(o),o.sort(function(e,t){return e.attributes.AcquisitionDate==t.attributes.AcquisitionDate?0:e.attributes.AcquisitionDate>t.attributes.AcquisitionDate?-1:1}),n+="<p>Click a date below to see the imagery.</p><ul class='popup-list'><li><strong>Date <span class='satelliteColumn'>Satellite</span></strong></li>",t.forEach(o,function(e){var t=moment(e.attributes.AcquisitionDate).tz("Asia/Jakarta");t>=l&&m>=t&&(n+="<li><a class='popup-link' data-layer='"+e.attributes.LayerId+"' data-bucket='"+e.attributes.SensorName+"_id_"+e.attributes.OBJECTID+"'> "+t.format("YYYY/MM/DD")+"  <span class='satelliteColumn' data-layer='"+e.attributes.LayerId+"' data-bucket='"+e.attributes.SensorName+"_id_"+e.attributes.OBJECTID+"'>"+e.attributes.SensorName+"</span></a></li>")}),n+="</ul><a class='custom-zoom-to' id='custom-zoom-to'>Zoom To</a>",x.infoWindow.setContent(n),x.infoWindow.resize(270,500),x.infoWindow.show(c),u=0,i(".contentPane .popup-link").forEach(function(e,t){f.push(r(e,"click",function(e){var r=e.target?e.target:e.srcElement,i=r.dataset?r.dataset.bucket:r.getAttribute("data-bucket"),a=r.getAttribute("data-layer");$("#imageryWindow > table > tbody > tr").each(function(){$(this).removeClass("imageryRowSelected");var e=this.firstElementChild;e=$(e).html(),e=$(e).attr("data-bucket"),i==e&&$(this).addClass("imageryRowSelected")});var n=i.split("_"),o={};o.feature={},o.feature.attributes={},o.feature.attributes.SensorName=n[0],o.feature.attributes.OBJECTID=n[2],o.feature.attributes.LayerId=a,A.showDigitalGlobeImagery(o),u=t}))}),f.push(r(e.byId("custom-zoom-to"),"click",function(){var e=new h(o[u].attributes.CenterX,o[u].attributes.CenterY,x.spatialReference);x.centerAndZoom(e,12)})),r.once(x.infoWindow,"hide",function(){t.forEach(f,function(e){e.remove()})})}),I.digitalGlobe.identifyUrl),l=(new E(d),new C),c=o.mapPoint,f=[];l.geometry=c,l.tolerance=3,l.returnGeometry=!0,l.mapExtent=x.extent,l.layerOption=C.LAYER_OPTION_VISIBLE,l.layerIds=[0]}},getFireTweetsInfoWindow:function(e){var t,r,i=[];x.infoWindow.anchor="ANCHOR_UPPERRIGHT";for(var a=0;a<e.length;a++){t=e[a].feature.attributes,r="<table>";for(var n in t)!t[n]||"UserName"!=n&&"Text"!=n&&"Date"!=n&&"UserProfileImage"!=n||(r+="UserProfileImage"==n?"<tr><td><img src='"+e[a].feature.attributes.UserProfileImage+"'/></td></tr>":"<tr><td>"+n+": "+t[n]+"</td></tr>");r+="</div>",template=new p(e[a].feature.attributes.UserName,r),e[a].feature.setInfoTemplate(template),i.push(e[a].feature)}return i},getFireStoriesInfoWindow:function(e){x.infoWindow.anchor="ANCHOR_UPPERRIGHT";for(var t,r=[],i=0;i<e.length;i++){for(t in e[i].feature.attributes)"Null"==e[i].feature.attributes[t]&&(e[i].feature.attributes[t]="");var a=new y({title:"{Title}",fieldInfos:[{fieldName:"Date",label:"Date",format:{dateFormat:"shortDate"},visible:!0},{fieldName:"Details",label:"Details",visible:!0},{fieldName:"Video",label:"Video",visible:!0},{fieldName:"Name",label:"Name",visible:!0},{fieldName:"Attachments",label:"Attachments",visible:!0}],showAttachments:!0}),n=e[i].feature.attributes.OBJECTID,o=map.getLayer("Fire_Stories");!function(e){o.queryAttachmentInfos(n,function(t){if(t[0]&&(console.log(t),t[0].url)){if(e.attributes.Attachments="<img id='forceBlock'; src='"+t[0].url+"' />",t.length>1)for(var r=1;r<t.length;r++)t[r].url&&(e.attributes.Attachments+="<img id='forceBlock'; src='"+t[r].url+"' />");for(var i=[],a=0;a<map.infoWindow.features.length;a++)map.infoWindow.features[a].attributes.OBJECTID===e.attributes.OBJECTID?i.push(e):i.push(map.infoWindow.features[a]);map.infoWindow.setFeatures(i);var n=$("#forceBlock")[0],o=n.parentElement,s=o.previousSibling;$(o).css("display","block"),$(s).css("display","block")}})}(e[i].feature),e[i].feature.setInfoTemplate(a),r.push(e[i].feature)}return r},selectUploadOrDrawnGraphics:function(t){$("#uploadCustomGraphic").length>0&&$("#uploadCustomGraphic").remove();var i,a,n,o=t.graphic,s=I.defaultGraphicsLayerUniqueId,u=(I.defaultGraphicsLayerLabel,this);t.stopPropagation(),n="<strong>Custom Feature</strong>",i="Name: <input id='editTitle' style='width:165px;' class='editshow' value='Custom Feature'/><br/><div id='uploadCustomGraphic' class='uploadCustomGraphic'><span id='customGraphicSymbol'></span>Subscribe</div><div id='deleteCustomGraphic' class='deleteGraphicLink'>&#10007 Remove</div>";x.graphics.graphics,L.vm.customFeaturesArray.indexOf(o);x.infoWindow.setContent(i),$("#editTitle").val(o.attributes.ALERTS_LABEL),x.infoWindow.show(t.mapPoint),a=r.once(e.byId("deleteCustomGraphic"),"click",function(){A.removeGraphicWithId(o.attributes[s],s),0===x.graphics.graphics.length&&L.vm.customFeaturesPresence(!1),x.infoWindow.hide()}),handleSubscribe=r.once(e.byId("uploadCustomGraphic"),"click",function(){var t=o,r=e.byId("editTitle").value;o.attributes.ALERTS_LABEL=r,u.subscribeToAlerts(t),x.infoWindow.hide()}),$("#editTitle").bind("input",function(){var e=$(this).val();o.attributes.ALERTS_LABEL=e}),r.once(x.infoWindow,"hide",function(){a.remove(),handleSubscribe.remove()})},subscribeToAlerts:function(t){var r=this;require(["dojo/on","dijit/Dialog","dojo/dom-construct"],function(i,a){function n(){o.remove(),s.destroy(),telInput.intlTelInput("destroy")}var o,s=new a({id:"subscribeDialogWindow",title:"Subscribe to Alerts!",refocus:!1,style:"width: 300px;"}),u="<div class='subscription-content'><p>Enter your email(s) below to receive fire alerts. Multiple emails must be separated by commas.</p><div class='email-container'><input id='userEmail' type='text' placeholder='Email'/></div><p>Enter your phone number below to receive SMS alerts</p><div class='phone-container'><input id='userPhone' type='tel' placeholder='Phone Number'/></div><div class='submit-container'><button id='subscribe-now'>Subscribe</button></div><div id='form-response' class='message-container'></div></div>";u+="<input type='email' name='verify_email' id='verifyEmailForAlertsInMap' placeholder='Verify Email(Leave blank if your human)'/>",s.on("hide",n),s.setContent(u),s.show(),telInput=$("#userPhone"),telInput.intlTelInput({validationScript:"./app/libs/isValidNumber.js"}),o=i(e.byId("subscribe-now"),"click",function(){require(["dojox/validate/web","dojo/dom-style"],function(i,a){if(honeyPotValue=e.byId("verifyEmailForAlertsInMap").value,""!==honeyPotValue)return s.destroy(),void 0;if(emailValue=e.byId("userEmail").value,phoneValue=e.byId("userPhone").value,!emailValue&&!phoneValue)return a.set("userPhone","border","1px solid red"),a.set("userEmail","border","1px solid red"),alert("You must enter an email or phone number"),void 0;if(emailValue){if(emailValue.indexOf(",")>-1){for(var n=emailValue.split(","),o=0;o<n.length;o++){var u=n[o].replace(/\s/g,"");if(!i.isEmailAddress(u))return a.set("userEmail","border","1px solid red"),e.byId("subscribe-now").innerHTML="Subscribe",alert("You must enter valid email addresses, separated by commas."),void 0;console.log(u),r.postSubscribeRequest(t,u,"email",s),k.sendEvent("Subscribe","click","Fire Alerts","User is subscribing to Fire Alerts via Email.")}return a.set("userEmail","border","1px solid gray"),e.byId("subscribe-now").innerHTML="Submitting...",void 0}if(!i.isEmailAddress(emailValue))return a.set("userEmail","border","1px solid red"),alert("You must enter a valid email address!"),void 0;a.set("userEmail","border","1px solid gray"),e.byId("subscribe-now").innerHTML="Submitting...",r.postSubscribeRequest(t,emailValue,"email",s),k.sendEvent("Subscribe","click","Fire Alerts","User is subscribing to Fire Alerts via Email.")}phoneValue&&(a.set("userPhone","border","1px solid gray"),e.byId("subscribe-now").innerHTML="Submitting...",r.postSubscribeRequest(t,phoneValue,"sms",s),k.sendEvent("Subscribe","click","Fire Alerts","User is subscribing to Fire Alerts via SMS."))})})})},postSubscribeRequest:function(e,t,r,i){"sms"===r&&(t=t.replace(/\D/g,""));var n=w.emailSubscribeUrlPoly,s=new a,u={msg_addr:t,msg_type:r,area_name:e.attributes.ALERTS_LABEL},d=P.simplify(e.geometry);return u.features=JSON.stringify({rings:d.rings,spatialReference:d.spatialReference}),o(n,{handleAs:"json",method:"POST",data:u}).then(function(){emailValue&&phoneValue?i.setContent("<p>You have successfully subscribed. You will receive an email asking you to <strong>verify your subscription</strong>. Please be sure to check your SPAM folder. Once verified, you will start receiving alerts for your area.</p>"):emailValue&&!phoneValue?i.setContent("<p>You have successfully subscribed. You will receive an email asking you to <strong>verify your subscription</strong>. Please be sure to check your SPAM folder. Once verified, you will start receiving alerts for your area.</p>"):i.setContent("<p>You have successfully subscribed, you should start receiving SMS alerts as they come in for your area of interest.</p>"),s.resolve(!0)},function(e){alert("There was an error subsrcribing at this time. "+e.message),i.destroy(),s.resolve(!1)}),s.promise},setupInfowindowListeners:function(){var t,i=this;r(map.infoWindow,"selection-change",function(){setTimeout(function(){e.byId("uploadCustomGraphic")&&(t&&t.remove(),t=r(e.byId("uploadCustomGraphic"),"click",function(){var e=map.infoWindow.selectedIndex,t=map.infoWindow.features[e];i.subscribeToAlerts(t)}))},0)}),r(map.infoWindow,"hide",function(){t&&t.remove()})}}});