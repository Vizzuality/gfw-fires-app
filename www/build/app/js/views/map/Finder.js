define(["dojo/dom","dojo/_base/array","dojo/on","dojo/query","dojo/Deferred","dojo/promise/all","dojo/request/xhr","dojo/dom-attr","dojo/keys","esri/layers/FeatureLayer","esri/graphic","esri/request","esri/tasks/ImageServiceIdentifyParameters","esri/tasks/ImageServiceIdentifyTask","esri/layers/RasterFunction","esri/InfoTemplate","esri/dijit/PopupTemplate","esri/geometry/Point","esri/geometry/webMercatorUtils","esri/symbols/PictureMarkerSymbol","main/Config","views/map/MapConfig","views/map/MapModel","views/map/LayerController","esri/tasks/IdentifyTask","esri/tasks/IdentifyParameters","esri/tasks/query","esri/tasks/QueryTask","esri/geometry/Circle"],function(e,t,r,i,a,n,o,s,u,d,l,c,f,p,m,b,y,h,g,v,w,I,L,A,E,C,S,T){var D;return{setMap:function(e){D=e,window.PopupDateFormat=function(e){return new Date(e)}},clickNext:"",searchAreaByCoordinates:function(){var r,i,a,n,o={},s=!1,u="You did not enter a valid value.  Please check that your location values are all filled in and nubmers only.",d=new v("app/images/RedStickpin.png",32,32),c={},f=function(e){return s||(s=isNaN(parseInt(e))),isNaN(parseInt(e))?0:parseInt(e)},p=function(){var e=0;return t.forEach(D.graphics.graphics,function(t){t.attributes&&t.attributes.locatorValue&&(e=Math.max(e,parseInt(t.attributes.locatorValue)))}),e};L.get("showDMSInputs")?(o.dlat=f(e.byId("degreesLatInput").value),o.mlat=f(e.byId("minutesLatInput").value),o.slat=f(e.byId("secondsLatInput").value),o.dlon=f(e.byId("degreesLonInput").value),o.mlon=f(e.byId("minutesLonInput").value),o.slon=f(e.byId("secondsLonInput").value),r=o.dlat+o.mlat/60+o.slat/3600,i=o.dlon+o.mlon/60+o.slon/3600):(r=f(e.byId("latitudeInput").value),i=f(e.byId("longitudeInput").value)),s?alert(u):(a=g.geographicToWebMercator(new h(i,r)),c.locatorValue=p(),c.id="LOCATOR_"+c.locatorValue,n=new l(a,d,c),D.graphics.add(n),D.centerAndZoom(a,7),L.set("showClearPinsOption",!0))},fetchTwitterData:function(e){var t=e.target?e.target:e.srcElement;!t.checked},mapClick:function(e){console.log("Map Click event!"),$("#uploadCustomGraphic").length>0&&$("#uploadCustomGraphic").remove();var r=D,i=this,a=e.mapPoint,o=[],s=[];r.infoWindow.clearFeatures(),overlaysLayer=r.getLayer(I.overlaysLayer.id),overlaysLayer&&overlaysLayer.visible&&o.push(i.identifyOverlays(a)),forestUseLayer=r.getLayer(I.forestUseLayers.id),forestUseLayer&&forestUseLayer.visible&&o.push(i.identifyForestUse(a)),conservationLayers=r.getLayer(I.conservationLayers.id),conservationLayers&&conservationLayers.visible&&o.push(i.identifyConservation(a)),fireStoryLayer=r.getLayer(I.fireStories.id),fireStoryLayer&&fireStoryLayer.visible&&o.push(i.identifyFireStories(a)),fireTweets=r.getLayer(I.tweetLayer.id),fireTweets&&fireTweets.visible&&o.push(i.identifyFireTweets(a)),console.log(o),0!==o.length&&n(o).then(function(e){t.forEach(e,function(e){switch(console.log(e),e.layer){case"Overlays_Layer":s=s.concat(i.setOverlaysTemplates(e.features));break;case"Forest_Use":s=s.concat(i.setForestUseTemplates(e.features));break;case"Conservation":s=s.concat(i.setConservationTemplates(e.features));break;case"Fire_Stories":s=s.concat(i.getFireStoriesInfoWindow(e.features));break;case"Fire_Tweets":s=s.concat(i.getFireTweetsInfoWindow(e.features))}}),s.length>0&&(r.infoWindow.setFeatures(s),r.infoWindow.show(a))})},identifyOverlays:function(e){var t=new a,r=new E(I.overlaysLayer.url),i=new C;return i.tolerance=3,i.maxAllowableOffset=100,i.returnGeometry=!0,i.width=D.width,i.height=D.height,i.geometry=e,i.mapExtent=D.extent,i.layerIds=D.getLayer(I.overlaysLayer.id).visibleLayers,i.layerOption=C.LAYER_OPTION_VISIBLE,r.execute(i,function(e){t.resolve(e.length>0?{layer:I.overlaysLayer.id,features:e}:!1)},function(){t.resolve(!1)}),t.promise},identifyForestUse:function(e){var t=new a,r=new E(I.forestUseLayers.url),i=new C;return i.tolerance=3,i.returnGeometry=!0,i.width=D.width,i.height=D.height,i.geometry=e,i.mapExtent=D.extent,i.layerIds=D.getLayer(I.forestUseLayers.id).visibleLayers,i.layerOption=C.LAYER_OPTION_VISIBLE,r.execute(i,function(e){t.resolve(e.length>0?{layer:I.forestUseLayers.id,features:e}:!1)},function(){t.resolve(!1)}),t.promise},identifyConservation:function(e){var t=new a,r=new E(I.conservationLayers.url),i=new C;return i.tolerance=3,i.returnGeometry=!0,i.width=D.width,i.height=D.height,i.geometry=e,i.mapExtent=D.extent,i.layerIds=D.getLayer(I.conservationLayers.id).visibleLayers,i.layerOption=C.LAYER_OPTION_VISIBLE,r.execute(i,function(e){t.resolve(e.length>0?{layer:I.conservationLayers.id,features:e}:!1)},function(){t.resolve(!1)}),t.promise},identifyFireStories:function(e){var t=I.fireStories.url.split("/10");t=t[0];var r=new a,i=new E(t),n=new C;return n.tolerance=5,n.returnGeometry=!1,n.width=D.width,n.height=D.height,n.geometry=e,n.mapExtent=D.extent,n.layerIds=[10],n.layerOption=C.LAYER_OPTION_VISIBLE,i.execute(n,function(e){r.resolve(e.length>0?{layer:"Fire_Stories",features:e}:!1)},function(){r.resolve(!1)}),r.promise},identifyFireTweets:function(e){var t=I.tweetLayer.url.split("/3");t=t[0];var r=new a,i=new E(t),n=new C;return n.tolerance=5,n.returnGeometry=!1,n.width=D.width,n.height=D.height,n.geometry=e,n.mapExtent=D.extent,n.layerIds=[3],n.layerOption=C.LAYER_OPTION_VISIBLE,i.execute(n,function(e){r.resolve(e.length>0?{layer:"Fire_Tweets",features:e}:!1)},function(){r.resolve(!1)}),r.promise},setOverlaysTemplates:function(e){var r,i=[];return t.forEach(e,function(e){1===e.layerId?(r=new b("Village: "+e.value,"<table><tr><td>Subdistrict:</td><td>"+e.feature.attributes.SUBDISTRIC+"</td></tr><tr><td>District:</td><td>"+e.feature.attributes.DISTRICT+"</td></tr><tr style='height:10px;'></tr></table>"),e.feature.attributes.ALERTS_LABEL=e.value):2===e.layerId?(r=new b("Subdistrict: "+e.value,"<table><tr><td>District:</td><td>"+e.feature.attributes.DISTRICT+"</td></tr><tr><td>Province:</td><td>"+e.feature.attributes.PROVINCE+"</td></tr><tr style='height:10px;'></tr></table>"),e.feature.attributes.ALERTS_LABEL=e.value):3===e.layerId?(r=new b("District: "+e.feature.attributes.DISTRICT,"<table><tr><td>Province:</td><td>"+e.feature.attributes.PROVINCE+"</td></tr><tr><td>Island:</td><td>"+e.feature.attributes.ISLAND+"</td></tr><tr style='height:10px;'></tr></table>"),e.feature.attributes.ALERTS_LABEL=e.feature.attributes.DISTRICT):(r=new b("Province: "+e.value,"<table><tr><td>Island:</td><td>"+e.feature.attributes.ISLAND+"</td></tr><tr style='height:10px;'></tr></table>"),e.feature.attributes.ALERTS_LABEL=e.value),e.feature.setInfoTemplate(r),i.push(e.feature)}),0==$("#uploadCustomGraphic").length&&$(".sizer > .actionsPane").append("<div id='uploadCustomGraphic' class='uploadCustomGraphic'>Subscribe</div>"),i},setForestUseTemplates:function(e){var r,i="",a=[];return t.forEach(e,function(e){27===e.layerId?(i+="<table><tr><td>Concession Type</td><td>"+e.feature.attributes.TYPE+"</td></tr>",i+="<tr><td>Country</td><td>"+e.feature.attributes.Country+"</td></tr>",i+="<tr><td>Certification Status</td><td>"+e.feature.attributes.CERT_STAT+"</td></tr>",i+="<tr><td>GIS Calculated Area (ha)</td><td>"+e.feature.attributes.AREA_HA+"</td></tr>",i+="<tr><td>Certificate ID</td><td>"+e.feature.attributes.Certificat+"</td></tr>",i+="<tr><td>Certificate Issue Date</td><td>"+e.feature.attributes.Issued+"</td></tr>",i+="<tr><td>Certificate Expiry Date</td><td>"+e.feature.attributes.Expired+"</td></tr>",i+="<tr><td>Mill name</td><td>"+e.feature.attributes.Mill+"</td></tr>",i+="<tr><td>Mill location</td><td>"+e.feature.attributes.Location+"</td></tr>",i+="<tr><td>Mill capacity (t/hour)</td><td>"+e.feature.attributes.Capacity+"</td></tr>",i+="<tr><td>Certified CPO (mt)</td><td>"+e.feature.attributes.CPO+"</td></tr>",i+="<tr><td>Certified PK (mt)</td><td>"+e.feature.attributes.PK+"</td></tr>",i+="<tr><td>Estate Suppliers</td><td>"+e.feature.attributes.Estate+"</td></tr>",i+="<tr><td>Estate Area (ha)</td><td>"+e.feature.attributes.Estate_1+"</td></tr>",i+="<tr><td>Outgrower Area (ha)</td><td>"+e.feature.attributes.Outgrowe+"</td></tr>",i+="<tr><td>Scheme Smallholder Area (ha)</td><td>"+e.feature.attributes.SH+"</td></tr>",i+="<tr><td>Source: </td><td>"+(e.feature.attributes.Source||"N/A")+"</td></tr><tr style='height:10px;'></tr></table>",r=new b("<strong>"+e.value+"</strong>",i),e.feature.attributes.ALERTS_LABEL=e.value):16===e.layerId?(i+="<table><tr><td>Base</td><td>"+e.feature.attributes.Base+"</td></tr>",i+="<tr><td>AltMode</td><td>"+e.feature.attributes.AltMode+"</td></tr><tr style='height:10px;'></tr></table>",r=new b("<strong>"+e.feature.attributes.Name+"</strong>",i),e.feature.attributes.ALERTS_LABEL=e.value):(i+="<table><tr><td>Concession Type</td><td>"+e.feature.attributes.TYPE+"</td></tr>",i+="<tr><td>Country</td><td>"+e.feature.attributes.Country+"</td></tr>",i+="<tr><td>Certification Status</td><td>"+e.feature.attributes.CERT_STAT+"</td></tr>",i+="<tr><td>GIS Calculated Area (ha)</td><td>"+e.feature.attributes.AREA_HA+"</td></tr>",i+="<tr><td>Source: </td><td>"+(e.feature.attributes.Source||"N/A")+"</td></tr><tr style='height:10px;'></tr></table>",r=new b("<strong>"+e.value+"</strong>",i),e.feature.attributes.ALERTS_LABEL=e.value),e.feature.setInfoTemplate(r),a.push(e.feature)}),0==$("#uploadCustomGraphic").length&&$(".sizer > .actionsPane").append("<div id='uploadCustomGraphic' class='uploadCustomGraphic'>Subscribe</div>"),a},setConservationTemplates:function(e){var r,i=[];return t.forEach(e,function(e){r=new b("Protected Areas ","<table><tr class='infoName'><td colspan='2'>"+e.feature.attributes.NAME+"</td></tr><tr><td>Local Name</td><td>"+e.feature.attributes.ORIG_NAME+"</td></tr><tr><td>Legal Designation</td><td>"+e.feature.attributes.DESIG_ENG+"</td></tr><tr><td>WDPA ID</td><td>"+e.feature.attributes.WDPAID+"</td></tr><tr style='height:10px;'></tr></table>"),e.feature.attributes.ALERTS_LABEL=e.value,e.feature.setInfoTemplate(r),i.push(e.feature)}),0==$("#uploadCustomGraphic").length&&$(".sizer > .actionsPane").append("<div id='uploadCustomGraphic' class='uploadCustomGraphic'>Subscribe</div>"),i},getTomnodInfoWindow:function(e){var t=I.tomnodLayer,r=(t.url,e),i="";if(r){var a=new Date(r.attributes.ImageAquisitionDate),n=a.getMonth()+1,o=a.getDate(),s=a.getFullYear();return a=n+"/"+o+"/"+s,executeReturned=!1,i+=" <div><h3>"+r.attributes.name+"</h3></div>",i+="<tr><td><img src='"+t.chipBucket+r.attributes.ChipLink,i+="' style='width:300px' /></tc></tr>",i+="<div><strong>Image Acquisition Date:</strong> "+a+"</div>",i+="<div><strong>Confirmation:</strong> "+r.attributes.Confirmation+" people</div>",i+="<div><b>Crowd Rank:</b> "+r.attributes.CrowdRank+"%</div>",i+="<a href='"+r.attributes.ImageLink,i+="' target='_blank'>See this point on ",i+="<img style='height:20px;width:100px;' src='app/images/tomnod_logo.png'></div>"}},selectTomnodFeatures:function(r){var a=I.tomnodLayer,n=(e.byId("landsat-image-checkbox"),this),o=a.url,s=new E(o),u=new C,l=(new T(o),new S),c=r.mapPoint,f=(i(".selected-fire-option")[0],new Date,new Date,[]);if(!D.getLayer(a.id).visible){n.getActiveFiresInfoWindow(r),n.getArchiveFiresInfoWindow(r);var p=e.byId("noaa-fires-18"),m=e.byId("indonesia-fires"),b=e.byId("fires-checkbox");return"true"==p.getAttribute("aria-checked")&&"true"==m.getAttribute("aria-checked")||"true"==p.getAttribute("aria-checked")&&"true"==b.getAttribute("aria-checked")?setTimeout(function(){D.infoWindow.isShowing||n.getArchiveNoaaInfoWindow(r)},800):n.getArchiveNoaaInfoWindow(r),void setTimeout(function(){D.infoWindow.isShowing||n.getDigitalGlobeInfoWindow(r)},400)}u.geometry=c,u.tolerance=3,u.returnGeometry=!1,u.layerDefinitions=f,u.mapExtent=D.extent,u.layerIds=[8],l.where="OBJECTID in (",l.returnGeometry=!1,l.outFields=["OBJECTID","ChipLink","CrowdRank","Confirmation","name","ImageLink"];var y=[];s.execute(u,function(e){return t.forEach(e,function(e){y.push(e.feature.attributes.OBJECTID)}),y.length<1?(D.infoWindow.setFeatures(void 0),n.getActiveFiresInfoWindow(r),n.getDigitalGlobeInfoWindow(r),n.getArchiveFiresInfoWindow(r),void n.getArchiveNoaaInfoWindow(r)):(D.infoWindow.resize(340,500),l.where+=y.join(",")+")",selected_features=D.getLayer(I.tomnodLayer.sel_id).selectFeatures(l,d.SELECTION_NEW),void selected_features.then(function(e){D.infoWindow.setFeatures(e),D.infoWindow.resize(340,500),D.infoWindow.show(r.mapPoint)}))},function(){n.mapClick(r)})},getActiveFiresInfoWindow:function(e){var r=I.firesLayer,a=this,n=r.url,o=new E(n),s=new C,u=e.mapPoint,d=!0,l=i(".selected-fire-option")[0],c=new Date,f=new Date,p="",m="",b=[];if(!D.getLayer(r.id).visible)return void a.mapClick(e);switch(l.id){case"fires72":c.setDate(c.getDate()-4),f.setDate(f.getDate()-3);break;case"fires48":c.setDate(c.getDate()-3),f.setDate(f.getDate()-2);break;case"fires24":c.setDate(c.getDate()-2),f.setDate(f.getDate()-1);break;default:c.setDate(c.getDate()-8),f.setDate(f.getDate()-7)}m=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate()+" "+c.getHours()+":"+c.getMinutes()+":"+c.getSeconds(),p=f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate()+" "+f.getHours()+":"+f.getMinutes()+":"+f.getSeconds();for(var y=0,h=I.firesLayer.defaultLayers.length;h>y;y++)b[y]="ACQ_DATE > date '"+m+"'";s.geometry=u,s.tolerance=3,s.returnGeometry=!1,s.layerDefinitions=b,s.mapExtent=D.extent,s.layerOption=C.LAYER_OPTION_VISIBLE;var g="</div><table id='infoWindowTable'>";o.execute(s,function(i){var n=D,o=i[0];o?(d=!1,g+="<tr class='infoName'><td colspan='3'>Active Fires</td><td colspan='2'></td></tr>",t.forEach(r.query.fields,function(e){g+="<tr><td colspan='3'>"+e.label+"</td>",g+="<td colspan='2'>"+o.feature.attributes[e.name]+"</td></tr>"}),g+="</table>",n.infoWindow.setContent(g),n.infoWindow.resize(270,140),n.infoWindow.show(u)):a.mapClick(e)},function(){a.mapClick(e)})},getArchiveFiresInfoWindow:function(r){var i=I.indonesiaLayers,a=this,n=i.url,o=new E(n),s=new C,u=r.mapPoint,d=!0,l=(new Date,new Date,e.byId("indonesia-fires"));if(!D.getLayer(i.id).visible||1!=l.checked)return void a.mapClick(r);s.layerDefinitions=D.getLayer(i.id).layerDefinitions,s.geometry=u,s.tolerance=3,s.returnGeometry=!1,s.mapExtent=D.extent,s.layerOption=C.LAYER_OPTION_ALL,s.layerIds=[0];var c=(D.getLayer(i.id),"</div><table id='infoWindowTable'>");o.execute(s,function(e){var n=D,o=e[0];if(o){if(2==o.layerId)return;d=!1,c+="<tr class='infoName'><strong>NASA archived fires for Indonesia</strong></tr>",t.forEach(i.query.fields,function(e){c+="<tr><td colspan='3'>"+e.label+"</td>",c+="<td colspan='2'>"+o.feature.attributes[e.name]+"</td></tr>"}),c+="</table>",n.infoWindow.setContent(c),n.infoWindow.resize(270,140),n.infoWindow.show(u)}else a.mapClick(r)},function(){a.mapClick(r)})},getLandsatInfoWindow:function(e){var r=I.landsat8,i=new f,a=new p(r.url);i.geometry=e.mapPoint,i.returnCatalogItems=!0,i.f="json",i.returnGeometry=!0,i.renderingRule=new m({rasterFunction:"Stretch",rasterFunctionArguments:{StretchType:6,DRA:!0,Gamma:[1.4,1.4,1.4],UseGamma:!0,MinPercent:.5,MaxPercent:.5},outputPixelType:"U8"}),i.pixelSizeX=100,i.pixelSizeY=100,a.execute(i,function(r){t.forEach(r.catalogItems.features,function(e){e.infoTemplate=new b("Acquisition Date","<tr><td>${AcquisitionDate: PopupDateFormat}</td></td>")}),D.infoWindow.setFeatures(r.catalogItems.features),D.infoWindow.show(e.mapPoint)},function(e){console.dir(e)})},getArchiveNoaaInfoWindow:function(t){var r=I.indonesiaLayers,i=this,a=r.url,n=new E(a),o=new C,s=t.mapPoint,u=!0,d=(new Date,new Date,e.byId("noaa-fires-18"));if("false"!=d.getAttribute("aria-checked")&&D.getLayer("IndonesiaFires").visible){o.geometry=s,o.tolerance=3,o.returnGeometry=!1,o.mapExtent=D.extent,o.layerOption=C.LAYER_OPTION_ALL,o.layerIds=[9];{D.getLayer(r.id)}n.execute(o,function(e){var r=D,a=e[0];if(a){if(2==a.layerId)return;u=!1;var n=a.feature.attributes.Date,o=n.split(" "),o=o[0],d="</div><table id='infoWindowTable'>";d+="<tr class='infoName'><strong>NOAA-18 fires</strong></tr>",d+="<tr><td colspan='3'>DATE</td>",d+="<td colspan='2'>"+o+"</td></tr>",d+="</table>",r.infoWindow.setContent(d),r.infoWindow.resize(170,50),r.infoWindow.show(s)}else i.mapClick(t)},function(){i.mapClick(t)})}},getNOAAFiresInfoWindow:function(e){{var r=I.indonesiaLayers,i=this,a=r.url,n=new E(a),o=new C,s=e.mapPoint,u=!0;new Date,new Date}if(!D.getLayer(r.id).visible)return void i.mapClick(e);o.geometry=s,o.tolerance=10,o.returnGeometry=!1,o.mapExtent=D.extent,o.layerOption=C.LAYER_OPTION_ALL;var d="</div><table id='infoWindowTable'>";n.execute(o,function(a){var n=D,o=a[0];o?(u=!1,d+="<tr class='infoName'><strong>NASA archived fires for Indonesia</strong></tr>",t.forEach(r.query.fields,function(e){d+="<tr><td colspan='3'>"+e.label+"</td>",d+="<td colspan='2'>"+o.feature.attributes[e.name]+"</td></tr>"}),d+="</table>",n.infoWindow.setContent(d),n.infoWindow.show(s)):(console.log("No result returned!"),i.mapClick(e))},function(){i.mapClick(e)})},getDigitalGlobeInfoWindow:function(o){var s=(I.digitalGlobe,D.getLayer(I.digitalGlobe.graphicsLayerId),new S);if((!o.graphic||"Digital_Globe"===o.graphic.attributes.Layer)&&void 0!==o.graphic){s.geometry=o.graphic.geometry,s.where="Category = 1",s.returnGeometry=!1,s.outFields=["*"];var u,d=(n(I.digitalGlobe.mosaics.map(function(e){var t=new a;s.geometry=o.graphic.geometry,s.returnGeometry=!1,s.outFields=["*"];var r=new T(I.digitalGlobe.imagedir+e+"/ImageServer");return r.execute(s,function(e){t.resolve(e.features)},function(){t.resolve([])}),t.promise})).then(function(a){var n="",o=[],s=dijit.byId("timeSliderDG").thumbIndexes,d=dijit.byId("timeSliderDG").timeStops,l=moment(d[s[0]]).tz("Asia/Jakarta"),p=moment(d[s[1]]).tz("Asia/Jakarta");a.map(function(e){e.map(function(e){o.push(e)})}),o.sort(function(e,t){return e.attributes.AcquisitionDate==t.attributes.AcquisitionDate?0:e.attributes.AcquisitionDate>t.attributes.AcquisitionDate?-1:1}),n+="<p>Click a date below to see the imagery.</p><ul class='popup-list'><li><strong>Date <span class='satelliteColumn'>Satellite</span></strong></li>",t.forEach(o,function(e){var t=moment(e.attributes.AcquisitionDate).tz("Asia/Jakarta");t>=l&&p>=t&&(n+="<li><a class='popup-link' data-bucket='"+e.attributes.SensorName+"_id_"+e.attributes.OBJECTID+"'> "+t.format("YYYY/MM/DD")+"  <span class='satelliteColumn' data-bucket='"+e.attributes.SensorName+"_id_"+e.attributes.OBJECTID+"'>"+e.attributes.SensorName+"</span></a></li>")}),n+="</ul><a class='custom-zoom-to' id='custom-zoom-to'>Zoom To</a>",D.infoWindow.setContent(n),D.infoWindow.resize(270,500),D.infoWindow.show(c),u=0,i(".contentPane .popup-link").forEach(function(e,t){f.push(r(e,"click",function(e){var r=e.target?e.target:e.srcElement,i=r.dataset?r.dataset.bucket:r.getAttribute("data-bucket");$("#imageryWindow > table > tbody > tr").each(function(){$(this).removeClass("imageryRowSelected");var e=this.firstElementChild;e=$(e).html(),e=$(e).attr("data-bucket"),i==e&&$(this).addClass("imageryRowSelected")});var a=i.split("_"),n={};n.feature={},n.feature.attributes={},n.feature.attributes.SensorName=a[0],n.feature.attributes.OBJECTID=a[2],A.showDigitalGlobeImagery(n),u=t}))}),f.push(r(e.byId("custom-zoom-to"),"click",function(){var e=new h(o[u].attributes.CenterX,o[u].attributes.CenterY,D.spatialReference);D.centerAndZoom(e,12)})),r.once(D.infoWindow,"hide",function(){t.forEach(f,function(e){e.remove()})})}),I.digitalGlobe.identifyUrl),l=(new E(d),new C),c=o.mapPoint,f=[];l.geometry=c,l.tolerance=3,l.returnGeometry=!0,l.mapExtent=D.extent,l.layerOption=C.LAYER_OPTION_VISIBLE,l.layerIds=[0]}},getFireTweetsInfoWindow:function(e){var t,r,i=[];D.infoWindow.anchor="ANCHOR_UPPERRIGHT";for(var a=0;a<e.length;a++){t=e[a].feature.attributes,r="<table>";for(var n in t)!t[n]||"UserName"!=n&&"Text"!=n&&"Date"!=n&&"UserProfileImage"!=n||(r+="UserProfileImage"==n?"<tr><td><img src='"+e[a].feature.attributes.UserProfileImage+"'/></td></tr>":"<tr><td>"+n+": "+t[n]+"</td></tr>");r+="</div>",template=new b(e[a].feature.attributes.UserName,r),e[a].feature.setInfoTemplate(template),i.push(e[a].feature)}return i},getFireStoriesInfoWindow:function(e){D.infoWindow.anchor="ANCHOR_UPPERRIGHT";for(var t,r=[],i=0;i<e.length;i++){for(t in e[i].feature.attributes)"Null"==e[i].feature.attributes[t]&&(e[i].feature.attributes[t]="");var a=new y({title:"{Title}",fieldInfos:[{fieldName:"Date",label:"Date",format:{dateFormat:"shortDate"},visible:!0},{fieldName:"Details",label:"Details",visible:!0},{fieldName:"Video",label:"Video",visible:!0},{fieldName:"Name",label:"Name",visible:!0}],showAttachments:!0});e[i].feature.setInfoTemplate(a),r.push(e[i].feature)}return r},selectUploadOrDrawnGraphics:function(t){$("#uploadCustomGraphic").length>0&&$("#uploadCustomGraphic").remove();var i,a,n,o=t.graphic,s=I.defaultGraphicsLayerUniqueId,d=(I.defaultGraphicsLayerLabel,this);t.stopPropagation(),n="<strong>Drawn/Uploaded Feature</strong>",i="Name: <input id='editTitle' style='width:165px;' class='editshow' placeholder='Type a new name & hit enter'/><br/><div id='uploadCustomGraphic' class='uploadCustomGraphic'><span id='customGraphicSymbol'></span>Subscribe</div><div id='deleteCustomGraphic' class='deleteGraphicLink'>&#10007 Remove</div>";var l=(D.graphics.graphics,L.vm.customFeaturesArray.indexOf(o));D.infoWindow.setTitle(L.vm.customFeaturesArray()[l].attributes.ALERTS_LABEL),D.infoWindow.setContent(i),D.infoWindow.show(t.mapPoint),r(e.byId("editTitle"),"keypress",function(t){var r=t.keyCode;if(r===u.ENTER){var i=L.vm.customFeaturesArray()[o.attributes.UNIQUE_GRAPHIC_ID-1];i.attributes.ALERTS_LABEL=a;var a=e.byId("editTitle").value;D.infoWindow.setTitle("<strong>"+a+"</strong>"),o.attributes.ALERTS_LABEL=a}}),a=r.once(e.byId("deleteCustomGraphic"),"click",function(){A.removeGraphicWithId(o.attributes[s],s),0===D.graphics.graphics.length&&L.vm.customFeaturesPresence(!1),D.infoWindow.hide()}),handleSubscribe=r.once(e.byId("uploadCustomGraphic"),"click",function(){var e=o;d.subscribeToAlerts(e),D.infoWindow.hide()}),r.once(D.infoWindow,"hide",function(){a.remove(),handleSubscribe.remove()})},subscribeToAlerts:function(t){var r=this;require(["dojo/on","dijit/Dialog","dojo/dom-construct"],function(i,a){function n(){o.remove(),s.destroy(),telInput.intlTelInput("destroy")}var o,s=new a({id:"subscribeDialogWindow",title:"Subscribe to Alerts!",refocus:!1,style:"width: 300px;"}),u="<div class='subscription-content'><p>Enter your email below to receive fire alerts</p><div class='email-container'><input id='userEmail' type='text' placeholder='Email'/></div><p>Enter your phone number below to receive SMS alerts</p><div class='phone-container'><input id='userPhone' type='tel' placeholder='Phone Number'/></div><div class='submit-container'><button id='subscribe-now'>Subscribe</button></div><div id='form-response' class='message-container'></div></div>";u+="<input type='email' name='verify_email' id='verifyEmailForAlertsInMap' placeholder='Verify Email(Leave blank if your human)'/>",s.on("hide",n),s.setContent(u),s.show(),telInput=$("#userPhone"),telInput.intlTelInput({validationScript:"./app/libs/isValidNumber.js"}),o=i(e.byId("subscribe-now"),"click",function(){require(["dojox/validate/web","dojo/dom-style"],function(i,a){if(honeyPotValue=e.byId("verifyEmailForAlertsInMap").value,""!==honeyPotValue)return void s.destroy();if(emailValue=e.byId("userEmail").value,phoneValue=e.byId("userPhone").value,!emailValue&&!phoneValue)return a.set("userPhone","border","1px solid red"),a.set("userEmail","border","1px solid red"),void alert("You must enter an email or phone number");if(emailValue){if(!i.isEmailAddress(emailValue))return a.set("userEmail","border","1px solid red"),void alert("You must enter a valid email address!");a.set("userEmail","border","1px solid gray"),e.byId("subscribe-now").innerHTML="Submitting...",r.postSubscribeRequest(t,emailValue,"email",s),Analytics.sendEvent("Subscribe","click","Fire Alerts","User is subscribing to Fire Alerts via Email.")}phoneValue&&(a.set("userPhone","border","1px solid gray"),e.byId("subscribe-now").innerHTML="Submitting...",r.postSubscribeRequest(t,phoneValue,"sms",s),Analytics.sendEvent("Subscribe","click","Fire Alerts","User is subscribing to Fire Alerts via SMS."))})})})},postSubscribeRequest:function(e,t,r,i){"sms"===r&&(t=t.replace(/\D/g,""));var n=w.emailSubscribeUrlPoly,s=new a,u={features:JSON.stringify({rings:e.geometry.rings,spatialReference:e.geometry.spatialReference}),msg_addr:t,msg_type:r,area_name:e.attributes.ALERTS_LABEL};return o(n,{handleAs:"json",method:"POST",data:u}).then(function(){i.setContent(emailValue&&phoneValue?"<p>You have successfully subscribed. You will receive an email asking you to <strong>verify your subscription</strong>. Please be sure to check your SPAM folder. Once verified, you will start receiving alerts for your area.</p>":emailValue&&!phoneValue?"<p>You have successfully subscribed. You will receive an email asking you to <strong>verify your subscription</strong>. Please be sure to check your SPAM folder. Once verified, you will start receiving alerts for your area.</p>":"<p>You have successfully subscribed, you should start receiving SMS alerts as they come in for your area of interest.</p>"),s.resolve(!0)},function(e){alert("There was an error subsrcribing at this time. "+e.message),i.destroy(),s.resolve(!1)}),s.promise},setupInfowindowListeners:function(){var t,i=this;r(map.infoWindow,"selection-change",function(){setTimeout(function(){e.byId("uploadCustomGraphic")&&(t&&t.remove(),t=r(e.byId("uploadCustomGraphic"),"click",function(){var e=map.infoWindow.selectedIndex,t=map.infoWindow.features[e];i.subscribeToAlerts(t)}))},0)}),r(map.infoWindow,"hide",function(){t&&t.remove()})}}});