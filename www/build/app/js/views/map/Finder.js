define(["dojo/dom","dojo/_base/array","dojo/on","dojo/query","dojo/Deferred","dojo/promise/all","dojo/request/xhr","dojo/dom-attr","dojo/keys","esri/layers/FeatureLayer","esri/graphic","esri/request","esri/tasks/ImageServiceIdentifyParameters","esri/tasks/ImageServiceIdentifyTask","esri/layers/RasterFunction","esri/InfoTemplate","esri/geometry/Point","esri/geometry/webMercatorUtils","esri/symbols/PictureMarkerSymbol","main/Config","views/map/MapConfig","views/map/MapModel","views/map/LayerController","esri/tasks/IdentifyTask","esri/tasks/IdentifyParameters","esri/tasks/query","esri/tasks/QueryTask","esri/geometry/Circle"],function(e,t,r,a,i,n,o,s,u,d,l,c,f,m,p,b,y,h,v,g,w,I,L,A,E,C,T){var D;return{setMap:function(e){D=e,window.PopupDateFormat=function(e){return new Date(e)}},clickNext:"",searchAreaByCoordinates:function(){var r,a,i,n,o={},s=!1,u="You did not enter a valid value.  Please check that your location values are all filled in and nubmers only.",d=new v("app/images/RedStickpin.png",32,32),c={},f=function(e){return s||(s=isNaN(parseInt(e))),isNaN(parseInt(e))?0:parseInt(e)},m=function(){var e=0;return t.forEach(D.graphics.graphics,function(t){t.attributes&&t.attributes.locatorValue&&(e=Math.max(e,parseInt(t.attributes.locatorValue)))}),e};I.get("showDMSInputs")?(o.dlat=f(e.byId("degreesLatInput").value),o.mlat=f(e.byId("minutesLatInput").value),o.slat=f(e.byId("secondsLatInput").value),o.dlon=f(e.byId("degreesLonInput").value),o.mlon=f(e.byId("minutesLonInput").value),o.slon=f(e.byId("secondsLonInput").value),r=o.dlat+o.mlat/60+o.slat/3600,a=o.dlon+o.mlon/60+o.slon/3600):(r=f(e.byId("latitudeInput").value),a=f(e.byId("longitudeInput").value)),s?alert(u):(i=h.geographicToWebMercator(new y(a,r)),c.locatorValue=m(),c.id="LOCATOR_"+c.locatorValue,n=new l(i,d,c),D.graphics.add(n),D.centerAndZoom(i,7),I.set("showClearPinsOption",!0))},fetchTwitterData:function(e){var t=e.target?e.target:e.srcElement;!t.checked},mapClick:function(e){var r=D,a=this,i=e.mapPoint,o=[],s=[];r.infoWindow.clearFeatures(),overlaysLayer=r.getLayer(w.overlaysLayer.id),overlaysLayer&&overlaysLayer.visible&&o.push(a.identifyOverlays(i)),forestUseLayer=r.getLayer(w.forestUseLayers.id),forestUseLayer&&forestUseLayer.visible&&o.push(a.identifyForestUse(i)),conservationLayers=r.getLayer(w.conservationLayers.id),conservationLayers&&conservationLayers.visible&&o.push(a.identifyConservation(i)),console.log(o),0!==o.length&&n(o).then(function(e){t.forEach(e,function(e){switch(e.layer){case"Overlays_Layer":s=s.concat(a.setOverlaysTemplates(e.features));break;case"Forest_Use":s=s.concat(a.setForestUseTemplates(e.features));break;case"Conservation":s=s.concat(a.setConservationTemplates(e.features))}}),s.length>0&&(r.infoWindow.setFeatures(s),r.infoWindow.show(i))})},identifyOverlays:function(e){var t=new i,r=new A(w.overlaysLayer.url),a=new E;return a.tolerance=3,a.maxAllowableOffset=100,a.returnGeometry=!0,a.width=D.width,a.height=D.height,a.geometry=e,a.mapExtent=D.extent,a.layerIds=D.getLayer(w.overlaysLayer.id).visibleLayers,a.layerOption=E.LAYER_OPTION_VISIBLE,r.execute(a,function(e){t.resolve(e.length>0?{layer:w.overlaysLayer.id,features:e}:!1)},function(){t.resolve(!1)}),t.promise},identifyForestUse:function(e){var t=new i,r=new A(w.forestUseLayers.url),a=new E;return a.tolerance=3,a.returnGeometry=!0,a.width=D.width,a.height=D.height,a.geometry=e,a.mapExtent=D.extent,a.layerIds=D.getLayer(w.forestUseLayers.id).visibleLayers,a.layerOption=E.LAYER_OPTION_VISIBLE,r.execute(a,function(e){t.resolve(e.length>0?{layer:w.forestUseLayers.id,features:e}:!1)},function(){t.resolve(!1)}),t.promise},identifyConservation:function(e){var t=new i,r=new A(w.conservationLayers.url),a=new E;return a.tolerance=3,a.returnGeometry=!0,a.width=D.width,a.height=D.height,a.geometry=e,a.mapExtent=D.extent,a.layerIds=D.getLayer(w.conservationLayers.id).visibleLayers,a.layerOption=E.LAYER_OPTION_VISIBLE,r.execute(a,function(e){t.resolve(e.length>0?{layer:w.conservationLayers.id,features:e}:!1)},function(){t.resolve(!1)}),t.promise},setOverlaysTemplates:function(e){var r,a=[];return t.forEach(e,function(e){1===e.layerId?(r=new b("Village: "+e.value,"<table><tr><td>Subdistrict:</td><td>"+e.feature.attributes.SUBDISTRIC+"</td></tr><tr><td>District:</td><td>"+e.feature.attributes.DISTRICT+"</td></tr><tr style='height:10px;'></tr></table>"),e.feature.attributes.ALERTS_LABEL=e.value):2===e.layerId?(r=new b("Subdistrict: "+e.value,"<table><tr><td>District:</td><td>"+e.feature.attributes.DISTRICT+"</td></tr><tr><td>Province:</td><td>"+e.feature.attributes.PROVINCE+"</td></tr><tr style='height:10px;'></tr></table>"),e.feature.attributes.ALERTS_LABEL=e.value):3===e.layerId?(r=new b("District: "+e.feature.attributes.DISTRICT,"<table><tr><td>Province:</td><td>"+e.feature.attributes.PROVINCE+"</td></tr><tr><td>Island:</td><td>"+e.feature.attributes.ISLAND+"</td></tr><tr style='height:10px;'></tr></table>"),e.feature.attributes.ALERTS_LABEL=e.feature.attributes.DISTRICT):(r=new b("Province: "+e.value,"<table><tr><td>Island:</td><td>"+e.feature.attributes.ISLAND+"</td></tr><tr style='height:10px;'></tr></table>"),e.feature.attributes.ALERTS_LABEL=e.value),r.content+="<br /><div id='uploadCustomGraphic' class='uploadCustomGraphic'>Subscribe</div>",e.feature.setInfoTemplate(r),a.push(e.feature)}),a},setForestUseTemplates:function(e){var r,a="",i=[];return t.forEach(e,function(e){27===e.layerId?(a+="<table><tr><td>Concession Type</td><td>"+e.feature.attributes.TYPE+"</td></tr>",a+="<tr><td>Country</td><td>"+e.feature.attributes.Country+"</td></tr>",a+="<tr><td>Certification Status</td><td>"+e.feature.attributes.CERT_STAT+"</td></tr>",a+="<tr><td>GIS Calculated Area (ha)</td><td>"+e.feature.attributes.AREA_HA+"</td></tr>",a+="<tr><td>Certificate ID</td><td>"+e.feature.attributes.Certificat+"</td></tr>",a+="<tr><td>Certificate Issue Date</td><td>"+e.feature.attributes.Issued+"</td></tr>",a+="<tr><td>Certificate Expiry Date</td><td>"+e.feature.attributes.Expired+"</td></tr>",a+="<tr><td>Mill name</td><td>"+e.feature.attributes.Mill+"</td></tr>",a+="<tr><td>Mill location</td><td>"+e.feature.attributes.Location+"</td></tr>",a+="<tr><td>Mill capacity (t/hour)</td><td>"+e.feature.attributes.Capacity+"</td></tr>",a+="<tr><td>Certified CPO (mt)</td><td>"+e.feature.attributes.CPO+"</td></tr>",a+="<tr><td>Certified PK (mt)</td><td>"+e.feature.attributes.PK+"</td></tr>",a+="<tr><td>Estate Suppliers</td><td>"+e.feature.attributes.Estate+"</td></tr>",a+="<tr><td>Estate Area (ha)</td><td>"+e.feature.attributes.Estate_1+"</td></tr>",a+="<tr><td>Outgrower Area (ha)</td><td>"+e.feature.attributes.Outgrowe+"</td></tr>",a+="<tr><td>Scheme Smallholder Area (ha)</td><td>"+e.feature.attributes.SH+"</td></tr>",a+="<tr><td>Source: </td><td>"+(e.feature.attributes.Source||"N/A")+"</td></tr><tr style='height:10px;'></tr></table>",r=new b("<strong>"+e.value+"</strong>",a),e.feature.attributes.ALERTS_LABEL=e.value):16===e.layerId?(a+="<table><tr><td>Base</td><td>"+e.feature.attributes.Base+"</td></tr>",a+="<tr><td>AltMode</td><td>"+e.feature.attributes.AltMode+"</td></tr><tr style='height:10px;'></tr></table>",r=new b("<strong>"+e.feature.attributes.Name+"</strong>",a),e.feature.attributes.ALERTS_LABEL=e.value):(a+="<table><tr><td>Concession Type</td><td>"+e.feature.attributes.TYPE+"</td></tr>",a+="<tr><td>Country</td><td>"+e.feature.attributes.Country+"</td></tr>",a+="<tr><td>Certification Status</td><td>"+e.feature.attributes.CERT_STAT+"</td></tr>",a+="<tr><td>GIS Calculated Area (ha)</td><td>"+e.feature.attributes.AREA_HA+"</td></tr>",a+="<tr><td>Source: </td><td>"+(e.feature.attributes.Source||"N/A")+"</td></tr><tr style='height:10px;'></tr></table>",r=new b("<strong>"+e.value+"</strong>",a),e.feature.attributes.ALERTS_LABEL=e.value),r.content+="<br /><div id='uploadCustomGraphic' class='uploadCustomGraphic'>Subscribe</div>",e.feature.setInfoTemplate(r),i.push(e.feature)}),i},setConservationTemplates:function(e){var r,a=[];return t.forEach(e,function(e){r=new b("Protected Areas ","<table><tr class='infoName'><td colspan='2'>"+e.feature.attributes.NAME+"</td></tr><tr><td>Local Name</td><td>"+e.feature.attributes.ORIG_NAME+"</td></tr><tr><td>Legal Designation</td><td>"+e.feature.attributes.DESIG_ENG+"</td></tr><tr><td>WDPA ID</td><td>"+e.feature.attributes.WDPAID+"</td></tr><tr style='height:10px;'></tr></table>"),e.feature.attributes.ALERTS_LABEL=e.value,r.content+="<br /><div id='uploadCustomGraphic' class='uploadCustomGraphic'>Subscribe</div>",e.feature.setInfoTemplate(r),a.push(e.feature)}),a},getTomnodInfoWindow:function(e){var t=w.tomnodLayer,r=(t.url,e),a="";if(r){var i=new Date(r.attributes.ImageAquisitionDate),n=i.getMonth()+1,o=i.getDate(),s=i.getFullYear();return i=n+"/"+o+"/"+s,executeReturned=!1,a+=" <div><h3>"+r.attributes.name+"</h3></div>",a+="<tr><td><img src='"+t.chipBucket+r.attributes.ChipLink,a+="' style='width:300px' /></tc></tr>",a+="<div><strong>Image Acquisition Date:</strong> "+i+"</div>",a+="<div><strong>Confirmation:</strong> "+r.attributes.Confirmation+" people</div>",a+="<div><b>Crowd Rank:</b> "+r.attributes.CrowdRank+"%</div>",a+="<a href='"+r.attributes.ImageLink,a+="' target='_blank'>See this point on ",a+="<img style='height:20px;width:100px;' src='app/images/tomnod_logo.png'></div>"}},selectTomnodFeatures:function(r){var i=w.tomnodLayer,n=(e.byId("landsat-image-checkbox"),this),o=i.url,s=new A(o),u=new E,l=(new T(o),new C),c=r.mapPoint,f=(a(".selected-fire-option")[0],new Date,new Date,[]);if(!D.getLayer(i.id).visible){n.getActiveFiresInfoWindow(r),n.getArchiveFiresInfoWindow(r);var m=e.byId("noaa-fires-18"),p=e.byId("indonesia-fires"),b=e.byId("fires-checkbox");return"true"==m.getAttribute("aria-checked")&&"true"==p.getAttribute("aria-checked")||"true"==m.getAttribute("aria-checked")&&"true"==b.getAttribute("aria-checked")?setTimeout(function(){D.infoWindow.isShowing||n.getArchiveNoaaInfoWindow(r)},800):n.getArchiveNoaaInfoWindow(r),void setTimeout(function(){D.infoWindow.isShowing||n.getDigitalGlobeInfoWindow(r)},400)}u.geometry=c,u.tolerance=3,u.returnGeometry=!1,u.layerDefinitions=f,u.mapExtent=D.extent,u.layerIds=[8],l.where="OBJECTID in (",l.returnGeometry=!1,l.outFields=["OBJECTID","ChipLink","CrowdRank","Confirmation","name","ImageLink"];var y=[];s.execute(u,function(e){return t.forEach(e,function(e){y.push(e.feature.attributes.OBJECTID)}),y.length<1?(D.infoWindow.setFeatures(void 0),n.getActiveFiresInfoWindow(r),n.getDigitalGlobeInfoWindow(r),n.getArchiveFiresInfoWindow(r),void n.getArchiveNoaaInfoWindow(r)):(D.infoWindow.resize(340,500),l.where+=y.join(",")+")",selected_features=D.getLayer(w.tomnodLayer.sel_id).selectFeatures(l,d.SELECTION_NEW),void selected_features.then(function(e){D.infoWindow.setFeatures(e),D.infoWindow.resize(340,500),D.infoWindow.show(r.mapPoint)}))},function(){n.mapClick(r)})},getActiveFiresInfoWindow:function(e){var r=w.firesLayer,i=this,n=r.url,o=new A(n),s=new E,u=e.mapPoint,d=!0,l=a(".selected-fire-option")[0],c=new Date,f=new Date,m="",p="",b=[];if(!D.getLayer(r.id).visible)return void i.mapClick(e);switch(l.id){case"fires72":c.setDate(c.getDate()-4),f.setDate(f.getDate()-3);break;case"fires48":c.setDate(c.getDate()-3),f.setDate(f.getDate()-2);break;case"fires24":c.setDate(c.getDate()-2),f.setDate(f.getDate()-1);break;default:c.setDate(c.getDate()-8),f.setDate(f.getDate()-7)}p=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate()+" "+c.getHours()+":"+c.getMinutes()+":"+c.getSeconds(),m=f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate()+" "+f.getHours()+":"+f.getMinutes()+":"+f.getSeconds();for(var y=0,h=w.firesLayer.defaultLayers.length;h>y;y++)b[y]="ACQ_DATE > date '"+p+"'";s.geometry=u,s.tolerance=3,s.returnGeometry=!1,s.layerDefinitions=b,s.mapExtent=D.extent,s.layerOption=E.LAYER_OPTION_VISIBLE;var v="</div><table id='infoWindowTable'>";o.execute(s,function(a){var n=D,o=a[0];o?(d=!1,v+="<tr class='infoName'><td colspan='3'>Active Fires</td><td colspan='2'></td></tr>",t.forEach(r.query.fields,function(e){v+="<tr><td colspan='3'>"+e.label+"</td>",v+="<td colspan='2'>"+o.feature.attributes[e.name]+"</td></tr>"}),v+="</table>",n.infoWindow.setContent(v),n.infoWindow.resize(270,140),n.infoWindow.show(u)):i.mapClick(e)},function(){i.mapClick(e)})},getArchiveFiresInfoWindow:function(r){var a=w.indonesiaLayers,i=this,n=a.url,o=new A(n),s=new E,u=r.mapPoint,d=!0,l=(new Date,new Date,e.byId("indonesia-fires"));if(!D.getLayer(a.id).visible||1!=l.checked)return void i.mapClick(r);s.layerDefinitions=D.getLayer(a.id).layerDefinitions,s.geometry=u,s.tolerance=3,s.returnGeometry=!1,s.mapExtent=D.extent,s.layerOption=E.LAYER_OPTION_ALL,s.layerIds=[0];var c=(D.getLayer(a.id),"</div><table id='infoWindowTable'>");o.execute(s,function(e){var n=D,o=e[0];if(o){if(2==o.layerId)return;d=!1,c+="<tr class='infoName'><strong>NASA archived fires for Indonesia</strong></tr>",t.forEach(a.query.fields,function(e){c+="<tr><td colspan='3'>"+e.label+"</td>",c+="<td colspan='2'>"+o.feature.attributes[e.name]+"</td></tr>"}),c+="</table>",n.infoWindow.setContent(c),n.infoWindow.resize(270,140),n.infoWindow.show(u)}else i.mapClick(r)},function(){i.mapClick(r)})},getLandsatInfoWindow:function(e){var r=w.landsat8,a=new f,i=new m(r.url);a.geometry=e.mapPoint,a.returnCatalogItems=!0,a.f="json",a.returnGeometry=!0,a.renderingRule=new p({rasterFunction:"Stretch",rasterFunctionArguments:{StretchType:6,DRA:!0,Gamma:[1.4,1.4,1.4],UseGamma:!0,MinPercent:.5,MaxPercent:.5},outputPixelType:"U8"}),a.pixelSizeX=100,a.pixelSizeY=100,i.execute(a,function(r){t.forEach(r.catalogItems.features,function(e){e.infoTemplate=new b("Acquisition Date","<tr><td>${AcquisitionDate: PopupDateFormat}</td></td>")}),D.infoWindow.setFeatures(r.catalogItems.features),D.infoWindow.show(e.mapPoint)},function(e){console.dir(e)})},getArchiveNoaaInfoWindow:function(t){var r=w.indonesiaLayers,a=this,i=r.url,n=new A(i),o=new E,s=t.mapPoint,u=!0,d=(new Date,new Date,e.byId("noaa-fires-18"));if("false"!=d.getAttribute("aria-checked")){if(!D.getLayer("IndonesiaFires").visible)return void a.mapClick(t);o.geometry=s,o.tolerance=3,o.returnGeometry=!1,o.mapExtent=D.extent,o.layerOption=E.LAYER_OPTION_ALL,o.layerIds=[9];{D.getLayer(r.id)}n.execute(o,function(e){var r=D,i=e[0];if(i){if(2==i.layerId)return;u=!1;var n=i.feature.attributes.Date,o=n.split(" "),o=o[0],d="</div><table id='infoWindowTable'>";d+="<tr class='infoName'><strong>NOAA-18 fires</strong></tr>",d+="<tr><td colspan='3'>DATE</td>",d+="<td colspan='2'>"+o+"</td></tr>",d+="</table>",r.infoWindow.setContent(d),r.infoWindow.resize(170,50),r.infoWindow.show(s)}else a.mapClick(t)},function(){a.mapClick(t)})}},getNOAAFiresInfoWindow:function(e){{var r=w.indonesiaLayers,a=this,i=r.url,n=new A(i),o=new E,s=e.mapPoint,u=!0;new Date,new Date}if(!D.getLayer(r.id).visible)return void a.mapClick(e);o.geometry=s,o.tolerance=10,o.returnGeometry=!1,o.mapExtent=D.extent,o.layerOption=E.LAYER_OPTION_ALL;var d="</div><table id='infoWindowTable'>";n.execute(o,function(i){var n=D,o=i[0];o?(u=!1,d+="<tr class='infoName'><strong>NASA archived fires for Indonesia</strong></tr>",t.forEach(r.query.fields,function(e){d+="<tr><td colspan='3'>"+e.label+"</td>",d+="<td colspan='2'>"+o.feature.attributes[e.name]+"</td></tr>"}),d+="</table>",n.infoWindow.setContent(d),n.infoWindow.show(s)):(console.log("No result returned!"),a.mapClick(e))},function(){a.mapClick(e)})},getDigitalGlobeInfoWindow:function(o){var s=(w.digitalGlobe,D.getLayer(w.digitalGlobe.graphicsLayerId),new C);if((!o.graphic||"Digital_Globe"===o.graphic.attributes.Layer)&&void 0!==o.graphic){s.geometry=o.graphic.geometry,s.where="Category = 1",s.returnGeometry=!1,s.outFields=["*"];var u,d=(n(w.digitalGlobe.mosaics.map(function(e){var t=new i;s.geometry=o.graphic.geometry,s.returnGeometry=!1,s.outFields=["*"];var r=new T(w.digitalGlobe.imagedir+e+"/ImageServer");return r.execute(s,function(e){t.resolve(e.features)},function(){t.resolve([])}),t.promise})).then(function(i){var n="",o=[],s=dijit.byId("timeSliderDG").thumbIndexes,d=dijit.byId("timeSliderDG").timeStops,l=moment(d[s[0]]).tz("Asia/Jakarta"),m=moment(d[s[1]]).tz("Asia/Jakarta");i.map(function(e){e.map(function(e){o.push(e)})}),o.sort(function(e,t){return e.attributes.AcquisitionDate==t.attributes.AcquisitionDate?0:e.attributes.AcquisitionDate>t.attributes.AcquisitionDate?-1:1}),n+="<p>Click a date below to see the imagery.</p><ul class='popup-list'><li><strong>Date <span class='satelliteColumn'>Satellite</span></strong></li>",t.forEach(o,function(e){var t=moment(e.attributes.AcquisitionDate).tz("Asia/Jakarta");t>=l&&m>=t&&(n+="<li><a class='popup-link' data-bucket='"+e.attributes.SensorName+"_id_"+e.attributes.OBJECTID+"'> "+t.format("YYYY/MM/DD")+"  <span class='satelliteColumn' data-bucket='"+e.attributes.SensorName+"_id_"+e.attributes.OBJECTID+"'>"+e.attributes.SensorName+"</span></a></li>")}),n+="</ul><a class='custom-zoom-to' id='custom-zoom-to'>Zoom To</a>",D.infoWindow.setContent(n),D.infoWindow.resize(270,500),D.infoWindow.show(c),u=0,a(".contentPane .popup-link").forEach(function(e,t){f.push(r(e,"click",function(e){var r=e.target?e.target:e.srcElement,a=r.dataset?r.dataset.bucket:r.getAttribute("data-bucket");$("#imageryWindow > table > tbody > tr").each(function(){$(this).removeClass("imageryRowSelected");var e=this.firstElementChild;e=$(e).html(),e=$(e).attr("data-bucket"),a==e&&$(this).addClass("imageryRowSelected")});var i=a.split("_"),n={};n.feature={},n.feature.attributes={},n.feature.attributes.SensorName=i[0],n.feature.attributes.OBJECTID=i[2],L.showDigitalGlobeImagery(n),u=t}))}),f.push(r(e.byId("custom-zoom-to"),"click",function(){var e=new y(o[u].attributes.CenterX,o[u].attributes.CenterY,D.spatialReference);D.centerAndZoom(e,12)})),r.once(D.infoWindow,"hide",function(){t.forEach(f,function(e){e.remove()})})}),w.digitalGlobe.identifyUrl),l=(new A(d),new E),c=o.mapPoint,f=[];l.geometry=c,l.tolerance=3,l.returnGeometry=!0,l.mapExtent=D.extent,l.layerOption=E.LAYER_OPTION_VISIBLE,l.layerIds=[0]}},getFireTweetsInfoWindow:function(e){D.infoWindow.anchor="ANCHOR_UPPERRIGHT";var t=e.attributes,r="<table><tr><td>";return r+="<td><img src='"+t.UserProfileImage+"'/></td>",r+="<td>"+t.UserName+"</td></tr>",r+="<p>"+t.Text+"</p>",r+="<p>"+t.Date+"</p>",console.log(r),r},getFireStoriesInfoWindow:function(e){D.infoWindow.anchor="ANCHOR_UPPERRIGHT";var t=e.attributes,r="<table>";for(var a in t)t[a]&&"OBJECTID"!=a&&(r+="<tr><td>"+a+": "+t[a]+"</td></tr>");return r+="</div>"},selectUploadOrDrawnGraphics:function(t){var a,i,n,o=t.graphic,s=w.defaultGraphicsLayerUniqueId,d=(w.defaultGraphicsLayerLabel,this);t.stopPropagation(),n="<strong>Drawn/Uploaded Feature</strong>",a="Name: <input id='editTitle' style='width:165px;' class='editshow' placeholder='Type a new name and hit enter'/><br/><div id='deleteCustomGraphic' class='deleteGraphicLink'>Remove</div><div id='uploadCustomGraphic' class='uploadCustomGraphic'>Subscribe</div>";var l=I.vm.customFeaturesArray.indexOf(o);D.infoWindow.setTitle(I.vm.customFeaturesArray()[l].attributes.ALERTS_LABEL),D.infoWindow.setContent(a),D.infoWindow.show(t.mapPoint),r(e.byId("editTitle"),"keypress",function(t){var r=t.keyCode;if(r===u.ENTER){var a=I.vm.customFeaturesArray()[o.attributes.UNIQUE_GRAPHIC_ID-1];a.attributes.ALERTS_LABEL=i;var i=e.byId("editTitle").value;D.infoWindow.setTitle("<strong>"+i+"</strong>"),o.attributes.ALERTS_LABEL=i}}),i=r.once(e.byId("deleteCustomGraphic"),"click",function(){L.removeGraphicWithId(o.attributes[s],s),D.infoWindow.hide()}),handleSubscribe=r.once(e.byId("uploadCustomGraphic"),"click",function(){var e=o;d.subscribeToAlerts(e),D.infoWindow.hide()}),r.once(D.infoWindow,"hide",function(){i.remove(),handleSubscribe.remove()})},subscribeToAlerts:function(t){var r=this;require(["dojo/on","dijit/Dialog","dojo/dom-construct"],function(a,i){function n(){o.remove(),s.destroy(),telInput.intlTelInput("destroy")}var o,s=new i({id:"subscribeDialogWindow",title:"Subscribe to Alerts!",refocus:!1,style:"width: 300px;"}),u="<div class='subscription-content'><p>Enter your email below to receive fire alerts</p><div class='email-container'><input id='userEmail' type='text' placeholder='Email'/></div><p>Enter your phone number below to receive SMS alerts</p><div class='phone-container'><input id='userPhone' type='tel' placeholder='Phone Number'/></div><div class='submit-container'><button id='subscribe-now'>Subscribe</button></div><div id='form-response' class='message-container'></div></div>";u+="<input type='email' name='verify_email' id='verifyEmailForAlertsInMap' placeholder='Verify Email(Leave blank if your human)'/>",s.on("hide",n),s.setContent(u),s.show(),telInput=$("#userPhone"),telInput.intlTelInput({validationScript:"./app/libs/isValidNumber.js"}),o=a(e.byId("subscribe-now"),"click",function(){require(["dojox/validate/web","dojo/dom-style"],function(a,i){if(honeyPotValue=e.byId("verifyEmailForAlertsInMap").value,""!==honeyPotValue)return void s.destroy();if(emailValue=e.byId("userEmail").value,phoneValue=e.byId("userPhone").value,!emailValue&&!phoneValue)return i.set("userPhone","border","1px solid red"),i.set("userEmail","border","1px solid red"),void alert("You must enter an email or phone number");if(emailValue){if(!a.isEmailAddress(emailValue))return i.set("userEmail","border","1px solid red"),void alert("You must enter a valid email address!");i.set("userEmail","border","1px solid gray"),e.byId("subscribe-now").innerHTML="Submitting...",r.postSubscribeRequest(t,emailValue,"email",s)}if(phoneValue){if(phoneValue.length<17)return i.set("userPhone","border","1px solid red"),void alert("Please reformat your phone number with the country code first! Such as: +1 (222) 333-4444");i.set("userPhone","border","1px solid gray"),e.byId("subscribe-now").innerHTML="Submitting...",r.postSubscribeRequest(t,phoneValue,"sms",s)}})})})},postSubscribeRequest:function(e,t,r,a){"sms"===r&&(t=t.replace(/\D/g,""));var n=g.emailSubscribeUrlPoly,s=new i,u={features:JSON.stringify({rings:e.geometry.rings,spatialReference:e.geometry.spatialReference}),msg_addr:t,msg_type:r,area_name:e.attributes.ALERTS_LABEL};return o(n,{handleAs:"json",method:"POST",data:u}).then(function(){a.setContent(emailValue&&phoneValue?"<p>You have successfully subscribed. You will receive an email asking you to <strong>verify your subscription</strong>. Please be sure to check your SPAM folder. Once verified, you will start receiving alerts for your area.</p>":emailValue&&!phoneValue?"<p>You have successfully subscribed. You will receive an email asking you to <strong>verify your subscription</strong>. Please be sure to check your SPAM folder. Once verified, you will start receiving alerts for your area.</p>":"<p>You have successfully subscribed, you should start receiving SMS alerts as they come in for your area of interest.</p>"),s.resolve(!0)},function(e){alert("There was an error subsrcribing at this time. "+e.message),a.destroy(),s.resolve(!1)}),s.promise},setupInfowindowListeners:function(){var t,a=this;r(map.infoWindow,"selection-change",function(){setTimeout(function(){e.byId("uploadCustomGraphic")&&(t&&t.remove(),t=r(e.byId("uploadCustomGraphic"),"click",function(){var e=map.infoWindow.selectedIndex,t=map.infoWindow.features[e];a.subscribeToAlerts(t)}))},0)}),r(map.infoWindow,"hide",function(){t&&t.remove()})}}});