define(["dojo/dom","dojo/_base/array","dojo/on","dojo/mouse","dojo/query","dojo/Deferred","dojo/promise/all","dojo/request/xhr","dojo/dom-attr","dojo/dom-class","dojo/keys","esri/layers/FeatureLayer","esri/graphic","esri/request","esri/tasks/ImageServiceIdentifyParameters","esri/tasks/ImageServiceIdentifyTask","esri/layers/RasterFunction","esri/InfoTemplate","esri/dijit/PopupTemplate","esri/geometry/Point","esri/geometry/webMercatorUtils","esri/symbols/PictureMarkerSymbol","main/Config","views/map/MapConfig","views/map/MapModel","views/map/LayerController","esri/tasks/IdentifyTask","esri/tasks/IdentifyParameters","esri/tasks/query","esri/tasks/QueryTask","esri/geometry/Circle","utils/Analytics","esri/geometry/geometryEngine"],function(e,t,r,i,a,n,o,s,u,l,d,c,f,p,m,v,h,y,b,g,w,I,L,E,A,C,T,S,D,x,P,k,F){var W,O=[],_=[],G=[];return{setMap:function(e){W=e,window.PopupDateFormat=function(e){return new Date(e)}},clickNext:"",searchAreaByCoordinates:function(){var r,i,a,n,o={},s=!1,u="You did not enter a valid value.  Please check that your location values are all filled in and nubmers only.",l=new I("app/images/RedStickpin.png",32,32),d={},c=function(e){return s||(s=isNaN(parseInt(e))),isNaN(parseInt(e))?0:parseInt(e)},p=function(){var e=0;return t.forEach(W.graphics.graphics,function(t){t.attributes&&t.attributes.locatorValue&&(e=Math.max(e,parseInt(t.attributes.locatorValue)))}),e};A.get("showDMSInputs")?(o.dlat=c(e.byId("degreesLatInput").value),o.mlat=c(e.byId("minutesLatInput").value),o.slat=c(e.byId("secondsLatInput").value),o.dlon=c(e.byId("degreesLonInput").value),o.mlon=c(e.byId("minutesLonInput").value),o.slon=c(e.byId("secondsLonInput").value),r=o.dlat+o.mlat/60+o.slat/3600,i=o.dlon+o.mlon/60+o.slon/3600):(r=c(e.byId("latitudeInput").value),i=c(e.byId("longitudeInput").value)),s?alert(u):(a=w.geographicToWebMercator(new g(i,r)),d.locatorValue=p(),d.id="LOCATOR_"+d.locatorValue,n=new f(a,l,d),W.graphics.add(n),W.centerAndZoom(a,7),A.set("showClearPinsOption",!0))},fetchTwitterData:function(e){var t=e.target?e.target:e.srcElement;!t.checked},mapClick:function(e){console.log("Map Click event!"),$("#uploadCustomGraphic").length>0&&$("#uploadCustomGraphic").remove();var r,i=W,a=this,n=e.mapPoint,s=[],u=[];i.infoWindow.clearFeatures(),overlaysLayer=i.getLayer(E.overlaysLayer.id),overlaysLayer&&overlaysLayer.visible&&s.push(a.identifyOverlays(n)),forestUseLayer=i.getLayer(E.forestUseLayers.id),forestUseLayer&&forestUseLayer.visible&&s.push(a.identifyForestUse(n)),landUseLayer=i.getLayer(E.landUseLayers.id),landUseLayer&&landUseLayer.visible&&s.push(a.identifyLandUse(n)),conservationLayers=i.getLayer(E.conservationLayers.id),conservationLayers&&conservationLayers.visible&&s.push(a.identifyConservation(n)),fireStoryLayer=i.getLayer(E.fireStories.id),fireStoryLayer&&fireStoryLayer.visible&&s.push(a.identifyFireStories(n)),fireTweets=i.getLayer(E.tweetLayer.id),fireTweets&&fireTweets.visible&&s.push(a.identifyFireTweets(n)),console.log(s),0!==s.length&&o(s).then(function(e){t.forEach(e,function(e){switch(console.log(e),e.layer){case"Overlays_Layer":u=u.concat(a.setOverlaysTemplates(e.features));break;case"Forest_Use":r=!0,u=u.concat(a.setForestUseTemplates(e.features));break;case"Land_Use":r=!0,u=u.concat(a.setForestUseTemplates(e.features));break;case"Conservation":u=u.concat(a.setConservationTemplatesFull(e.features));break;case"Fire_Stories":return u=u.concat(a.getFireStoriesInfoWindow(e.features)),void 0;case"Fire_Tweets":u=u.concat(a.getFireTweetsInfoWindow(e.features))}}),u.length>0&&(i.infoWindow.setFeatures(u),i.infoWindow.show(n),"Fire_Stories"===e[0].layer?i.infoWindow.resize(550,300):i.infoWindow.resize(300,300),r&&a.connectFirePopEvents())})},identifyOverlays:function(e){var t=new n,r=new T(E.overlaysLayer.url),i=new S;return i.tolerance=3,i.maxAllowableOffset=100,i.returnGeometry=!0,i.width=W.width,i.height=W.height,i.geometry=e,i.mapExtent=W.extent,i.layerIds=W.getLayer(E.overlaysLayer.id).visibleLayers,i.layerOption=S.LAYER_OPTION_VISIBLE,r.execute(i,function(e){e.length>0?t.resolve({layer:E.overlaysLayer.id,features:e}):t.resolve(!1)},function(){t.resolve(!1)}),t.promise},identifyForestUse:function(e){var t=new n,r=new T(E.forestUseLayers.url),i=new S;return i.tolerance=3,i.returnGeometry=!0,i.width=W.width,i.height=W.height,i.geometry=e,i.mapExtent=W.extent,i.layerIds=W.getLayer(E.forestUseLayers.id).visibleLayers,i.layerOption=S.LAYER_OPTION_VISIBLE,r.execute(i,function(e){if(e.length>0){var r=e.map(function(e){var t=new n,r=new x(E.firesLayer.url+"4"),i=new D;return i.geometry=e.feature.geometry,i.where="1=1",i.outFields=["Date"],r.execute(i).then(function(r){e.fires=r.features,setTimeout(function(){t.resolve(!1)},3e3),t.resolve(e)}),t});o(r).then(function(e){t.resolve({layer:E.forestUseLayers.id,features:e})})}else t.resolve(!1)},function(){t.resolve(!1)}),t.promise},identifyLandUse:function(e){var t=new n,r=new T(E.landUseLayers.url),i=new S;return i.tolerance=3,i.returnGeometry=!0,i.width=W.width,i.height=W.height,i.geometry=e,i.mapExtent=W.extent,i.layerIds=W.getLayer(E.landUseLayers.id).visibleLayers,i.layerOption=S.LAYER_OPTION_VISIBLE,r.execute(i,function(e){if(e.length>0){var r=e.map(function(e){var t=new n,r=new x(E.firesLayer.url+"4"),i=new D;return i.geometry=e.feature.geometry,i.where="1=1",i.outFields=["Date"],r.execute(i).then(function(r){e.fires=r.features,t.resolve(e)}),t});o(r).then(function(e){t.resolve({layer:E.landUseLayers.id,features:e})})}else t.resolve(!1)},function(){t.resolve(!1)}),t.promise},identifyConservation:function(e){var t=new n,r=new T(E.conservationLayers.url),i=new S;return i.tolerance=3,i.returnGeometry=!0,i.width=W.width,i.height=W.height,i.geometry=e,i.mapExtent=W.extent,i.layerIds=W.getLayer(E.conservationLayers.id).visibleLayers,i.layerOption=S.LAYER_OPTION_VISIBLE,r.execute(i,function(e){if(e.length>0){var r=e.map(function(e){var t=new n,r=new x(E.firesLayer.url+"4"),i=new D;return i.geometry=e.feature.geometry,i.where="1=1",i.outFields=["Date"],r.execute(i).then(function(r){e.fires=r.features,setTimeout(function(){t.resolve(!1)},3e3),t.resolve(e)}),t});o(r).then(function(e){t.resolve({layer:E.conservationLayers.id,features:e})})}else t.resolve(!1)},function(){t.resolve(!1)}),t.promise},identifyFireStories:function(e){var t=E.fireStories.url.split(E.fireStories.layerId);t=t[0];var r=new n,i=new T(t),a=new S;return a.tolerance=5,a.maxAllowableOffset=5e3,a.returnGeometry=!1,a.width=W.width,a.height=W.height,a.geometry=e,a.mapExtent=W.extent,a.layerIds=[10],a.layerOption=S.LAYER_OPTION_VISIBLE,i.execute(a,function(e){e.length>0?r.resolve({layer:"Fire_Stories",features:e}):r.resolve(!1)},function(){r.resolve(!1)}),r.promise},identifyFireTweets:function(e){var t=E.tweetLayer.url.split("/3");t=t[0];var r=new n,i=new T(t),a=new S;return a.tolerance=5,a.returnGeometry=!1,a.width=W.width,a.height=W.height,a.geometry=e,a.mapExtent=W.extent,a.layerIds=[3],a.layerOption=S.LAYER_OPTION_VISIBLE,i.execute(a,function(e){e.length>0?r.resolve({layer:"Fire_Tweets",features:e}):r.resolve(!1)},function(){r.resolve(!1)}),r.promise},setOverlaysTemplates:function(e){var r,i=[];return t.forEach(e,function(e){1===e.layerId?(r=new y("Village: "+e.value,"<table><tr><td>Subdistrict:</td><td>"+e.feature.attributes.SUBDISTRIC+"</td></tr><tr><td>District:</td><td>"+e.feature.attributes.DISTRICT+"</td></tr><tr style='height:10px;'></tr></table>"),e.feature.attributes.ALERTS_LABEL=e.value):2===e.layerId?(r=new y("Subdistrict: "+e.value,"<table><tr><td>District:</td><td>"+e.feature.attributes.DISTRICT+"</td></tr><tr><td>Province:</td><td>"+e.feature.attributes.PROVINCE+"</td></tr><tr style='height:10px;'></tr></table>"),e.feature.attributes.ALERTS_LABEL=e.value):3===e.layerId?(r=new y("District: "+e.feature.attributes.DISTRICT,"<table><tr><td>Province:</td><td>"+e.feature.attributes.PROVINCE+"</td></tr><tr><td>Island:</td><td>"+e.feature.attributes.ISLAND+"</td></tr><tr style='height:10px;'></tr></table>"),e.feature.attributes.ALERTS_LABEL=e.feature.attributes.DISTRICT):(r=new y("Province: "+e.value,"<table><tr><td>Island:</td><td>"+e.feature.attributes.ISLAND+"</td></tr><tr style='height:10px;'></tr></table>"),e.feature.attributes.ALERTS_LABEL=e.value),e.feature.setInfoTemplate(r),i.push(e.feature)}),0==$("#uploadCustomGraphic").length&&$(".sizer > .actionsPane").append("<div id='uploadCustomGraphic' class='uploadCustomGraphic'>Subscribe</div>"),i},updateFirePopSelection:function(t,r){var i=a(".fire-pop-item");if(!(i.length<1)&&(i.forEach(function(e){l.remove(e,"selected")}),l.add(t,"selected"),r)){var n=e.byId(t.id.split("-")[0]),o=require("views/map/MapController");o.toggleFireOption({srcElement:n})}},connectFirePopEvents:function(){var e=this,t=a(".fire-pop-item");O.forEach(function(e){e.remove()}),_.forEach(function(e){e.remove()}),O=[a(".titlePane > .prev")[0],a(".titlePane > .next")[0]].map(function(t){return r(t,"click",function(){e.connectFirePopEvents()})}),_=t.map(function(t){return t.id.split("-")[0]===A.vm.currentFireTime()&&l.add(t,"selected"),r(t,"click",function(t){var r=t.currentTarget;e.updateFirePopSelection(r,!0)})})},getFirePopupContent:function(e){var t=e.fires.length>0,r='<div class="fire-popup-list" id="fireResults">Recent Fires',i='<div class="fire-popup-list no-fires" id="fireResults">No fires in past 7 days',a=t?[r]:[i];if(t){var n=[1,2,3,7].map(function(t){return e.fires.filter(function(e){return moment(e.attributes.Date)>moment().subtract(t+1,"days")}).length});a=a.concat(['<div class="fire-pop-item-cont">','<div id="firesWeek-pop" class="fire-pop-item"><div class="fire-pop-count">',n[3],'</div><div class="fire-pop-label">Week</div></div>','<div id="fires72-pop" class="fire-pop-item"><div class="fire-pop-count">',n[2],'</div><div class="fire-pop-label">72 hrs</div></div>','<div id="fires48-pop" class="fire-pop-item"><div class="fire-pop-count">',n[1],'</div><div class="fire-pop-label">48 hrs</div></div>','<div id="fires24-pop" class="fire-pop-item"><div class="fire-pop-count">',n[0],'</div><div class="fire-pop-label">24 hrs</div></div>',"</div>"])}return a.push("</div>"),a},getAdditonalInfoContent:function(e){var t=e.feature.attributes,r={0:["<table class='forest-use-pop'>","<tr><td>Country</td><td>",t.Country,"</td>","</tr><tr><td>Certification Status</td><td>",t.CERT_STAT,"</td></tr>","<tr><td>Source </td><td>",t.Source||"N/A","</td></tr>","<tr style='height:10px;'></tr>","</table>"],1:["<table class='forest-use-pop'>","<tr><td>Country</td><td>",t.Country,"</td>","</tr><tr><td>Certification Status</td><td>",t.CERT_STAT,"</td></tr>","<tr><td>Source </td><td>",t.Source||"N/A","</td></tr>","<tr style='height:10px;'></tr>","</table>"],3:["<table class='forest-use-pop'>","<tr><td>Country</td><td>",t.Country,"</td>","</tr><tr><td>Certification Status</td><td>",t.CERT_STAT,"</td></tr>","<tr><td>Source </td><td>",t.Source||"N/A","</td></tr>","<tr style='height:10px;'></tr>","</table>"],4:["<table class='forest-use-pop'>","<tr><td>Country</td><td>",t.Country,"</td></tr>","<tr><td>Certification Status</td><td>",t.cert_schem,"</td>","<tr><td>Certificate ID</td><td>",t.certificat,"</td></tr>","<tr><td>Certificate Issue Date</td><td>",t.issued,"</td></tr>","<tr><td>Certificate Expiry Date</td><td>",t.expired,"</td></tr>","<tr><td>Mill name</td><td>",t.mill,"</td></tr>","<tr><td>Mill location</td><td>",t.location,"</td></tr>","<tr><td>Mill capacity (t/hour)</td><td>",t.capacity,"</td></tr>","<tr><td>Certified CPO (mt)</td><td>",t.cpo,"</td></tr>","<tr><td>Certified PK (mt)</td><td>",t.pk,"</td></tr>","<tr><td>Estate Suppliers</td><td>",t.estate,"</td></tr>","<tr><td>Estate Area (ha)</td><td>",t.estate_1,"</td></tr>","<tr><td>Outgrower Area (ha)</td><td>",t.outgrower,"</td></tr>","<tr><td>Scheme Smallholder Area (ha)</td><td>",t.sh,"</td></tr>","<tr><td>Source </td><td>",t.Source||"N/A","</td></tr>","<tr style='height:10px;'></tr>","</table>"],7:!1};return r[e.layerId]},getAdditonalInfoContentProtected:function(e){var t=e.feature.attributes,r={0:["<table class='conservation-use-pop'>","<tr><td>Local Name</td><td>",t["Local Name"],"</td>","</tr><tr><td>Local Designation</td><td>",t["Local Designation"],"</td></tr>","<tr><td>WDPA ID </td><td>",t["WDPA ID"]||"N/A","</td></tr>","<tr style='height:10px;'></tr>","</table>"]};return r[e.layerId]},getTemplateContent:function(e){console.log(e);var t=this.getFirePopupContent(e),r=["<div>",e.feature.attributes.TYPE,"</div>","<div>Area (ha): ",e.feature.attributes.AREA_HA,"</div>"].concat(t);r.push("<div>Additional Info</div>");var i;if(i="WDPA Protected areas"===e.layerName?this.getAdditonalInfoContentProtected(e):this.getAdditonalInfoContent(e),!i)return!1;var a=r.concat(i).join("");return a},setForestUseTemplates:function(e){var r,i=this,a=[];return t.forEach(e,function(e){var t=["<strong>",e.value,"</strong>"].join(""),n=i.getTemplateContent(e);n&&(r=new y(t,n),e.feature.setInfoTemplate(r),e.feature.attributes.ALERTS_LABEL=e.value,a.push(e.feature))}),0==$("#uploadCustomGraphic").length&&$(".sizer > .actionsPane").append("<div id='uploadCustomGraphic' class='uploadCustomGraphic'>Subscribe</div>"),a},setConservationTemplatesFull:function(e){var r,i=this,a=[];return t.forEach(e,function(e){var t=["<strong>",e.value,"</strong>"].join(""),n=i.getTemplateContent(e);n&&(r=new y(t,n),e.feature.setInfoTemplate(r),e.feature.attributes.ALERTS_LABEL=e.value,a.push(e.feature))}),0==$("#uploadCustomGraphic").length&&$(".sizer > .actionsPane").append("<div id='uploadCustomGraphic' class='uploadCustomGraphic'>Subscribe</div>"),a},setConservationTemplates:function(e){var r,i=[];return t.forEach(e,function(e){r=new y("Protected Areas ","<table><tr class='infoName'><td colspan='2'>"+e.feature.attributes.Name+"</td></tr><tr><td>Local Name</td><td>"+e.feature.attributes["Local Name"]+"</td></tr><tr><td>Legal Designation</td><td>"+e.feature.attributes["Local Designation"]+"</td></tr><tr><td>WDPA ID</td><td>"+e.feature.attributes["WDPA ID"]+"</td></tr><tr style='height:10px;'></tr></table>"),e.feature.attributes.ALERTS_LABEL=e.value,e.feature.setInfoTemplate(r),i.push(e.feature)}),0==$("#uploadCustomGraphic").length&&$(".sizer > .actionsPane").append("<div id='uploadCustomGraphic' class='uploadCustomGraphic'>Subscribe</div>"),i},getTomnodInfoWindow:function(e){var t=E.tomnodLayer,r=(t.url,e),i="";if(r){var a=new Date(r.attributes.ImageAquisitionDate),n=a.getMonth()+1,o=a.getDate(),s=a.getFullYear();return a=n+"/"+o+"/"+s,executeReturned=!1,i+=" <div><h3>"+r.attributes.name+"</h3></div>",i+="<tr><td><img src='"+t.chipBucket+r.attributes.ChipLink,i+="' style='width:300px' /></tc></tr>",i+="<div><strong>Image Acquisition Date:</strong> "+a+"</div>",i+="<div><strong>Confirmation:</strong> "+r.attributes.Confirmation+" people</div>",i+="<div><b>Crowd Rank:</b> "+r.attributes.CrowdRank+"%</div>",i+="<a href='"+r.attributes.ImageLink,i+="' target='_blank'>See this point on ",i+="<img style='height:20px;width:100px;' src='app/images/tomnod_logo.png'></div>"}},showInfoWindowContent:function(e,t){map.infoWindow.setContent(t),map.infoWindow.resize(270,140),map.infoWindow.show(e)},identifyInfoWindows:function(t){var r=this,i=e.byId("noaa-fires-18"),a=e.byId("indonesia-fires"),n=e.byId("fires-checkbox"),s=e.byId("digital-globe-footprints-checkbox"),u=e.byId("tomnod-checkbox"),l=[[r.getActiveFiresInfoWindow(t),r.showInfoWindowContent,n],[r.getArchiveFiresInfoWindow(t),r.showInfoWindowContent,a],[r.getArchiveNoaaInfoWindow(t),r.showInfoWindowContent,i],[r.selectTomnodFeatures(t),r.renderTomnodInfoWindow,u],[r.getDigitalGlobeInfoWindow(t),r.renderDGInfoWindow,s]],d=l.filter(function(e){return"fires-checkbox"===e[2].id&&"Heat map"===A.vm.smartRendererName()?!1:"true"===e[2].getAttribute("aria-checked")});console.log(d),d.forEach(function(e,r){var i=d.slice(0,r).map(function(e){return e[0]});o(i).then(function(r){r.filter(function(e){return e}).length>0||e[0].then(function(r){r&&(e[1](t.mapPoint,r),dojo.byId("uploadCustomGraphic")&&dojo.byId("uploadCustomGraphic").remove())})})}),o(d.map(function(e){return e[0]})).then(function(e){e.filter(function(e){return e}).length>0||r.mapClick(t)})},selectTomnodFeatures:function(t){var r=E.tomnodLayer,i=(e.byId("landsat-image-checkbox"),r.url),o=new T(i),s=new S,u=t.mapPoint,l=(a(".selected-fire-option")[0],new Date,new Date,[]),d=new n;s.geometry=u,s.tolerance=3,s.returnGeometry=!1,s.layerDefinitions=l,s.mapExtent=W.extent,s.layerIds=[8];return o.execute(s,function(e){e.length<1&&d.resolve(!1),d.resolve(e)},function(){d.resolve(!1)}),d},renderTomnodInfoWindow:function(e,r){var i=E.tomnodLayer,a=i.url,n=(new x(a),new D);n.where="OBJECTID in (",n.returnGeometry=!1,n.outFields=["OBJECTID","ChipLink","CrowdRank","Confirmation","name","ImageLink"];var o=[];t.forEach(r,function(e){o.push(e.feature.attributes.OBJECTID)}),o.length<1||(W.infoWindow.resize(340,500),n.where+=o.join(",")+")",selected_features=W.getLayer(E.tomnodLayer.sel_id).selectFeatures(n,c.SELECTION_NEW),selected_features.then(function(t){W.infoWindow.setFeatures(t),W.infoWindow.resize(340,500),W.infoWindow.show(e)}))},getActiveFiresInfoWindow:function(e){var r=E.firesLayer,i=r.url,o=new T(i),s=new S,u=e.mapPoint,l=!0,d=a(".selected-fire-option")[0],c=new Date,f=new Date,p="",m="",v=[],h=new n;switch(d.id){case"fires72":c.setDate(c.getDate()-4),f.setDate(f.getDate()-3);break;case"fires48":c.setDate(c.getDate()-3),f.setDate(f.getDate()-2);break;case"fires24":c.setDate(c.getDate()-2),f.setDate(f.getDate()-1);break;default:c.setDate(c.getDate()-8),f.setDate(f.getDate()-7)}m=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate()+" "+c.getHours()+":"+c.getMinutes()+":"+c.getSeconds(),p=f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate()+" "+f.getHours()+":"+f.getMinutes()+":"+f.getSeconds();for(var y=0,b=E.firesLayer.defaultLayers.length;b>y;y++)v[y]="ACQ_DATE > date '"+m+"'";s.geometry=u,s.tolerance=3,s.returnGeometry=!1,s.layerDefinitions=v,s.mapExtent=W.extent,s.layerOption=S.LAYER_OPTION_VISIBLE;var g="</div><table id='infoWindowTable'>";return o.execute(s,function(e){var i=e[0];i?(l=!1,g+="<tr class='infoName'><td colspan='3'>Active Fires</td><td colspan='2'></td></tr>",t.forEach(r.query.fields,function(e){g+="<tr><td colspan='3'>"+e.label+"</td>",g+="<td colspan='2'>"+i.feature.attributes[e.name]+"</td></tr>"}),g+="</table>",h.resolve(g)):h.resolve(!1)},function(){h.resolve(!1)}),h},getArchiveFiresInfoWindow:function(r){{var i=E.indonesiaLayers,a=i.url,o=new T(a),s=new S,u=r.mapPoint,l=!0,d=(new Date,new Date,new n);e.byId("indonesia-fires")}s.layerDefinitions=W.getLayer(i.id).layerDefinitions,s.geometry=u,s.tolerance=3,s.returnGeometry=!1,s.mapExtent=W.extent,s.layerOption=S.LAYER_OPTION_ALL,s.layerIds=[0];var c=(W.getLayer(i.id),"</div><table id='infoWindowTable'>");return o.execute(s,function(e){var r=e[0];if(r){if(2==r.layerId)return;l=!1,c+="<tr class='infoName'><strong>NASA archived fires for Indonesia</strong></tr>",t.forEach(i.query.fields,function(e){c+="<tr><td colspan='3'>"+e.label+"</td>",c+="<td colspan='2'>"+r.feature.attributes[e.name]+"</td></tr>"}),c+="</table>",d.resolve(c)}else d.resolve(!1)},function(){d.resolve(!1)}),d},getLandsatInfoWindow:function(e){var r=new n,i=E.landsat8,a=new m,o=new v(i.url);return a.geometry=e.mapPoint,a.returnCatalogItems=!0,a.f="json",a.returnGeometry=!0,a.renderingRule=new h({rasterFunction:"Stretch",rasterFunctionArguments:{StretchType:6,DRA:!0,Gamma:[1.4,1.4,1.4],UseGamma:!0,MinPercent:.5,MaxPercent:.5},outputPixelType:"U8"}),a.pixelSizeX=100,a.pixelSizeY=100,o.execute(a,function(e){e.catalogItems.features.length<1&&r.resolve(!1),t.forEach(e.catalogItems.features,function(e){e.infoTemplate=new y("Acquisition Date","<tr><td>${AcquisitionDate: PopupDateFormat}</td></td>")}),r.resolve(features)},function(e){console.dir(e),r.resolve(!1)}),r},getArchiveNoaaInfoWindow:function(t){var r=E.indonesiaLayers,i=r.url,a=new T(i),o=new S,s=t.mapPoint,u=!0,l=(new Date,new Date,new n),d=e.byId("noaa-fires-18");if("false"==d.getAttribute("aria-checked"))return l.resolve(!1),l;if(!W.getLayer("IndonesiaFires").visible)return l.resolve(!1),l;o.geometry=s,o.tolerance=3,o.returnGeometry=!1,o.mapExtent=W.extent,o.layerOption=S.LAYER_OPTION_ALL,o.layerIds=[9];W.getLayer(r.id);return a.execute(o,function(e){var t=e[0];if(t){if(2==t.layerId)return;u=!1;var r=t.feature.attributes.Date,i=r.split(" "),i=i[0],a="</div><table id='infoWindowTable'>";a+="<tr class='infoName'><strong>NOAA-18 fires</strong></tr>",a+="<tr><td colspan='3'>DATE</td>",a+="<td colspan='2'>"+i+"</td></tr>",a+="</table>",l.resolve(a)}else l.resolve(!1)},function(){l.resolve(!1)}),l},getNOAAFiresInfoWindow:function(e){var r=E.indonesiaLayers,i=r.url,a=new T(i),o=new S,s=e.mapPoint,u=!0,l=(new Date,new Date,new n);o.geometry=s,o.tolerance=10,o.returnGeometry=!1,o.mapExtent=W.extent,o.layerOption=S.LAYER_OPTION_ALL;var d="</div><table id='infoWindowTable'>";return a.execute(o,function(e){var i=e[0];i?(u=!1,d+="<tr class='infoName'><strong>NASA archived fires for Indonesia</strong></tr>",t.forEach(r.query.fields,function(e){d+="<tr><td colspan='3'>"+e.label+"</td>",d+="<td colspan='2'>"+i.feature.attributes[e.name]+"</td></tr>"}),d+="</table>",l.resolve(d)):l.resolve(!1)},function(){l.resolve(!1)}),l},getDigitalGlobeInfoWindow:function(e){var r=new n,i=(E.digitalGlobe,W.getLayer(E.digitalGlobe.graphicsLayerId),new D);if(e.graphic&&"Digital_Globe"!==e.graphic.attributes.Layer)return r.resolve(!1),r;if(void 0===e.graphic)return r.resolve(!1),r;i.geometry=e.graphic.geometry,i.where="Category = 1",i.returnGeometry=!1,i.outFields=["*"];o(E.digitalGlobe.imageServices.map(function(r){var a=new n;i.geometry=e.graphic.geometry,i.returnGeometry=!0,i.outFields=["AcquisitionDate","SensorName","OBJECTID","CenterX","CenterY"];var o=new x(r.url);return function(e){o.execute(i,function(r){t.forEach(r.features,function(t){t.attributes.LayerId=e.id}),a.resolve(r.features)},function(){a.resolve([])})}(r),a.promise})).then(function(e){var i="",a=[],n=dijit.byId("timeSliderDG").thumbIndexes,o=dijit.byId("timeSliderDG").timeStops,s=moment(o[n[0]]).tz("Asia/Jakarta"),u=moment(o[n[1]]).tz("Asia/Jakarta");e.map(function(e){e.map(function(e){a.push(e)})}),console.dir(a),a.sort(function(e,t){return e.attributes.AcquisitionDate==t.attributes.AcquisitionDate?0:e.attributes.AcquisitionDate>t.attributes.AcquisitionDate?-1:1}),i+="<p>Click a date below to see the imagery.</p><ul class='popup-list'><li><strong>Date <span class='satelliteColumn'>Satellite</span></strong></li>",G=[],t.forEach(a,function(e,t){var r=moment(e.attributes.AcquisitionDate).tz("Asia/Jakarta");G.push(e),r>=s&&u>=r&&(i+="<li class='dg-image-item' value='"+t+"'><a class='popup-link' data-layer='"+e.attributes.LayerId+"' data-bucket='"+e.attributes.SensorName+"_id_"+e.attributes.OBJECTID+"'> "+r.format("YYYY/MM/DD")+"  <span class='satelliteColumn' data-layer='"+e.attributes.LayerId+"' data-bucket='"+e.attributes.SensorName+"_id_"+e.attributes.OBJECTID+"'>"+e.attributes.SensorName+"</span></a></li>")}),i+="</ul><a class='custom-zoom-to' id='custom-zoom-to'>Zoom To</a>",r.resolve(i)});return r},renderDGInfoWindow:function(n,o){W.infoWindow.setContent(o),W.infoWindow.resize(270,500),W.infoWindow.show(n);var s=[];activeFeatureIndex=0,a(".contentPane .popup-link").forEach(function(e,t){s.push(r(e,"click",function(e){var r=e.target?e.target:e.srcElement,i=r.dataset?r.dataset.bucket:r.getAttribute("data-bucket"),n=r.getAttribute("data-layer");a(".contentPane .popup-link").forEach(function(e){l.remove(e.parentElement,"selected")}),l.add(e.currentTarget.parentElement,"selected"),$("#imageryWindow > table > tbody > tr").each(function(){$(this).removeClass("imageryRowSelected");var e=this.firstElementChild;e=$(e).html(),e=$(e).attr("data-bucket"),i==e&&$(this).addClass("imageryRowSelected")});var o=i.split("_"),s={};s.feature={},s.feature.attributes={},s.feature.attributes.SensorName=o[0],s.feature.attributes.OBJECTID=o[2],s.feature.attributes.LayerId=n,C.showDigitalGlobeImagery(s),activeFeatureIndex=t})),s.push(r(e,i.enter,function(e){var r=e.target?e.target:e.srcElement,i=r.dataset?r.dataset.bucket:r.getAttribute("data-bucket");a("td > .popup-link").forEach(function(e){if(u.get(e,"data-bucket")===i){var t=e.parentElement.parentElement;l.add(t,"hover")}else{var t=e.parentElement.parentElement;l.remove(t,"hover")}});var n=require("views/map/MapController"),o=G[t];n.handleImageryOver({feature:o},e)})),s.push(r(e,i.leave,function(e){var r=require("views/map/MapController"),i=G[t];r.handleImageryOut({feature:i},e),a("td > .popup-link").forEach(function(e){var t=e.parentElement.parentElement;l.remove(t,"hover")})}))}),s.push(r(e.byId("custom-zoom-to"),"click",function(){var e=new g(features[activeFeatureIndex].attributes.CenterX,features[activeFeatureIndex].attributes.CenterY,W.spatialReference);W.centerAndZoom(e,12)})),r.once(W.infoWindow,"hide",function(){t.forEach(s,function(e){e.remove()})})},getFireTweetsInfoWindow:function(e){var t,r,i=[];W.infoWindow.anchor="ANCHOR_UPPERRIGHT";for(var a=0;a<e.length;a++){t=e[a].feature.attributes,r="<table>";for(var n in t)!t[n]||"UserName"!=n&&"Text"!=n&&"Date"!=n&&"UserProfileImage"!=n||(r+="UserProfileImage"==n?"<tr><td><img src='"+e[a].feature.attributes.UserProfileImage+"'/></td></tr>":"<tr><td>"+n+": "+t[n]+"</td></tr>");r+="</div>",template=new y(e[a].feature.attributes.UserName,r),e[a].feature.setInfoTemplate(template),i.push(e[a].feature)}return i},getFireStoriesInfoWindow:function(e){W.infoWindow.anchor="ANCHOR_UPPERRIGHT";for(var t,r="<table style='min-width:500px;'>",i=[],a=0;a<e.length;a++){for(t in e[a].feature.attributes)"Null"==e[a].feature.attributes[t]&&(e[a].feature.attributes[t]="");t=e[a].feature.attributes,r+="<tr><td>"+e[a].feature.attributes.Name+"</td></tr><tr><td>"+e[a].feature.attributes.Details+"</td></tr><tr><td><a style='color:#97bd3d;cursor:pointer;' href='"+e[a].feature.attributes.Video+"' target='blank'>"+e[a].feature.attributes.Video+"</a></td></tr><tr><td>Published on "+e[a].feature.attributes.Date+"</td></tr></table>";var n=e[a].feature.attributes.Title?e[a].feature.attributes.Title:"User Story",o=new y(n,r),s=e[a].feature.attributes.OBJECTID,u=map.getLayer("Fire_Stories");map.infoWindow.resize(550,300),function(e){console.log(s),u.queryAttachmentInfos(s,function(t){if(console.log(t),t[0]&&(console.log(t),t[0].url)){if(e.attributes.Attachments="<img id='forceBlock'; src='"+t[0].url+"' />",t.length>1)for(var r=1;r<t.length;r++)t[r].url&&(e.attributes.Attachments+="<img id='forceBlock'; src='"+t[r].url+"' />");for(var i=[],a=0;a<map.infoWindow.features.length;a++)map.infoWindow.features[a].attributes.OBJECTID===e.attributes.OBJECTID?i.push(e):i.push(map.infoWindow.features[a]);map.infoWindow.setFeatures(i);var n=$("#forceBlock")[0],o=n.parentElement,s=o.previousSibling;$(o).css("display","block"),$(s).css("display","block")}})}(e[a].feature),e[a].feature.setInfoTemplate(o),i.push(e[a].feature)}return i},selectUploadOrDrawnGraphics:function(t){$("#uploadCustomGraphic").length>0&&$("#uploadCustomGraphic").remove();var i,a,n,o=t.graphic,s=E.defaultGraphicsLayerUniqueId,u=(E.defaultGraphicsLayerLabel,this);t.stopPropagation(),n="<strong>Custom Feature</strong>",i="Name: <input id='editTitle' style='width:165px;' class='editshow' value='Custom Feature'/><br/><div id='uploadCustomGraphic' class='uploadCustomGraphic'><span id='customGraphicSymbol'></span>Subscribe</div><div id='deleteCustomGraphic' class='deleteGraphicLink'>&#10007 Remove</div>";W.graphics.graphics,A.vm.customFeaturesArray.indexOf(o);W.infoWindow.setContent(i),$("#editTitle").val(o.attributes.ALERTS_LABEL),W.infoWindow.setTitle("&nbsp;"),W.infoWindow.show(t.mapPoint),a=r.once(e.byId("deleteCustomGraphic"),"click",function(){C.removeGraphicWithId(o.attributes[s],s),0===W.graphics.graphics.length&&A.vm.customFeaturesPresence(!1),W.infoWindow.hide()}),handleSubscribe=r.once(e.byId("uploadCustomGraphic"),"click",function(){var t=o,r=e.byId("editTitle").value;o.attributes.ALERTS_LABEL=r,u.subscribeToAlerts(t),W.infoWindow.hide()}),$("#editTitle").bind("input",function(){var e=$(this).val();e.length>50&&($("#editTitle").val(e.substring(0,50)),e=e.substring(0,50)),o.attributes.ALERTS_LABEL=e}),r.once(W.infoWindow,"hide",function(){a.remove(),handleSubscribe.remove()})},subscribeToAlerts:function(t){var r=this;require(["dojo/on","dijit/Dialog","dojo/dom-construct"],function(i,a){function n(){o.remove(),s.destroy(),telInput.intlTelInput("destroy")}var o,s=new a({id:"subscribeDialogWindow",title:"Subscribe to Alerts!",refocus:!1,style:"width: 300px;"}),u="<div class='subscription-content'><p>Enter your email(s) below to receive fire alerts. Multiple emails must be separated by commas.</p><div class='email-container'><input id='userEmail' type='text' placeholder='Email'/></div><p>Enter your phone number below to receive SMS alerts</p><div class='phone-container'><input id='userPhone' type='tel' placeholder='Phone Number'/></div><div class='submit-container'><button id='subscribe-now'>Subscribe</button></div><div id='form-response' class='message-container'></div></div>";u+="<input type='email' name='verify_email' id='verifyEmailForAlertsInMap' placeholder='Verify Email(Leave blank if your human)'/>",s.on("hide",n),s.setContent(u),s.show(),telInput=$("#userPhone"),telInput.intlTelInput({validationScript:"./app/libs/isValidNumber.js"}),o=i(e.byId("subscribe-now"),"click",function(){require(["dojox/validate/web","dojo/dom-style"],function(i,a){if(honeyPotValue=e.byId("verifyEmailForAlertsInMap").value,""!==honeyPotValue)return s.destroy(),void 0;if(emailValue=e.byId("userEmail").value,phoneValue=e.byId("userPhone").value,!emailValue&&!phoneValue)return a.set("userPhone","border","1px solid red"),a.set("userEmail","border","1px solid red"),alert("You must enter an email or phone number"),void 0;if(emailValue){if(emailValue.indexOf(",")>-1){for(var n=emailValue.split(","),o=0;o<n.length;o++){var u=n[o].replace(/\s/g,"");if(!i.isEmailAddress(u))return a.set("userEmail","border","1px solid red"),e.byId("subscribe-now").innerHTML="Subscribe",alert("You must enter valid email addresses, separated by commas."),void 0;console.log(u),r.postSubscribeRequest(t,u,"email",s),k.sendEvent("Subscribe","click","Fire Alerts","User is subscribing to Fire Alerts via Email.")}return a.set("userEmail","border","1px solid gray"),e.byId("subscribe-now").innerHTML="Submitting...",void 0}if(!i.isEmailAddress(emailValue))return a.set("userEmail","border","1px solid red"),alert("You must enter a valid email address!"),void 0;a.set("userEmail","border","1px solid gray"),e.byId("subscribe-now").innerHTML="Submitting...",r.postSubscribeRequest(t,emailValue,"email",s),k.sendEvent("Subscribe","click","Fire Alerts","User is subscribing to Fire Alerts via Email.")}phoneValue&&(a.set("userPhone","border","1px solid gray"),e.byId("subscribe-now").innerHTML="Submitting...",r.postSubscribeRequest(t,phoneValue,"sms",s),k.sendEvent("Subscribe","click","Fire Alerts","User is subscribing to Fire Alerts via SMS."))})})})},postSubscribeRequest:function(e,t,r,i){"sms"===r&&(t=t.replace(/\D/g,""));var a=L.emailSubscribeUrlPoly,o=new n,u={msg_addr:t,msg_type:r,area_name:e.attributes.ALERTS_LABEL},l=F.simplify(e.geometry);return u.features=JSON.stringify({rings:l.rings,spatialReference:l.spatialReference}),s(a,{handleAs:"json",method:"POST",data:u}).then(function(){emailValue&&phoneValue?i.setContent("<p>You have successfully subscribed. You will receive an email asking you to <strong>verify your subscription</strong>. Please be sure to check your SPAM folder. Once verified, you will start receiving alerts for your area.</p>"):emailValue&&!phoneValue?i.setContent("<p>You have successfully subscribed. You will receive an email asking you to <strong>verify your subscription</strong>. Please be sure to check your SPAM folder. Once verified, you will start receiving alerts for your area.</p>"):i.setContent("<p>You have successfully subscribed, you should start receiving SMS alerts as they come in for your area of interest.</p>"),o.resolve(!0)
},function(e){alert("There was an error subsrcribing at this time. "+e.message),i.destroy(),o.resolve(!1)}),o.promise},setupInfowindowListeners:function(){var t,i=this;r(map.infoWindow,"selection-change",function(){setTimeout(function(){e.byId("uploadCustomGraphic")&&(t&&t.remove(),t=r(e.byId("uploadCustomGraphic"),"click",function(){var e=map.infoWindow.selectedIndex,t=map.infoWindow.features[e];i.subscribeToAlerts(t)}))},0)}),r(map.infoWindow,"hide",function(){t&&t.remove()})}}});