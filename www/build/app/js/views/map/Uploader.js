define(["esri/Color","dojo/sniff","esri/graphic","esri/request","utils/Helper","dijit/registry","dojo/dom-class","dojo/_base/array","dojo/store/Memory","dojo/dom-construct","dijit/form/ComboBox","views/map/MapConfig","views/map/MapModel","esri/geometry/Polygon","esri/geometry/scaleUtils","esri/symbols/SimpleFillSymbol","esri/symbols/SimpleLineSymbol"],function(e,t,r,a,o,i,n,s,l,d,u,m,p,c,f,g,y){var h,b={setMap:function(e){return h=e,this},beginUpload:function(e){var r=e.target?e.target:e.srcElement;if(""!==r.value){if(r.files&&r.files[0].size>1048576)return alert("Currently we only support files under 1MB in size. Please try a smaller shapefile."),document.uploadForm.reset(),void 0;var o,i,n=r.value.toLowerCase();if(t("ie")){var s=n.split("\\");n=s[s.length-1]}if(n.indexOf(".zip")<0)return alert("Currently only files with a .zip extension are supported."),void 0;n=n.split("."),n=n[0].replace("c:\\fakepath\\",""),o={name:n,generalize:!0,targetSR:h.spatialReference,maxRecordCount:1e3,reducePrecision:!0,numberOfDigitsAfterDecimal:0,enforceInputFileSizeLimit:!0,enforceOutputJsonSizeLimit:!0},i=f.getExtentForScale(h,4e4),o.maxAllowableOffset=i.getWidth()/h.width,a({url:m.uploadOptions.url,content:{filetype:"shapefile",publishParameters:JSON.stringify(o),f:"json","callback.html":"textarea"},form:document.uploadForm,handleAs:"json",error:this.uploadError,load:this.uploadSuccess.bind(this)})}},uploadError:function(e){alert(["Error:",e.message].join(" "))},uploadSuccess:function(e){function t(){i.byId("uploadComboNameWidget")&&i.byId("uploadComboNameWidget").destroy(),document.getElementById("dropdownContainerName")&&d.destroy("dropdownContainerName"),document.uploadForm.file.value=""}var r,a=document.getElementById("uploadNameSelectContainer"),o=e.featureCollection,n=[],m=this;s.forEach(o.layers[0].layerDefinition.fields,function(e){n.push({name:e.name,id:e.alias})}),d.create("div",{id:"dropdownContainerName",innerHTML:"<div id='uploadComboNameWidget'></div>"},a,"first"),r=new l({data:n}),new u({id:"uploadComboNameWidget",value:"-- Choose name field --",store:r,searchAttr:"name",onChange:function(e){e&&(m.addFeaturesToMap(e,o.layers[0].featureSet),t())}},"uploadComboNameWidget")},nextId:function(){var e,t=h.graphics.graphics,r=t.length,a=0,o=0;for(a;r>a;a+=1)"point"!==t[a].geometry.type&&(e=parseInt(t[a].attributes.GRAPHIC_ID),isNaN(e)||(o=e>o?e:o));return o+1},addFeaturesToMap:function(t,a){var i,n,l,d,u=m.defaultGraphicsLayerUniqueId,f=m.defaultGraphicsLayerLabel,b=h.graphics;i=new g(g.STYLE_SOLID,new y(y.STYLE_SOLID,new e([255,0,0]),2),new e([103,200,255,0])),s.forEach(a.features,function(e){e.attributes[f]=e.attributes[t],e.attributes[u]=o.nextAvailableGraphicId(b,u),l=new c(e.geometry),n=new r(l,i,e.attributes),d=d?d.union(l.getExtent()):l.getExtent(),b.add(n),p.vm.customFeaturesArray().push(n)}),p.vm.customFeaturesPresence(!0),h.setExtent(d,!0)}};return b});