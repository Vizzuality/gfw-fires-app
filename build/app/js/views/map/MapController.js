define(["dojo/on","dojo/dom","dojo/query","dojo/dom-construct","dojo/number","dojo/dom-class","dojo/_base/array","dojo/_base/fx","dojo/promise/all","dojo/Deferred","dojo/dom-style","dojo/dom-geometry","esri/map","esri/config","esri/dijit/HomeButton","esri/geometry/Point","esri/dijit/BasemapGallery","esri/dijit/Basemap","esri/dijit/BasemapLayer","esri/dijit/LocateButton","esri/dijit/Geocoder","esri/dijit/Legend","esri/dijit/Scalebar","esri/layers/ArcGISDynamicMapServiceLayer","esri/layers/ArcGISImageServiceLayer","esri/layers/ImageParameters","esri/layers/FeatureLayer","esri/geometry/webMercatorUtils","esri/geometry/Extent","esri/InfoTemplate","esri/graphic","esri/urlUtils","esri/symbols/SimpleFillSymbol","esri/symbols/SimpleLineSymbol","esri/Color","dijit/registry","views/map/MapConfig","views/map/MapModel","views/map/LayerController","views/map/WindyController","views/map/Finder","views/report/ReportOptionsController","utils/DijitFactory","modules/EventsController","esri/request","esri/tasks/query","esri/tasks/QueryTask","esri/tasks/PrintTask","esri/tasks/PrintParameters","esri/tasks/PrintTemplate","views/map/DigitalGlobeTiledLayer","views/map/DigitalGlobeServiceLayer","views/map/BurnScarTiledLayer","modules/HashController","esri/layers/GraphicsLayer","esri/layers/ImageServiceParameters","dijit/Dialog"],function(e,a,t,r,i,o,n,s,l,d,c,y,p,m,u,g,h,b,f,v,w,L,I,k,A,S,O,D,T,x,E,C,P,j,H,M,_,F,G,Y,W,N,R,z,B,V,q,U,J,Z,Q,K,X,ea,aa,ta,ra){var ia,oa={},na=!1,sa={viewId:"mapView",viewName:"map"},la=[],da=new P(P.STYLE_SOLID,new j(j.STYLE_SOLID,new H("yellow"),5),new H([255,255,0,0]));oa.mapExtentPausable,oa.init=function(){var e=this;return na?(oa.map.resize(),void z.switchToView(sa)):(na=!0,void require(["dojo/text!views/map/map.html","dojo/ready"],function(t,r){a.byId(sa.viewId).innerHTML=t,z.switchToView(sa),r(function(){F.applyBindings("map-view"),addthis.init(),e.addConfigurations(),e.createMap()})}))},oa.centerChange=function(){if(oa.map){var a=D.webMercatorToGeographic(oa.map.extent),t=i.round(a.getCenter().x,2),r=i.round(a.getCenter().y,2),o=oa.map.getLevel(),n=ea.newState,s=parseFloat(n.x)!=t||parseFloat(n.y)!=r||parseInt(n.l)!=o;if(s){oa.mapExtentPausable.pause(),e.once(oa.map,"extent-change",function(){oa.mapExtentPausable.resume()});var l=D.geographicToWebMercator(new g(parseFloat(n.x),parseFloat(n.y)));oa.map.centerAndZoom(l,parseInt(n.l))}}},oa.addConfigurations=function(){var e=_.proxies,a=document.location.href,t="/proxy/proxy.ashx";for(var r in e)0===a.indexOf(r)&&(t=e[r],m.defaults.io.proxyUrl=e[r]);C.addProxyRule({urlPrefix:"https://services.digitalglobe.com/",proxyUrl:t}),C.addProxyRule({urlPrefix:_.landsat8.prefix,proxyUrl:t}),m.defaults.io.corsEnabledServers.push(_.windData.domain)},oa.createMap=function(){var a=this;R.buildDijits(_.reportOptionsDijits),R.buildDijits(_.accordionDijits);var t=ea.newState.x,r=ea.newState.y,o=ea.newState.l;oa.map=new p("map",{center:[t,r],zoom:o,basemap:_.mapOptions.basemap,minZoom:_.mapOptions.minZoom,maxZoom:_.mapOptions.maxZoom,sliderPosition:_.mapOptions.sliderPosition}),window.map=oa.map,oa.map.on("load",function(){$("#firesDateFrom").datepicker("setDate","+0m -7d"),$("#noaaDateFrom").datepicker("setDate","10/22/2014"),$("#indoDateFrom").datepicker("setDate","1/1/2013"),oa.map.graphics.clear(),F.vm.windPicker(),M.byId("fires-map-accordion").resize(),Y.setMap(oa.map),G.setMap(oa.map),W.setMap(oa.map),a.addWidgets(),a.bindEvents(),a.addLayers(),e.once(oa.map,"update-end",function(){oa.map.centerAt(new g(t,r)).then(function(){setTimeout(function(){oa.mapExtentPausable.resume()},1e3)})}),oa.map.resize()}),oa.mapExtentPausable=e.pausable(oa.map,"extent-change",function(e){var a=(e.delta,D.webMercatorToGeographic(e.extent)),t=(e.levelChange,e.lod),r=(e.target,i.round(a.getCenter().x,2)),o=i.round(a.getCenter().y,2);ea.updateHash({x:r,y:o,l:t.level}),"on"==dijit.byId("digital-globe-checkbox").getValue()&&oa.updateImageryList()}),oa.mapExtentPausable.pause()},oa.updateImageryList=function(){F.vm.digitalGlobeInView.removeAll();{var a=(_.digitalGlobe,oa.map.getLayer(_.digitalGlobe.graphicsLayerId),new V);l(_.digitalGlobe.mosaics.map(function(e){var t=new d,r=oa.map.extent;a.geometry=r,a.returnGeometry=!1,a.outFields=["*"];var i=new q(_.digitalGlobe.imagedir+e+"/ImageServer");return i.execute(a,function(e){t.resolve(e.features)},function(){t.resolve([])}),t.promise})).then(function(a){la=[];var r=dijit.byId("timeSliderDG").thumbIndexes,i=dijit.byId("timeSliderDG").timeStops,o=moment(i[r[0]]).tz("Asia/Jakarta"),s=moment(i[r[1]]).tz("Asia/Jakarta");a.map(function(e){e.map(function(e){la.push(e)})}),n.forEach(la,function(e){var a=moment(e.attributes.AcquisitionDate).tz("Asia/Jakarta");if(a>=o&&s>=a){var a=moment(e.attributes.AcquisitionDate).tz("Asia/Jakarta");e.attributes.AcquisitionDate2=e.attributes.AcquisitionDate,e.attributes.AcquisitionDate=a.format("YYYY/MM/DD");var t="<a class='popup-link' data-bucket='"+e.attributes.SensorName+"_id_"+e.attributes.OBJECTID+"'>"+a.format("YYYY/MM/DD")+"</a>",r="<a class='popup-link' data-bucket='"+e.attributes.SensorName+"_id_"+e.attributes.OBJECTID+"'>"+e.attributes.SensorName+"</a>";e.attributes.formattedZoomTo="<a class='popup-link-zoom'>Zoom To</a>",e.attributes.formattedDatePrefix1=t,e.attributes.formattedDatePrefix2=r,F.vm.digitalGlobeInView.push({feature:e,mouseover:!1})}}),F.vm.digitalGlobeInView.sort(function(e,a){return e.feature.attributes.AcquisitionDate==a.feature.attributes.AcquisitionDate?0:e.feature.attributes.AcquisitionDate>a.feature.attributes.AcquisitionDate?-1:1});var l=0,d=[];t(".imageryTable .popup-link").forEach(function(a,t){d.push(e(a,"click",function(e){var a=e.target?e.target:e.srcElement,r=a.dataset?a.dataset.bucket:a.getAttribute("data-bucket");$("#imageryWindow > table > tbody > tr").each(function(){$(this).removeClass("imageryRowSelected")}),G.showDigitalGlobeImagery(r),l=t;var i=$(this).parent();console.log(i),$(i).parent().removeClass("imageryRowHover"),$(i).parent().addClass("imageryRowSelected")}))}),$("#imageryWindow > table > tbody > tr").mouseenter(function(){var e=this.firstElementChild;$(this).addClass("imageryRowHover"),e=$(e).html(),e=$(e).attr("data-bucket");for(var a=0;a<la.length;a++){var t=la[a].attributes.SensorName+"_id_"+la[a].attributes.OBJECTID;if(t==e){var r=new P(P.STYLE_SOLID,new j(j.STYLE_SOLID,new H("yellow"),5),new H([255,255,0,0]));la[a].setSymbol(r),ia=new E(la[a].geometry,r),ia.id="highlight",oa.map.graphics.add(ia)}}}),$("#imageryWindow > table > tbody > tr").mouseleave(function(){$(this).removeClass("imageryRowHover"),oa.map.graphics.remove(oa.map.graphics.graphics[oa.map.graphics.graphics.length-1])}),d.push(e(t(".popup-link-zoom"),"click",function(){oa.map.graphics.remove(oa.map.graphics.graphics[oa.map.graphics.graphics.length-1]);var e=$(this).parent()[0],a=e.firstElementChild;a=a.firstElementChild,a=$(a).attr("data-bucket");for(var t=0;t<la.length;t++){var r=la[t].attributes.SensorName+"_id_"+la[t].attributes.OBJECTID;r==a&&oa.map.setExtent(la[t].geometry.getExtent())}}))})}};var ca=$(this).parent();return $(ca).parent().removeClass("imageryRowHover"),$(ca).parent().addClass("imageryRowSelected"),oa.handleImageryOver=function(e,a){console.log("starting function");var t=a.currentTarget;$(t).addClass("imageryRowHover"),ia=new E(e.geometry,da),ia.id="highlight",oa.map.graphics.add(ia)},oa.handleImageryOut=function(e,a){var t=$(a.target).parent();$(t).removeClass("imageryRowHover"),oa.map.graphics.remove(oa.map.graphics.graphics[oa.map.graphics.graphics.length-1])},oa.resizeMapPanel=function(){require(["dojo/fx","dojo/_base/fx","dojo/query","dojo/dom-geometry"],function(e,t){var r=function(){var r=e.chain([t.animateProperty({node:a.byId("control-panel"),properties:{marginLeft:{start:0,end:-320}},units:"px",duration:500})]),i=e.chain([t.animateProperty({node:a.byId("map-container"),properties:{left:{start:320,end:0}},units:"px",duration:500})]),o=e.chain([t.animateProperty({node:a.byId("map"),properties:{left:{start:320,end:0}},onEnd:function(){},units:"px",duration:500})]);r.play(),i.play(),o.play()};r(),setTimeout(function(){oa.map.resize()},500)})},oa.addWidgets=function(){var t,i,o,n,s,l,d,c=[];t=new I({map:oa.map,scalebarUnit:"metric"}),r.create("div",{id:"home-button","class":"home-button"},document.querySelector(".esriSimpleSliderIncrementButton"),"after"),l=new u({map:oa.map},"home-button"),l.startup(),i=new b({layers:[new f({url:_.mapOptions.darkGrayCanvas})],id:"darkgray",title:"Dark Gray Canvas",thumbnailUrl:"app/images/darkGreyThumb.jpg"}),c.push(i),d=new h({map:oa.map,basemaps:c,showArcGISBasemaps:!0},"basemap-gallery"),d.startup(),n=new v({map:oa.map,highlightLocation:!1},"location-widget"),n.startup(),o=new w({map:oa.map},"esri-geocoder-widget"),o.startup(),s=new L({map:oa.map,layerInfos:[],autoUpdate:!0},"legend"),s.startup();var y=function(){F.get("showBasemapGallery")&&F.set("showBasemapGallery",!1),F.get("showShareContainer")&&F.set("showShareContainer",!1),F.set("showLocatorWidgets",!F.get("showLocatorWidgets"))},p=function(){F.get("showLocatorWidgets")&&F.set("showLocatorWidgets",!1),F.get("showShareContainer")&&F.set("showShareContainer",!1),F.set("showBasemapGallery",!F.get("showBasemapGallery"))},m=function(){F.get("showLocatorWidgets")&&F.set("showLocatorWidgets",!1),F.get("showBasemapGallery")&&F.set("showBasemapGallery",!1),F.set("showShareContainer",!F.get("showShareContainer"))};e(a.byId("locator-widget-button"),"click",y),e(a.byId("basemap-gallery-button"),"click",p),e(a.byId("share-button"),"click",m),this.initTransparency()},oa.initTransparency=function(){["forest-transparency-slider","conservation-transparency-slider","land-cover-transparency-slider"].map(function(e){dijit.byId(e).set("value",70)})},oa.bindEvents=function(){var i=this;e(a.byId("dms-search"),"change",function(e){var a=e.target?e.target.checked:e.srcElement.checked;a&&(F.set("showDMSInputs",!0),F.set("showLatLongInputs",!1))}),e(a.byId("lat-long-search"),"change",function(e){var a=e.target?e.target.checked:e.srcElement.checked;a&&(F.set("showLatLongInputs",!0),F.set("showDMSInputs",!1))}),e(oa.map,"mouse-move",function(e){F.set("currentLatitude",e.mapPoint.getLatitude().toFixed(4)),F.set("currentLongitude",e.mapPoint.getLongitude().toFixed(4))}),e(oa.map,"click",function(e){W.selectTomnodFeatures(e)}),e(M.byId("confidence-fires-checkbox"),"change",function(e){G.updateFiresLayer(!0),e&&i.reportAnalyticsHelper("layer","option","The user toggled the Active Fires only show high confidence fires option on.")}),e(M.byId("twitter-conversations-checkbox"),"change",function(){var e=M.byId("twitter-conversations-checkbox").checked;G.toggleLayerVisibility(_.tweetLayer.id,e),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Twitter Conversations layer on.")}),e(M.byId("fires-checkbox"),"change",function(){var e=M.byId("fires-checkbox").checked;G.toggleLayerVisibility(_.firesLayer.id,e),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Active Fires layer on.")}),e(M.byId("air-quality-checkbox"),"change",function(e){G.toggleLayerVisibility(_.airQualityLayer.id,e),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Air Quality layer on.")}),e(M.byId("tomnod-checkbox"),"change",function(e){G.toggleLayerVisibility(_.tomnodLayer.id,e),G.toggleLayerVisibility(_.tomnodLayer.sel_id,e),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Tomnod layer on.")}),e(M.byId("indonesia-fires"),"change",function(e){G.toggleMapServiceLayerVisibility(oa.map.getLayer(_.indonesiaLayers.id),_.indonesiaLayers.layerIds.indonesiaFires,e)}),e(M.byId("confidence-archive-checkbox"),"change",function(){}),e(M.byId("noaa-fires-18"),"change",function(e){G.toggleMapServiceLayerVisibility(oa.map.getLayer(_.indonesiaLayers.id),_.indonesiaLayers.layerIds.noaa18,e)}),e(M.byId("burned-scars-checkbox"),"change",function(e){G.toggleLayerVisibility(_.burnScarLayer.id,e),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Burn Scars layer on.")}),e(M.byId("landsat-image-checkbox"),"change",function(){var e=M.byId("landsat-image-checkbox").checked;G.toggleLayerVisibility(_.landsat8.id,e),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Latest Landsat 8 Imagery layer on.")}),M.byId("windy-layer-checkbox").on("change",function(e){Y.toggleWindLayer(e),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Wind direction layer on.")}),M.byId("digital-globe-checkbox").on("change",function(e){G.toggleDigitalGlobeLayer(e),F.vm.showReportOptionsDigitalGlobe(e),e&&(setTimeout(function(){dijit.byId("digital-globe-footprints-checkbox").set("value","true",!1)},0),i.reportAnalyticsHelper("layer","toggle","The user toggled the Digital Globe - First Look layer on."))}),M.byId("digital-globe-footprints-checkbox").on("change",function(e){G.toggleDigitalGlobeLayer(e,"footprints")}),M.byId("provinces-checkbox").on("change",function(e){G.adjustOverlaysLayer(),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Provinces overlay layer on.")}),M.byId("districts-checkbox").on("change",function(e){G.adjustOverlaysLayer(),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Districts overlay layer on.")}),M.byId("subdistricts-checkbox").on("change",function(e){G.adjustOverlaysLayer(),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Subdistricts overlay layer on.")}),M.byId("villages-checkbox").on("change",function(e){G.adjustOverlaysLayer(),e&&i.reportAnalyticsHelper("layer","toggle","The user toggled the Villages overlay layer on.")}),e(a.byId("search-option-go-button"),"click",function(){W.searchAreaByCoordinates(),i.reportAnalyticsHelper("widget","search","The user searched for location by latitude/longitude or Degrees/Minutes/Seconds.")}),e(a.byId("print-button"),"click",function(){i.printMap(),i.reportAnalyticsHelper("widget","print","The user clicked the print widget to print the map.")}),e(a.byId("report-link"),"click",function(){F.vm.showReportOptions(!0),F.vm.reportAOIs().length<1&&N.populate_select(),i.reportAnalyticsHelper("widget","report","The user clicked Get Fires Analysis to generate an report with the latest analysis.")}),e(a.byId("noaa-fires-18"),"click",function(){if("false"==this.getAttribute("aria-checked")){var e=a.byId("indonesia-fires");return"false"==e.getAttribute("aria-checked")&&(oa.map.getLayer("IndonesiaFires").visible=!1,console.log("Should disable pop-ups")),void F.vm.showReportOptionsNOAA(!1)}F.vm.showReportOptionsNOAA(!0),N.populate_select()}),e(a.byId("indonesia-fires"),"click",function(){if("false"==this.getAttribute("aria-checked")){var e=a.byId("noaa-fires-18");return"false"==e.getAttribute("aria-checked")&&(oa.map.getLayer("IndonesiaFires").visible=!1,console.log("Should disable pop-ups")),void F.vm.showReportOptionsINDO(!1)}F.vm.showReportOptionsINDO(!0),N.populate_select()}),e(a.byId("windy-layer-checkbox"),"click",function(){return"false"==this.getAttribute("aria-checked")?void F.vm.showReportOptionsWIND(!1):(F.vm.showReportOptionsWIND(!0),void N.populate_select())}),e(a.byId("updateNOAA"),"click",function(){var e=F.vm.noaaObservFrom(),a=F.vm.noaaObservTo();a=moment(a).add(1,"day"),e=moment(e).tz("Asia/Jakarta").format("M/D/YYYY"),a=moment(a._d).tz("Asia/Jakarta").format("M/D/YYYY");var t=e.replace(/\//g,"-"),r=a.replace(/\//g,"-"),i=G.getTimeDefinition("Date",t,r);G.updateDynamicMapServiceLayerDefinition(oa.map.getLayer(_.indonesiaLayers.id),_.indonesiaLayers.layerIds.noaa18,i)}),e(a.byId("updateINDO"),"click",function(){var e=F.vm.indoObservFrom(),a=F.vm.indoObservTo();a=moment(a).add(1,"day"),e=moment(e).tz("Asia/Jakarta").format("M/D/YYYY"),a=moment(a._d).tz("Asia/Jakarta").format("M/D/YYYY");var t=e.replace(/\//g,"-"),r=(a.replace(/\//g,"-"),G.getTimeDefinition("ACQ_DATE",t,a));G.updateDynamicMapServiceLayerDefinition(oa.map.getLayer(_.indonesiaLayers.id),_.indonesiaLayers.layerIds.indonesiaFires,r)}),e(a.byId("updateWIND"),"click",function(){var e=F.vm.windObserv(),a=F.vm.timeOfDay(),t=e.split("/"),r=t[2].toString()+t[0].toString()+t[1].toString(),i="http://suitability-mapper.s3.amazonaws.com/wind/archive/wind-surface-level-gfs-"+r+a+".1-0.gz.json";Y.deactivateWindLayer(),Y.activateWindLayer(i)}),e(a.byId("embedShare"),"click",function(){i.showEmbedCode()}),e(a.byId("clear-search-pins"),"click",this.clearSearchPins),e(a.byId("legend-widget-title"),"click",this.toggleLegend),M.byId("forest-transparency-slider").on("change",function(e){G.setTransparency(_.forestUseLayers.id,e)}),M.byId("land-cover-transparency-slider").on("change",function(e){G.setTransparency(_.landCoverLayers.id,e)}),M.byId("conservation-transparency-slider").on("change",function(e){G.setTransparency(_.conservationLayers.id,e)}),t(".active-fires-options").forEach(function(a){e(a,"click",i.toggleFireOption.bind(i))}),t(".esriPopupWrapper").forEach(function(t){r.create("div",{id:"close-icon","class":"close-icon"},t),e(a.byId("close-icon"),"click",function(){oa.map.infoWindow.hide()})}),t("#forest-use-panel div.checkbox-container div input").forEach(function(e){o.add(e,"forest-use-layers-option")}),t("#conservation-panel div.checkbox-container div input").forEach(function(e){o.add(e,"conservation-layers-option")}),t("#land-cover-panel div.checkbox-container div input").forEach(function(e){"land-cover-radios"===e.name&&o.add(e,"land-cover-layers-option")}),t("#forest-use-panel div.checkbox-container div input").forEach(function(a){e(a,"change",function(e){G.updateAdditionalVisibleLayers("forest-use-layers-option",_.forestUseLayers);var a=e.target?e.target:e.srcElement;if(a.checked&&a.labels.length>0){var t=a.labels[0].innerHTML;i.reportAnalyticsHelper("layer","toggle","The user toggled the "+t+" layer on")}})}),t(".conservation-layers-option").forEach(function(a){e(a,"change",function(e){G.updateAdditionalVisibleLayers("conservation-layers-option",_.conservationLayers);var a=e.target?e.target:e.srcElement;if(a.checked&&a.labels.length>0){var t=a.labels[0].innerHTML;i.reportAnalyticsHelper("layer","toggle","The user toggled the "+t+" layer on")}})}),t(".land-cover-layers-option").forEach(function(a){e(a,"change",function(e){G.updateLandCoverLayers(e);var a=e.target?e.target:e.srcElement;if(a.checked&&a.labels.length>0){var t=a.labels[0].innerHTML;-1===t.search("None")&&i.reportAnalyticsHelper("layer","toggle","The user toggled the "+t+" layer on")}})}),t("#primary-forests-options input").forEach(function(a){e(a,"change",function(e){G.updatePrimaryForestsLayer(!0);var a=e.target?e.target:e.srcElement;if(a.checked&&a.labels.length>0){var t=a.labels[0].innerHTML;-1===t.search("Primary")&&(t="Primary Forests "+t),i.reportAnalyticsHelper("layer","toggle","The user toggled the "+t+" layer on")}})})},oa.addLayers=function(){var a,t,r,i,o,s,l,d,c,y,p,m,u,g,h,b,f,v,w=this;a=new S,a.format="png32",a.layerIds=_.conservationLayers.defaultLayers,a.layerOption=S.LAYER_OPTION_SHOW,t=new k(_.conservationLayers.url,{imageParameters:a,id:_.conservationLayers.id,visible:!1}),indonesiaParams=new S,indonesiaParams.format="png32",indonesiaParams.layerIds=_.indonesiaLayers.defaultLayers,indonesiaParams.layerOption=S.LAYER_OPTION_SHOW,indonesiaLayer=new k(_.indonesiaLayers.url,{imageParameters:indonesiaParams,id:_.indonesiaLayers.id,visible:!1}),s=new S,s.format="png32",s.layerIds=_.landCoverLayers.defaultLayers,s.layerOption=S.LAYER_OPTION_SHOW,l=new k(_.landCoverLayers.url,{imageParameters:s,id:_.landCoverLayers.id,visible:!1}),c=new S,c.format="png32",c.layerIds=_.forestUseLayers.defaultLayers,c.layerOption=S.LAYER_OPTION_SHOW,y=new k(_.forestUseLayers.url,{imageParameters:c,id:_.forestUseLayers.id,visible:!1}),p=new A(_.treeCoverLayer.url,{id:_.treeCoverLayer.id,visible:!1}),r=new S,r.format="png32",r.layerIds=_.primaryForestsLayer.defaultLayers,r.layerOption=S.LAYER_OPTION_SHOW,i=new k(_.primaryForestsLayer.url,{imageParameters:r,id:_.primaryForestsLayer.id,visible:!1}),h=new A(_.landsat8.url,{id:_.landsat8.id,visible:!1}),v=_.digitalGlobe,o=v.mosaics.map(function(e){return new A(v.imagedir+e+"/ImageServer",{id:e,visible:!1})}),dglyrs=o,m=new k(_.overlaysLayer.url,{id:_.overlaysLayer.id,visible:!1}),d=new k(_.airQualityLayer.url,{id:_.airQualityLayer.id,visible:!1}),tomnodParams=new S,tomnodParams.layerIds=_.tomnodLayer.defaultLayers,tomnodParams.layerOption=S.LAYER_OPTION_SHOW,g=new k(_.tomnodLayer.url,{imageParameters:tomnodParams,id:_.tomnodLayer.id,visible:!1});var L=new x("${name}",W.getTomnodInfoWindow),I=new O(_.tomnodLayer.url+"/"+_.tomnodLayer.defaultLayers[0],{mode:O.MODE_SELECTION,infoTemplate:L,outFields:["*"],id:_.tomnodLayer.sel_id});u=new X(_.burnScarLayer.url,_.burnScarLayer.id),b=new S,b.format="png32",b.layerIds=_.firesLayer.defaultLayers,b.layerOption=S.LAYER_OPTION_SHOW,f=new k(_.firesLayer.url,{imageParameters:b,id:_.firesLayer.id,visible:!1});var D=new x;D.setContent(W.getFireTweetsInfoWindow),tweetLayer=new O(_.tweetLayer.url,{mode:O.MODE_ONDEMAND,id:_.tweetLayer.id,visible:!1,outFields:["*"],infoTemplate:D});var T={layerDefinition:{geometryType:"esriGeometryPolygon",fields:[]},featureSet:null},E=new O(T,{id:_.digitalGlobe.graphicsLayerId,visible:!1});dglyr=E;var C=[h,p,l,i,E].concat(o).concat([t,u,g,y,m,tweetLayer,d,I,indonesiaLayer,f]);e.once(oa.map,"layers-add-result",function(e){w.enableLayersFromHash();var a=n.map(e.layers,function(e){return{layer:e.layer}});a=n.filter(a,function(e){var a=e.layer.url?e.layer.url.search("ImageServer")<0:!1,t=!(e.layer.id===I.id);return a&&t}),console.dir(a),M.byId("legend").refresh(a)}),oa.map.addLayers(C),m.on("load",G.setOverlayLayerOrder),u.on("error",this.layerAddError),h.on("error",this.layerAddError),p.on("error",this.layerAddError),i.on("error",this.layerAddError),t.on("error",this.layerAddError),l.on("error",this.layerAddError),m.on("error",this.layerAddError),y.on("error",this.layerAddError),f.on("error",this.layerAddError),d.on("error",this.layerAddError)},oa.layerAddError=function(e){require(["modules/ErrorController"],function(a){a.show(10,"Error adding Layer : <br> "+e.target.url)})},oa.toggleFireOption=function(e){var a=e.target?e.target:e.srcElement;t(".selected-fire-option").forEach(function(e){o.remove(e,"selected-fire-option")}),o.add(a,"selected-fire-option"),G.updateFiresLayer()},oa.enableLayersFromHash=function(){function t(){M.byId("fires-checkbox").set("checked",!0),G.updateLayersInHash("add",_.firesLayer.id,_.firesLayer.id)}function r(t,r){if(void 0!==t&&""!==t)if(void 0===r)y[t]&&(o=y[t].id,M.byId(o)&&(M.byId(o).set("checked",!0),e.emit(a.byId(o),"change",{})));else{n=y[t],s=r.split(",");for(var i=0,l=s.length;l>i;i++)if(o=n[s[i]].id,"[object Array]"===Object.prototype.toString.call(o))for(var d=0,c=o.length;c>d;d++)M.byId(o[d])&&(M.byId(o[d]).set("checked",!0),e.emit(a.byId(o[d]),"change",{}));else M.byId(o)&&(M.byId(o).set("checked",!0),e.emit(a.byId(o),"change",{}))}}var i,o,n,s,l=ea.getHash(),d=l.lyrs,c=d.split(":"),y=_.layersCheckboxes;if(void 0===d)return void t();if(1===c.length&&""===c[0])return void t();for(var p=0,m=c.length;m>p;p++)i=c[p].split("/"),r(i[0],i[1])},oa.clearSearchPins=function(){oa.map.graphics.clear(),F.set("showClearPinsOption",!1)},oa.toggleLegend=function(){var e=a.byId("legend-widget-container"),t=e.offsetHeight-2===280?30:280;s.animateProperty({node:e,properties:{height:t},duration:500}).play(),30===t?o.add("legend-widget-title","legend-closed"):o.remove("legend-widget-title","legend-closed")},oa.printMap=function(){var a=document.getElementsByTagName("body")[0];o.add("print-button","loading"),o.add(a,"map-view-print"),M.byId("stackContainer").resize(),M.byId("mapView").resize(),oa.map.resize(),e.once(oa.map,"resize",function(){setTimeout(function(){window.print(),o.remove("print-button","loading"),o.remove(a,"map-view-print"),M.byId("stackContainer").resize(),oa.map.resize()},2e3)})},oa.reportAnalyticsHelper=function(e,a,t){ga("A.send","event",e,a,t),ga("B.send","event",e,a,t)},oa.showEmbedCode=function(){M.byId("embedCodeShareDialog")&&M.byId("embedCodeShareDialog").destroy();var e,t="<iframe src='"+window.location+"' height='600' width='900'></iframe>",r=new ra({title:"Embed Code",style:"width: 350px",id:"embedCodeShareDialog",content:'Copy the code below to embed in your site. (Ctrl+C on PC and Cmd+C on Mac)<div class=\'dijitDialogPaneActionBar\'><input id="embedInput" type="text" value="'+t+'" autofocus /></div>'});e=function(){r.destroy()},r.show(),a.byId("embedInput").select(),r.on("cancel",function(){e()})},oa});