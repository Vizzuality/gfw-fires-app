/*! Global-Forest-Watch-Fires Tue Jul 22 2014 16:30:35 */
define(["dojo/on","dojo/dom","dojo/query","dojo/dom-construct","dojo/number","dojo/dom-class","dojo/_base/array","dojo/_base/fx","esri/map","esri/config","esri/dijit/HomeButton","esri/geometry/Point","esri/dijit/BasemapGallery","esri/dijit/Basemap","esri/dijit/BasemapLayer","esri/dijit/LocateButton","esri/dijit/Geocoder","esri/dijit/Legend","esri/dijit/Scalebar","esri/layers/ArcGISDynamicMapServiceLayer","esri/layers/ArcGISImageServiceLayer","esri/layers/ImageParameters","esri/layers/FeatureLayer","esri/geometry/webMercatorUtils","esri/geometry/Extent","esri/InfoTemplate","esri/graphic","esri/urlUtils","dijit/registry","views/map/MapConfig","views/map/MapModel","views/map/LayerController","views/map/WindyController","views/map/Finder","utils/DijitFactory","modules/EventsController","esri/request","esri/tasks/PrintTask","esri/tasks/PrintParameters","esri/tasks/PrintTemplate","views/map/DigitalGlobeTiledLayer","views/map/BurnScarTiledLayer","modules/HashController"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q){var R={},S=!1,T={viewId:"mapView",viewName:"map"};return R.mapExtentPausable,R.init=function(){var a=this;return S?(R.map.resize(),void J.switchToView(T)):(S=!0,void require(["dojo/text!views/map/map.html","dojo/ready"],function(c,d){b.byId(T.viewId).innerHTML=c,J.switchToView(T),d(function(){E.applyBindings("map-view"),addthis.init(),a.addConfigurations(),a.createMap()})}))},R.centerChange=function(){if(R.map){var b=x.webMercatorToGeographic(R.map.extent),c=e.round(b.getCenter().x,2),d=e.round(b.getCenter().y,2),f=R.map.getLevel(),g=Q.newState,h=parseFloat(g.x)!=c||parseFloat(g.y)!=d||parseInt(g.l)!=f;if(h){R.mapExtentPausable.pause(),a.once(R.map,"extent-change",function(){R.mapExtentPausable.resume()});var i=x.geographicToWebMercator(new l(parseFloat(g.x),parseFloat(g.y)));R.map.centerAndZoom(i,parseInt(g.l))}}},R.addConfigurations=function(){var a=D.proxies,b=document.location.href,c="/proxy/proxy.ashx";for(var d in a)0===b.indexOf(d)&&(c=a[d]);B.addProxyRule({urlPrefix:"https://services.digitalglobe.com/",proxyUrl:c}),B.addProxyRule({urlPrefix:D.landsat8.prefix,proxyUrl:c}),B.addProxyRule({urlPrefix:D.windData.prefix,proxyUrl:c})},R.createMap=function(){var b=this;I.buildDijits(D.accordionDijits);var c=Q.newState.x,d=Q.newState.y,f=Q.newState.l;R.map=new i("map",{center:[c,d],zoom:f,basemap:D.mapOptions.basemap,minZoom:D.mapOptions.minZoom,sliderPosition:D.mapOptions.sliderPosition}),R.map.on("load",function(){R.map.graphics.clear(),C.byId("fires-map-accordion").resize(),G.setMap(R.map),F.setMap(R.map),H.setMap(R.map),b.addWidgets(),b.bindEvents(),b.addLayers();var e=R.map.on("resize",function(){a.once(R.map,"update-end",function(){R.map.centerAt(new l(c,d)).then(function(){R.mapExtentPausable.resume()})}),e.remove()});R.map.resize()}),R.mapExtentPausable=a.pausable(R.map,"extent-change",function(a){var b=(a.delta,x.webMercatorToGeographic(a.extent)),c=(a.levelChange,a.lod),d=(a.target,e.round(b.getCenter().x,2)),f=e.round(b.getCenter().y,2);Q.updateHash({x:d,y:f,l:c.level})}),R.mapExtentPausable.pause()},R.addWidgets=function(){var c,e,f,g,h,i,j,l=[];c=new s({map:R.map,scalebarUnit:"metric"}),d.create("div",{id:"home-button","class":"home-butotn"},document.querySelector(".esriSimpleSliderIncrementButton"),"after"),i=new k({map:R.map},"home-button"),i.startup(),e=new n({layers:[new o({url:D.mapOptions.darkGrayCanvas})],title:"Dark Gray Canvas",thumbnailUrl:"app/images/darkGreyThumb.png"}),l.push(e),j=new m({map:R.map,basemaps:l,showArcGISBasemaps:!0},"basemap-gallery"),j.startup(),g=new p({map:R.map,highlightLocation:!1},"location-widget"),g.startup(),f=new q({map:R.map},"esri-geocoder-widget"),f.startup(),h=new r({map:R.map,layerInfos:[],autoUpdate:!0},"legend"),h.startup();var t=function(){E.get("showBasemapGallery")&&E.set("showBasemapGallery",!1),E.get("showShareContainer")&&E.set("showShareContainer",!1),E.set("showLocatorWidgets",!E.get("showLocatorWidgets"))},u=function(){E.get("showLocatorWidgets")&&E.set("showLocatorWidgets",!1),E.get("showShareContainer")&&E.set("showShareContainer",!1),E.set("showBasemapGallery",!E.get("showBasemapGallery"))},v=function(){E.get("showLocatorWidgets")&&E.set("showLocatorWidgets",!1),E.get("showBasemapGallery")&&E.set("showBasemapGallery",!1),E.set("showShareContainer",!E.get("showShareContainer"))};a(b.byId("locator-widget-button"),"click",t),a(b.byId("basemap-gallery-button"),"click",u),a(b.byId("share-button"),"click",v)},R.bindEvents=function(){var e=this;a(b.byId("dms-search"),"change",function(a){var b=a.target?a.target.checked:a.srcElement.checked;b&&(E.set("showDMSInputs",!0),E.set("showLatLongInputs",!1))}),a(b.byId("lat-long-search"),"change",function(a){var b=a.target?a.target.checked:a.srcElement.checked;b&&(E.set("showLatLongInputs",!0),E.set("showDMSInputs",!1))}),a(R.map,"mouse-move",function(a){E.set("currentLatitude",a.mapPoint.getLatitude().toFixed(4)),E.set("currentLongitude",a.mapPoint.getLongitude().toFixed(4))}),a(R.map,"click",function(a){H.getActiveFiresInfoWindow(a)}),a(C.byId("confidence-fires-checkbox"),"change",function(){F.updateFiresLayer(!0)}),a(C.byId("twitter-conversations-checkbox"),"change",function(){var a=C.byId("twitter-conversations-checkbox").checked;F.toggleLayerVisibility(D.tweetLayer.id,a)}),a(C.byId("fires-checkbox"),"change",function(){var a=C.byId("fires-checkbox").checked;F.toggleLayerVisibility(D.firesLayer.id,a)}),a(C.byId("air-quality-checkbox"),"change",function(a){F.toggleLayerVisibility(D.airQualityLayer.id,a)}),a(C.byId("burned-scars-checkbox"),"change",function(a){F.toggleLayerVisibility(D.burnScarLayer.id,a)}),a(C.byId("landsat-image-checkbox"),"change",function(){var a=C.byId("landsat-image-checkbox").checked;F.toggleLayerVisibility(D.landsat8.id,a)}),C.byId("windy-layer-checkbox").on("change",function(a){G.toggleWindLayer(a)}),C.byId("digital-globe-checkbox").on("change",function(a){F.toggleDigitalGlobeLayer(a)}),C.byId("provinces-checkbox").on("change",function(){F.adjustOverlaysLayer()}),C.byId("districts-checkbox").on("change",function(){F.adjustOverlaysLayer()}),C.byId("subdistricts-checkbox").on("change",function(){F.adjustOverlaysLayer()}),C.byId("villages-checkbox").on("change",function(){F.adjustOverlaysLayer()}),a(b.byId("search-option-go-button"),"click",function(){H.searchAreaByCoordinates()}),a(b.byId("print-button"),"click",function(){e.printMap()}),a(b.byId("report-link"),"click",function(){window.open("./app/js/views/report/report.html","Report","")}),a(b.byId("clear-search-pins"),"click",this.clearSearchPins),a(b.byId("legend-widget-title"),"click",this.toggleLegend),C.byId("forest-transparency-slider").on("change",function(a){F.setTransparency(D.forestUseLayers.id,a)}),C.byId("land-cover-transparency-slider").on("change",function(a){F.setTransparency(D.landCoverLayers.id,a)}),C.byId("conservation-transparency-slider").on("change",function(a){F.setTransparency(D.conservationLayers.id,a)}),c(".active-fires-options").forEach(function(b){a(b,"click",e.toggleFireOption.bind(e))}),c(".esriPopupWrapper").forEach(function(b){d.create("div",{id:"close-icon","class":"close-icon"},b),a(b,"click",function(){R.map.infoWindow.hide()})}),c("#forest-use-panel div.checkbox-container div input").forEach(function(a){f.add(a,"forest-use-layers-option")}),c("#conservation-panel div.checkbox-container div input").forEach(function(a){f.add(a,"conservation-layers-option")}),c("#land-cover-panel div.checkbox-container div input").forEach(function(a){"land-cover-radios"===a.name&&f.add(a,"land-cover-layers-option")}),c("#forest-use-panel div.checkbox-container div input").forEach(function(b){a(b,"change",function(){F.updateAdditionalVisibleLayers("forest-use-layers-option",D.forestUseLayers)})}),c(".conservation-layers-option").forEach(function(b){a(b,"change",function(){F.updateAdditionalVisibleLayers("conservation-layers-option",D.conservationLayers)})}),c(".land-cover-layers-option").forEach(function(b){a(b,"change",function(a){F.updateLandCoverLayers(a)})}),c("#primary-forests-options input").forEach(function(b){a(b,"change",function(){F.updatePrimaryForestsLayer(!0)})})},R.addLayers=function(){var b,c,d,e,f,h,i,j,k,l,m,n,o,p,q,r,s=this;b=new v,b.format="png32",b.layerIds=D.conservationLayers.defaultLayers,b.layerOption=v.LAYER_OPTION_SHOW,c=new t(D.conservationLayers.url,{imageParameters:b,id:D.conservationLayers.id,visible:!1}),h=new v,h.format="png32",h.layerIds=D.landCoverLayers.defaultLayers,h.layerOption=v.LAYER_OPTION_SHOW,i=new t(D.landCoverLayers.url,{imageParameters:h,id:D.landCoverLayers.id,visible:!1}),k=new v,k.format="png32",k.layerIds=D.forestUseLayers.defaultLayers,k.layerOption=v.LAYER_OPTION_SHOW,l=new t(D.forestUseLayers.url,{imageParameters:k,id:D.forestUseLayers.id,visible:!1}),m=new u(D.treeCoverLayer.url,{id:D.treeCoverLayer.id,visible:!1}),d=new v,d.format="png32",d.layerIds=D.primaryForestsLayer.defaultLayers,d.layerOption=v.LAYER_OPTION_SHOW,e=new t(D.primaryForestsLayer.url,{imageParameters:d,id:D.primaryForestsLayer.id,visible:!1}),p=new u(D.landsat8.url,{id:D.landsat8.id,visible:!1}),f=new u(D.digitalGlobe.url,{id:D.digitalGlobe.id,visible:!1}),n=new t(D.overlaysLayer.url,{id:D.overlaysLayer.id,visible:!1}),j=new t(D.airQualityLayer.url,{id:D.airQualityLayer.id,visible:!1}),o=new P(D.burnScarLayer.url,D.burnScarLayer.id),q=new v,q.format="png32",q.layerIds=D.firesLayer.defaultLayers,q.layerOption=v.LAYER_OPTION_SHOW,r=new t(D.firesLayer.url,{imageParameters:q,id:D.firesLayer.id,visible:!1});var x=new z;x.setContent(H.getFireTweetsInfoWindow),tweetLayer=new w(D.tweetLayer.url,{mode:w.MODE_ONDEMAND,id:D.tweetLayer.id,visible:!1,outFields:["*"],infoTemplate:x}),R.map.addLayers([m,p,i,e,l,c,f,o,n,j,r,tweetLayer]),a.once(R.map,"layers-add-result",function(a){s.enableLayersFromHash();var b=g.map(a.layers,function(a){return{layer:a.layer}});b=g.filter(b,function(a){return a.layer.url.search("ImageServer")<0}),C.byId("legend").refresh(b)}),n.on("load",F.setOverlayLayerOrder),o.on("error",this.layerAddError),p.on("error",this.layerAddError),m.on("error",this.layerAddError),e.on("error",this.layerAddError),c.on("error",this.layerAddError),i.on("error",this.layerAddError),n.on("error",this.layerAddError),l.on("error",this.layerAddError),r.on("error",this.layerAddError)},R.layerAddError=function(a){require(["modules/ErrorController"],function(b){b.show(10,"Error adding Layer : <br> "+a.target.url)})},R.toggleFireOption=function(a){var b=a.target?a.target:a.srcElement;c(".selected-fire-option").forEach(function(a){f.remove(a,"selected-fire-option")}),f.add(b,"selected-fire-option"),F.updateFiresLayer()},R.enableLayersFromHash=function(){function c(){C.byId("fires-checkbox").set("checked",!0),F.updateLayersInHash("add",D.firesLayer.id,D.firesLayer.id)}function d(c,d){if(void 0!==c&&""!==c)if(void 0===d)f=l[c].id,C.byId(f)&&(C.byId(f).set("checked",!0),a.emit(b.byId(f),"change",{}));else{g=l[c],h=d.split(",");for(var e=0,i=h.length;i>e;e++)if(f=g[h[e]].id,"[object Array]"===Object.prototype.toString.call(f))for(var j=0,k=f.length;k>j;j++)C.byId(f[j])&&(C.byId(f[j]).set("checked",!0),a.emit(b.byId(f[j]),"change",{}));else C.byId(f)&&(C.byId(f).set("checked",!0),a.emit(b.byId(f),"change",{}))}}var e,f,g,h,i=Q.getHash(),j=i.lyrs,k=j.split(":"),l=D.layersCheckboxes;if(void 0===j)return void c();if(1===k.length&&""===k[0])return void c();for(var m=0,n=k.length;n>m;m++)e=k[m].split("/"),d(e[0],e[1])},R.clearSearchPins=function(){R.map.graphics.clear(),E.set("showClearPinsOption",!1)},R.toggleLegend=function(){var a=b.byId("legend-widget-container"),c=a.offsetHeight-2===280?30:280;h.animateProperty({node:a,properties:{height:c},duration:500}).play(),30===c?f.add("legend-widget-title","legend-closed"):f.remove("legend-widget-title","legend-closed")},R.printMap=function(){var a,b,c=new L(D.printOptions.url),d=new N,e=new M,g="You need to disable your pop-up blocker to see the printed map.";d.format="png32",d.layout=D.printOptions.template,d.showAttribution=!1,d.preserveScale=!1,e.map=R.map,a=function(a){var b=window.open(a.url,"_blank");f.remove("print-button","loading"),(null===b||void 0===typeof b||void 0===b)&&alert(g)},b=function(a){f.remove("print-button","loading"),console.error(a)},f.add("print-button","loading"),c.execute(e,a,b)},R});