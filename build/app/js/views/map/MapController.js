define(["dojo/on","dojo/dom","dojo/query","dojo/dom-construct","dojo/number","dojo/dom-class","dojo/_base/array","dojo/_base/fx","esri/map","esri/config","esri/dijit/HomeButton","esri/geometry/Point","esri/dijit/BasemapGallery","esri/dijit/Basemap","esri/dijit/BasemapLayer","esri/dijit/LocateButton","esri/dijit/Geocoder","esri/dijit/Legend","esri/dijit/Scalebar","esri/layers/ArcGISDynamicMapServiceLayer","esri/layers/ArcGISImageServiceLayer","esri/layers/ImageParameters","esri/layers/FeatureLayer","esri/geometry/webMercatorUtils","esri/InfoTemplate","esri/graphic","esri/urlUtils","dijit/registry","views/map/MapConfig","views/map/MapModel","views/map/LayerController","views/map/WindyController","views/map/Finder","utils/DijitFactory","modules/EventsController","esri/request","esri/tasks/PrintTask","esri/tasks/PrintParameters","esri/tasks/PrintTemplate","views/map/DigitalGlobeTiledLayer","modules/HashController"],function(e,r,a,t,i,n,o,s,d,c,l,p,y,u,g,h,m,f,b,v,L,w,I,x,k,O,P,E,C,S,A,j,T,F,M,W,G,H,_,B,D){var U={},R=!1,N={viewId:"mapView",viewName:"map"};return U.mapExtentPausable,U.init=function(){var e=this;return R?(U.map.resize(),void M.switchToView(N)):(R=!0,void require(["dojo/text!views/map/map.html","dojo/ready"],function(a,t){r.byId(N.viewId).innerHTML=a,M.switchToView(N),t(function(){S.applyBindings("map-view"),addthis.init(),e.addConfigurations(),e.createMap()})}))},U.centerChange=function(){if(U.map){var r=x.webMercatorToGeographic(U.map.extent),a=i.round(r.getCenter().x,2),t=i.round(r.getCenter().y,2),n=U.map.getLevel(),o=D.newState,s=parseFloat(o.x)!=a||parseFloat(o.y)!=t||parseInt(o.l)!=n;if(s){U.mapExtentPausable.pause(),e.once(U.map,"extent-change",function(){U.mapExtentPausable.resume()});var d=x.geographicToWebMercator(new p(parseFloat(o.x),parseFloat(o.y)));U.map.centerAndZoom(d,parseInt(o.l))}}},U.addConfigurations=function(){var e=C.proxies,r=document.location.href,a="/proxy/proxy.ashx";for(var t in e)0===r.indexOf(t)&&(a=e[t]);P.addProxyRule({urlPrefix:"https://services.digitalglobe.com/",proxyUrl:a}),P.addProxyRule({urlPrefix:C.landsat8.prefix,proxyUrl:a}),P.addProxyRule({urlPrefix:C.windData.prefix,proxyUrl:a})},U.createMap=function(){var r=this;F.buildDijits(C.accordionDijits);var a=D.newState.x,t=D.newState.y,n=D.newState.l;U.map=new d("map",{center:[a,t],zoom:n,basemap:C.mapOptions.basemap,minZoom:C.mapOptions.minZoom,sliderPosition:C.mapOptions.sliderPosition}),U.map.on("load",function(){E.byId("fires-map-accordion").resize(),U.map.graphics.clear(),j.setMap(U.map),A.setMap(U.map),T.setMap(U.map),r.addWidgets(),r.bindEvents(),r.addLayers(),U.map.resize()}),U.mapExtentPausable=e.pausable(U.map,"extent-change",function(e){var r=(e.delta,x.webMercatorToGeographic(e.extent)),a=(e.levelChange,e.lod),t=(e.target,i.round(r.getCenter().x,2)),n=i.round(r.getCenter().y,2);D.updateHash({x:t,y:n,l:a.level})})},U.addWidgets=function(){var a,i,n,o,s,d,c,p=[];a=new b({map:U.map,scalebarUnit:"metric"}),t.create("div",{id:"home-button","class":"home-butotn"},document.querySelector(".esriSimpleSliderIncrementButton"),"after"),d=new l({map:U.map},"home-button"),d.startup(),i=new u({layers:[new g({url:C.mapOptions.darkGrayCanvas})],title:"Dark Gray Canvas",thumbnailUrl:"app/images/darkGreyThumb.png"}),p.push(i),c=new y({map:U.map,basemaps:p,showArcGISBasemaps:!0},"basemap-gallery"),c.startup(),o=new h({map:U.map,highlightLocation:!1},"location-widget"),o.startup(),n=new m({map:U.map},"esri-geocoder-widget"),n.startup(),s=new f({map:U.map,layerInfos:[],autoUpdate:!0},"legend"),s.startup();var v=function(){S.get("showBasemapGallery")&&S.set("showBasemapGallery",!1),S.get("showShareContainer")&&S.set("showShareContainer",!1),S.set("showLocatorWidgets",!S.get("showLocatorWidgets"))},L=function(){S.get("showLocatorWidgets")&&S.set("showLocatorWidgets",!1),S.get("showShareContainer")&&S.set("showShareContainer",!1),S.set("showBasemapGallery",!S.get("showBasemapGallery"))},w=function(){S.get("showLocatorWidgets")&&S.set("showLocatorWidgets",!1),S.get("showBasemapGallery")&&S.set("showBasemapGallery",!1),S.set("showShareContainer",!S.get("showShareContainer"))};e(r.byId("locator-widget-button"),"click",v),e(r.byId("basemap-gallery-button"),"click",L),e(r.byId("share-button"),"click",w)},U.bindEvents=function(){var i=this;e(r.byId("dms-search"),"change",function(e){var r=e.target?e.target.checked:e.srcElement.checked;r&&(S.set("showDMSInputs",!0),S.set("showLatLongInputs",!1))}),e(r.byId("lat-long-search"),"change",function(e){var r=e.target?e.target.checked:e.srcElement.checked;r&&(S.set("showLatLongInputs",!0),S.set("showDMSInputs",!1))}),e(U.map,"mouse-move",function(e){S.set("currentLatitude",e.mapPoint.getLatitude().toFixed(4)),S.set("currentLongitude",e.mapPoint.getLongitude().toFixed(4))}),e(U.map,"click",function(e){T.getActiveFiresInfoWindow(e)}),e(E.byId("confidence-fires-checkbox"),"change",function(){A.updateFiresLayer(!0)}),e(E.byId("twitter-conversations-checkbox"),"change",function(){var e=E.byId("twitter-conversations-checkbox").checked;A.toggleLayerVisibility(C.tweetLayer.id,e)}),e(E.byId("fires-checkbox"),"change",function(){var e=E.byId("fires-checkbox").checked;A.toggleLayerVisibility(C.firesLayer.id,e)}),e(E.byId("air-quality-checkbox"),"change",function(e){A.toggleLayerVisibility(C.airQualityLayer.id,e)}),e(E.byId("landsat-image-checkbox"),"change",function(){var e=E.byId("landsat-image-checkbox").checked;A.toggleLayerVisibility(C.landsat8.id,e)}),E.byId("windy-layer-checkbox").on("change",function(e){j.toggleWindLayer(e)}),E.byId("digital-globe-checkbox").on("change",function(e){A.toggleDigitalGlobeLayer(e)}),E.byId("provinces-checkbox").on("change",function(){A.adjustOverlaysLayer()}),E.byId("districts-checkbox").on("change",function(){A.adjustOverlaysLayer()}),E.byId("subdistricts-checkbox").on("change",function(){A.adjustOverlaysLayer()}),E.byId("villages-checkbox").on("change",function(){A.adjustOverlaysLayer()}),e(r.byId("search-option-go-button"),"click",function(){T.searchAreaByCoordinates()}),e(r.byId("print-button"),"click",function(){i.printMap()}),e(r.byId("report-link"),"click",function(){window.open("./app/js/views/report/report.html","Report","")}),e(r.byId("clear-search-pins"),"click",this.clearSearchPins),e(r.byId("legend-widget-title"),"click",this.toggleLegend),E.byId("forest-transparency-slider").on("change",function(e){A.setTransparency(C.forestUseLayers.id,e)}),E.byId("land-cover-transparency-slider").on("change",function(e){A.setTransparency(C.landCoverLayers.id,e)}),E.byId("conservation-transparency-slider").on("change",function(e){A.setTransparency(C.conservationLayers.id,e)}),a(".active-fires-options").forEach(function(r){e(r,"click",i.toggleFireOption.bind(i))}),a(".esriPopupWrapper").forEach(function(r){t.create("div",{id:"close-icon","class":"close-icon"},r),e(r,"click",function(){U.map.infoWindow.hide()})}),a("#forest-use-panel div.checkbox-container div input").forEach(function(e){n.add(e,"forest-use-layers-option")}),a("#conservation-panel div.checkbox-container div input").forEach(function(e){n.add(e,"conservation-layers-option")}),a("#land-cover-panel div.checkbox-container div input").forEach(function(e){"land-cover-radios"===e.name&&n.add(e,"land-cover-layers-option")}),a("#forest-use-panel div.checkbox-container div input").forEach(function(r){e(r,"change",function(){A.updateAdditionalVisibleLayers("forest-use-layers-option",C.forestUseLayers)})}),a(".conservation-layers-option").forEach(function(r){e(r,"change",function(){A.updateAdditionalVisibleLayers("conservation-layers-option",C.conservationLayers)})}),a(".land-cover-layers-option").forEach(function(r){e(r,"change",function(e){A.updateLandCoverLayers(e)})}),a("#primary-forests-options input").forEach(function(r){e(r,"change",function(){A.updatePrimaryForestsLayer(!0)})})},U.addLayers=function(){var r,a,t,i,n,s,d,c,l,p,y,u,g,h,m,f,b,x=this;r=new w,r.format="png32",r.layerIds=C.conservationLayers.defaultLayers,r.layerOption=w.LAYER_OPTION_SHOW,a=new v(C.conservationLayers.url,{imageParameters:r,id:C.conservationLayers.id,visible:!1}),t=new w,t.format="png32",t.layerIds=C.burnedAreaLayers.defaultLayers,t.layerOption=w.LAYER_OPTION_SHOW,i=new v(C.burnedAreaLayers.url,{imageParameters:t,id:C.burnedAreaLayers.id,visible:!1}),c=new w,c.format="png32",c.layerIds=C.landCoverLayers.defaultLayers,c.layerOption=w.LAYER_OPTION_SHOW,l=new v(C.landCoverLayers.url,{imageParameters:c,id:C.landCoverLayers.id,visible:!1}),y=new w,y.format="png32",y.layerIds=C.forestUseLayers.defaultLayers,y.layerOption=w.LAYER_OPTION_SHOW,u=new v(C.forestUseLayers.url,{imageParameters:y,id:C.forestUseLayers.id,visible:!1}),g=new L(C.treeCoverLayer.url,{id:C.treeCoverLayer.id,visible:!1}),n=new w,n.format="png32",n.layerIds=C.primaryForestsLayer.defaultLayers,n.layerOption=w.LAYER_OPTION_SHOW,s=new v(C.primaryForestsLayer.url,{imageParameters:n,id:C.primaryForestsLayer.id,visible:!1}),m=new L(C.landsat8.url,{id:C.landsat8.id,visible:!1}),d=new L(C.digitalGlobe.url,{id:C.digitalGlobe.id,visible:!1}),h=new v(C.overlaysLayer.url,{id:C.overlaysLayer.id,visible:!1}),p=new v(C.airQualityLayer.url,{id:C.airQualityLayer.id,visible:!1}),f=new w,f.format="png32",f.layerIds=C.firesLayer.defaultLayers,f.layerOption=w.LAYER_OPTION_SHOW,b=new v(C.firesLayer.url,{imageParameters:f,id:C.firesLayer.id,visible:!1});var O=new k;O.setContent(T.getFireTweetsInfoWindow),tweetLayer=new I(C.tweetLayer.url,{mode:I.MODE_ONDEMAND,id:C.tweetLayer.id,visible:!1,outFields:["*"],infoTemplate:O}),U.map.addLayers([g,m,l,s,u,a,i,d,h,p,b,tweetLayer]),e.once(U.map,"layers-add-result",function(e){x.enableLayersFromHash();var r=o.map(e.layers,function(e){return{layer:e.layer}});r=o.filter(r,function(e){return e.layer.url.search("ImageServer")<0}),E.byId("legend").refresh(r)}),h.on("load",A.setOverlayLayerOrder),m.on("error",this.layerAddError),g.on("error",this.layerAddError),s.on("error",this.layerAddError),a.on("error",this.layerAddError),l.on("error",this.layerAddError),h.on("error",this.layerAddError),u.on("error",this.layerAddError),b.on("error",this.layerAddError)},U.layerAddError=function(e){require(["modules/ErrorController"],function(r){r.show(10,"Error adding Layer : <br> "+e.target.url)})},U.toggleFireOption=function(e){var r=e.target?e.target:e.srcElement;a(".selected-fire-option").forEach(function(e){n.remove(e,"selected-fire-option")}),n.add(r,"selected-fire-option"),A.updateFiresLayer()},U.enableLayersFromHash=function(){function a(){E.byId("fires-checkbox").set("checked",!0),E.byId("peat-lands-radio").set("checked",!0),e.emit(r.byId("peat-lands-radio"),"change",{}),A.updateLayersInHash("add",C.firesLayer.id,C.firesLayer.id),A.updateLayersInHash("add",C.landCoverLayers.id,C.landCoverLayers.id+"/1")}function t(a,t){if(void 0!==a&&""!==a)if(void 0===t)n=p[a].id,E.byId(n)&&(E.byId(n).set("checked",!0),"radio"===p[a].type&&e.emit(r.byId(n),"change",{}));else{o=p[a],s=t.split(",");for(var i=0,d=s.length;d>i;i++)n=o[s[i]].id,E.byId(n)&&(E.byId(n).set("checked",!0),"radio"===o[s[i]].type&&e.emit(r.byId(n),"change",{}))}}var i,n,o,s,d=D.getHash(),c=d.lyrs,l=c.split(":"),p=C.layersCheckboxes;if(void 0===c)return void a();if(1===l.length&&""===l[0])return void a();for(var y=0,u=l.length;u>y;y++)i=l[y].split("/"),t(i[0],i[1])},U.clearSearchPins=function(){U.map.graphics.clear(),S.set("showClearPinsOption",!1)},U.toggleLegend=function(){var e=r.byId("legend-widget-container"),a=e.offsetHeight-2===200?30:200;s.animateProperty({node:e,properties:{height:a},duration:500}).play(),30===a?n.add("legend-widget-title","legend-closed"):n.remove("legend-widget-title","legend-closed")},U.printMap=function(){function e(){r.byId("print-button").innerHTML="P"===r.byId("print-button").innerHTML?"":"P"}var a,t,i=new G(C.printOptions.url),o=new _,s=new H,d="You need to disable your pop-up blocker to see the printed map.";o.format="png32",o.layout=C.printOptions.template,o.showAttribution=!1,o.preserveScale=!1,s.map=U.map,a=function(r){var a=window.open(r.url,"_blank");n.remove("print-button","loading"),e(),(null===a||void 0===typeof a||void 0===a)&&alert(d)},t=function(r){n.remove("print-button","loading"),e(),console.error(r)},e(),n.add("print-button","loading"),i.execute(s,a,t)},U});