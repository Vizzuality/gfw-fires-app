define(["dojo/on","dojo/dom","dojo/query","dojo/dom-construct","dojo/number","dojo/dom-class","dojo/_base/array","dojo/_base/fx","esri/map","esri/config","esri/dijit/HomeButton","esri/geometry/Point","esri/dijit/BasemapGallery","esri/dijit/Basemap","esri/dijit/BasemapLayer","esri/dijit/LocateButton","esri/dijit/Geocoder","esri/dijit/Legend","esri/dijit/Scalebar","esri/layers/ArcGISDynamicMapServiceLayer","esri/layers/ArcGISImageServiceLayer","esri/layers/ImageParameters","esri/layers/FeatureLayer","esri/geometry/webMercatorUtils","esri/geometry/Extent","esri/InfoTemplate","esri/graphic","esri/urlUtils","dijit/registry","views/map/MapConfig","views/map/MapModel","views/map/LayerController","views/map/WindyController","views/map/Finder","utils/DijitFactory","modules/EventsController","esri/request","esri/tasks/PrintTask","esri/tasks/PrintParameters","esri/tasks/PrintTemplate","views/map/DigitalGlobeTiledLayer","views/map/BurnScarTiledLayer","modules/HashController"],function(e,r,a,t,i,n,o,s,d,c,l,p,y,u,g,h,m,f,b,v,w,L,I,x,k,E,O,P,C,S,j,A,F,T,G,M,W,B,H,_,D,U,V){var R={},N=!1,q={viewId:"mapView",viewName:"map"};return R.mapExtentPausable,R.init=function(){var e=this;return N?(R.map.resize(),void M.switchToView(q)):(N=!0,void require(["dojo/text!views/map/map.html","dojo/ready"],function(a,t){r.byId(q.viewId).innerHTML=a,M.switchToView(q),t(function(){j.applyBindings("map-view"),addthis.init(),e.addConfigurations(),e.createMap()})}))},R.centerChange=function(){if(R.map){var r=x.webMercatorToGeographic(R.map.extent),a=i.round(r.getCenter().x,2),t=i.round(r.getCenter().y,2),n=R.map.getLevel(),o=V.newState,s=parseFloat(o.x)!=a||parseFloat(o.y)!=t||parseInt(o.l)!=n;if(s){R.mapExtentPausable.pause(),e.once(R.map,"extent-change",function(){R.mapExtentPausable.resume()});var d=x.geographicToWebMercator(new p(parseFloat(o.x),parseFloat(o.y)));R.map.centerAndZoom(d,parseInt(o.l))}}},R.addConfigurations=function(){var e=S.proxies,r=document.location.href,a="/proxy/proxy.ashx";for(var t in e)0===r.indexOf(t)&&(a=e[t]);P.addProxyRule({urlPrefix:"https://services.digitalglobe.com/",proxyUrl:a}),P.addProxyRule({urlPrefix:S.landsat8.prefix,proxyUrl:a}),P.addProxyRule({urlPrefix:S.windData.prefix,proxyUrl:a})},R.createMap=function(){var r=this;G.buildDijits(S.accordionDijits);var a=V.newState.x,t=V.newState.y,n=V.newState.l;R.map=new d("map",{center:[a,t],zoom:n,basemap:S.mapOptions.basemap,minZoom:S.mapOptions.minZoom,sliderPosition:S.mapOptions.sliderPosition}),R.map.on("load",function(){R.map.graphics.clear(),C.byId("fires-map-accordion").resize(),F.setMap(R.map),A.setMap(R.map),T.setMap(R.map),r.addWidgets(),r.bindEvents(),r.addLayers(),R.map.resize(),e.once(R.map,"update-end",function(){R.map.centerAt(new p(a,t)).then(function(){R.mapExtentPausable.resume()})})}),R.mapExtentPausable=e.pausable(R.map,"extent-change",function(e){var r=(e.delta,x.webMercatorToGeographic(e.extent)),a=(e.levelChange,e.lod),t=(e.target,i.round(r.getCenter().x,2)),n=i.round(r.getCenter().y,2);V.updateHash({x:t,y:n,l:a.level})}),R.mapExtentPausable.pause()},R.addWidgets=function(){var a,i,n,o,s,d,c,p=[];a=new b({map:R.map,scalebarUnit:"metric"}),t.create("div",{id:"home-button","class":"home-butotn"},document.querySelector(".esriSimpleSliderIncrementButton"),"after"),d=new l({map:R.map},"home-button"),d.startup(),i=new u({layers:[new g({url:S.mapOptions.darkGrayCanvas})],title:"Dark Gray Canvas",thumbnailUrl:"app/images/darkGreyThumb.png"}),p.push(i),c=new y({map:R.map,basemaps:p,showArcGISBasemaps:!0},"basemap-gallery"),c.startup(),o=new h({map:R.map,highlightLocation:!1},"location-widget"),o.startup(),n=new m({map:R.map},"esri-geocoder-widget"),n.startup(),s=new f({map:R.map,layerInfos:[],autoUpdate:!0},"legend"),s.startup();var v=function(){j.get("showBasemapGallery")&&j.set("showBasemapGallery",!1),j.get("showShareContainer")&&j.set("showShareContainer",!1),j.set("showLocatorWidgets",!j.get("showLocatorWidgets"))},w=function(){j.get("showLocatorWidgets")&&j.set("showLocatorWidgets",!1),j.get("showShareContainer")&&j.set("showShareContainer",!1),j.set("showBasemapGallery",!j.get("showBasemapGallery"))},L=function(){j.get("showLocatorWidgets")&&j.set("showLocatorWidgets",!1),j.get("showBasemapGallery")&&j.set("showBasemapGallery",!1),j.set("showShareContainer",!j.get("showShareContainer"))};e(r.byId("locator-widget-button"),"click",v),e(r.byId("basemap-gallery-button"),"click",w),e(r.byId("share-button"),"click",L)},R.bindEvents=function(){var i=this;e(r.byId("dms-search"),"change",function(e){var r=e.target?e.target.checked:e.srcElement.checked;r&&(j.set("showDMSInputs",!0),j.set("showLatLongInputs",!1))}),e(r.byId("lat-long-search"),"change",function(e){var r=e.target?e.target.checked:e.srcElement.checked;r&&(j.set("showLatLongInputs",!0),j.set("showDMSInputs",!1))}),e(R.map,"mouse-move",function(e){j.set("currentLatitude",e.mapPoint.getLatitude().toFixed(4)),j.set("currentLongitude",e.mapPoint.getLongitude().toFixed(4))}),e(R.map,"click",function(e){T.getActiveFiresInfoWindow(e)}),e(C.byId("confidence-fires-checkbox"),"change",function(){A.updateFiresLayer(!0)}),e(C.byId("twitter-conversations-checkbox"),"change",function(){var e=C.byId("twitter-conversations-checkbox").checked;A.toggleLayerVisibility(S.tweetLayer.id,e)}),e(C.byId("fires-checkbox"),"change",function(){var e=C.byId("fires-checkbox").checked;A.toggleLayerVisibility(S.firesLayer.id,e)}),e(C.byId("air-quality-checkbox"),"change",function(e){A.toggleLayerVisibility(S.airQualityLayer.id,e)}),e(C.byId("burned-scars-checkbox"),"change",function(e){A.toggleLayerVisibility(S.burnScarLayer.id,e)}),e(C.byId("landsat-image-checkbox"),"change",function(){var e=C.byId("landsat-image-checkbox").checked;A.toggleLayerVisibility(S.landsat8.id,e)}),C.byId("windy-layer-checkbox").on("change",function(e){F.toggleWindLayer(e)}),C.byId("digital-globe-checkbox").on("change",function(e){A.toggleDigitalGlobeLayer(e)}),C.byId("provinces-checkbox").on("change",function(){A.adjustOverlaysLayer()}),C.byId("districts-checkbox").on("change",function(){A.adjustOverlaysLayer()}),C.byId("subdistricts-checkbox").on("change",function(){A.adjustOverlaysLayer()}),C.byId("villages-checkbox").on("change",function(){A.adjustOverlaysLayer()}),e(r.byId("search-option-go-button"),"click",function(){T.searchAreaByCoordinates()}),e(r.byId("print-button"),"click",function(){i.printMap()}),e(r.byId("report-link"),"click",function(){window.open("./app/js/views/report/report.html","Report","")}),e(r.byId("clear-search-pins"),"click",this.clearSearchPins),e(r.byId("legend-widget-title"),"click",this.toggleLegend),C.byId("forest-transparency-slider").on("change",function(e){A.setTransparency(S.forestUseLayers.id,e)}),C.byId("land-cover-transparency-slider").on("change",function(e){A.setTransparency(S.landCoverLayers.id,e)}),C.byId("conservation-transparency-slider").on("change",function(e){A.setTransparency(S.conservationLayers.id,e)}),a(".active-fires-options").forEach(function(r){e(r,"click",i.toggleFireOption.bind(i))}),a(".esriPopupWrapper").forEach(function(r){t.create("div",{id:"close-icon","class":"close-icon"},r),e(r,"click",function(){R.map.infoWindow.hide()})}),a("#forest-use-panel div.checkbox-container div input").forEach(function(e){n.add(e,"forest-use-layers-option")}),a("#conservation-panel div.checkbox-container div input").forEach(function(e){n.add(e,"conservation-layers-option")}),a("#land-cover-panel div.checkbox-container div input").forEach(function(e){"land-cover-radios"===e.name&&n.add(e,"land-cover-layers-option")}),a("#forest-use-panel div.checkbox-container div input").forEach(function(r){e(r,"change",function(){A.updateAdditionalVisibleLayers("forest-use-layers-option",S.forestUseLayers)})}),a(".conservation-layers-option").forEach(function(r){e(r,"change",function(){A.updateAdditionalVisibleLayers("conservation-layers-option",S.conservationLayers)})}),a(".land-cover-layers-option").forEach(function(r){e(r,"change",function(e){A.updateLandCoverLayers(e)})}),a("#primary-forests-options input").forEach(function(r){e(r,"change",function(){A.updatePrimaryForestsLayer(!0)})})},R.addLayers=function(){var r,a,t,i,n,s,d,c,l,p,y,u,g,h,m,f,b=this;r=new L,r.format="png32",r.layerIds=S.conservationLayers.defaultLayers,r.layerOption=L.LAYER_OPTION_SHOW,a=new v(S.conservationLayers.url,{imageParameters:r,id:S.conservationLayers.id,visible:!1}),s=new L,s.format="png32",s.layerIds=S.landCoverLayers.defaultLayers,s.layerOption=L.LAYER_OPTION_SHOW,d=new v(S.landCoverLayers.url,{imageParameters:s,id:S.landCoverLayers.id,visible:!1}),l=new L,l.format="png32",l.layerIds=S.forestUseLayers.defaultLayers,l.layerOption=L.LAYER_OPTION_SHOW,p=new v(S.forestUseLayers.url,{imageParameters:l,id:S.forestUseLayers.id,visible:!1}),y=new w(S.treeCoverLayer.url,{id:S.treeCoverLayer.id,visible:!1}),t=new L,t.format="png32",t.layerIds=S.primaryForestsLayer.defaultLayers,t.layerOption=L.LAYER_OPTION_SHOW,i=new v(S.primaryForestsLayer.url,{imageParameters:t,id:S.primaryForestsLayer.id,visible:!1}),h=new w(S.landsat8.url,{id:S.landsat8.id,visible:!1}),n=new w(S.digitalGlobe.url,{id:S.digitalGlobe.id,visible:!1}),u=new v(S.overlaysLayer.url,{id:S.overlaysLayer.id,visible:!1}),c=new v(S.airQualityLayer.url,{id:S.airQualityLayer.id,visible:!1}),g=new U(S.burnScarLayer.url,S.burnScarLayer.id),m=new L,m.format="png32",m.layerIds=S.firesLayer.defaultLayers,m.layerOption=L.LAYER_OPTION_SHOW,f=new v(S.firesLayer.url,{imageParameters:m,id:S.firesLayer.id,visible:!1});var x=new E;x.setContent(T.getFireTweetsInfoWindow),tweetLayer=new I(S.tweetLayer.url,{mode:I.MODE_ONDEMAND,id:S.tweetLayer.id,visible:!1,outFields:["*"],infoTemplate:x}),R.map.addLayers([y,h,d,i,p,a,n,g,u,c,f,tweetLayer]),e.once(R.map,"layers-add-result",function(e){b.enableLayersFromHash();var r=o.map(e.layers,function(e){return{layer:e.layer}});r=o.filter(r,function(e){return e.layer.url.search("ImageServer")<0}),C.byId("legend").refresh(r)}),u.on("load",A.setOverlayLayerOrder),g.on("error",this.layerAddError),h.on("error",this.layerAddError),y.on("error",this.layerAddError),i.on("error",this.layerAddError),a.on("error",this.layerAddError),d.on("error",this.layerAddError),u.on("error",this.layerAddError),p.on("error",this.layerAddError),f.on("error",this.layerAddError)},R.layerAddError=function(e){require(["modules/ErrorController"],function(r){r.show(10,"Error adding Layer : <br> "+e.target.url)})},R.toggleFireOption=function(e){var r=e.target?e.target:e.srcElement;a(".selected-fire-option").forEach(function(e){n.remove(e,"selected-fire-option")}),n.add(r,"selected-fire-option"),A.updateFiresLayer()},R.enableLayersFromHash=function(){function a(){C.byId("fires-checkbox").set("checked",!0),C.byId("peat-lands-radio").set("checked",!0),e.emit(r.byId("peat-lands-radio"),"change",{}),A.updateLayersInHash("add",S.firesLayer.id,S.firesLayer.id),A.updateLayersInHash("add",S.landCoverLayers.id,S.landCoverLayers.id+"/1")}function t(a,t){if(void 0!==a&&""!==a)if(void 0===t)n=p[a].id,C.byId(n)&&(C.byId(n).set("checked",!0),"radio"===p[a].type&&e.emit(r.byId(n),"change",{}));else{o=p[a],s=t.split(",");for(var i=0,d=s.length;d>i;i++)n=o[s[i]].id,C.byId(n)&&(C.byId(n).set("checked",!0),"radio"===o[s[i]].type&&e.emit(r.byId(n),"change",{}))}}var i,n,o,s,d=V.getHash(),c=d.lyrs,l=c.split(":"),p=S.layersCheckboxes;if(void 0===c)return void a();if(1===l.length&&""===l[0])return void a();for(var y=0,u=l.length;u>y;y++)i=l[y].split("/"),t(i[0],i[1])},R.clearSearchPins=function(){R.map.graphics.clear(),j.set("showClearPinsOption",!1)},R.toggleLegend=function(){var e=r.byId("legend-widget-container"),a=e.offsetHeight-2===280?30:280;s.animateProperty({node:e,properties:{height:a},duration:500}).play(),30===a?n.add("legend-widget-title","legend-closed"):n.remove("legend-widget-title","legend-closed")},R.printMap=function(){var e,r,a=new B(S.printOptions.url),t=new _,i=new H,o="You need to disable your pop-up blocker to see the printed map.";t.format="png32",t.layout=S.printOptions.template,t.showAttribution=!1,t.preserveScale=!1,i.map=R.map,e=function(e){var r=window.open(e.url,"_blank");n.remove("print-button","loading"),(null===r||void 0===typeof r||void 0===r)&&alert(o)},r=function(e){n.remove("print-button","loading"),console.error(e)},n.add("print-button","loading"),a.execute(i,e,r)},R});