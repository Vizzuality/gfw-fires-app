/*! Global-Forest-Watch-Fires Fri Dec 05 2014 09:10:06 */
define(["dojo/on","dojo/dom","dojo/query","dojo/dom-construct","dojo/number","dojo/dom-class","dojo/_base/array","dojo/_base/fx","dojo/promise/all","dojo/Deferred","esri/map","esri/config","esri/dijit/HomeButton","esri/geometry/Point","esri/dijit/BasemapGallery","esri/dijit/Basemap","esri/dijit/BasemapLayer","esri/dijit/LocateButton","esri/dijit/Geocoder","esri/dijit/Legend","esri/dijit/Scalebar","esri/layers/ArcGISDynamicMapServiceLayer","esri/layers/ArcGISImageServiceLayer","esri/layers/ImageParameters","esri/layers/FeatureLayer","esri/geometry/webMercatorUtils","esri/geometry/Extent","esri/InfoTemplate","esri/graphic","esri/urlUtils","esri/symbols/SimpleFillSymbol","esri/symbols/SimpleLineSymbol","esri/Color","dijit/registry","views/map/MapConfig","views/map/MapModel","views/map/LayerController","views/map/WindyController","views/map/Finder","views/report/ReportOptionsController","utils/DijitFactory","modules/EventsController","esri/request","esri/tasks/query","esri/tasks/QueryTask","esri/tasks/PrintTask","esri/tasks/PrintParameters","esri/tasks/PrintTemplate","views/map/DigitalGlobeTiledLayer","views/map/DigitalGlobeServiceLayer","views/map/BurnScarTiledLayer","modules/HashController","esri/layers/GraphicsLayer","esri/layers/ImageServiceParameters","dijit/Dialog"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,_,ab,bb){var cb={},db=!1,eb={viewId:"mapView",viewName:"map"};return cb.mapExtentPausable,cb.init=function(){var a=this;return db?(cb.map.resize(),void P.switchToView(eb)):(db=!0,void require(["dojo/text!views/map/map.html","dojo/ready"],function(c,d){b.byId(eb.viewId).innerHTML=c,P.switchToView(eb),d(function(){J.applyBindings("map-view"),addthis.init(),a.addConfigurations(),a.createMap()})}))},cb.centerChange=function(){if(cb.map){var b=z.webMercatorToGeographic(cb.map.extent),c=e.round(b.getCenter().x,2),d=e.round(b.getCenter().y,2),f=cb.map.getLevel(),g=Z.newState,h=parseFloat(g.x)!=c||parseFloat(g.y)!=d||parseInt(g.l)!=f;if(h){cb.mapExtentPausable.pause(),a.once(cb.map,"extent-change",function(){cb.mapExtentPausable.resume()});var i=z.geographicToWebMercator(new n(parseFloat(g.x),parseFloat(g.y)));cb.map.centerAndZoom(i,parseInt(g.l))}}},cb.addConfigurations=function(){var a=I.proxies,b=document.location.href,c="/proxy/proxy.ashx";for(var d in a)0===b.indexOf(d)&&(c=a[d],l.defaults.io.proxyUrl=a[d]);D.addProxyRule({urlPrefix:"https://services.digitalglobe.com/",proxyUrl:c}),D.addProxyRule({urlPrefix:I.landsat8.prefix,proxyUrl:c}),l.defaults.io.corsEnabledServers.push(I.windData.domain)},cb.createMap=function(){var b=this;O.buildDijits(I.reportOptionsDijits),O.buildDijits(I.accordionDijits);var c=Z.newState.x,d=Z.newState.y,f=Z.newState.l;cb.map=new k("map",{center:[c,d],zoom:f,basemap:I.mapOptions.basemap,minZoom:I.mapOptions.minZoom,maxZoom:I.mapOptions.maxZoom,sliderPosition:I.mapOptions.sliderPosition}),cb.map.on("load",function(){$("#firesDateFrom").datepicker("setDate","6/1/2014"),$("#noaaDateFrom").datepicker("setDate","10/22/2014"),$("#indoDateFrom").datepicker("setDate","1/1/2013"),$("#firesDateTo").datepicker("option","minDate","6/1/2014"),cb.map.graphics.clear(),J.vm.windPicker(),H.byId("fires-map-accordion").resize(),L.setMap(cb.map),K.setMap(cb.map),M.setMap(cb.map),b.addWidgets(),b.bindEvents(),b.addLayers(),a.once(cb.map,"update-end",function(){cb.map.centerAt(new n(c,d)).then(function(){setTimeout(function(){cb.mapExtentPausable.resume()},1e3)})}),cb.map.resize()}),cb.mapExtentPausable=a.pausable(cb.map,"extent-change",function(a){var b=(a.delta,z.webMercatorToGeographic(a.extent)),c=(a.levelChange,a.lod),d=(a.target,e.round(b.getCenter().x,2)),f=e.round(b.getCenter().y,2);Z.updateHash({x:d,y:f,l:c.level}),"on"==dijit.byId("digital-globe-checkbox").getValue()&&cb.updateImageryList()}),cb.mapExtentPausable.pause()},cb.updateImageryList=function(){J.vm.digitalGlobeInView.removeAll();{var b=(I.digitalGlobe,cb.map.getLayer(I.digitalGlobe.graphicsLayerId),new R);i(I.digitalGlobe.mosaics.map(function(a){var c=new j,d=cb.map.extent;b.geometry=d,b.returnGeometry=!1,b.outFields=["*"];var e=new S(I.digitalGlobe.imagedir+a+"/ImageServer");return e.execute(b,function(a){c.resolve(a.features)},function(){c.resolve([])}),c.promise})).then(function(b){var d=[],e=dijit.byId("timeSliderDG").thumbIndexes,f=dijit.byId("timeSliderDG").timeStops,h=moment(f[e[0]]).tz("Asia/Jakarta"),i=moment(f[e[1]]).tz("Asia/Jakarta");b.map(function(a){a.map(function(a){d.push(a)})}),g.forEach(d,function(a){var b=moment(a.attributes.AcquisitionDate).tz("Asia/Jakarta");if(b>=h&&i>=b){var b=moment(a.attributes.AcquisitionDate).tz("Asia/Jakarta");a.attributes.AcquisitionDate2=a.attributes.AcquisitionDate,a.attributes.AcquisitionDate=b.format("YYYY/MM/DD");var c="<a class='popup-link' data-bucket='"+a.attributes.SensorName+"_id_"+a.attributes.OBJECTID+"'>"+b.format("YYYY/MM/DD")+"</a>",d="<a class='popup-link' data-bucket='"+a.attributes.SensorName+"_id_"+a.attributes.OBJECTID+"'>"+a.attributes.SensorName+"</a>";a.attributes.formattedZoomTo="<a class='popup-link-zoom'>Zoom To</a>",a.attributes.formattedDatePrefix1=c,a.attributes.formattedDatePrefix2=d,J.vm.digitalGlobeInView.push(a)}}),J.vm.digitalGlobeInView.sort(function(a,b){return a.attributes.AcquisitionDate==b.attributes.AcquisitionDate?0:a.attributes.AcquisitionDate>b.attributes.AcquisitionDate?-1:1});var j=0,k=[];c(".imageryTable .popup-link").forEach(function(b,c){k.push(a(b,"click",function(a){var b=a.target?a.target:a.srcElement,d=b.dataset?b.dataset.bucket:b.getAttribute("data-bucket");$("#imageryWindow > table > tbody > tr").each(function(){$(this).removeClass("imageryRowSelected")}),K.showDigitalGlobeImagery(d),j=c;var e=$(this).parent();console.log(e),$(e).parent().removeClass("imageryRowHover"),$(e).parent().addClass("imageryRowSelected")}))});var l;$("#imageryWindow > table > tbody > tr").mouseenter(function(){var a=this.firstElementChild;$(this).addClass("imageryRowHover"),a=$(a).html(),a=$(a).attr("data-bucket");for(var b=0;b<d.length;b++){var c=d[b].attributes.SensorName+"_id_"+d[b].attributes.OBJECTID;if(c==a){var e=new E(E.STYLE_SOLID,new F(F.STYLE_SOLID,new G("yellow"),5),new G([255,255,0,0]));d[b].setSymbol(e),l=new C(d[b].geometry,e),l.id="highlight",cb.map.graphics.add(l)}}}),$("#imageryWindow > table > tbody > tr").mouseleave(function(){$(this).removeClass("imageryRowHover"),cb.map.graphics.remove(cb.map.graphics.graphics[cb.map.graphics.graphics.length-1])}),k.push(a(c(".popup-link-zoom"),"click",function(){cb.map.graphics.remove(cb.map.graphics.graphics[cb.map.graphics.graphics.length-1]);var a=$(this).parent().parent(),b=a[0].firstElementChild;b=$(b).html(),b=$(b).attr("data-bucket");for(var c=0;c<d.length;c++){var e=d[c].attributes.SensorName+"_id_"+d[c].attributes.OBJECTID;e==b&&cb.map.setExtent(d[c].geometry.getExtent())}}))})}},cb.addWidgets=function(){var c,e,f,g,h,i,j,k=[];c=new u({map:cb.map,scalebarUnit:"metric"}),d.create("div",{id:"home-button","class":"home-button"},document.querySelector(".esriSimpleSliderIncrementButton"),"after"),i=new m({map:cb.map},"home-button"),i.startup(),e=new p({layers:[new q({url:I.mapOptions.darkGrayCanvas})],id:"darkgray",title:"Dark Gray Canvas",thumbnailUrl:"app/images/darkGreyThumb.jpg"}),k.push(e),j=new o({map:cb.map,basemaps:k,showArcGISBasemaps:!0},"basemap-gallery"),j.startup(),g=new r({map:cb.map,highlightLocation:!1},"location-widget"),g.startup(),f=new s({map:cb.map},"esri-geocoder-widget"),f.startup(),h=new t({map:cb.map,layerInfos:[],autoUpdate:!0},"legend"),h.startup();var l=function(){J.get("showBasemapGallery")&&J.set("showBasemapGallery",!1),J.get("showShareContainer")&&J.set("showShareContainer",!1),J.set("showLocatorWidgets",!J.get("showLocatorWidgets"))},n=function(){J.get("showLocatorWidgets")&&J.set("showLocatorWidgets",!1),J.get("showShareContainer")&&J.set("showShareContainer",!1),J.set("showBasemapGallery",!J.get("showBasemapGallery"))},v=function(){J.get("showLocatorWidgets")&&J.set("showLocatorWidgets",!1),J.get("showBasemapGallery")&&J.set("showBasemapGallery",!1),J.set("showShareContainer",!J.get("showShareContainer"))};a(b.byId("locator-widget-button"),"click",l),a(b.byId("basemap-gallery-button"),"click",n),a(b.byId("share-button"),"click",v),this.initTransparency()},cb.initTransparency=function(){["forest-transparency-slider","conservation-transparency-slider","land-cover-transparency-slider"].map(function(a){dijit.byId(a).set("value",70)})},cb.bindEvents=function(){var e=this;a(b.byId("dms-search"),"change",function(a){var b=a.target?a.target.checked:a.srcElement.checked;b&&(J.set("showDMSInputs",!0),J.set("showLatLongInputs",!1))}),a(b.byId("lat-long-search"),"change",function(a){var b=a.target?a.target.checked:a.srcElement.checked;b&&(J.set("showLatLongInputs",!0),J.set("showDMSInputs",!1))}),a(cb.map,"mouse-move",function(a){J.set("currentLatitude",a.mapPoint.getLatitude().toFixed(4)),J.set("currentLongitude",a.mapPoint.getLongitude().toFixed(4))}),a(cb.map,"click",function(a){M.selectTomnodFeatures(a)}),a(H.byId("confidence-fires-checkbox"),"change",function(a){K.updateFiresLayer(!0),a&&e.reportAnalyticsHelper("layer","option","The user toggled the Active Fires only show high confidence fires option on.")}),a(H.byId("twitter-conversations-checkbox"),"change",function(){var a=H.byId("twitter-conversations-checkbox").checked;K.toggleLayerVisibility(I.tweetLayer.id,a),a&&e.reportAnalyticsHelper("layer","toggle","The user toggled the Twitter Conversations layer on.")}),a(H.byId("fires-checkbox"),"change",function(){var a=H.byId("fires-checkbox").checked;K.toggleLayerVisibility(I.firesLayer.id,a),a&&e.reportAnalyticsHelper("layer","toggle","The user toggled the Active Fires layer on.")}),a(H.byId("air-quality-checkbox"),"change",function(a){K.toggleLayerVisibility(I.airQualityLayer.id,a),a&&e.reportAnalyticsHelper("layer","toggle","The user toggled the Air Quality layer on.")}),a(H.byId("tomnod-checkbox"),"change",function(a){K.toggleLayerVisibility(I.tomnodLayer.id,a),K.toggleLayerVisibility(I.tomnodLayer.sel_id,a),a&&e.reportAnalyticsHelper("layer","toggle","The user toggled the Tomnod layer on.")}),a(H.byId("indonesia-fires"),"change",function(a){K.toggleMapServiceLayerVisibility(cb.map.getLayer(I.indonesiaLayers.id),I.indonesiaLayers.layerIds.indonesiaFires,a)}),a(H.byId("noaa-fires-18"),"change",function(a){K.toggleMapServiceLayerVisibility(cb.map.getLayer(I.indonesiaLayers.id),I.indonesiaLayers.layerIds.noaa18,a)}),a(H.byId("burned-scars-checkbox"),"change",function(a){K.toggleLayerVisibility(I.burnScarLayer.id,a),a&&e.reportAnalyticsHelper("layer","toggle","The user toggled the Burn Scars layer on.")}),a(H.byId("landsat-image-checkbox"),"change",function(){var a=H.byId("landsat-image-checkbox").checked;K.toggleLayerVisibility(I.landsat8.id,a),a&&e.reportAnalyticsHelper("layer","toggle","The user toggled the Latest Landsat 8 Imagery layer on.")}),H.byId("windy-layer-checkbox").on("change",function(a){L.toggleWindLayer(a),a&&e.reportAnalyticsHelper("layer","toggle","The user toggled the Wind direction layer on.")}),H.byId("digital-globe-checkbox").on("change",function(a){K.toggleDigitalGlobeLayer(a),J.vm.showReportOptionsDigitalGlobe(a),a&&(setTimeout(function(){dijit.byId("digital-globe-footprints-checkbox").set("value","true",!1)},0),e.reportAnalyticsHelper("layer","toggle","The user toggled the Digital Globe - First Look layer on."))}),H.byId("digital-globe-footprints-checkbox").on("change",function(a){K.toggleDigitalGlobeLayer(a,"footprints")}),H.byId("provinces-checkbox").on("change",function(a){K.adjustOverlaysLayer(),a&&e.reportAnalyticsHelper("layer","toggle","The user toggled the Provinces overlay layer on.")}),H.byId("districts-checkbox").on("change",function(a){K.adjustOverlaysLayer(),a&&e.reportAnalyticsHelper("layer","toggle","The user toggled the Districts overlay layer on.")}),H.byId("subdistricts-checkbox").on("change",function(a){K.adjustOverlaysLayer(),a&&e.reportAnalyticsHelper("layer","toggle","The user toggled the Subdistricts overlay layer on.")}),H.byId("villages-checkbox").on("change",function(a){K.adjustOverlaysLayer(),a&&e.reportAnalyticsHelper("layer","toggle","The user toggled the Villages overlay layer on.")}),a(b.byId("search-option-go-button"),"click",function(){M.searchAreaByCoordinates(),e.reportAnalyticsHelper("widget","search","The user searched for location by latitude/longitude or Degrees/Minutes/Seconds.")}),a(b.byId("print-button"),"click",function(){e.printMap(),e.reportAnalyticsHelper("widget","print","The user clicked the print widget to print the map.")}),a(b.byId("report-link"),"click",function(){J.vm.showReportOptions(!0),J.vm.reportAOIs().length<1&&N.populate_select(),e.reportAnalyticsHelper("widget","report","The user clicked Get Fires Analysis to generate an report with the latest analysis.")}),a(b.byId("noaa-fires-18"),"click",function(){if("false"==this.getAttribute("aria-checked")){var a=b.byId("indonesia-fires");return"false"==a.getAttribute("aria-checked")&&(cb.map.getLayer("IndonesiaFires").visible=!1,console.log("Should disable pop-ups")),void J.vm.showReportOptionsNOAA(!1)}J.vm.showReportOptionsNOAA(!0),N.populate_select()}),a(b.byId("indonesia-fires"),"click",function(){if("false"==this.getAttribute("aria-checked")){var a=b.byId("noaa-fires-18");return"false"==a.getAttribute("aria-checked")&&(cb.map.getLayer("IndonesiaFires").visible=!1,console.log("Should disable pop-ups")),void J.vm.showReportOptionsINDO(!1)}J.vm.showReportOptionsINDO(!0),N.populate_select()}),a(b.byId("windy-layer-checkbox"),"click",function(){return"false"==this.getAttribute("aria-checked")?void J.vm.showReportOptionsWIND(!1):(J.vm.showReportOptionsWIND(!0),void N.populate_select())}),a(b.byId("updateNOAA"),"click",function(){var a=J.vm.noaaObservFrom(),b=J.vm.noaaObservTo();b=moment(b).add(1,"day"),a=moment(a).tz("Asia/Jakarta").format("M/D/YYYY"),b=moment(b._d).tz("Asia/Jakarta").format("M/D/YYYY");var c=a.replace(/\//g,"-"),d=b.replace(/\//g,"-"),e=K.getTimeDefinition("Date",c,d);K.updateDynamicMapServiceLayerDefinition(cb.map.getLayer(I.indonesiaLayers.id),I.indonesiaLayers.layerIds.noaa18,e)}),a(b.byId("updateINDO"),"click",function(){var a=J.vm.indoObservFrom(),b=J.vm.indoObservTo();b=moment(b).add(1,"day"),a=moment(a).tz("Asia/Jakarta").format("M/D/YYYY"),b=moment(b._d).tz("Asia/Jakarta").format("M/D/YYYY");var c=a.replace(/\//g,"-"),d=(b.replace(/\//g,"-"),K.getTimeDefinition("ACQ_DATE",c,b));K.updateDynamicMapServiceLayerDefinition(cb.map.getLayer(I.indonesiaLayers.id),I.indonesiaLayers.layerIds.indonesiaFires,d)}),a(b.byId("updateWIND"),"click",function(){var a=J.vm.windObserv(),b=J.vm.timeOfDay(),c=a.split("/"),d=c[2].toString()+c[0].toString()+c[1].toString(),e="http://suitability-mapper.s3.amazonaws.com/wind/archive/wind-surface-level-gfs-"+d+b+".1-0.gz.json";L.deactivateWindLayer(),L.activateWindLayer(e)}),a(b.byId("embedShare"),"click",function(){e.showEmbedCode()}),a(b.byId("clear-search-pins"),"click",this.clearSearchPins),a(b.byId("legend-widget-title"),"click",this.toggleLegend),H.byId("forest-transparency-slider").on("change",function(a){K.setTransparency(I.forestUseLayers.id,a)}),H.byId("land-cover-transparency-slider").on("change",function(a){K.setTransparency(I.landCoverLayers.id,a)}),H.byId("conservation-transparency-slider").on("change",function(a){K.setTransparency(I.conservationLayers.id,a)}),c(".active-fires-options").forEach(function(b){a(b,"click",e.toggleFireOption.bind(e))}),c(".esriPopupWrapper").forEach(function(c){d.create("div",{id:"close-icon","class":"close-icon"},c),a(b.byId("close-icon"),"click",function(){cb.map.infoWindow.hide()})}),c("#forest-use-panel div.checkbox-container div input").forEach(function(a){f.add(a,"forest-use-layers-option")}),c("#conservation-panel div.checkbox-container div input").forEach(function(a){f.add(a,"conservation-layers-option")}),c("#land-cover-panel div.checkbox-container div input").forEach(function(a){"land-cover-radios"===a.name&&f.add(a,"land-cover-layers-option")}),c("#forest-use-panel div.checkbox-container div input").forEach(function(b){a(b,"change",function(a){K.updateAdditionalVisibleLayers("forest-use-layers-option",I.forestUseLayers);var b=a.target?a.target:a.srcElement;if(b.checked&&b.labels.length>0){var c=b.labels[0].innerHTML;e.reportAnalyticsHelper("layer","toggle","The user toggled the "+c+" layer on")}})}),c(".conservation-layers-option").forEach(function(b){a(b,"change",function(a){K.updateAdditionalVisibleLayers("conservation-layers-option",I.conservationLayers);var b=a.target?a.target:a.srcElement;if(b.checked&&b.labels.length>0){var c=b.labels[0].innerHTML;e.reportAnalyticsHelper("layer","toggle","The user toggled the "+c+" layer on")}})}),c(".land-cover-layers-option").forEach(function(b){a(b,"change",function(a){K.updateLandCoverLayers(a);var b=a.target?a.target:a.srcElement;if(b.checked&&b.labels.length>0){var c=b.labels[0].innerHTML;-1===c.search("None")&&e.reportAnalyticsHelper("layer","toggle","The user toggled the "+c+" layer on")}})}),c("#primary-forests-options input").forEach(function(b){a(b,"change",function(a){K.updatePrimaryForestsLayer(!0);var b=a.target?a.target:a.srcElement;if(b.checked&&b.labels.length>0){var c=b.labels[0].innerHTML;-1===c.search("Primary")&&(c="Primary Forests "+c),e.reportAnalyticsHelper("layer","toggle","The user toggled the "+c+" layer on")}})})},cb.addLayers=function(){var b,c,d,e,f,h,i,j,k,l,m,n,o,p,q,r,s,t,u=this;b=new x,b.format="png32",b.layerIds=I.conservationLayers.defaultLayers,b.layerOption=x.LAYER_OPTION_SHOW,c=new v(I.conservationLayers.url,{imageParameters:b,id:I.conservationLayers.id,visible:!1}),indonesiaParams=new x,indonesiaParams.format="png32",indonesiaParams.layerIds=I.indonesiaLayers.defaultLayers,indonesiaParams.layerOption=x.LAYER_OPTION_SHOW,indonesiaLayer=new v(I.indonesiaLayers.url,{imageParameters:indonesiaParams,id:I.indonesiaLayers.id,visible:!1}),h=new x,h.format="png32",h.layerIds=I.landCoverLayers.defaultLayers,h.layerOption=x.LAYER_OPTION_SHOW,i=new v(I.landCoverLayers.url,{imageParameters:h,id:I.landCoverLayers.id,visible:!1}),k=new x,k.format="png32",k.layerIds=I.forestUseLayers.defaultLayers,k.layerOption=x.LAYER_OPTION_SHOW,l=new v(I.forestUseLayers.url,{imageParameters:k,id:I.forestUseLayers.id,visible:!1}),m=new w(I.treeCoverLayer.url,{id:I.treeCoverLayer.id,visible:!1}),d=new x,d.format="png32",d.layerIds=I.primaryForestsLayer.defaultLayers,d.layerOption=x.LAYER_OPTION_SHOW,e=new v(I.primaryForestsLayer.url,{imageParameters:d,id:I.primaryForestsLayer.id,visible:!1}),q=new w(I.landsat8.url,{id:I.landsat8.id,visible:!1}),t=I.digitalGlobe,f=t.mosaics.map(function(a){return new w(t.imagedir+a+"/ImageServer",{id:a,visible:!1})}),dglyrs=f,n=new v(I.overlaysLayer.url,{id:I.overlaysLayer.id,visible:!1}),j=new v(I.airQualityLayer.url,{id:I.airQualityLayer.id,visible:!1}),tomnodParams=new x,tomnodParams.layerIds=I.tomnodLayer.defaultLayers,tomnodParams.layerOption=x.LAYER_OPTION_SHOW,p=new v(I.tomnodLayer.url,{imageParameters:tomnodParams,id:I.tomnodLayer.id,visible:!1});var z=new B("${name}",M.getTomnodInfoWindow),A=new y(I.tomnodLayer.url+"/"+I.tomnodLayer.defaultLayers[0],{mode:y.MODE_SELECTION,infoTemplate:z,outFields:["*"],id:I.tomnodLayer.sel_id});o=new Y(I.burnScarLayer.url,I.burnScarLayer.id),r=new x,r.format="png32",r.layerIds=I.firesLayer.defaultLayers,r.layerOption=x.LAYER_OPTION_SHOW,s=new v(I.firesLayer.url,{imageParameters:r,id:I.firesLayer.id,visible:!1});var C=new B;C.setContent(M.getFireTweetsInfoWindow),tweetLayer=new y(I.tweetLayer.url,{mode:y.MODE_ONDEMAND,id:I.tweetLayer.id,visible:!1,outFields:["*"],infoTemplate:C});var D={layerDefinition:{geometryType:"esriGeometryPolygon",fields:[]},featureSet:null},E=new y(D,{id:I.digitalGlobe.graphicsLayerId,visible:!1});dglyr=E;var F=[q,m,i,e,E].concat(f).concat([c,o,p,l,n,tweetLayer,j,A,indonesiaLayer,s]);a.once(cb.map,"layers-add-result",function(a){u.enableLayersFromHash();var b=g.map(a.layers,function(a){return{layer:a.layer}});b=g.filter(b,function(a){var b=a.layer.url?a.layer.url.search("ImageServer")<0:!1,c=!(a.layer.id===A.id);return b&&c}),console.dir(b),H.byId("legend").refresh(b)}),cb.map.addLayers(F),n.on("load",K.setOverlayLayerOrder),o.on("error",this.layerAddError),q.on("error",this.layerAddError),m.on("error",this.layerAddError),e.on("error",this.layerAddError),c.on("error",this.layerAddError),i.on("error",this.layerAddError),n.on("error",this.layerAddError),l.on("error",this.layerAddError),s.on("error",this.layerAddError),j.on("error",this.layerAddError)},cb.layerAddError=function(a){require(["modules/ErrorController"],function(b){b.show(10,"Error adding Layer : <br> "+a.target.url)})},cb.toggleFireOption=function(a){var b=a.target?a.target:a.srcElement;c(".selected-fire-option").forEach(function(a){f.remove(a,"selected-fire-option")}),f.add(b,"selected-fire-option"),K.updateFiresLayer()},cb.enableLayersFromHash=function(){function c(){H.byId("fires-checkbox").set("checked",!0),K.updateLayersInHash("add",I.firesLayer.id,I.firesLayer.id)}function d(c,d){if(void 0!==c&&""!==c)if(void 0===d)l[c]&&(f=l[c].id,H.byId(f)&&(H.byId(f).set("checked",!0),a.emit(b.byId(f),"change",{})));else{g=l[c],h=d.split(",");for(var e=0,i=h.length;i>e;e++)if(f=g[h[e]].id,"[object Array]"===Object.prototype.toString.call(f))for(var j=0,k=f.length;k>j;j++)H.byId(f[j])&&(H.byId(f[j]).set("checked",!0),a.emit(b.byId(f[j]),"change",{}));else H.byId(f)&&(H.byId(f).set("checked",!0),a.emit(b.byId(f),"change",{}))}}var e,f,g,h,i=Z.getHash(),j=i.lyrs,k=j.split(":"),l=I.layersCheckboxes;if(void 0===j)return void c();if(1===k.length&&""===k[0])return void c();for(var m=0,n=k.length;n>m;m++)e=k[m].split("/"),d(e[0],e[1])},cb.clearSearchPins=function(){cb.map.graphics.clear(),J.set("showClearPinsOption",!1)},cb.toggleLegend=function(){var a=b.byId("legend-widget-container"),c=a.offsetHeight-2===280?30:280;h.animateProperty({node:a,properties:{height:c},duration:500}).play(),30===c?f.add("legend-widget-title","legend-closed"):f.remove("legend-widget-title","legend-closed")},cb.printMap=function(){var b=document.getElementsByTagName("body")[0];f.add("print-button","loading"),f.add(b,"map-view-print"),H.byId("stackContainer").resize(),H.byId("mapView").resize(),cb.map.resize(),a.once(cb.map,"resize",function(){setTimeout(function(){window.print(),f.remove("print-button","loading"),f.remove(b,"map-view-print"),H.byId("stackContainer").resize(),cb.map.resize()},2e3)})},cb.reportAnalyticsHelper=function(a,b,c){ga("A.send","event",a,b,c),ga("B.send","event",a,b,c)},cb.showEmbedCode=function(){H.byId("embedCodeShareDialog")&&H.byId("embedCodeShareDialog").destroy();var a,c="<iframe src='"+window.location+"' height='600' width='900'></iframe>",d=new bb({title:"Embed Code",style:"width: 350px",id:"embedCodeShareDialog",content:'Copy the code below to embed in your site. (Ctrl+C on PC and Cmd+C on Mac)<div class=\'dijitDialogPaneActionBar\'><input id="embedInput" type="text" value="'+c+'" autofocus /></div>'});a=function(){d.destroy()},d.show(),b.byId("embedInput").select(),d.on("cancel",function(){a()})},cb});