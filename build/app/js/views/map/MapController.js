define(["dojo/on","dojo/dom","dojo/query","dojo/dom-construct","dojo/dom-class","dojo/_base/array","dojo/_base/fx","esri/map","esri/config","esri/dijit/HomeButton","esri/dijit/BasemapGallery","esri/dijit/Basemap","esri/dijit/BasemapLayer","esri/dijit/LocateButton","esri/dijit/Geocoder","esri/dijit/Legend","esri/dijit/Scalebar","esri/layers/ArcGISDynamicMapServiceLayer","esri/layers/ArcGISImageServiceLayer","esri/layers/ImageParameters","esri/layers/FeatureLayer","esri/InfoTemplate","esri/graphic","esri/urlUtils","dijit/registry","views/map/MapConfig","views/map/MapModel","views/map/LayerController","views/map/WindyController","views/map/Finder","utils/DijitFactory","modules/EventsController","esri/layers/WMTSLayerInfo","esri/layers/WMTSLayer","esri/request","views/map/DigitalGlobeTiledLayer"],function(e,r,a,i,t,o,n,s,d,c,l,y,p,u,g,h,m,f,v,b,w,L,I,k,O,x,E,P,S,j,C,A){var W={},G=!1,T={viewId:"mapView",viewName:"map"};return W.init=function(){var e=this;return G?(W.map.resize(),void A.switchToView(T)):(G=!0,void require(["dojo/text!views/map/map.html","dojo/ready"],function(a,i){r.byId(T.viewId).innerHTML=a,A.switchToView(T),i(function(){E.applyBindings("map-view"),addthis.init(),e.addConfigurations(),e.createMap()})}))},W.addConfigurations=function(){var e=x.proxies,r=document.location.href,a="/proxy/proxy.ashx";for(var i in e)0===r.indexOf(i)&&(a=e[i]);k.addProxyRule({urlPrefix:"https://services.digitalglobe.com/",proxyUrl:a}),k.addProxyRule({urlPrefix:x.landsat8.prefix,proxyUrl:a}),k.addProxyRule({urlPrefix:x.windData.prefix,proxyUrl:a})},W.createMap=function(){var e=this;C.buildDijits(x.accordionDijits),W.map=new s("map",{center:x.mapOptions.center,basemap:x.mapOptions.basemap,zoom:x.mapOptions.initalZoom,minZoom:x.mapOptions.minZoom,sliderPosition:x.mapOptions.sliderPosition}),W.map.on("load",function(){O.byId("fires-map-accordion").resize(),W.map.graphics.clear(),S.setMap(W.map),P.setMap(W.map),j.setMap(W.map),e.addWidgets(),e.bindEvents(),e.addLayers(),W.map.resize()})},W.addWidgets=function(){var a,t,o,n,s,d,f,v=[];a=new m({map:W.map,scalebarUnit:"metric"}),i.create("div",{id:"home-button","class":"home-butotn"},document.querySelector(".esriSimpleSliderIncrementButton"),"after"),d=new c({map:W.map},"home-button"),d.startup(),t=new y({layers:[new p({url:x.mapOptions.darkGrayCanvas})],title:"Dark Gray Canvas",thumbnailUrl:"app/images/darkGreyThumb.png"}),v.push(t),f=new l({map:W.map,basemaps:v,showArcGISBasemaps:!0},"basemap-gallery"),f.startup(),n=new u({map:W.map,highlightLocation:!1},"location-widget"),n.startup(),o=new g({map:W.map},"esri-geocoder-widget"),o.startup(),s=new h({map:W.map,layerInfos:[],autoUpdate:!0},"legend"),s.startup();var b=function(){E.get("showBasemapGallery")&&E.set("showBasemapGallery",!1),E.get("showShareContainer")&&E.set("showShareContainer",!1),E.set("showLocatorWidgets",!E.get("showLocatorWidgets"))},w=function(){E.get("showLocatorWidgets")&&E.set("showLocatorWidgets",!1),E.get("showShareContainer")&&E.set("showShareContainer",!1),E.set("showBasemapGallery",!E.get("showBasemapGallery"))},L=function(){E.get("showLocatorWidgets")&&E.set("showLocatorWidgets",!1),E.get("showBasemapGallery")&&E.set("showBasemapGallery",!1),E.set("showShareContainer",!E.get("showShareContainer"))};e(r.byId("locator-widget-button"),"click",b),e(r.byId("basemap-gallery-button"),"click",w),e(r.byId("share-button"),"click",L)},W.bindEvents=function(){var o=this;e(r.byId("dms-search"),"change",function(e){var r=e.target?e.target.checked:e.srcElement.checked;r&&(E.set("showDMSInputs",!0),E.set("showLatLongInputs",!1))}),e(r.byId("lat-long-search"),"change",function(e){var r=e.target?e.target.checked:e.srcElement.checked;r&&(E.set("showLatLongInputs",!0),E.set("showDMSInputs",!1))}),e(W.map,"mouse-move",function(e){E.set("currentLatitude",e.mapPoint.getLatitude().toFixed(4)),E.set("currentLongitude",e.mapPoint.getLongitude().toFixed(4))}),e(W.map,"click",function(e){j.getActiveFiresInfoWindow(e)}),e(O.byId("confidence-fires-checkbox"),"change",function(){P.updateFiresLayer(!0)}),e(O.byId("twitter-conversations-checkbox"),"change",function(){var e=O.byId("twitter-conversations-checkbox").checked;P.toggleLayerVisibility(x.tweetLayer.id,e)}),e(O.byId("fires-checkbox"),"change",function(){var e=O.byId("fires-checkbox").checked;P.toggleLayerVisibility(x.firesLayer.id,e)}),e(O.byId("landsat-image-checkbox"),"change",function(){var e=O.byId("landsat-image-checkbox").checked;P.toggleLayerVisibility(x.landsat8.id,e)}),O.byId("windy-layer-checkbox").on("change",function(e){S.toggleWindLayer(e)}),O.byId("digital-globe-checkbox").on("change",function(e){P.toggleDigitalGlobeLayer(e)}),O.byId("provinces-checkbox").on("change",function(){P.adjustOverlaysLayer()}),O.byId("districts-checkbox").on("change",function(){P.adjustOverlaysLayer()}),O.byId("subdistricts-checkbox").on("change",function(){P.adjustOverlaysLayer()}),O.byId("villages-checkbox").on("change",function(){P.adjustOverlaysLayer()}),e(r.byId("search-option-go-button"),"click",function(){j.searchAreaByCoordinates()}),e(r.byId("report-link"),"click",function(){window.open("./app/js/views/report/report.html","Report","")}),e(r.byId("clear-search-pins"),"click",this.clearSearchPins),e(r.byId("legend-widget-title"),"click",this.toggleLegend),O.byId("forest-transparency-slider").on("change",function(e){P.setTransparency(x.forestUseLayers.id,e)}),O.byId("land-cover-transparency-slider").on("change",function(e){P.setTransparency(x.landCoverLayers.id,e)}),O.byId("conservation-transparency-slider").on("change",function(e){P.setTransparency(x.conservationLayers.id,e)}),a(".active-fires-options").forEach(function(r){e(r,"click",o.toggleFireOption.bind(o))}),a(".esriPopupWrapper").forEach(function(r){i.create("div",{id:"close-icon","class":"close-icon"},r),e(r,"click",function(){W.map.infoWindow.hide()})}),a("#forest-use-panel div.checkbox-container div input").forEach(function(e){t.add(e,"forest-use-layers-option")}),a("#conservation-panel div.checkbox-container div input").forEach(function(e){t.add(e,"conservation-layers-option")}),a("#land-cover-panel div.checkbox-container div input").forEach(function(e){"land-cover-radios"===e.name&&t.add(e,"land-cover-layers-option")}),a("#forest-use-panel div.checkbox-container div input").forEach(function(r){e(r,"change",function(){P.updateAdditionalVisibleLayers("forest-use-layers-option",x.forestUseLayers)})}),a(".conservation-layers-option").forEach(function(r){e(r,"change",function(){P.updateAdditionalVisibleLayers("conservation-layers-option",x.conservationLayers)})}),a(".land-cover-layers-option").forEach(function(r){e(r,"change",function(e){P.updateLandCoverLayers(e)})}),a("#primary-forests-options input").forEach(function(r){e(r,"change",function(){P.updatePrimaryForestsLayer(!0)})})},W.addLayers=function(){var r,a,i,t,n,s,d,c,l,y,p,u,g,h;r=new b,r.format="png32",r.layerIds=x.conservationLayers.defaultLayers,r.layerOption=b.LAYER_OPTION_SHOW,a=new f(x.conservationLayers.url,{imageParameters:r,id:x.conservationLayers.id,visible:!1}),s=new b,s.format="png32",s.layerIds=x.landCoverLayers.defaultLayers,s.layerOption=b.LAYER_OPTION_SHOW,d=new f(x.landCoverLayers.url,{imageParameters:s,id:x.landCoverLayers.id,visible:!0}),c=new b,c.format="png32",c.layerIds=x.forestUseLayers.defaultLayers,c.layerOption=b.LAYER_OPTION_SHOW,l=new f(x.forestUseLayers.url,{imageParameters:c,id:x.forestUseLayers.id,visible:!1}),y=new v(x.treeCoverLayer.url,{id:x.treeCoverLayer.id,visible:!1}),i=new b,i.format="png32",i.layerIds=x.primaryForestsLayer.defaultLayers,i.layerOption=b.LAYER_OPTION_SHOW,t=new f(x.primaryForestsLayer.url,{imageParameters:i,id:x.primaryForestsLayer.id,visible:!1}),u=new v(x.landsat8.url,{id:x.landsat8.id,visible:!1}),n=new v(x.digitalGlobe.url,{id:x.digitalGlobe.id,visible:!1}),p=new f(x.overlaysLayer.url,{id:x.overlaysLayer.id,visible:!1}),g=new b,g.format="png32",g.layerIds=x.firesLayer.defaultLayers,g.layerOption=b.LAYER_OPTION_SHOW,h=new f(x.firesLayer.url,{imageParameters:g,id:x.firesLayer.id,visible:!0});var m=new L;m.setContent(j.getFireTweetsInfoWindow),tweetLayer=new w(x.tweetLayer.url,{mode:w.MODE_ONDEMAND,id:x.tweetLayer.id,visible:!1,outFields:["*"],infoTemplate:m}),W.map.addLayers([y,u,d,t,l,a,n,p,h,tweetLayer]),e.once(W.map,"layers-add-result",function(e){var r=o.map(e.layers,function(e){return{layer:e.layer}});r=o.filter(r,function(e){return e.layer.url.search("ImageServer")<0}),O.byId("legend").refresh(r)}),p.on("load",P.setOverlayLayerOrder),u.on("error",this.layerAddError),y.on("error",this.layerAddError),t.on("error",this.layerAddError),a.on("error",this.layerAddError),d.on("error",this.layerAddError),p.on("error",this.layerAddError),l.on("error",this.layerAddError),h.on("error",this.layerAddError)},W.layerAddError=function(e){require(["modules/ErrorController"],function(r){r.show(10,"Error adding Layer : <br> "+e.target.url)})},W.toggleFireOption=function(e){var r=e.target?e.target:e.srcElement;a(".selected-fire-option").forEach(function(e){t.remove(e,"selected-fire-option")}),t.add(r,"selected-fire-option"),P.updateFiresLayer()},W.clearSearchPins=function(){W.map.graphics.clear(),E.set("showClearPinsOption",!1)},W.toggleLegend=function(){var e=r.byId("legend-widget-container"),a=e.offsetHeight-2===200?30:200;n.animateProperty({node:e,properties:{height:a},duration:500}).play(),30===a?t.add("legend-widget-title","legend-closed"):t.remove("legend-widget-title","legend-closed")},W});