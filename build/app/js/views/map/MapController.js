/*! Global-Forest-Watch-Fires Tue Dec 16 2014 10:40:51 */
define(["dojo/on","dojo/dom","dojo/query","dojo/dom-construct","dojo/number","dojo/dom-class","dojo/_base/array","dojo/_base/fx","dojo/promise/all","dojo/Deferred","dojo/dom-style","dojo/dom-geometry","esri/map","esri/config","esri/dijit/HomeButton","esri/geometry/Point","esri/dijit/BasemapGallery","esri/dijit/Basemap","esri/dijit/BasemapLayer","esri/dijit/LocateButton","esri/dijit/Geocoder","esri/dijit/Legend","esri/dijit/Scalebar","esri/layers/ArcGISDynamicMapServiceLayer","esri/layers/ArcGISImageServiceLayer","esri/layers/ImageParameters","esri/layers/FeatureLayer","esri/geometry/webMercatorUtils","esri/geometry/Extent","esri/InfoTemplate","esri/graphic","esri/urlUtils","esri/symbols/SimpleFillSymbol","esri/symbols/SimpleLineSymbol","esri/Color","dijit/registry","views/map/MapConfig","views/map/MapModel","views/map/LayerController","views/map/WindyController","views/map/Finder","views/report/ReportOptionsController","utils/DijitFactory","modules/EventsController","esri/request","esri/tasks/query","esri/tasks/QueryTask","esri/tasks/PrintTask","esri/tasks/PrintParameters","esri/tasks/PrintTemplate","views/map/DigitalGlobeTiledLayer","views/map/DigitalGlobeServiceLayer","views/map/BurnScarTiledLayer","modules/HashController","esri/layers/GraphicsLayer","esri/layers/ImageServiceParameters","dijit/Dialog"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,_,ab,bb,cb,db){var eb,fb={},gb=!1,hb={viewId:"mapView",viewName:"map"},ib=[],jb=new G(G.STYLE_SOLID,new H(H.STYLE_SOLID,new I("yellow"),5),new I([255,255,0,0]));fb.mapExtentPausable,fb.init=function(){var a=this;return gb?(fb.map.resize(),void R.switchToView(hb)):(gb=!0,void require(["dojo/text!views/map/map.html","dojo/ready"],function(c,d){b.byId(hb.viewId).innerHTML=c,R.switchToView(hb),d(function(){L.applyBindings("map-view"),addthis.init(),a.addConfigurations(),a.createMap()})}))},fb.centerChange=function(){if(fb.map){var b=B.webMercatorToGeographic(fb.map.extent),c=e.round(b.getCenter().x,2),d=e.round(b.getCenter().y,2),f=fb.map.getLevel(),g=ab.newState,h=parseFloat(g.x)!=c||parseFloat(g.y)!=d||parseInt(g.l)!=f;if(h){fb.mapExtentPausable.pause(),a.once(fb.map,"extent-change",function(){fb.mapExtentPausable.resume()});var i=B.geographicToWebMercator(new p(parseFloat(g.x),parseFloat(g.y)));fb.map.centerAndZoom(i,parseInt(g.l))}}},fb.addConfigurations=function(){var a=K.proxies,b=document.location.href,c="/proxy/proxy.ashx";for(var d in a)0===b.indexOf(d)&&(c=a[d],n.defaults.io.proxyUrl=a[d]);F.addProxyRule({urlPrefix:"https://services.digitalglobe.com/",proxyUrl:c}),F.addProxyRule({urlPrefix:K.landsat8.prefix,proxyUrl:c}),n.defaults.io.corsEnabledServers.push(K.windData.domain)},fb.createMap=function(){var b=this;Q.buildDijits(K.reportOptionsDijits),Q.buildDijits(K.accordionDijits);var c=ab.newState.x,d=ab.newState.y,f=ab.newState.l;fb.map=new m("map",{center:[c,d],zoom:f,basemap:K.mapOptions.basemap,minZoom:K.mapOptions.minZoom,maxZoom:K.mapOptions.maxZoom,sliderPosition:K.mapOptions.sliderPosition}),window.map=fb.map,fb.map.on("load",function(){$("#firesDateTo").datepicker("option","minDate","+0m -7d"),$("#noaaDateFrom").datepicker("setDate","10/22/2014"),$("#indoDateFrom").datepicker("setDate","1/1/2013"),fb.map.graphics.clear(),L.vm.windPicker(),J.byId("fires-map-accordion").resize(),N.setMap(fb.map),M.setMap(fb.map),O.setMap(fb.map),b.addWidgets(),b.bindEvents(),b.addLayers(),a.once(fb.map,"update-end",function(){fb.map.centerAt(new p(c,d)).then(function(){setTimeout(function(){fb.mapExtentPausable.resume()},1e3)})}),fb.map.resize()}),fb.mapExtentPausable=a.pausable(fb.map,"extent-change",function(a){var b=(a.delta,B.webMercatorToGeographic(a.extent)),c=(a.levelChange,a.lod),d=(a.target,e.round(b.getCenter().x,2)),f=e.round(b.getCenter().y,2);ab.updateHash({x:d,y:f,l:c.level}),"on"==dijit.byId("digital-globe-checkbox").getValue()&&fb.updateImageryList()}),fb.mapExtentPausable.pause()},fb.updateImageryList=function(){L.vm.digitalGlobeInView.removeAll();var b=fb.map.extent,d=fb.map.getLayer("Digital_Globe_Bounding_Boxes");ib=[];for(var e=dijit.byId("timeSliderDG").thumbIndexes,f=dijit.byId("timeSliderDG").timeStops,h=moment(f[e[0]]).tz("Asia/Jakarta"),i=moment(f[e[1]]).tz("Asia/Jakarta"),j=0;j<d.graphics.length;j++)b.intersects(d.graphics[j].geometry)&&ib.push(d.graphics[j]);g.forEach(ib,function(a){var b=moment(a.attributes.AcquisitionDate).tz("Asia/Jakarta");if(b>=h&&i>=b){var b=moment(a.attributes.AcquisitionDate).tz("Asia/Jakarta");a.attributes.AcquisitionDate2=a.attributes.AcquisitionDate,a.attributes.AcquisitionDate=b.format("YYYY/MM/DD");var c="<a class='popup-link' data-bucket='"+a.attributes.SensorName+"_id_"+a.attributes.OBJECTID+"'>"+b.format("YYYY/MM/DD")+"</a>",d="<a class='popup-link' data-bucket='"+a.attributes.SensorName+"_id_"+a.attributes.OBJECTID+"'>"+a.attributes.SensorName+"</a>";a.attributes.formattedZoomTo="<a class='popup-link-zoom'>Zoom To</a>",a.attributes.formattedDatePrefix1=c,a.attributes.formattedDatePrefix2=d,L.vm.digitalGlobeInView.push({feature:a,mouseover:!1})}}),$("#imageryWindow > table > tbody > tr").each(function(){var a=this.firstElementChild;a=$(a).html(),a=$(a).attr("data-bucket"),L.vm.selectedImageryRow&&L.vm.selectedImageryRow==a&&$(this).addClass("imageryRowSelected")}),L.vm.digitalGlobeInView.sort(function(a,b){return a.feature.attributes.AcquisitionDate==b.feature.attributes.AcquisitionDate?0:a.feature.attributes.AcquisitionDate>b.feature.attributes.AcquisitionDate?-1:1});var k=0,l=[];c(".imageryTable .popup-link").forEach(function(b,c){l.push(a(b,"click",function(a){var b=a.target?a.target:a.srcElement,d=b.dataset?b.dataset.bucket:b.getAttribute("data-bucket");$("#imageryWindow > table > tbody > tr").each(function(){$(this).removeClass("imageryRowSelected")}),M.showDigitalGlobeImagery(d),k=c;var e=$(this).parent();$(e).parent().removeClass("imageryRowHover"),L.vm.selectedImageryRow=this.dataset.bucket,$(e).parent().addClass("imageryRowSelected")}))}),$("#imageryWindow > table > tbody > tr").mouseenter(function(){var a=this.firstElementChild;$(this).addClass("imageryRowHover"),a=$(a).html(),a=$(a).attr("data-bucket");for(var b=0;b<ib.length;b++){var c=ib[b].attributes.SensorName+"_id_"+ib[b].attributes.OBJECTID;if(c==a){var d=new G(G.STYLE_SOLID,new H(H.STYLE_SOLID,new I("yellow"),5),new I([255,255,0,0]));eb=new E(ib[b].geometry,d),eb.id="highlight",fb.map.graphics.add(eb)}}}),$("#imageryWindow > table > tbody > tr").mouseleave(function(){$(this).removeClass("imageryRowHover"),fb.map.graphics.remove(fb.map.graphics.graphics[fb.map.graphics.graphics.length-1])}),l.push(a(c(".popup-link-zoom"),"click",function(){fb.map.graphics.remove(fb.map.graphics.graphics[fb.map.graphics.graphics.length-1]);var a=$(this).parent()[0],b=a.firstElementChild;b=b.firstElementChild,b=$(b).attr("data-bucket");for(var c=0;c<ib.length;c++){var d=ib[c].attributes.SensorName+"_id_"+ib[c].attributes.OBJECTID;d==b&&fb.map.setExtent(ib[c].geometry.getExtent())}}))};var kb=$(this).parent();return $(kb).parent().removeClass("imageryRowHover"),$(kb).parent().addClass("imageryRowSelected"),fb.handleImageryOver=function(a,b){console.log("starting function");var c=b.currentTarget;$(c).addClass("imageryRowHover"),eb=new E(a.geometry,jb),eb.id="highlight",fb.map.graphics.add(eb)},fb.handleImageryOut=function(a,b){var c=$(b.target).parent();$(c).removeClass("imageryRowHover"),fb.map.graphics.remove(fb.map.graphics.graphics[fb.map.graphics.graphics.length-1])},fb.resizeMapPanel=function(a){1==a?($("#control-panel").css("width","2px"),$(".map-container").css("left","2px"),$("#leftPaneToggle").html("+"),$("#latLongHUD").css("left","100px"),$("div.scalebar_bottom-left.esriScalebar").css("left","119px"),$("#map").css("left","2px"),$("#control-panel").css("background-color","#ecc53d"),fb.map.resize(),L.vm.toggleMapPane(!1)):($("#control-panel").css("width","320px"),$(".map-container").css("left","320px"),$("#leftPaneToggle").html("-"),$("#map").css("left","320px"),$("#latLongHUD").css("left","0px"),$("div.scalebar_bottom-left.esriScalebar").css("left","19px"),$("#control-panel").css("background-color","transparent"),fb.map.resize(),L.vm.toggleMapPane(!0)),$("#leftPaneToggle").hide(),$("#latLongHUD").hide(),$("div.scalebar_bottom-left.esriScalebar").hide(),$("#control-panel > div.report-link-container").hide(),setTimeout(function(){$("#latLongHUD").show(),$("#leftPaneToggle").show(),$("div.scalebar_bottom-left.esriScalebar").show(),$("#control-panel > div.report-link-container").show()},1e3)},fb.addWidgets=function(){var c,e,f,g,h,i,j,k=[];c=new w({map:fb.map,scalebarUnit:"metric"}),d.create("div",{id:"home-button","class":"home-button"},document.querySelector(".esriSimpleSliderIncrementButton"),"after"),i=new o({map:fb.map},"home-button"),i.startup(),e=new r({layers:[new s({url:K.mapOptions.darkGrayCanvas})],id:"darkgray",title:"Dark Gray Canvas",thumbnailUrl:"app/images/darkGreyThumb.jpg"}),console.log(k),j=new q({map:fb.map,basemaps:k,showArcGISBasemaps:!0},"basemap-gallery"),j.startup(),g=new t({map:fb.map,highlightLocation:!1},"location-widget"),g.startup(),f=new u({map:fb.map},"esri-geocoder-widget"),f.startup(),h=new v({map:fb.map,layerInfos:[],autoUpdate:!0},"legend"),h.startup();var l=function(){L.get("showBasemapGallery")&&L.set("showBasemapGallery",!1),L.get("showShareContainer")&&L.set("showShareContainer",!1),L.set("showLocatorWidgets",!L.get("showLocatorWidgets"))},m=function(){L.get("showLocatorWidgets")&&L.set("showLocatorWidgets",!1),L.get("showShareContainer")&&L.set("showShareContainer",!1),L.set("showBasemapGallery",!L.get("showBasemapGallery"))},n=function(){L.get("showLocatorWidgets")&&L.set("showLocatorWidgets",!1),L.get("showBasemapGallery")&&L.set("showBasemapGallery",!1),L.set("showShareContainer",!L.get("showShareContainer"))};a(b.byId("locator-widget-button"),"click",l),a(b.byId("basemap-gallery-button"),"click",m),a(b.byId("share-button"),"click",n),this.initTransparency()},fb.initTransparency=function(){["forest-transparency-slider","conservation-transparency-slider","land-cover-transparency-slider"].map(function(a){dijit.byId(a).set("value",70)})},fb.bindEvents=function(){var e=this;a(b.byId("dms-search"),"change",function(a){var b=a.target?a.target.checked:a.srcElement.checked;b&&(L.set("showDMSInputs",!0),L.set("showLatLongInputs",!1))}),a(b.byId("lat-long-search"),"change",function(a){var b=a.target?a.target.checked:a.srcElement.checked;b&&(L.set("showLatLongInputs",!0),L.set("showDMSInputs",!1))}),a(fb.map,"mouse-move",function(a){L.set("currentLatitude",a.mapPoint.getLatitude().toFixed(4)),L.set("currentLongitude",a.mapPoint.getLongitude().toFixed(4))}),a(fb.map,"click",function(a){O.selectTomnodFeatures(a)}),a(J.byId("confidence-fires-checkbox"),"change",function(a){M.updateFiresLayer(!0),a&&e.reportAnalyticsHelper("layer","option","The user toggled the Active Fires only show high confidence fires option on.")}),a(J.byId("twitter-conversations-checkbox"),"change",function(){var a=J.byId("twitter-conversations-checkbox").checked;M.toggleLayerVisibility(K.tweetLayer.id,a),a&&e.reportAnalyticsHelper("layer","toggle","The user toggled the Twitter Conversations layer on.")}),a(J.byId("fires-checkbox"),"change",function(){var a=J.byId("fires-checkbox").checked;M.toggleLayerVisibility(K.firesLayer.id,a),L.vm.showActiveFiresButtons(a),a&&e.reportAnalyticsHelper("layer","toggle","The user toggled the Active Fires layer on.")}),a(J.byId("air-quality-checkbox"),"change",function(a){M.toggleLayerVisibility(K.airQualityLayer.id,a),a&&e.reportAnalyticsHelper("layer","toggle","The user toggled the Air Quality layer on.")}),a(J.byId("tomnod-checkbox"),"change",function(a){M.toggleLayerVisibility(K.tomnodLayer.id,a),M.toggleLayerVisibility(K.tomnodLayer.sel_id,a),a&&e.reportAnalyticsHelper("layer","toggle","The user toggled the Tomnod layer on.")}),a(J.byId("indonesia-fires"),"change",function(a){console.log(a),1==a?$(".confidence-fires-container").css("margin-left","38px"):$(".confidence-fires-container").css("margin-left","46px"),M.toggleMapServiceLayerVisibility(fb.map.getLayer(K.indonesiaLayers.id),K.indonesiaLayers.layerIds.indonesiaFires,a)}),a(J.byId("noaa-fires-18"),"change",function(a){M.toggleMapServiceLayerVisibility(fb.map.getLayer(K.indonesiaLayers.id),K.indonesiaLayers.layerIds.noaa18,a)}),a(J.byId("burned-scars-checkbox"),"change",function(a){M.toggleLayerVisibility(K.burnScarLayer.id,a),a&&e.reportAnalyticsHelper("layer","toggle","The user toggled the Burn Scars layer on.")}),a(J.byId("landsat-image-checkbox"),"change",function(){var a=J.byId("landsat-image-checkbox").checked;M.toggleLayerVisibility(K.landsat8.id,a),a&&e.reportAnalyticsHelper("layer","toggle","The user toggled the Latest Landsat 8 Imagery layer on.")}),J.byId("windy-layer-checkbox").on("change",function(a){N.toggleWindLayer(a),a&&e.reportAnalyticsHelper("layer","toggle","The user toggled the Wind direction layer on.")}),J.byId("digital-globe-checkbox").on("change",function(a){M.toggleDigitalGlobeLayer(a),L.vm.showReportOptionsDigitalGlobe(a),a&&(setTimeout(function(){dijit.byId("digital-globe-footprints-checkbox").set("value","true",!1)},0),e.reportAnalyticsHelper("layer","toggle","The user toggled the Digital Globe - First Look layer on."))}),J.byId("digital-globe-footprints-checkbox").on("change",function(a){M.toggleDigitalGlobeLayer(a,"footprints")}),J.byId("provinces-checkbox").on("change",function(a){M.adjustOverlaysLayer(),a&&e.reportAnalyticsHelper("layer","toggle","The user toggled the Provinces overlay layer on.")}),J.byId("districts-checkbox").on("change",function(a){M.adjustOverlaysLayer(),a&&e.reportAnalyticsHelper("layer","toggle","The user toggled the Districts overlay layer on.")}),J.byId("subdistricts-checkbox").on("change",function(a){M.adjustOverlaysLayer(),a&&e.reportAnalyticsHelper("layer","toggle","The user toggled the Subdistricts overlay layer on.")}),J.byId("villages-checkbox").on("change",function(a){M.adjustOverlaysLayer(),a&&e.reportAnalyticsHelper("layer","toggle","The user toggled the Villages overlay layer on.")}),a(b.byId("search-option-go-button"),"click",function(){O.searchAreaByCoordinates(),e.reportAnalyticsHelper("widget","search","The user searched for location by latitude/longitude or Degrees/Minutes/Seconds.")}),a(b.byId("print-button"),"click",function(){e.printMap(),e.reportAnalyticsHelper("widget","print","The user clicked the print widget to print the map.")}),a(b.byId("report-link"),"click",function(){L.vm.showReportOptions(!0),L.vm.reportAOIs().length<1&&P.populate_select(),e.reportAnalyticsHelper("widget","report","The user clicked Get Fires Analysis to generate an report with the latest analysis.")}),a(b.byId("noaa-fires-18"),"click",function(){if("false"==this.getAttribute("aria-checked")){var a=b.byId("indonesia-fires");return"false"==a.getAttribute("aria-checked")&&(fb.map.getLayer("IndonesiaFires").visible=!1,console.log("Should disable pop-ups")),void L.vm.showReportOptionsNOAA(!1)}L.vm.showReportOptionsNOAA(!0),P.populate_select()}),a(b.byId("indonesia-fires"),"click",function(){if("false"==this.getAttribute("aria-checked")){var a=b.byId("noaa-fires-18");return"false"==a.getAttribute("aria-checked")&&(fb.map.getLayer("IndonesiaFires").visible=!1,console.log("Should disable pop-ups")),void L.vm.showReportOptionsINDO(!1)}L.vm.showReportOptionsINDO(!0),P.populate_select()}),a(b.byId("windy-layer-checkbox"),"click",function(){return"false"==this.getAttribute("aria-checked")?void L.vm.showReportOptionsWIND(!1):(L.vm.showReportOptionsWIND(!0),void P.populate_select())}),a(b.byId("updateNOAA"),"click",function(){var a=L.vm.noaaObservFrom(),b=L.vm.noaaObservTo(),c=$("#noaaDateFrom").datepicker("getDate"),d=$("#noaaDateTo").datepicker("getDate");b=moment(d).add(1,"day"),a=moment(c).tz("Asia/Jakarta").format("M/D/YYYY"),b=moment(b._d).tz("Asia/Jakarta").format("M/D/YYYY");var e=a.replace(/\//g,"-"),f=b.replace(/\//g,"-"),g=M.getTimeDefinition("Date",e,f);M.updateDynamicMapServiceLayerDefinition(fb.map.getLayer(K.indonesiaLayers.id),K.indonesiaLayers.layerIds.noaa18,g)}),a(b.byId("updateINDO"),"click",function(){var a=L.vm.indoObservFrom(),b=L.vm.indoObservTo(),c=$("#indoDateFrom").datepicker("getDate"),d=$("#indoDateTo").datepicker("getDate");b=moment(d).add(1,"day"),a=moment(c).tz("Asia/Jakarta").format("M/D/YYYY"),b=moment(b._d).tz("Asia/Jakarta").format("M/D/YYYY");var e=a.replace(/\//g,"-"),f=(b.replace(/\//g,"-"),M.getTimeDefinition("ACQ_DATE",e,b));J.byId("confidence-archive-checkbox").checked&&(f=[f,K.firesLayer.highConfidence].join(" AND ")),M.updateDynamicMapServiceLayerDefinition(fb.map.getLayer(K.indonesiaLayers.id),K.indonesiaLayers.layerIds.indonesiaFires,f)}),a(J.byId("confidence-archive-checkbox"),"change",function(a){console.log("confidence",a);var b=a?K.firesLayer.highConfidence:"",c=fb.map.getLayer(K.indonesiaLayers.id),d=K.indonesiaLayers.layerIds.indonesiaFires,e=c.layerDefinitions,f=e[d];if(a)var g=void 0!=f?[f,b].join(" AND "):b;else var g=f.replace(" AND "+K.firesLayer.highConfidence,b).replace(K.firesLayer.highConfidence,b);M.updateDynamicMapServiceLayerDefinition(fb.map.getLayer(K.indonesiaLayers.id),K.indonesiaLayers.layerIds.indonesiaFires,g)}),a(b.byId("updateWIND"),"click",function(){var a=(L.vm.windObserv(),$("#windDate").datepicker("getDate")),b=moment(a).tz("Asia/Jakarta").format("MM/DD/YYYY"),c=L.vm.timeOfDay(),d=b.split("/"),e=d[2].toString()+d[0].toString()+d[1].toString();console.log(e);var f="http://suitability-mapper.s3.amazonaws.com/wind/archive/wind-surface-level-gfs-"+e+c+".1-0.gz.json";N.deactivateWindLayer(),N.activateWindLayer(f)}),a(b.byId("embedShare"),"click",function(){e.showEmbedCode()}),a(b.byId("clear-search-pins"),"click",this.clearSearchPins),a(b.byId("legend-widget-title"),"click",this.toggleLegend),J.byId("forest-transparency-slider").on("change",function(a){M.setTransparency(K.forestUseLayers.id,a)}),J.byId("land-cover-transparency-slider").on("change",function(a){M.setTransparency(K.landCoverLayers.id,a)}),J.byId("conservation-transparency-slider").on("change",function(a){M.setTransparency(K.conservationLayers.id,a)}),c(".active-fires-options").forEach(function(b){a(b,"click",e.toggleFireOption.bind(e))}),c(".esriPopupWrapper").forEach(function(c){d.create("div",{id:"close-icon","class":"close-icon"},c),a(b.byId("close-icon"),"click",function(){fb.map.infoWindow.hide()})}),c("#forest-use-panel div.checkbox-container div input").forEach(function(a){f.add(a,"forest-use-layers-option")}),c("#conservation-panel div.checkbox-container div input").forEach(function(a){f.add(a,"conservation-layers-option")}),c("#land-cover-panel div.checkbox-container div input").forEach(function(a){"land-cover-radios"===a.name&&f.add(a,"land-cover-layers-option")}),c("#forest-use-panel div.checkbox-container div input").forEach(function(b){a(b,"change",function(a){M.updateAdditionalVisibleLayers("forest-use-layers-option",K.forestUseLayers);var b=a.target?a.target:a.srcElement;if(b.checked&&b.labels.length>0){var c=b.labels[0].innerHTML;e.reportAnalyticsHelper("layer","toggle","The user toggled the "+c+" layer on")}})}),c(".conservation-layers-option").forEach(function(b){a(b,"change",function(a){M.updateAdditionalVisibleLayers("conservation-layers-option",K.conservationLayers);var b=a.target?a.target:a.srcElement;if(b.checked&&b.labels.length>0){var c=b.labels[0].innerHTML;e.reportAnalyticsHelper("layer","toggle","The user toggled the "+c+" layer on")}})}),c(".land-cover-layers-option").forEach(function(b){a(b,"change",function(a){M.updateLandCoverLayers(a);var b=a.target?a.target:a.srcElement;if(b.checked&&b.labels.length>0){var c=b.labels[0].innerHTML;-1===c.search("None")&&e.reportAnalyticsHelper("layer","toggle","The user toggled the "+c+" layer on")}})}),c("#primary-forests-options input").forEach(function(b){a(b,"change",function(a){M.updatePrimaryForestsLayer(!0);var b=a.target?a.target:a.srcElement;if(b.checked&&b.labels.length>0){var c=b.labels[0].innerHTML;-1===c.search("Primary")&&(c="Primary Forests "+c),e.reportAnalyticsHelper("layer","toggle","The user toggled the "+c+" layer on")}})})},fb.addLayers=function(){var b,c,d,e,f,h,i,j,k,l,m,n,o,p,q,r,s,t,u=this;b=new z,b.format="png32",b.layerIds=K.conservationLayers.defaultLayers,b.layerOption=z.LAYER_OPTION_SHOW,c=new x(K.conservationLayers.url,{imageParameters:b,id:K.conservationLayers.id,visible:!1}),indonesiaParams=new z,indonesiaParams.format="png32",indonesiaParams.layerIds=K.indonesiaLayers.defaultLayers,indonesiaParams.layerOption=z.LAYER_OPTION_SHOW,indonesiaLayer=new x(K.indonesiaLayers.url,{imageParameters:indonesiaParams,id:K.indonesiaLayers.id,visible:!1}),h=new z,h.format="png32",h.layerIds=K.landCoverLayers.defaultLayers,h.layerOption=z.LAYER_OPTION_SHOW,i=new x(K.landCoverLayers.url,{imageParameters:h,id:K.landCoverLayers.id,visible:!1}),k=new z,k.format="png32",k.layerIds=K.forestUseLayers.defaultLayers,k.layerOption=z.LAYER_OPTION_SHOW,l=new x(K.forestUseLayers.url,{imageParameters:k,id:K.forestUseLayers.id,visible:!1}),m=new y(K.treeCoverLayer.url,{id:K.treeCoverLayer.id,visible:!1}),d=new z,d.format="png32",d.layerIds=K.primaryForestsLayer.defaultLayers,d.layerOption=z.LAYER_OPTION_SHOW,e=new x(K.primaryForestsLayer.url,{imageParameters:d,id:K.primaryForestsLayer.id,visible:!1}),q=new y(K.landsat8.url,{id:K.landsat8.id,visible:!1}),t=K.digitalGlobe,f=t.mosaics.map(function(a){return new y(t.imagedir+a+"/ImageServer",{id:a,visible:!1})}),dglyrs=f,n=new x(K.overlaysLayer.url,{id:K.overlaysLayer.id,visible:!1}),j=new x(K.airQualityLayer.url,{id:K.airQualityLayer.id,visible:!1}),tomnodParams=new z,tomnodParams.layerIds=K.tomnodLayer.defaultLayers,tomnodParams.layerOption=z.LAYER_OPTION_SHOW,p=new x(K.tomnodLayer.url,{imageParameters:tomnodParams,id:K.tomnodLayer.id,visible:!1});var v=new D("${name}",O.getTomnodInfoWindow),w=new A(K.tomnodLayer.url+"/"+K.tomnodLayer.defaultLayers[0],{mode:A.MODE_SELECTION,infoTemplate:v,outFields:["*"],id:K.tomnodLayer.sel_id});o=new _(K.burnScarLayer.url,K.burnScarLayer.id),r=new z,r.format="png32",r.layerIds=K.firesLayer.defaultLayers,r.layerOption=z.LAYER_OPTION_SHOW,s=new x(K.firesLayer.url,{imageParameters:r,id:K.firesLayer.id,visible:!1});var B=new D;B.setContent(O.getFireTweetsInfoWindow),tweetLayer=new A(K.tweetLayer.url,{mode:A.MODE_ONDEMAND,id:K.tweetLayer.id,visible:!1,outFields:["*"],infoTemplate:B});var C={layerDefinition:{geometryType:"esriGeometryPolygon",fields:[]},featureSet:null},E=new A(C,{id:K.digitalGlobe.graphicsLayerId,visible:!1});dglyr=E;var F=[q,m,i,e,E].concat(f).concat([c,o,p,l,n,tweetLayer,j,w,indonesiaLayer,s]);a.once(fb.map,"layers-add-result",function(a){u.enableLayersFromHash();var b=g.map(a.layers,function(a){return{layer:a.layer}});b=g.filter(b,function(a){var b=a.layer.url?a.layer.url.search("ImageServer")<0:!1,c=!(a.layer.id===w.id);return b&&c}),console.dir(b),J.byId("legend").refresh(b)}),fb.map.addLayers(F),n.on("load",M.setOverlayLayerOrder),o.on("error",this.layerAddError),q.on("error",this.layerAddError),m.on("error",this.layerAddError),e.on("error",this.layerAddError),c.on("error",this.layerAddError),i.on("error",this.layerAddError),n.on("error",this.layerAddError),l.on("error",this.layerAddError),s.on("error",this.layerAddError),j.on("error",this.layerAddError)},fb.layerAddError=function(a){require(["modules/ErrorController"],function(b){b.show(10,"Error adding Layer : <br> "+a.target.url)})},fb.toggleFireOption=function(a){var b=a.target?a.target:a.srcElement;c(".selected-fire-option").forEach(function(a){f.remove(a,"selected-fire-option")}),f.add(b,"selected-fire-option"),M.updateFiresLayer()},fb.enableLayersFromHash=function(){function c(){J.byId("fires-checkbox").set("checked",!0),M.updateLayersInHash("add",K.firesLayer.id,K.firesLayer.id)}function d(c,d){if(void 0!==c&&""!==c)if(void 0===d)l[c]&&(f=l[c].id,J.byId(f)&&(J.byId(f).set("checked",!0),a.emit(b.byId(f),"change",{})));else{g=l[c],h=d.split(",");for(var e=0,i=h.length;i>e;e++)if(f=g[h[e]].id,"[object Array]"===Object.prototype.toString.call(f))for(var j=0,k=f.length;k>j;j++)J.byId(f[j])&&(J.byId(f[j]).set("checked",!0),a.emit(b.byId(f[j]),"change",{}));else J.byId(f)&&(J.byId(f).set("checked",!0),a.emit(b.byId(f),"change",{}))}}var e,f,g,h,i=ab.getHash(),j=i.lyrs,k=j.split(":"),l=K.layersCheckboxes;if(void 0===j)return void c();if(1===k.length&&""===k[0])return void c();for(var m=0,n=k.length;n>m;m++)e=k[m].split("/"),d(e[0],e[1])},fb.clearSearchPins=function(){fb.map.graphics.clear(),L.set("showClearPinsOption",!1)},fb.toggleLegend=function(){var a=b.byId("legend-widget-container"),c=a.offsetHeight-2===280?30:280;h.animateProperty({node:a,properties:{height:c},duration:500}).play(),30===c?f.add("legend-widget-title","legend-closed"):f.remove("legend-widget-title","legend-closed")},fb.printMap=function(){var b=document.getElementsByTagName("body")[0];f.add("print-button","loading"),f.add(b,"map-view-print"),J.byId("stackContainer").resize(),J.byId("mapView").resize(),fb.map.resize(),a.once(fb.map,"resize",function(){setTimeout(function(){window.print(),f.remove("print-button","loading"),f.remove(b,"map-view-print"),J.byId("stackContainer").resize(),fb.map.resize()},2e3)})},fb.reportAnalyticsHelper=function(a,b,c){ga("A.send","event",a,b,c),ga("B.send","event",a,b,c),ga("C.send","event",a,b,c)},fb.showEmbedCode=function(){J.byId("embedCodeShareDialog")&&J.byId("embedCodeShareDialog").destroy();var a,c="<iframe src='"+window.location+"' height='600' width='900'></iframe>",d=new db({title:"Embed Code",style:"width: 350px",id:"embedCodeShareDialog",content:'Copy the code below to embed in your site. (Ctrl+C on PC and Cmd+C on Mac)<div class=\'dijitDialogPaneActionBar\'><input id="embedInput" type="text" value="'+c+'" autofocus /></div>'});a=function(){d.destroy()},d.show(),b.byId("embedInput").select(),d.on("cancel",function(){a()})},fb});