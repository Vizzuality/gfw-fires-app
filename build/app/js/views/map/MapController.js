define(["dojo/on","dojo/dom","dojo/query","dojo/dom-construct","dojo/dom-class","dojo/_base/array","dojo/_base/fx","esri/map","esri/config","esri/dijit/HomeButton","esri/dijit/BasemapGallery","esri/dijit/Basemap","esri/dijit/BasemapLayer","esri/dijit/LocateButton","esri/dijit/Geocoder","esri/dijit/Legend","esri/dijit/Scalebar","esri/layers/ArcGISDynamicMapServiceLayer","esri/layers/ArcGISImageServiceLayer","esri/layers/ImageParameters","esri/layers/FeatureLayer","esri/InfoTemplate","esri/graphic","esri/urlUtils","dijit/registry","views/map/MapConfig","views/map/MapModel","views/map/LayerController","views/map/WindyController","views/map/Finder","utils/DijitFactory","modules/EventsController","esri/request","esri/tasks/PrintTask","esri/tasks/PrintParameters","esri/tasks/PrintTemplate","views/map/DigitalGlobeTiledLayer"],function(e,r,a,t,i,o,n,s,d,c,l,p,y,u,m,g,h,f,v,b,w,L,I,k,O,x,E,P,j,S,C,A,T,W,G,M){var F={},B=!1,_={viewId:"mapView",viewName:"map"};return F.init=function(){var e=this;return B?(F.map.resize(),void A.switchToView(_)):(B=!0,void require(["dojo/text!views/map/map.html","dojo/ready"],function(a,t){r.byId(_.viewId).innerHTML=a,A.switchToView(_),t(function(){E.applyBindings("map-view"),addthis.init(),e.addConfigurations(),e.createMap()})}))},F.addConfigurations=function(){var e=x.proxies,r=document.location.href,a="/proxy/proxy.ashx";for(var t in e)0===r.indexOf(t)&&(a=e[t]);k.addProxyRule({urlPrefix:"https://services.digitalglobe.com/",proxyUrl:a}),k.addProxyRule({urlPrefix:x.landsat8.prefix,proxyUrl:a}),k.addProxyRule({urlPrefix:x.windData.prefix,proxyUrl:a})},F.createMap=function(){var e=this;C.buildDijits(x.accordionDijits),F.map=new s("map",{center:x.mapOptions.center,basemap:x.mapOptions.basemap,zoom:x.mapOptions.initalZoom,minZoom:x.mapOptions.minZoom,sliderPosition:x.mapOptions.sliderPosition}),F.map.on("load",function(){O.byId("fires-map-accordion").resize(),F.map.graphics.clear(),j.setMap(F.map),P.setMap(F.map),S.setMap(F.map),e.addWidgets(),e.bindEvents(),e.addLayers(),F.map.resize()})},F.addWidgets=function(){var a,i,o,n,s,d,f,v=[];a=new h({map:F.map,scalebarUnit:"metric"}),t.create("div",{id:"home-button","class":"home-butotn"},document.querySelector(".esriSimpleSliderIncrementButton"),"after"),d=new c({map:F.map},"home-button"),d.startup(),i=new p({layers:[new y({url:x.mapOptions.darkGrayCanvas})],title:"Dark Gray Canvas",thumbnailUrl:"app/images/darkGreyThumb.png"}),v.push(i),f=new l({map:F.map,basemaps:v,showArcGISBasemaps:!0},"basemap-gallery"),f.startup(),n=new u({map:F.map,highlightLocation:!1},"location-widget"),n.startup(),o=new m({map:F.map},"esri-geocoder-widget"),o.startup(),s=new g({map:F.map,layerInfos:[],autoUpdate:!0},"legend"),s.startup();var b=function(){E.get("showBasemapGallery")&&E.set("showBasemapGallery",!1),E.get("showShareContainer")&&E.set("showShareContainer",!1),E.set("showLocatorWidgets",!E.get("showLocatorWidgets"))},w=function(){E.get("showLocatorWidgets")&&E.set("showLocatorWidgets",!1),E.get("showShareContainer")&&E.set("showShareContainer",!1),E.set("showBasemapGallery",!E.get("showBasemapGallery"))},L=function(){E.get("showLocatorWidgets")&&E.set("showLocatorWidgets",!1),E.get("showBasemapGallery")&&E.set("showBasemapGallery",!1),E.set("showShareContainer",!E.get("showShareContainer"))};e(r.byId("locator-widget-button"),"click",b),e(r.byId("basemap-gallery-button"),"click",w),e(r.byId("share-button"),"click",L)},F.bindEvents=function(){var o=this;e(r.byId("dms-search"),"change",function(e){var r=e.target?e.target.checked:e.srcElement.checked;r&&(E.set("showDMSInputs",!0),E.set("showLatLongInputs",!1))}),e(r.byId("lat-long-search"),"change",function(e){var r=e.target?e.target.checked:e.srcElement.checked;r&&(E.set("showLatLongInputs",!0),E.set("showDMSInputs",!1))}),e(F.map,"mouse-move",function(e){E.set("currentLatitude",e.mapPoint.getLatitude().toFixed(4)),E.set("currentLongitude",e.mapPoint.getLongitude().toFixed(4))}),e(F.map,"click",function(e){S.getActiveFiresInfoWindow(e)}),e(O.byId("confidence-fires-checkbox"),"change",function(){P.updateFiresLayer(!0)}),e(O.byId("twitter-conversations-checkbox"),"change",function(){var e=O.byId("twitter-conversations-checkbox").checked;P.toggleLayerVisibility(x.tweetLayer.id,e)}),e(O.byId("fires-checkbox"),"change",function(){var e=O.byId("fires-checkbox").checked;P.toggleLayerVisibility(x.firesLayer.id,e)}),e(O.byId("landsat-image-checkbox"),"change",function(){var e=O.byId("landsat-image-checkbox").checked;P.toggleLayerVisibility(x.landsat8.id,e)}),O.byId("windy-layer-checkbox").on("change",function(e){j.toggleWindLayer(e)}),O.byId("digital-globe-checkbox").on("change",function(e){P.toggleDigitalGlobeLayer(e)}),O.byId("provinces-checkbox").on("change",function(){P.adjustOverlaysLayer()}),O.byId("districts-checkbox").on("change",function(){P.adjustOverlaysLayer()}),O.byId("subdistricts-checkbox").on("change",function(){P.adjustOverlaysLayer()}),O.byId("villages-checkbox").on("change",function(){P.adjustOverlaysLayer()}),e(r.byId("search-option-go-button"),"click",function(){S.searchAreaByCoordinates()}),e(r.byId("print-button"),"click",function(){o.printMap()}),e(r.byId("report-link"),"click",function(){window.open("./app/js/views/report/report.html","Report","")}),e(r.byId("clear-search-pins"),"click",this.clearSearchPins),e(r.byId("legend-widget-title"),"click",this.toggleLegend),O.byId("forest-transparency-slider").on("change",function(e){P.setTransparency(x.forestUseLayers.id,e)}),O.byId("land-cover-transparency-slider").on("change",function(e){P.setTransparency(x.landCoverLayers.id,e)}),O.byId("conservation-transparency-slider").on("change",function(e){P.setTransparency(x.conservationLayers.id,e)}),a(".active-fires-options").forEach(function(r){e(r,"click",o.toggleFireOption.bind(o))}),a(".esriPopupWrapper").forEach(function(r){t.create("div",{id:"close-icon","class":"close-icon"},r),e(r,"click",function(){F.map.infoWindow.hide()})}),a("#forest-use-panel div.checkbox-container div input").forEach(function(e){i.add(e,"forest-use-layers-option")}),a("#conservation-panel div.checkbox-container div input").forEach(function(e){i.add(e,"conservation-layers-option")}),a("#land-cover-panel div.checkbox-container div input").forEach(function(e){"land-cover-radios"===e.name&&i.add(e,"land-cover-layers-option")}),a("#forest-use-panel div.checkbox-container div input").forEach(function(r){e(r,"change",function(){P.updateAdditionalVisibleLayers("forest-use-layers-option",x.forestUseLayers)})}),a(".conservation-layers-option").forEach(function(r){e(r,"change",function(){P.updateAdditionalVisibleLayers("conservation-layers-option",x.conservationLayers)})}),a(".land-cover-layers-option").forEach(function(r){e(r,"change",function(e){P.updateLandCoverLayers(e)})}),a("#primary-forests-options input").forEach(function(r){e(r,"change",function(){P.updatePrimaryForestsLayer(!0)})})},F.addLayers=function(){var r,a,t,i,n,s,d,c,l,p,y,u,m,g;r=new b,r.format="png32",r.layerIds=x.conservationLayers.defaultLayers,r.layerOption=b.LAYER_OPTION_SHOW,a=new f(x.conservationLayers.url,{imageParameters:r,id:x.conservationLayers.id,visible:!1}),s=new b,s.format="png32",s.layerIds=x.landCoverLayers.defaultLayers,s.layerOption=b.LAYER_OPTION_SHOW,d=new f(x.landCoverLayers.url,{imageParameters:s,id:x.landCoverLayers.id,visible:!0}),c=new b,c.format="png32",c.layerIds=x.forestUseLayers.defaultLayers,c.layerOption=b.LAYER_OPTION_SHOW,l=new f(x.forestUseLayers.url,{imageParameters:c,id:x.forestUseLayers.id,visible:!1}),p=new v(x.treeCoverLayer.url,{id:x.treeCoverLayer.id,visible:!1}),t=new b,t.format="png32",t.layerIds=x.primaryForestsLayer.defaultLayers,t.layerOption=b.LAYER_OPTION_SHOW,i=new f(x.primaryForestsLayer.url,{imageParameters:t,id:x.primaryForestsLayer.id,visible:!1}),u=new v(x.landsat8.url,{id:x.landsat8.id,visible:!1}),n=new v(x.digitalGlobe.url,{id:x.digitalGlobe.id,visible:!1}),y=new f(x.overlaysLayer.url,{id:x.overlaysLayer.id,visible:!1}),m=new b,m.format="png32",m.layerIds=x.firesLayer.defaultLayers,m.layerOption=b.LAYER_OPTION_SHOW,g=new f(x.firesLayer.url,{imageParameters:m,id:x.firesLayer.id,visible:!0});var h=new L;h.setContent(S.getFireTweetsInfoWindow),tweetLayer=new w(x.tweetLayer.url,{mode:w.MODE_ONDEMAND,id:x.tweetLayer.id,visible:!1,outFields:["*"],infoTemplate:h}),F.map.addLayers([p,u,d,i,l,a,n,y,g,tweetLayer]),e.once(F.map,"layers-add-result",function(e){var r=o.map(e.layers,function(e){return{layer:e.layer}});r=o.filter(r,function(e){return e.layer.url.search("ImageServer")<0}),O.byId("legend").refresh(r)}),y.on("load",P.setOverlayLayerOrder),u.on("error",this.layerAddError),p.on("error",this.layerAddError),i.on("error",this.layerAddError),a.on("error",this.layerAddError),d.on("error",this.layerAddError),y.on("error",this.layerAddError),l.on("error",this.layerAddError),g.on("error",this.layerAddError)},F.layerAddError=function(e){require(["modules/ErrorController"],function(r){r.show(10,"Error adding Layer : <br> "+e.target.url)})},F.toggleFireOption=function(e){var r=e.target?e.target:e.srcElement;a(".selected-fire-option").forEach(function(e){i.remove(e,"selected-fire-option")}),i.add(r,"selected-fire-option"),P.updateFiresLayer()},F.clearSearchPins=function(){F.map.graphics.clear(),E.set("showClearPinsOption",!1)},F.toggleLegend=function(){var e=r.byId("legend-widget-container"),a=e.offsetHeight-2===200?30:200;n.animateProperty({node:e,properties:{height:a},duration:500}).play(),30===a?i.add("legend-widget-title","legend-closed"):i.remove("legend-widget-title","legend-closed")},F.printMap=function(){function e(){r.byId("print-button").innerHTML="P"===r.byId("print-button").innerHTML?"":"P"}var a,t,o=new W(x.printOptions.url),n=new M,s=new G,d="You need to disable your pop-up blocker to see the printed map.";n.format="png32",n.layout=x.printOptions.template,n.showAttribution=!1,n.preserveScale=!1,s.map=F.map,a=function(r){var a=window.open(r.url,"_blank");i.remove("print-button","loading"),e(),(null===a||void 0===typeof a||void 0===a)&&alert(d)},t=function(r){i.remove("print-button","loading"),e(),console.error(r)},e(),i.add("print-button","loading"),o.execute(s,a,t)},F});