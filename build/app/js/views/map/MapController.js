define(["dojo/on","dojo/dom","dojo/query","dojo/dom-construct","dojo/number","dojo/dom-class","dojo/_base/array","dojo/_base/fx","esri/map","esri/config","esri/dijit/HomeButton","esri/geometry/Point","esri/dijit/BasemapGallery","esri/dijit/Basemap","esri/dijit/BasemapLayer","esri/dijit/LocateButton","esri/dijit/Geocoder","esri/dijit/Legend","esri/dijit/Scalebar","esri/layers/ArcGISDynamicMapServiceLayer","esri/layers/ArcGISImageServiceLayer","esri/layers/ImageParameters","esri/layers/FeatureLayer","esri/geometry/webMercatorUtils","esri/InfoTemplate","esri/graphic","esri/urlUtils","dijit/registry","views/map/MapConfig","views/map/MapModel","views/map/LayerController","views/map/WindyController","views/map/Finder","utils/DijitFactory","modules/EventsController","esri/request","esri/tasks/PrintTask","esri/tasks/PrintParameters","esri/tasks/PrintTemplate","views/map/DigitalGlobeTiledLayer","modules/HashController"],function(e,r,a,t,i,n,o,s,d,c,l,p,y,u,g,h,m,f,b,v,w,L,I,x,k,E,O,P,C,S,j,A,T,F,M,G,W,H,B,_,D){var U={},R=!1,V={viewId:"mapView",viewName:"map"};return U.mapExtentPausable,U.init=function(){var e=this;return R?(U.map.resize(),void M.switchToView(V)):(R=!0,void require(["dojo/text!views/map/map.html","dojo/ready"],function(a,t){r.byId(V.viewId).innerHTML=a,M.switchToView(V),t(function(){S.applyBindings("map-view"),addthis.init(),e.addConfigurations(),e.createMap()})}))},U.centerChange=function(){if(U.map){var r=x.webMercatorToGeographic(U.map.extent),a=i.round(r.getCenter().x,2),t=i.round(r.getCenter().y,2),n=U.map.getLevel(),o=D.newState,s=parseFloat(o.x)!=a||parseFloat(o.y)!=t||parseInt(o.l)!=n;if(s){U.mapExtentPausable.pause(),e.once(U.map,"extent-change",function(){U.mapExtentPausable.resume()});var d=x.geographicToWebMercator(new p(parseFloat(o.x),parseFloat(o.y)));U.map.centerAndZoom(d,parseInt(o.l))}}},U.addConfigurations=function(){var e=C.proxies,r=document.location.href,a="/proxy/proxy.ashx";for(var t in e)0===r.indexOf(t)&&(a=e[t]);O.addProxyRule({urlPrefix:"https://services.digitalglobe.com/",proxyUrl:a}),O.addProxyRule({urlPrefix:C.landsat8.prefix,proxyUrl:a}),O.addProxyRule({urlPrefix:C.windData.prefix,proxyUrl:a})},U.createMap=function(){var r=this;F.buildDijits(C.accordionDijits);var a=D.newState.x,t=D.newState.y,n=D.newState.l;U.map=new d("map",{center:[a,t],zoom:n,basemap:C.mapOptions.basemap,minZoom:C.mapOptions.minZoom,sliderPosition:C.mapOptions.sliderPosition}),U.map.on("load",function(){P.byId("fires-map-accordion").resize(),U.map.graphics.clear(),A.setMap(U.map),j.setMap(U.map),T.setMap(U.map),r.addWidgets(),r.bindEvents(),r.addLayers(),U.map.resize()}),U.mapExtentPausable=e.pausable(U.map,"extent-change",function(e){var r=(e.delta,x.webMercatorToGeographic(e.extent)),a=(e.levelChange,e.lod),t=(e.target,i.round(r.getCenter().x,2)),n=i.round(r.getCenter().y,2);D.updateHash({x:t,y:n,l:a.level})})},U.addWidgets=function(){var a,i,n,o,s,d,c,p=[];a=new b({map:U.map,scalebarUnit:"metric"}),t.create("div",{id:"home-button","class":"home-butotn"},document.querySelector(".esriSimpleSliderIncrementButton"),"after"),d=new l({map:U.map},"home-button"),d.startup(),i=new u({layers:[new g({url:C.mapOptions.darkGrayCanvas})],title:"Dark Gray Canvas",thumbnailUrl:"app/images/darkGreyThumb.png"}),p.push(i),c=new y({map:U.map,basemaps:p,showArcGISBasemaps:!0},"basemap-gallery"),c.startup(),o=new h({map:U.map,highlightLocation:!1},"location-widget"),o.startup(),n=new m({map:U.map},"esri-geocoder-widget"),n.startup(),s=new f({map:U.map,layerInfos:[],autoUpdate:!0},"legend"),s.startup();var v=function(){S.get("showBasemapGallery")&&S.set("showBasemapGallery",!1),S.get("showShareContainer")&&S.set("showShareContainer",!1),S.set("showLocatorWidgets",!S.get("showLocatorWidgets"))},w=function(){S.get("showLocatorWidgets")&&S.set("showLocatorWidgets",!1),S.get("showShareContainer")&&S.set("showShareContainer",!1),S.set("showBasemapGallery",!S.get("showBasemapGallery"))},L=function(){S.get("showLocatorWidgets")&&S.set("showLocatorWidgets",!1),S.get("showBasemapGallery")&&S.set("showBasemapGallery",!1),S.set("showShareContainer",!S.get("showShareContainer"))};e(r.byId("locator-widget-button"),"click",v),e(r.byId("basemap-gallery-button"),"click",w),e(r.byId("share-button"),"click",L)},U.bindEvents=function(){var i=this;e(r.byId("dms-search"),"change",function(e){var r=e.target?e.target.checked:e.srcElement.checked;r&&(S.set("showDMSInputs",!0),S.set("showLatLongInputs",!1))}),e(r.byId("lat-long-search"),"change",function(e){var r=e.target?e.target.checked:e.srcElement.checked;r&&(S.set("showLatLongInputs",!0),S.set("showDMSInputs",!1))}),e(U.map,"mouse-move",function(e){S.set("currentLatitude",e.mapPoint.getLatitude().toFixed(4)),S.set("currentLongitude",e.mapPoint.getLongitude().toFixed(4))}),e(U.map,"click",function(e){T.getActiveFiresInfoWindow(e)}),e(P.byId("confidence-fires-checkbox"),"change",function(){j.updateFiresLayer(!0)}),e(P.byId("twitter-conversations-checkbox"),"change",function(){var e=P.byId("twitter-conversations-checkbox").checked;j.toggleLayerVisibility(C.tweetLayer.id,e)}),e(P.byId("fires-checkbox"),"change",function(){var e=P.byId("fires-checkbox").checked;j.toggleLayerVisibility(C.firesLayer.id,e)}),e(P.byId("air-quality-checkbox"),"change",function(e){j.toggleLayerVisibility(C.airQualityLayer.id,e)}),e(P.byId("landsat-image-checkbox"),"change",function(){var e=P.byId("landsat-image-checkbox").checked;j.toggleLayerVisibility(C.landsat8.id,e)}),P.byId("windy-layer-checkbox").on("change",function(e){A.toggleWindLayer(e)}),P.byId("digital-globe-checkbox").on("change",function(e){j.toggleDigitalGlobeLayer(e)}),P.byId("provinces-checkbox").on("change",function(){j.adjustOverlaysLayer()}),P.byId("districts-checkbox").on("change",function(){j.adjustOverlaysLayer()}),P.byId("subdistricts-checkbox").on("change",function(){j.adjustOverlaysLayer()}),P.byId("villages-checkbox").on("change",function(){j.adjustOverlaysLayer()}),e(r.byId("search-option-go-button"),"click",function(){T.searchAreaByCoordinates()}),e(r.byId("print-button"),"click",function(){i.printMap()}),e(r.byId("report-link"),"click",function(){window.open("./app/js/views/report/report.html","Report","")}),e(r.byId("clear-search-pins"),"click",this.clearSearchPins),e(r.byId("legend-widget-title"),"click",this.toggleLegend),P.byId("forest-transparency-slider").on("change",function(e){j.setTransparency(C.forestUseLayers.id,e)}),P.byId("land-cover-transparency-slider").on("change",function(e){j.setTransparency(C.landCoverLayers.id,e)}),P.byId("conservation-transparency-slider").on("change",function(e){j.setTransparency(C.conservationLayers.id,e)}),a(".active-fires-options").forEach(function(r){e(r,"click",i.toggleFireOption.bind(i))}),a(".esriPopupWrapper").forEach(function(r){t.create("div",{id:"close-icon","class":"close-icon"},r),e(r,"click",function(){U.map.infoWindow.hide()})}),a("#forest-use-panel div.checkbox-container div input").forEach(function(e){n.add(e,"forest-use-layers-option")}),a("#conservation-panel div.checkbox-container div input").forEach(function(e){n.add(e,"conservation-layers-option")}),a("#land-cover-panel div.checkbox-container div input").forEach(function(e){"land-cover-radios"===e.name&&n.add(e,"land-cover-layers-option")}),a("#forest-use-panel div.checkbox-container div input").forEach(function(r){e(r,"change",function(){j.updateAdditionalVisibleLayers("forest-use-layers-option",C.forestUseLayers)})}),a(".conservation-layers-option").forEach(function(r){e(r,"change",function(){j.updateAdditionalVisibleLayers("conservation-layers-option",C.conservationLayers)})}),a(".land-cover-layers-option").forEach(function(r){e(r,"change",function(e){j.updateLandCoverLayers(e)})}),a("#primary-forests-options input").forEach(function(r){e(r,"change",function(){j.updatePrimaryForestsLayer(!0)})})},U.addLayers=function(){var r,a,t,i,n,s,d,c,l,p,y,u,g,h,m,f=this;r=new L,r.format="png32",r.layerIds=C.conservationLayers.defaultLayers,r.layerOption=L.LAYER_OPTION_SHOW,a=new v(C.conservationLayers.url,{imageParameters:r,id:C.conservationLayers.id,visible:!1}),s=new L,s.format="png32",s.layerIds=C.landCoverLayers.defaultLayers,s.layerOption=L.LAYER_OPTION_SHOW,d=new v(C.landCoverLayers.url,{imageParameters:s,id:C.landCoverLayers.id,visible:!1}),l=new L,l.format="png32",l.layerIds=C.forestUseLayers.defaultLayers,l.layerOption=L.LAYER_OPTION_SHOW,p=new v(C.forestUseLayers.url,{imageParameters:l,id:C.forestUseLayers.id,visible:!1}),y=new w(C.treeCoverLayer.url,{id:C.treeCoverLayer.id,visible:!1}),t=new L,t.format="png32",t.layerIds=C.primaryForestsLayer.defaultLayers,t.layerOption=L.LAYER_OPTION_SHOW,i=new v(C.primaryForestsLayer.url,{imageParameters:t,id:C.primaryForestsLayer.id,visible:!1}),g=new w(C.landsat8.url,{id:C.landsat8.id,visible:!1}),n=new w(C.digitalGlobe.url,{id:C.digitalGlobe.id,visible:!1}),u=new v(C.overlaysLayer.url,{id:C.overlaysLayer.id,visible:!1}),c=new v(C.airQualityLayer.url,{id:C.airQualityLayer.id,visible:!1}),h=new L,h.format="png32",h.layerIds=C.firesLayer.defaultLayers,h.layerOption=L.LAYER_OPTION_SHOW,m=new v(C.firesLayer.url,{imageParameters:h,id:C.firesLayer.id,visible:!1});var b=new k;b.setContent(T.getFireTweetsInfoWindow),tweetLayer=new I(C.tweetLayer.url,{mode:I.MODE_ONDEMAND,id:C.tweetLayer.id,visible:!1,outFields:["*"],infoTemplate:b}),U.map.addLayers([y,g,d,i,p,a,n,u,c,m,tweetLayer]),e.once(U.map,"layers-add-result",function(e){f.enableLayersFromHash();var r=o.map(e.layers,function(e){return{layer:e.layer}});r=o.filter(r,function(e){return e.layer.url.search("ImageServer")<0}),P.byId("legend").refresh(r)}),u.on("load",j.setOverlayLayerOrder),g.on("error",this.layerAddError),y.on("error",this.layerAddError),i.on("error",this.layerAddError),a.on("error",this.layerAddError),d.on("error",this.layerAddError),u.on("error",this.layerAddError),p.on("error",this.layerAddError),m.on("error",this.layerAddError)},U.layerAddError=function(e){require(["modules/ErrorController"],function(r){r.show(10,"Error adding Layer : <br> "+e.target.url)})},U.toggleFireOption=function(e){var r=e.target?e.target:e.srcElement;a(".selected-fire-option").forEach(function(e){n.remove(e,"selected-fire-option")}),n.add(r,"selected-fire-option"),j.updateFiresLayer()},U.enableLayersFromHash=function(){function a(){P.byId("fires-checkbox").set("checked",!0),P.byId("peat-lands-radio").set("checked",!0),e.emit(r.byId("peat-lands-radio"),"change",{}),j.updateLayersInHash("add",C.firesLayer.id,C.firesLayer.id),j.updateLayersInHash("add",C.landCoverLayers.id,C.landCoverLayers.id+"/1")}function t(a,t){if(void 0!==a&&""!==a)if(void 0===t)n=p[a].id,P.byId(n)&&(P.byId(n).set("checked",!0),"radio"===p[a].type&&e.emit(r.byId(n),"change",{}));else{o=p[a],s=t.split(",");for(var i=0,d=s.length;d>i;i++)n=o[s[i]].id,P.byId(n)&&(P.byId(n).set("checked",!0),"radio"===o[s[i]].type&&e.emit(r.byId(n),"change",{}))}}var i,n,o,s,d=D.getHash(),c=d.lyrs,l=c.split(":"),p=C.layersCheckboxes;if(void 0===c)return void a();if(1===l.length&&""===l[0])return void a();for(var y=0,u=l.length;u>y;y++)i=l[y].split("/"),t(i[0],i[1])},U.clearSearchPins=function(){U.map.graphics.clear(),S.set("showClearPinsOption",!1)},U.toggleLegend=function(){var e=r.byId("legend-widget-container"),a=e.offsetHeight-2===200?30:200;s.animateProperty({node:e,properties:{height:a},duration:500}).play(),30===a?n.add("legend-widget-title","legend-closed"):n.remove("legend-widget-title","legend-closed")},U.printMap=function(){function e(){r.byId("print-button").innerHTML="P"===r.byId("print-button").innerHTML?"":"P"}var a,t,i=new W(C.printOptions.url),o=new B,s=new H,d="You need to disable your pop-up blocker to see the printed map.";o.format="png32",o.layout=C.printOptions.template,o.showAttribution=!1,o.preserveScale=!1,s.map=U.map,a=function(r){var a=window.open(r.url,"_blank");n.remove("print-button","loading"),e(),(null===a||void 0===typeof a||void 0===a)&&alert(d)},t=function(r){n.remove("print-button","loading"),e(),console.error(r)},e(),n.add("print-button","loading"),i.execute(s,a,t)},U});