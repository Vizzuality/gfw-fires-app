define(["dojo/on","dojo/dom","dojo/query","dojo/dom-construct","dojo/dom-class","dojo/_base/array","dojo/_base/fx","esri/map","esri/config","esri/dijit/HomeButton","esri/dijit/BasemapGallery","esri/dijit/Basemap","esri/dijit/BasemapLayer","esri/dijit/LocateButton","esri/dijit/Geocoder","esri/dijit/Legend","esri/layers/ArcGISDynamicMapServiceLayer","esri/layers/ArcGISImageServiceLayer","esri/layers/ImageParameters","esri/graphic","esri/urlUtils","dijit/registry","views/map/MapConfig","views/map/MapModel","views/map/LayerController","views/map/Finder","utils/DijitFactory","modules/EventsController"],function(e,r,a,t,i,o,n,s,d,c,l,p,y,g,u,m,h,f,w,v,L,b,I,E,k,O,S,C){var j={},P=!1,A={viewName:"mapView"};return j.init=function(){var e=this;return P?(j.map.resize(),void C.switchToView(A)):(P=!0,void require(["dojo/text!views/map/map.html","dojo/ready"],function(a,t){r.byId(A.viewName).innerHTML=a,C.switchToView(A),t(function(){E.applyBindings("map-view"),e.addConfigurations(),e.createMap()})}))},j.addConfigurations=function(){var e=document.location.href.search("staging")>0?I.stagingProxyUrl:I.proxyUrl;L.addProxyRule({urlPrefix:I.landsat8.prefix,proxyUrl:e})},j.createMap=function(){var e=this;S.buildDijits(I.accordionDijits),j.map=new s("map",{basemap:I.mapOptions.basemap,zoom:I.mapOptions.initalZoom,center:I.mapOptions.center,sliderPosition:I.mapOptions.sliderPosition}),j.map.on("load",function(){j.map.graphics.clear(),k.setMap(j.map),O.setMap(j.map),e.addWidgets(),e.bindEvents(),e.addLayers(),j.map.resize()})},j.addWidgets=function(){var a,i,o,n,s,d,h=[];t.create("div",{id:"home-button","class":"home-butotn"},document.querySelector(".esriSimpleSliderIncrementButton"),"after"),s=new c({map:j.map},"home-button"),s.startup(),a=new p({layers:[new y({url:I.mapOptions.darkGrayCanvas})],title:"Dark Gray Canvas",thumbnailUrl:"app/images/darkGreyThumb.png"}),h.push(a),d=new l({map:j.map,basemaps:h,showArcGISBasemaps:!0},"basemap-gallery"),d.startup(),o=new g({map:j.map,highlightLocation:!1},"location-widget"),o.startup(),i=new u({map:j.map},"esri-geocoder-widget"),i.startup(),n=new m({map:j.map,layerInfos:[],autoUpdate:!0},"legend"),n.startup();var f=function(){E.get("showBasemapGallery")&&E.set("showBasemapGallery",!1),E.get("showShareContainer")&&E.set("showShareContainer",!1),E.set("showLocatorWidgets",!E.get("showLocatorWidgets"))},w=function(){E.get("showLocatorWidgets")&&E.set("showLocatorWidgets",!1),E.get("showShareContainer")&&E.set("showShareContainer",!1),E.set("showBasemapGallery",!E.get("showBasemapGallery"))},v=function(){E.get("showLocatorWidgets")&&E.set("showLocatorWidgets",!1),E.get("showBasemapGallery")&&E.set("showBasemapGallery",!1),E.set("showShareContainer",!E.get("showShareContainer"))};e(r.byId("locator-widget-button"),"click",f),e(r.byId("basemap-gallery-button"),"click",w),e(r.byId("share-button"),"click",v)},j.bindEvents=function(){var t=this;e(r.byId("dms-search"),"change",function(e){var r=e.target?e.target.checked:e.srcElement.checked;r&&(E.set("showDMSInputs",!0),E.set("showLatLongInputs",!1))}),e(r.byId("lat-long-search"),"change",function(e){var r=e.target?e.target.checked:e.srcElement.checked;r&&(E.set("showLatLongInputs",!0),E.set("showDMSInputs",!1))}),e(j.map,"mouse-move",function(e){E.set("currentLatitude",e.mapPoint.getLatitude().toFixed(4)),E.set("currentLongitude",e.mapPoint.getLongitude().toFixed(4))}),e(j.map,"click",function(e){O.getActiveFiresInfoWindow(e)}),e(r.byId("confidence-fires-checkbox"),"change",function(){k.updateFiresLayer(!0)}),e(r.byId("fires-checkbox"),"change",function(e){var r=e.target?e.target.checked:e.srcElement.checked;k.toggleLayerVisibility(I.firesLayer.id,r)}),e(r.byId("landsat-image-checkbox"),"change",function(e){var r=e.target?e.target.checked:e.srcElement.checked;k.toggleLayerVisibility(I.landsat8.id,r)}),e(r.byId("search-option-go-button"),"click",function(){O.searchAreaByCoordinates()}),e(r.byId("report-link"),"click",function(){window.open("./app/js/views/report/report.html","Report","")}),e(r.byId("clear-search-pins"),"click",this.clearSearchPins),e(r.byId("legend-widget-title"),"click",this.toggleLegend),b.byId("forest-transparency-slider").on("change",function(e){k.setTransparency(I.forestUseLayers.id,e)}),b.byId("land-cover-transparency-slider").on("change",function(e){k.setTransparency(I.landCoverLayers.id,e)}),b.byId("conservation-transparency-slider").on("change",function(e){k.setTransparency(I.conservationLayers.id,e)}),a(".active-fires-options").forEach(function(r){e(r,"click",t.toggleFireOption.bind(t))}),a(".forest-use-layers-option").forEach(function(r){e(r,"change",function(){k.updateAdditionalVisibleLayers("forest-use-layers-option",I.forestUseLayers)})}),a(".conservation-layers-option").forEach(function(r){e(r,"change",function(){k.updateAdditionalVisibleLayers("conservation-layers-option",I.conservationLayers)})}),a(".land-cover-layers-option").forEach(function(r){e(r,"change",function(){k.updateAdditionalVisibleLayers("land-cover-layers-option",I.landCoverLayers)})})},j.addLayers=function(){var r,a,t,i,n,s,d,c,l,p;r=new w,r.format="png32",r.layerIds=I.conservationLayers.defaultLayers,r.layerOption=w.LAYER_OPTION_SHOW,a=new h(I.conservationLayers.url,{imageParameters:r,id:I.conservationLayers.id,visible:!1}),t=new w,t.format="png32",t.layerIds=I.landCoverLayers.defaultLayers,t.layerOption=w.LAYER_OPTION_SHOW,i=new h(I.landCoverLayers.url,{imageParameters:t,id:I.landCoverLayers.id,visible:!1}),n=new w,n.format="png32",n.layerIds=I.forestUseLayers.defaultLayers,n.layerOption=w.LAYER_OPTION_SHOW,s=new h(I.forestUseLayers.url,{imageParameters:n,id:I.forestUseLayers.id,visible:!1}),d=new f(I.treeCoverLayer.url,{id:I.treeCoverLayer.id,visible:!1}),c=new f(I.landsat8.url,{id:I.landsat8.id,visible:!1}),l=new w,l.format="png32",l.layerIds=I.firesLayer.defaultLayers,l.layerOption=w.LAYER_OPTION_SHOW,p=new h(I.firesLayer.url,{imageParameters:l,id:I.firesLayer.id,visible:!0}),j.map.addLayers([d,c,i,s,a,p]),e.once(j.map,"layers-add-result",function(e){var r=o.map(e.layers,function(e){return{layer:e.layer}});r=o.filter(r,function(e){return e.layer.url.search("ImageServer")<0}),b.byId("legend").refresh(r)}),c.on("error",this.layerAddError),d.on("error",this.layerAddError),a.on("error",this.layerAddError),i.on("error",this.layerAddError),s.on("error",this.layerAddError),p.on("error",this.layerAddError)},j.layerAddError=function(e){alert("Error adding Layer at "+e.target.url)},j.toggleFireOption=function(e){var r=e.target?e.target:e.srcElement;a(".selected-fire-option").forEach(function(e){i.remove(e,"selected-fire-option")}),i.add(r,"selected-fire-option"),k.updateFiresLayer()},j.clearSearchPins=function(){j.map.graphics.clear(),E.set("showClearPinsOption",!1)},j.toggleLegend=function(){var e=r.byId("legend-widget-container"),a=e.offsetHeight-2===200?30:200;n.animateProperty({node:e,properties:{height:a},duration:500}).play(),30===a?i.add("legend-widget-title","legend-closed"):i.remove("legend-widget-title","legend-closed")},j});