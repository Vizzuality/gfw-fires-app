/*! Global-Forest-Watch-Fires Fri Dec 12 2014 09:16:49 */
define(["dojo/dom","dojo/_base/array","dojo/on","dojo/query","dojo/Deferred","dojo/promise/all","esri/layers/FeatureLayer","esri/graphic","esri/geometry/Point","esri/geometry/webMercatorUtils","esri/symbols/PictureMarkerSymbol","views/map/MapConfig","views/map/MapModel","views/map/LayerController","esri/tasks/IdentifyTask","esri/tasks/IdentifyParameters","esri/tasks/query","esri/tasks/QueryTask","esri/geometry/Circle","libs/moment","libs/timezone"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){var s;return{setMap:function(a){s=a},clickNext:"",searchAreaByCoordinates:function(){var c,d,e,f,g={},l=!1,n="You did not enter a valid value.  Please check that your location values are all filled in and nubmers only.",o=new k("app/images/RedStickpin.png",32,32),p={},q=function(a){return l||(l=isNaN(parseInt(a))),isNaN(parseInt(a))?0:parseInt(a)},r=function(){var a=0;return b.forEach(s.graphics.graphics,function(b){b.attributes&&b.attributes.locatorValue&&(a=Math.max(a,parseInt(b.attributes.locatorValue)))}),a};m.get("showDMSInputs")?(g.dlat=q(a.byId("degreesLatInput").value),g.mlat=q(a.byId("minutesLatInput").value),g.slat=q(a.byId("secondsLatInput").value),g.dlon=q(a.byId("degreesLonInput").value),g.mlon=q(a.byId("minutesLonInput").value),g.slon=q(a.byId("secondsLonInput").value),c=g.dlat+g.mlat/60+g.slat/3600,d=g.dlon+g.mlon/60+g.slon/3600):(c=q(a.byId("latitudeInput").value),d=q(a.byId("longitudeInput").value)),l?alert(n):(e=j.geographicToWebMercator(new i(d,c)),p.locatorValue=r(),p.id="LOCATOR_"+p.locatorValue,f=new h(e,o,p),s.graphics.add(f),s.centerAndZoom(e,7),m.set("showClearPinsOption",!0))},fetchTwitterData:function(a){var b=a.target?a.target:a.srcElement;!b.checked},mapClick:function(c){var d=s;if(forestUseLayer=d.getLayer(l.forestUseLayers.id),conservationLayers=d.getLayer(l.conservationLayers.id),visLayers=[],isVisLayers=forestUseLayer.visibleLayers.indexOf(10)>-1||conservationLayers.visible||forestUseLayer.visibleLayers.indexOf(26)>-1||forestUseLayer.visibleLayers.indexOf(27)>-1||forestUseLayer.visibleLayers.indexOf(28)>-1||forestUseLayer.visibleLayers.indexOf(32)>-1,visible=forestUseLayer.visible,b.forEach(forestUseLayer.visibleLayers,function(a){visLayers.push(a)}),conservationLayers.visible&&visLayers.push(25),Array.prototype.move=function(a,b){this.splice(b,0,this.splice(a,1)[0])},visLayers.move(visLayers.indexOf(27),0),isVisLayers){var e=new o(forestUseLayer.url);identifyParams=new p,identifyParams.tolerance=3,identifyParams.returnGeometry=!0,identifyParams.layerIds=visLayers,identifyParams.width=d.width,identifyParams.height=d.height,identifyParams.geometry=c.mapPoint,identifyParams.mapExtent=d.extent,e.execute(identifyParams,function(b){var e=b[0];e&&(content=void 0===a.byId("close-icon")?"<div id='closePopup' class='close-icon'></div><table id='infoWindowTable'>":"<table id='infoWindowTable'>",25==e.layerId?(content+="<tr class='infoName'><td colspan='2'>"+e.feature.attributes.NAME+"</td></tr>",content+="<tr><td>Local Name</td><td>"+e.feature.attributes.ORIG_NAME+"</td></tr>",content+="<tr><td>Legal Designation</td><td>"+e.feature.attributes.DESIG_ENG+"</td></tr>",content+="<tr><td>WDPA ID</td><td>"+e.feature.attributes.WDPAID+"</td></tr>"):27==e.layerId?(content+="<tr class='infoName'><td colspan='2'>"+e.feature.attributes.NAME+"</td></tr>",content+="<tr><td>Concession Type</td><td>"+e.feature.attributes.TYPE+"</td></tr>",content+="<tr><td>Country</td><td>"+e.feature.attributes.Country+"</td></tr>",content+="<tr><td>Certification Status</td><td>"+e.feature.attributes.CERT_STAT+"</td></tr>",content+="<tr><td>GIS Calculated Area (ha)</td><td>"+e.feature.attributes.AREA_HA+"</td></tr>",content+="<tr><td>Certificate ID</td><td>"+e.feature.attributes.Certificat+"</td></tr>",content+="<tr><td>Certificate Issue Date</td><td>"+e.feature.attributes.Issued+"</td></tr>",content+="<tr><td>Certificate Expiry Date</td><td>"+e.feature.attributes.Expired+"</td></tr>",content+="<tr><td>Mill name</td><td>"+e.feature.attributes.Mill+"</td></tr>",content+="<tr><td>Mill location</td><td>"+e.feature.attributes.Location+"</td></tr>",content+="<tr><td>Mill capacity (t/hour)</td><td>"+e.feature.attributes.Capacity+"</td></tr>",content+="<tr><td>Certified CPO (mt)</td><td>"+e.feature.attributes.CPO+"</td></tr>",content+="<tr><td>Certified PK (mt)</td><td>"+e.feature.attributes.PK+"</td></tr>",content+="<tr><td>Estate Suppliers</td><td>"+e.feature.attributes.Estate+"</td></tr>",content+="<tr><td>Estate Area (ha)</td><td>"+e.feature.attributes.Estate_1+"</td></tr>",content+="<tr><td>Outgrower Area (ha)</td><td>"+e.feature.attributes.Outgrowe+"</td></tr>",content+="<tr><td>Scheme Smallholder Area (ha)</td><td>"+e.feature.attributes.SH+"</td></tr>"):(content+="<tr class='infoName'><td colspan='2'>"+e.feature.attributes.NAME+"</td></tr>",content+="<tr><td>Concession Type</td><td>"+e.feature.attributes.TYPE+"</td></tr>",content+="<tr><td>Country</td><td>"+e.feature.attributes.Country+"</td></tr>",content+="<tr><td>Certification Status</td><td>"+e.feature.attributes.CERT_STAT+"</td></tr>",content+="<tr><td>GIS Calculated Area (ha)</td><td>"+e.feature.attributes.AREA_HA+"</td></tr>"),content+="<tr><td>Source: </td><td>"+(e.feature.attributes.Source||"N/A")+"</td></tr>",content+="</table>",d.infoWindow.setContent(content),d.infoWindow.show(c.mapPoint))},function(a){console.dir(a)})}},getTomnodInfoWindow:function(a){var b=l.tomnodLayer,c=(b.url,a),d="";return c?(executeReturned=!1,d+=" <div><h3>"+c.attributes.name+"</h3></div>",d+="<tr><td><img src='"+b.chipBucket+c.attributes.ChipLink,d+="' style='width:300px' /></tc></tr>",d+="<div><strong>Confirmation:</strong> "+c.attributes.Confirmation+" people</div>",d+="<div><b>Crowd Rank:</b> "+c.attributes.CrowdRank+"%</div>",d+="<a href='"+c.attributes.ImageLink,d+="' target='_blank'>See this point on ",d+="<img style='height:20px;width:100px;' src='app/images/tomnod_logo.png'></div>"):void 0},selectTomnodFeatures:function(c){var e=l.tomnodLayer,f=this,h=e.url,i=new o(h),j=new p,k=(new r(h),new q),m=c.mapPoint,n=(d(".selected-fire-option")[0],new Date,new Date,[]);if(!s.getLayer(e.id).visible){f.getActiveFiresInfoWindow(c),f.getArchiveFiresInfoWindow(c);var t=a.byId("noaa-fires-18"),u=a.byId("indonesia-fires"),v=a.byId("fires-checkbox");return"true"==t.getAttribute("aria-checked")&&"true"==u.getAttribute("aria-checked")||"true"==t.getAttribute("aria-checked")&&"true"==v.getAttribute("aria-checked")?setTimeout(function(){s.infoWindow.isShowing||f.getArchiveNoaaInfoWindow(c)},800):f.getArchiveNoaaInfoWindow(c),void setTimeout(function(){s.infoWindow.isShowing||f.getDigitalGlobeInfoWindow(c)},400)}j.geometry=m,j.tolerance=3,j.returnGeometry=!1,j.layerDefinitions=n,j.mapExtent=s.extent,j.layerIds=[8],k.where="OBJECTID in (",k.returnGeometry=!1,k.outFields=["OBJECTID","ChipLink","CrowdRank","Confirmation","name","ImageLink"];var w=[];i.execute(j,function(a){return b.forEach(a,function(a){w.push(a.feature.attributes.OBJECTID)}),w.length<1?(s.infoWindow.setFeatures(void 0),f.getActiveFiresInfoWindow(c),f.getDigitalGlobeInfoWindow(c),f.getArchiveFiresInfoWindow(c),void f.getArchiveNoaaInfoWindow(c)):(s.infoWindow.resize(340,500),k.where+=w.join(",")+")",selected_features=s.getLayer(l.tomnodLayer.sel_id).selectFeatures(k,g.SELECTION_NEW),void selected_features.then(function(a){s.infoWindow.setFeatures(a),s.infoWindow.resize(340,500),s.infoWindow.show(c.mapPoint)}))},function(){f.mapClick(c)})},getActiveFiresInfoWindow:function(a){var c=l.firesLayer,e=this,f=c.url,g=new o(f),h=new p,i=a.mapPoint,j=!0,k=d(".selected-fire-option")[0],m=new Date,n=new Date,q="",r="",t=[];if(!s.getLayer(c.id).visible)return void e.mapClick(a);switch(k.id){case"fires72":m.setDate(m.getDate()-4),n.setDate(n.getDate()-3);break;case"fires48":m.setDate(m.getDate()-3),n.setDate(n.getDate()-2);break;case"fires24":m.setDate(m.getDate()-2),n.setDate(n.getDate()-1);break;default:m.setDate(m.getDate()-8),n.setDate(n.getDate()-7)}r=m.getFullYear()+"-"+(m.getMonth()+1)+"-"+m.getDate()+" "+m.getHours()+":"+m.getMinutes()+":"+m.getSeconds(),q=n.getFullYear()+"-"+(n.getMonth()+1)+"-"+n.getDate()+" "+n.getHours()+":"+n.getMinutes()+":"+n.getSeconds();for(var u=0,v=l.firesLayer.defaultLayers.length;v>u;u++)t[u]="ACQ_DATE > date '"+r+"'";h.geometry=i,h.tolerance=3,h.returnGeometry=!1,h.layerDefinitions=t,h.mapExtent=s.extent,h.layerOption=p.LAYER_OPTION_VISIBLE;var w="</div><table id='infoWindowTable'>";g.execute(h,function(d){var f=s,g=d[0];g?(j=!1,w+="<tr class='infoName'><td colspan='3'>Active Fires</td><td colspan='2'></td></tr>",b.forEach(c.query.fields,function(a){w+="<tr><td colspan='3'>"+a.label+"</td>",w+="<td colspan='2'>"+g.feature.attributes[a.name]+"</td></tr>"}),w+="</table>",f.infoWindow.setContent(w),f.infoWindow.resize(270,140),f.infoWindow.show(i)):e.mapClick(a)},function(){e.mapClick(a)})},getArchiveFiresInfoWindow:function(c){var d=l.indonesiaLayers,e=this,f=d.url,g=new o(f),h=new p,i=c.mapPoint,j=!0,k=(new Date,new Date,a.byId("indonesia-fires"));if(!s.getLayer(d.id).visible||1!=k.checked)return void e.mapClick(c);h.layerDefinitions=s.getLayer(d.id).layerDefinitions,h.geometry=i,h.tolerance=3,h.returnGeometry=!1,h.mapExtent=s.extent,h.layerOption=p.LAYER_OPTION_ALL,h.layerIds=[0];var m=(s.getLayer(d.id),"</div><table id='infoWindowTable'>");g.execute(h,function(a){var f=s,g=a[0];if(g){if(2==g.layerId)return;j=!1,m+="<tr class='infoName'><strong>NASA archived fires for Indonesia</strong></tr>",b.forEach(d.query.fields,function(a){m+="<tr><td colspan='3'>"+a.label+"</td>",m+="<td colspan='2'>"+g.feature.attributes[a.name]+"</td></tr>"}),m+="</table>",f.infoWindow.setContent(m),f.infoWindow.resize(270,140),f.infoWindow.show(i)}else e.mapClick(c)},function(){e.mapClick(c)})},getArchiveNoaaInfoWindow:function(b){var c=l.indonesiaLayers,d=this,e=c.url,f=new o(e),g=new p,h=b.mapPoint,i=!0,j=(new Date,new Date,a.byId("noaa-fires-18"));if("false"!=j.getAttribute("aria-checked")){if(!s.getLayer("IndonesiaFires").visible)return void d.mapClick(b);g.geometry=h,g.tolerance=3,g.returnGeometry=!1,g.mapExtent=s.extent,g.layerOption=p.LAYER_OPTION_ALL,g.layerIds=[9];{s.getLayer(c.id)}f.execute(g,function(a){var c=s,e=a[0];if(e){if(2==e.layerId)return;i=!1;var f=e.feature.attributes.Date,g=f.split(" "),g=g[0],j="</div><table id='infoWindowTable'>";j+="<tr class='infoName'><strong>NOAA-18 fires</strong></tr>",j+="<tr><td colspan='3'>DATE</td>",j+="<td colspan='2'>"+g+"</td></tr>",j+="</table>",c.infoWindow.setContent(j),c.infoWindow.resize(170,50),c.infoWindow.show(h)}else d.mapClick(b)},function(){d.mapClick(b)})}},getNOAAFiresInfoWindow:function(a){{var c=l.indonesiaLayers,d=this,e=c.url,f=new o(e),g=new p,h=a.mapPoint,i=!0;new Date,new Date}if(!s.getLayer(c.id).visible)return void d.mapClick(a);g.geometry=h,g.tolerance=10,g.returnGeometry=!1,g.mapExtent=s.extent,g.layerOption=p.LAYER_OPTION_ALL;var j="</div><table id='infoWindowTable'>";f.execute(g,function(e){var f=s,g=e[0];g?(i=!1,j+="<tr class='infoName'><strong>NASA archived fires for Indonesia</strong></tr>",b.forEach(c.query.fields,function(a){j+="<tr><td colspan='3'>"+a.label+"</td>",j+="<td colspan='2'>"+g.feature.attributes[a.name]+"</td></tr>"}),j+="</table>",f.infoWindow.setContent(j),f.infoWindow.show(h)):(console.log("No result returned!"),d.mapClick(a))},function(){d.mapClick(a)})},getDigitalGlobeInfoWindow:function(g){var h=(l.digitalGlobe,s.getLayer(l.digitalGlobe.graphicsLayerId),new q);if((!g.graphic||"Digital_Globe"===g.graphic.attributes.Layer)&&void 0!=g.graphic){h.geometry=g.graphic.geometry,h.where="Category = 1",h.returnGeometry=!1,h.outFields=["*"];var j,k=(f(l.digitalGlobe.mosaics.map(function(a){var b=new e;h.geometry=g.graphic.geometry,h.returnGeometry=!1,h.outFields=["*"];var c=new r(l.digitalGlobe.imagedir+a+"/ImageServer");return c.execute(h,function(a){b.resolve(a.features)},function(){b.resolve([])}),b.promise})).then(function(e){var f="",g=[],h=dijit.byId("timeSliderDG").thumbIndexes,k=dijit.byId("timeSliderDG").timeStops,l=moment(k[h[0]]).tz("Asia/Jakarta"),m=moment(k[h[1]]).tz("Asia/Jakarta");e.map(function(a){a.map(function(a){g.push(a)})}),g.sort(function(a,b){return a.attributes.AcquisitionDate==b.attributes.AcquisitionDate?0:a.attributes.AcquisitionDate>b.attributes.AcquisitionDate?-1:1}),f+="<p>Click a date below to see the imagery.</p><ul class='popup-list'><li><strong>Date <span class='satelliteColumn'>Satellite</span></strong></li>",b.forEach(g,function(a){var b=moment(a.attributes.AcquisitionDate).tz("Asia/Jakarta");b>=l&&m>=b&&(f+="<li><a class='popup-link' data-bucket='"+a.attributes.SensorName+"_id_"+a.attributes.OBJECTID+"'> "+b.format("YYYY/MM/DD")+"  <span class='satelliteColumn' data-bucket='"+a.attributes.SensorName+"_id_"+a.attributes.OBJECTID+"'>"+a.attributes.SensorName+"</span></a></li>")}),f+="</ul><a class='custom-zoom-to' id='custom-zoom-to'>Zoom To</a>",s.infoWindow.setContent(f),s.infoWindow.resize(270,500),s.infoWindow.show(t),j=0,d(".contentPane .popup-link").forEach(function(a,b){u.push(c(a,"click",function(a){var c=a.target?a.target:a.srcElement,d=c.dataset?c.dataset.bucket:c.getAttribute("data-bucket");$("#imageryWindow > table > tbody > tr").each(function(){$(this).removeClass("imageryRowSelected");var a=this.firstElementChild;a=$(a).html(),a=$(a).attr("data-bucket"),d==a&&$(this).addClass("imageryRowSelected")}),n.showDigitalGlobeImagery(d),j=b}))}),u.push(c(a.byId("custom-zoom-to"),"click",function(){var a=new i(g[j].attributes.CenterX,g[j].attributes.CenterY,s.spatialReference);s.centerAndZoom(a,12)})),c.once(s.infoWindow,"hide",function(){b.forEach(u,function(a){a.remove()})})}),l.digitalGlobe.identifyUrl),m=(new o(k),new p),t=g.mapPoint,u=[];m.geometry=t,m.tolerance=3,m.returnGeometry=!0,m.mapExtent=s.extent,m.layerOption=p.LAYER_OPTION_VISIBLE,m.layerIds=[0]}},getFireTweetsInfoWindow:function(a){s.infoWindow.anchor="ANCHOR_UPPERRIGHT";var b=a.attributes,c="<table><tr><td>";return c+="<td><img src='"+b.UserProfileImage+"'/></td>",c+="<td>"+b.UserName+"</td></tr>",c+="<p>"+b.Text+"</p>",c+="<p>"+b.Date+"</p>"}}});