/*! Global-Forest-Watch-Fires Tue Jul 22 2014 16:30:35 */
define(["dojo/dom","dojo/_base/array","dojo/on","dojo/query","esri/graphic","esri/geometry/Point","esri/geometry/webMercatorUtils","esri/symbols/PictureMarkerSymbol","views/map/MapConfig","views/map/MapModel","esri/tasks/IdentifyTask","esri/tasks/IdentifyParameters"],function(a,b,c,d,e,f,g,h,i,j,k,l){var m;return{setMap:function(a){m=a},searchAreaByCoordinates:function(){var c,d,i,k,l={},n=!1,o="You did not enter a valid value.  Please check that your location values are all filled in and nubmers only.",p=new h("app/images/RedStickpin.png",32,32),q={},r=function(a){return n||(n=isNaN(parseInt(a))),isNaN(parseInt(a))?0:parseInt(a)},s=function(){var a=0;return b.forEach(m.graphics.graphics,function(b){b.attribtues&&b.attributes.locatorValue&&(a=Math.max(a,parseInt(b.attributes.locatorValue)))}),a};j.get("showDMSInputs")?(l.dlat=r(a.byId("degreesLatInput").value),l.mlat=r(a.byId("minutesLatInput").value),l.slat=r(a.byId("secondsLatInput").value),l.dlon=r(a.byId("degreesLonInput").value),l.mlon=r(a.byId("minutesLonInput").value),l.slon=r(a.byId("secondsLonInput").value),c=l.dlat+l.mlat/60+l.slat/3600,d=l.dlon+l.mlon/60+l.slon/3600):(c=r(a.byId("latitudeInput").value),d=r(a.byId("longitudeInput").value)),n?alert(o):(i=g.geographicToWebMercator(new f(d,c)),q.locatorValue=s(),q.id="LOCATOR_"+q.locatorValue,k=new e(i,p,q),m.graphics.add(k),m.centerAndZoom(i,7),j.set("showClearPinsOption",!0))},fetchTwitterData:function(a){var b=a.target?a.target:a.srcElement;!b.checked},mapClick:function(d){var e=m;if(forestUseLayer=e.getLayer(i.forestUseLayers.id),conservationLayers=e.getLayer(i.conservationLayers.id),visLayers=[],isVisLayers=forestUseLayer.visibleLayers.indexOf(10)>-1||conservationLayers.visible||forestUseLayer.visibleLayers.indexOf(26)>-1||forestUseLayer.visibleLayers.indexOf(27)>-1||forestUseLayer.visibleLayers.indexOf(28)>-1||forestUseLayer.visibleLayers.indexOf(32)>-1,visible=forestUseLayer.visible,b.forEach(forestUseLayer.visibleLayers,function(a){visLayers.push(a)}),conservationLayers.visible&&visLayers.push(25),Array.prototype.move=function(a,b){this.splice(b,0,this.splice(a,1)[0])},visLayers.move(visLayers.indexOf(27),0),isVisLayers){var f=new k(forestUseLayer.url);identifyParams=new l,identifyParams.tolerance=3,identifyParams.returnGeometry=!0,identifyParams.layerIds=visLayers,identifyParams.width=e.width,identifyParams.height=e.height,identifyParams.geometry=d.mapPoint,identifyParams.mapExtent=e.extent,f.execute(identifyParams,function(b){var f=b[0];f&&(content=void 0===a.byId("close-icon")?"<div id='closePopup' class='close-icon'></div><table id='infoWindowTable'>":"<table id='infoWindowTable'>",25==f.layerId?(content+="<tr class='infoName'><td colspan='2'>"+f.feature.attributes.NAME+"</td></tr>",content+="<tr><td>Local Name</td><td>"+f.feature.attributes.ORIG_NAME+"</td></tr>",content+="<tr><td>Legal Designation</td><td>"+f.feature.attributes.DESIG_ENG+"</td></tr>",content+="<tr><td>WDPA ID</td><td>"+f.feature.attributes.WDPAID+"</td></tr>"):27==f.layerId?(content+="<tr class='infoName'><td colspan='2'>"+f.feature.attributes.NAME+"</td></tr>",content+="<tr><td>Concession Type</td><td>"+f.feature.attributes.TYPE+"</td></tr>",content+="<tr><td>Country</td><td>"+f.feature.attributes.Country+"</td></tr>",content+="<tr><td>Certification Status</td><td>"+f.feature.attributes.CERT_STAT+"</td></tr>",content+="<tr><td>GIS Calculated Area (ha)</td><td>"+f.feature.attributes.AREA_HA+"</td></tr>",content+="<tr><td>Certificate ID</td><td>"+f.feature.attributes.Certificat+"</td></tr>",content+="<tr><td>Certificate Issue Date</td><td>"+f.feature.attributes.Issued+"</td></tr>",content+="<tr><td>Certificate Expiry Date</td><td>"+f.feature.attributes.Expired+"</td></tr>",content+="<tr><td>Mill name</td><td>"+f.feature.attributes.Mill+"</td></tr>",content+="<tr><td>Mill location</td><td>"+f.feature.attributes.Location+"</td></tr>",content+="<tr><td>Mill capacity (t/hour)</td><td>"+f.feature.attributes.Capacity+"</td></tr>",content+="<tr><td>Certified CPO (mt)</td><td>"+f.feature.attributes.CPO+"</td></tr>",content+="<tr><td>Certified PK (mt)</td><td>"+f.feature.attributes.PK+"</td></tr>",content+="<tr><td>Estate Suppliers</td><td>"+f.feature.attributes.Estate+"</td></tr>",content+="<tr><td>Estate Area (ha)</td><td>"+f.feature.attributes.Estate_1+"</td></tr>",content+="<tr><td>Outgrower Area (ha)</td><td>"+f.feature.attributes.Outgrowe+"</td></tr>",content+="<tr><td>Scheme Smallholder Area (ha)</td><td>"+f.feature.attributes.SH+"</td></tr>"):(content+="<tr class='infoName'><td colspan='2'>"+f.feature.attributes.NAME+"</td></tr>",content+="<tr><td>Concession Type</td><td>"+f.feature.attributes.TYPE+"</td></tr>",content+="<tr><td>Country</td><td>"+f.feature.attributes.Country+"</td></tr>",content+="<tr><td>Certification Status</td><td>"+f.feature.attributes.CERT_STAT+"</td></tr>",content+="<tr><td>GIS Calculated Area (ha)</td><td>"+f.feature.attributes.AREA_HA+"</td></tr>"),content+="<tr><td>Source: </td><td>"+(f.feature.attributes.Source||"N/A")+"</td></tr>",content+="</table>",e.infoWindow.setContent(content),e.infoWindow.show(d.mapPoint),c.once(a.byId("closePopup"),"click",function(){e.infoWindow.hide()}))},function(a){console.dir(a)})}},getActiveFiresInfoWindow:function(a){var c=i.firesLayer,e=this,f=c.url,g=new k(f),h=new l,j=a.mapPoint,n=!0,o=d(".selected-fire-option")[0],p=new Date,q=new Date,r="",s="",t=[];if(!m.getLayer(c.id).visible)return void e.mapClick(a);switch(o.id){case"fires72":p.setDate(p.getDate()-4),q.setDate(q.getDate()-3);break;case"fires48":p.setDate(p.getDate()-3),q.setDate(q.getDate()-2);break;case"fires24":p.setDate(p.getDate()-2),q.setDate(q.getDate()-1);break;default:p.setDate(p.getDate()-8),q.setDate(q.getDate()-7)}s=p.getFullYear()+"-"+(p.getMonth()+1)+"-"+p.getDate()+" "+p.getHours()+":"+p.getMinutes()+":"+p.getSeconds(),r=q.getFullYear()+"-"+(q.getMonth()+1)+"-"+q.getDate()+" "+q.getHours()+":"+q.getMinutes()+":"+q.getSeconds();for(var u=0,v=i.firesLayer.defaultLayers.length;v>u;u++)t[u]="ACQ_DATE > date '"+s+"'";h.geometry=j,h.tolerance=3,h.returnGeometry=!1,h.layerDefinitions=t,h.mapExtent=m.extent,h.layerOption=l.LAYER_OPTION_VISIBLE;var w="</div><table id='infoWindowTable'>";g.execute(h,function(d){var f=m,g=d[0];g?(n=!1,w+="<tr class='infoName'><td colspan='3'>Active Fires</td><td colspan='2'></td></tr>",b.forEach(c.query.fields,function(a){w+="<tr><td colspan='3'>"+a.label+"</td>",w+="<td colspan='2'>"+g.feature.attributes[a.name]+"</td></tr>"}),w+="</table>",f.infoWindow.setContent(w),f.infoWindow.show(j)):e.mapClick(a)},function(){e.mapClick(a)})},getFireTweetsInfoWindow:function(a){m.infoWindow.anchor="ANCHOR_UPPERRIGHT";var b=a.attributes,c="<table><tr><td>";return c+="<td><img src='"+b.UserProfileImage+"'/></td>",c+="<td>"+b.UserName+"</td></tr>",c+="<p>"+b.Text+"</p>",c+="<p>"+b.Date+"</p>"}}});