define(["dojo/dom","dojo/_base/array","dojo/on","dojo/query","dojo/Deferred","dojo/promise/all","esri/layers/FeatureLayer","esri/graphic","esri/geometry/Point","esri/geometry/webMercatorUtils","esri/symbols/PictureMarkerSymbol","views/map/MapConfig","views/map/MapModel","views/map/LayerController","esri/tasks/IdentifyTask","esri/tasks/IdentifyParameters","esri/tasks/query","esri/tasks/QueryTask","esri/geometry/Circle"],function(t,e,i,r,a,n,o,s,d,u,c,l,f,m,y,b,p,g){var v;return{setMap:function(t){v=t},clickNext:"",searchAreaByCoordinates:function(){var i,r,a,n,o={},l=!1,m="You did not enter a valid value.  Please check that your location values are all filled in and nubmers only.",y=new c("app/images/RedStickpin.png",32,32),b={},p=function(t){return l||(l=isNaN(parseInt(t))),isNaN(parseInt(t))?0:parseInt(t)},g=function(){var t=0;return e.forEach(v.graphics.graphics,function(e){e.attributes&&e.attributes.locatorValue&&(t=Math.max(t,parseInt(e.attributes.locatorValue)))}),t};f.get("showDMSInputs")?(o.dlat=p(t.byId("degreesLatInput").value),o.mlat=p(t.byId("minutesLatInput").value),o.slat=p(t.byId("secondsLatInput").value),o.dlon=p(t.byId("degreesLonInput").value),o.mlon=p(t.byId("minutesLonInput").value),o.slon=p(t.byId("secondsLonInput").value),i=o.dlat+o.mlat/60+o.slat/3600,r=o.dlon+o.mlon/60+o.slon/3600):(i=p(t.byId("latitudeInput").value),r=p(t.byId("longitudeInput").value)),l?alert(m):(a=u.geographicToWebMercator(new d(r,i)),b.locatorValue=g(),b.id="LOCATOR_"+b.locatorValue,n=new s(a,y,b),v.graphics.add(n),v.centerAndZoom(a,7),f.set("showClearPinsOption",!0))},fetchTwitterData:function(t){var e=t.target?t.target:t.srcElement;!e.checked},mapClick:function(i){var r=v;if(forestUseLayer=r.getLayer(l.forestUseLayers.id),conservationLayers=r.getLayer(l.conservationLayers.id),visLayers=[],isVisLayers=forestUseLayer.visibleLayers.indexOf(10)>-1||conservationLayers.visible||forestUseLayer.visibleLayers.indexOf(26)>-1||forestUseLayer.visibleLayers.indexOf(27)>-1||forestUseLayer.visibleLayers.indexOf(28)>-1||forestUseLayer.visibleLayers.indexOf(32)>-1,visible=forestUseLayer.visible,e.forEach(forestUseLayer.visibleLayers,function(t){visLayers.push(t)}),conservationLayers.visible&&visLayers.push(25),Array.prototype.move=function(t,e){this.splice(e,0,this.splice(t,1)[0])},visLayers.move(visLayers.indexOf(27),0),isVisLayers){var a=new y(forestUseLayer.url);identifyParams=new b,identifyParams.tolerance=3,identifyParams.returnGeometry=!0,identifyParams.layerIds=visLayers,identifyParams.width=r.width,identifyParams.height=r.height,identifyParams.geometry=i.mapPoint,identifyParams.mapExtent=r.extent,a.execute(identifyParams,function(e){var a=e[0];a&&(content=void 0===t.byId("close-icon")?"<div id='closePopup' class='close-icon'></div><table id='infoWindowTable'>":"<table id='infoWindowTable'>",25==a.layerId?(content+="<tr class='infoName'><td colspan='2'>"+a.feature.attributes.NAME+"</td></tr>",content+="<tr><td>Local Name</td><td>"+a.feature.attributes.ORIG_NAME+"</td></tr>",content+="<tr><td>Legal Designation</td><td>"+a.feature.attributes.DESIG_ENG+"</td></tr>",content+="<tr><td>WDPA ID</td><td>"+a.feature.attributes.WDPAID+"</td></tr>"):27==a.layerId?(content+="<tr class='infoName'><td colspan='2'>"+a.feature.attributes.NAME+"</td></tr>",content+="<tr><td>Concession Type</td><td>"+a.feature.attributes.TYPE+"</td></tr>",content+="<tr><td>Country</td><td>"+a.feature.attributes.Country+"</td></tr>",content+="<tr><td>Certification Status</td><td>"+a.feature.attributes.CERT_STAT+"</td></tr>",content+="<tr><td>GIS Calculated Area (ha)</td><td>"+a.feature.attributes.AREA_HA+"</td></tr>",content+="<tr><td>Certificate ID</td><td>"+a.feature.attributes.Certificat+"</td></tr>",content+="<tr><td>Certificate Issue Date</td><td>"+a.feature.attributes.Issued+"</td></tr>",content+="<tr><td>Certificate Expiry Date</td><td>"+a.feature.attributes.Expired+"</td></tr>",content+="<tr><td>Mill name</td><td>"+a.feature.attributes.Mill+"</td></tr>",content+="<tr><td>Mill location</td><td>"+a.feature.attributes.Location+"</td></tr>",content+="<tr><td>Mill capacity (t/hour)</td><td>"+a.feature.attributes.Capacity+"</td></tr>",content+="<tr><td>Certified CPO (mt)</td><td>"+a.feature.attributes.CPO+"</td></tr>",content+="<tr><td>Certified PK (mt)</td><td>"+a.feature.attributes.PK+"</td></tr>",content+="<tr><td>Estate Suppliers</td><td>"+a.feature.attributes.Estate+"</td></tr>",content+="<tr><td>Estate Area (ha)</td><td>"+a.feature.attributes.Estate_1+"</td></tr>",content+="<tr><td>Outgrower Area (ha)</td><td>"+a.feature.attributes.Outgrowe+"</td></tr>",content+="<tr><td>Scheme Smallholder Area (ha)</td><td>"+a.feature.attributes.SH+"</td></tr>"):(content+="<tr class='infoName'><td colspan='2'>"+a.feature.attributes.NAME+"</td></tr>",content+="<tr><td>Concession Type</td><td>"+a.feature.attributes.TYPE+"</td></tr>",content+="<tr><td>Country</td><td>"+a.feature.attributes.Country+"</td></tr>",content+="<tr><td>Certification Status</td><td>"+a.feature.attributes.CERT_STAT+"</td></tr>",content+="<tr><td>GIS Calculated Area (ha)</td><td>"+a.feature.attributes.AREA_HA+"</td></tr>"),content+="<tr><td>Source: </td><td>"+(a.feature.attributes.Source||"N/A")+"</td></tr>",content+="</table>",r.infoWindow.setContent(content),r.infoWindow.show(i.mapPoint))},function(t){console.dir(t)})}},getTomnodInfoWindow:function(t){var e=l.tomnodLayer,i=(e.url,t),r="";return i?(executeReturned=!1,r+=" <div><h3>"+i.attributes.name+"</h3></div>",r+="<tr><td><img src='"+e.chipBucket+i.attributes.ChipLink,r+="' style='width:300px' /></tc></tr>",r+="<div><strong>Confirmation:</strong> "+i.attributes.Confirmation+" people</div>",r+="<div><b>Crowd Rank:</b> "+i.attributes.CrowdRank+"%</div>",r+="<a href='"+i.attributes.ImageLink,r+="' target='_blank'>See this point on ",r+="<img style='height:20px;width:100px;' src='app/images/tomnod_logo.png'></div>"):void 0},selectTomnodFeatures:function(i){var a=l.tomnodLayer,n=this,s=a.url,d=new y(s),u=new b,c=(new g(s),new p),f=i.mapPoint,m=(r(".selected-fire-option")[0],new Date,new Date,[]);if(!v.getLayer(a.id).visible){n.getActiveFiresInfoWindow(i),n.getArchiveFiresInfoWindow(i);var w=t.byId("noaa-fires-18"),h=t.byId("indonesia-fires"),I=t.byId("fires-checkbox");return"true"==w.getAttribute("aria-checked")&&"true"==h.getAttribute("aria-checked")||"true"==w.getAttribute("aria-checked")&&"true"==I.getAttribute("aria-checked")?setTimeout(function(){v.infoWindow.isShowing||n.getArchiveNoaaInfoWindow(i)},800):n.getArchiveNoaaInfoWindow(i),setTimeout(function(){v.infoWindow.isShowing||n.getDigitalGlobeInfoWindow(i)},400),void 0}u.geometry=f,u.tolerance=3,u.returnGeometry=!1,u.layerDefinitions=m,u.mapExtent=v.extent,u.layerIds=[8],c.where="OBJECTID in (",c.returnGeometry=!1,c.outFields=["OBJECTID","ChipLink","CrowdRank","Confirmation","name","ImageLink"];var L=[];d.execute(u,function(t){return e.forEach(t,function(t){L.push(t.feature.attributes.OBJECTID)}),L.length<1?(v.infoWindow.setFeatures(void 0),n.getActiveFiresInfoWindow(i),n.getDigitalGlobeInfoWindow(i),n.getArchiveFiresInfoWindow(i),n.getArchiveNoaaInfoWindow(i),void 0):(v.infoWindow.resize(340,500),c.where+=L.join(",")+")",selected_features=v.getLayer(l.tomnodLayer.sel_id).selectFeatures(c,o.SELECTION_NEW),selected_features.then(function(t){v.infoWindow.setFeatures(t),v.infoWindow.resize(340,500),v.infoWindow.show(i.mapPoint)}),void 0)},function(){n.mapClick(i)})},getActiveFiresInfoWindow:function(t){var i=l.firesLayer,a=this,n=i.url,o=new y(n),s=new b,d=t.mapPoint,u=!0,c=r(".selected-fire-option")[0],f=new Date,m=new Date,p="",g="",w=[];if(!v.getLayer(i.id).visible)return a.mapClick(t),void 0;switch(c.id){case"fires72":f.setDate(f.getDate()-4),m.setDate(m.getDate()-3);break;case"fires48":f.setDate(f.getDate()-3),m.setDate(m.getDate()-2);break;case"fires24":f.setDate(f.getDate()-2),m.setDate(m.getDate()-1);break;default:f.setDate(f.getDate()-8),m.setDate(m.getDate()-7)}g=f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate()+" "+f.getHours()+":"+f.getMinutes()+":"+f.getSeconds(),p=m.getFullYear()+"-"+(m.getMonth()+1)+"-"+m.getDate()+" "+m.getHours()+":"+m.getMinutes()+":"+m.getSeconds();for(var h=0,I=l.firesLayer.defaultLayers.length;I>h;h++)w[h]="ACQ_DATE > date '"+g+"'";s.geometry=d,s.tolerance=3,s.returnGeometry=!1,s.layerDefinitions=w,s.mapExtent=v.extent,s.layerOption=b.LAYER_OPTION_VISIBLE;var L="</div><table id='infoWindowTable'>";o.execute(s,function(r){var n=v,o=r[0];o?(u=!1,L+="<tr class='infoName'><td colspan='3'>Active Fires</td><td colspan='2'></td></tr>",e.forEach(i.query.fields,function(t){L+="<tr><td colspan='3'>"+t.label+"</td>",L+="<td colspan='2'>"+o.feature.attributes[t.name]+"</td></tr>"}),L+="</table>",n.infoWindow.setContent(L),n.infoWindow.resize(270,140),n.infoWindow.show(d)):a.mapClick(t)},function(){a.mapClick(t)})},getArchiveFiresInfoWindow:function(i){var r=l.indonesiaLayers,a=this,n=r.url,o=new y(n),s=new b,d=i.mapPoint,u=!0,c=(new Date,new Date,t.byId("indonesia-fires"));if(!v.getLayer(r.id).visible||1!=c.checked)return a.mapClick(i),void 0;s.layerDefinitions=v.getLayer(r.id).layerDefinitions,s.geometry=d,s.tolerance=3,s.returnGeometry=!1,s.mapExtent=v.extent,s.layerOption=b.LAYER_OPTION_ALL,s.layerIds=[0];var f=(v.getLayer(r.id),"</div><table id='infoWindowTable'>");o.execute(s,function(t){var n=v,o=t[0];if(o){if(2==o.layerId)return;u=!1,f+="<tr class='infoName'><strong>NASA archived fires for Indonesia</strong></tr>",e.forEach(r.query.fields,function(t){f+="<tr><td colspan='3'>"+t.label+"</td>",f+="<td colspan='2'>"+o.feature.attributes[t.name]+"</td></tr>"}),f+="</table>",n.infoWindow.setContent(f),n.infoWindow.resize(270,140),n.infoWindow.show(d)}else a.mapClick(i)},function(){a.mapClick(i)})},getArchiveNoaaInfoWindow:function(e){var i=l.indonesiaLayers,r=this,a=i.url,n=new y(a),o=new b,s=e.mapPoint,d=!0,u=(new Date,new Date,t.byId("noaa-fires-18"));if("false"!=u.getAttribute("aria-checked")){if(!v.getLayer("IndonesiaFires").visible)return r.mapClick(e),void 0;o.geometry=s,o.tolerance=3,o.returnGeometry=!1,o.mapExtent=v.extent,o.layerOption=b.LAYER_OPTION_ALL,o.layerIds=[9];{v.getLayer(i.id)}n.execute(o,function(t){var i=v,a=t[0];if(a){if(2==a.layerId)return;d=!1;var n=a.feature.attributes.Date,o=n.split(" "),o=o[0],u="</div><table id='infoWindowTable'>";u+="<tr class='infoName'><strong>NOAA-18 fires</strong></tr>",u+="<tr><td colspan='3'>DATE</td>",u+="<td colspan='2'>"+o+"</td></tr>",u+="</table>",i.infoWindow.setContent(u),i.infoWindow.resize(170,50),i.infoWindow.show(s)}else r.mapClick(e)},function(){r.mapClick(e)})}},getNOAAFiresInfoWindow:function(t){{var i=l.indonesiaLayers,r=this,a=i.url,n=new y(a),o=new b,s=t.mapPoint,d=!0;new Date,new Date}if(!v.getLayer(i.id).visible)return r.mapClick(t),void 0;o.geometry=s,o.tolerance=10,o.returnGeometry=!1,o.mapExtent=v.extent,o.layerOption=b.LAYER_OPTION_ALL;var u="</div><table id='infoWindowTable'>";n.execute(o,function(a){var n=v,o=a[0];o?(d=!1,u+="<tr class='infoName'><strong>NASA archived fires for Indonesia</strong></tr>",e.forEach(i.query.fields,function(t){u+="<tr><td colspan='3'>"+t.label+"</td>",u+="<td colspan='2'>"+o.feature.attributes[t.name]+"</td></tr>"}),u+="</table>",n.infoWindow.setContent(u),n.infoWindow.show(s)):(console.log("No result returned!"),r.mapClick(t))},function(){r.mapClick(t)})},getDigitalGlobeInfoWindow:function(o){var s=(l.digitalGlobe,v.getLayer(l.digitalGlobe.graphicsLayerId),new p);if((!o.graphic||"Digital_Globe"===o.graphic.attributes.Layer)&&void 0!=o.graphic){s.geometry=o.graphic.geometry,s.where="Category = 1",s.returnGeometry=!1,s.outFields=["*"];var u,c=(n(l.digitalGlobe.mosaics.map(function(t){var e=new a;s.geometry=o.graphic.geometry,s.returnGeometry=!1,s.outFields=["*"];var i=new g(l.digitalGlobe.imagedir+t+"/ImageServer");return i.execute(s,function(t){e.resolve(t.features)},function(){e.resolve([])}),e.promise})).then(function(a){var n="",o=[],s=dijit.byId("timeSliderDG").thumbIndexes,c=dijit.byId("timeSliderDG").timeStops,l=moment(c[s[0]]).tz("Asia/Jakarta"),f=moment(c[s[1]]).tz("Asia/Jakarta");a.map(function(t){t.map(function(t){o.push(t)})}),o.sort(function(t,e){return t.attributes.AcquisitionDate==e.attributes.AcquisitionDate?0:t.attributes.AcquisitionDate>e.attributes.AcquisitionDate?-1:1}),n+="<p>Click a date below to see the imagery.</p><ul class='popup-list'><li><strong>Date <span class='satelliteColumn'>Satellite</span></strong></li>",e.forEach(o,function(t){var e=moment(t.attributes.AcquisitionDate).tz("Asia/Jakarta");e>=l&&f>=e&&(n+="<li><a class='popup-link' data-bucket='"+t.attributes.SensorName+"_id_"+t.attributes.OBJECTID+"'> "+e.format("YYYY/MM/DD")+"  <span class='satelliteColumn' data-bucket='"+t.attributes.SensorName+"_id_"+t.attributes.OBJECTID+"'>"+t.attributes.SensorName+"</span></a></li>")}),n+="</ul><a class='custom-zoom-to' id='custom-zoom-to'>Zoom To</a>",v.infoWindow.setContent(n),v.infoWindow.resize(270,500),v.infoWindow.show(w),u=0,r(".contentPane .popup-link").forEach(function(t,e){h.push(i(t,"click",function(t){var i=t.target?t.target:t.srcElement,r=i.dataset?i.dataset.bucket:i.getAttribute("data-bucket");$("#imageryWindow > table > tbody > tr").each(function(){$(this).removeClass("imageryRowSelected");var t=this.firstElementChild;t=$(t).html(),t=$(t).attr("data-bucket"),r==t&&$(this).addClass("imageryRowSelected")});var a=r.split("_"),n={};n.feature={},n.feature.attributes={},n.feature.attributes.SensorName=a[0],n.feature.attributes.OBJECTID=a[2],m.showDigitalGlobeImagery(n),u=e}))}),h.push(i(t.byId("custom-zoom-to"),"click",function(){var t=new d(o[u].attributes.CenterX,o[u].attributes.CenterY,v.spatialReference);v.centerAndZoom(t,12)})),i.once(v.infoWindow,"hide",function(){e.forEach(h,function(t){t.remove()})})}),l.digitalGlobe.identifyUrl),f=(new y(c),new b),w=o.mapPoint,h=[];f.geometry=w,f.tolerance=3,f.returnGeometry=!0,f.mapExtent=v.extent,f.layerOption=b.LAYER_OPTION_VISIBLE,f.layerIds=[0]}},getFireTweetsInfoWindow:function(t){v.infoWindow.anchor="ANCHOR_UPPERRIGHT";var e=t.attributes,i="<table><tr><td>";return i+="<td><img src='"+e.UserProfileImage+"'/></td>",i+="<td>"+e.UserName+"</td></tr>",i+="<p>"+e.Text+"</p>",i+="<p>"+e.Date+"</p>"},getFireStoriesInfoWindow:function(t){v.infoWindow.anchor="ANCHOR_UPPERRIGHT";var e=t.attributes,i="<table>";for(var r in e)e[r]&&"OBJECTID"!=r&&(i+="<tr><td>"+r+": "+e[r]+"</td></tr>");return i+="</div>"}}});