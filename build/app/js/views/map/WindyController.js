/*! Global-Forest-Watch-Fires Thu Dec 11 2014 14:55:24 */
define(["dojo/on","dojo/dom","dojo/cookie","dojo/Deferred","dijit/Dialog","dijit/form/CheckBox","dijit/registry","esri/request","utils/Helper","utils/RasterLayer","views/map/MapModel","modules/ErrorController","views/map/LayerController","libs/windy"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n,o,p,q,r,s,t={dataUrl:"http://suitability-mapper.s3.amazonaws.com/wind/wind-surface-level-gfs-1.0.gz.json",id:"Wind_Direction",opacity:.85,mapLoaderId:"map_loader",mapLoaderContainer:"map-container"};return{setMap:function(a){n=a},toggleWindLayer:function(a){void 0===o&&(o=this.supportsCanvas(),o===!1&&(g.byId("windy-layer-checkbox").set("checked",!1),g.byId("windy-layer-checkbox").set("disabled",!0),l.show(10,"This browser does not support this feature. Visit <a target='_blank' href='http://www.caniuse.com/#search=canvas'>caniuse.com</a> for supported browsers."))),a?(this.activateWindLayer(),m.updateLayersInHash("add",t.id,t.id)):(this.deactivateWindLayer(),m.updateLayersInHash("remove",t.id,t.id))},activateWindLayer:function(a){function b(){q=new j(null,{opacity:t.opacity,id:t.id}),n.addLayer(q),p=[],p.push(n.on("extent-change",c.redraw)),p.push(n.on("zoom-start",c.redraw)),p.push(n.on("pan-start",c.redraw)),r=new Windy({canvas:q._element,data:s}),c.redraw(),c.toggleLegend(!0)}var c=this;return a?void this.promptAboutBasemap().then(function(){c.fetchDataForWindLayer(a).then(b)}):void(s?(console.log("just promptinggg then creating"),this.promptAboutBasemap().then(b)):(console.log("fetching data then creating"),this.promptAboutBasemap().then(function(){c.fetchDataForWindLayer().then(b)})))},promptAboutBasemap:function(){g.byId("windLayerBasemapDialog")&&g.byId("windLayerBasemapDialog").destroy();var h,i,j,k,l,m,n,o,p=new e({title:"Would you like to change basemaps?",style:"width: 350px",id:"windLayerBasemapDialog",content:"This layer is best visualized with the Dark Gray Canvas basemap.  Would you like to switch to it now.<div class='dijitDialogPaneActionBar'><button id='acceptBasemapChange'>Yes</button><button id='denyBasemapChange'>No</button></div><div class='dialogCheckbox'><input type='checkbox' id='rememberBasemapDecision' /><label for='rememberBasemapDecision'>Remember my decision</label></div>"}),q=new d;k=function(a){b.byId("rememberBasemapDecision")&&b.byId("rememberBasemapDecision").checked&&a&&c("windBasemapDecision",a,{expires:7})},i=function(a){o&&o.destroy(),l&&l.remove(),m&&m.remove(),a&&p.destroy()},n=function(a){a&&k("dontChange"),i(a),q.resolve()},h=function(){k("changeBasemap"),i(!0),q.resolve();var a=g.byId("basemap-gallery").getSelected();a?"darkgray"!==a.id&&g.byId("basemap-gallery").select("darkgray"):g.byId("basemap-gallery").select("darkgray")},j=c("windBasemapDecision");var r;return r=g.byId("basemap-gallery").getSelected()?g.byId("basemap-gallery").getSelected().id:"topo",void 0===j&&"darkgray"!==r?(p.show(),o=new f({checked:!1},"rememberBasemapDecision"),l=a(b.byId("acceptBasemapChange"),"click",h),m=a(b.byId("denyBasemapChange"),"click",function(){n(!0)}),p.on("cancel",function(){n(!1)})):"changeBasemap"===j?h():n(!1),q.promise},deactivateWindLayer:function(){var a=n.getLayer(t.id);if(a){n.removeLayer(a),q=void 0,r=void 0;for(var b=p.length-1;b>=0;b--)p[b].remove()}this.toggleLegend(!1)},fetchDataForWindLayer:function(a){i.showLoader(t.mapLoaderContainer,t.mapLoaderId),a&&(t.dataUrl=a),console.log(t.dataUrl);var b=new d,c=new h({url:t.dataUrl,content:{},handleAs:"json"});return c.then(function(a){s=a,b.resolve(!0),i.hideLoader(t.mapLoaderId)},function(a){console.error(a),b.resolve(!1),i.hideLoader(t.mapLoaderId)}),b.promise},redraw:function(){if(q){q._element.height=n.height,q._element.width=n.width,r.stop();var a=n.geographicExtent;setTimeout(function(){r.start([[0,0],[n.width,n.height]],n.width,n.height,[[a.xmin,a.ymin],[a.xmax,a.ymax]])},500)}},toggleLegend:function(a){a?k.set("showWindLegend",!0):k.set("showWindLegend",!1)},supportsCanvas:function(){return!!document.createElement("canvas").getContext}}});