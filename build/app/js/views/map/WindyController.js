define(["dojo/on","dojo/dom","dojo/cookie","dojo/Deferred","dijit/Dialog","dijit/form/CheckBox","dijit/registry","esri/request","utils/Helper","utils/RasterLayer","views/map/MapModel","modules/ErrorController","views/map/LayerController","libs/windy"],function(e,a,t,o,n,i,r,d,s,c,l,p,m){var h,u,y,g,b,w,v={dataUrl:"http://suitability-mapper.s3.amazonaws.com/wind/wind-surface-level-gfs-1.0.gz.json",id:"Wind_Direction",opacity:.85,mapLoaderId:"map_loader",mapLoaderContainer:"map-container"};return{setMap:function(e){h=e},toggleWindLayer:function(e){void 0===u&&(u=this.supportsCanvas(),u===!1&&(r.byId("windy-layer-checkbox").set("checked",!1),r.byId("windy-layer-checkbox").set("disabled",!0),p.show(10,"This browser does not support this feature. Visit <a target='_blank' href='http://www.caniuse.com/#search=canvas'>caniuse.com</a> for supported browsers."))),e?(this.activateWindLayer(),m.updateLayersInHash("add",v.id,v.id)):(this.deactivateWindLayer(),m.updateLayersInHash("remove",v.id,v.id))},activateWindLayer:function(e){function a(){g=new c(null,{opacity:v.opacity,id:v.id}),h.addLayer(g),y=[],y.push(h.on("extent-change",t.redraw)),y.push(h.on("zoom-start",t.redraw)),y.push(h.on("pan-start",t.redraw)),b=new Windy({canvas:g._element,data:w}),t.redraw(),t.toggleLegend(!0)}var t=this;return e?void this.promptAboutBasemap().then(function(){t.fetchDataForWindLayer(e).then(a)}):void(w?(console.log("just promptinggg then creating"),this.promptAboutBasemap().then(a)):(console.log("fetching data then creating"),this.promptAboutBasemap().then(function(){t.fetchDataForWindLayer().then(a)})))},promptAboutBasemap:function(){r.byId("windLayerBasemapDialog")&&r.byId("windLayerBasemapDialog").destroy();var d,s,c,l,p,m,h,u,y=new n({title:"Would you like to change basemaps?",style:"width: 350px",id:"windLayerBasemapDialog",content:"This layer is best visualized with the Dark Gray Canvas basemap.  Would you like to switch to it now.<div class='dijitDialogPaneActionBar'><button id='acceptBasemapChange'>Yes</button><button id='denyBasemapChange'>No</button></div><div class='dialogCheckbox'><input type='checkbox' id='rememberBasemapDecision' /><label for='rememberBasemapDecision'>Remember my decision</label></div>"}),g=new o;l=function(e){a.byId("rememberBasemapDecision")&&a.byId("rememberBasemapDecision").checked&&e&&t("windBasemapDecision",e,{expires:7})},s=function(e){u&&u.destroy(),p&&p.remove(),m&&m.remove(),e&&y.destroy()},h=function(e){e&&l("dontChange"),s(e),g.resolve()},d=function(){l("changeBasemap"),s(!0),g.resolve();var e=r.byId("basemap-gallery").getSelected();e?"galleryNode_basemap_6"!==e.id&&r.byId("basemap-gallery").select("basemap_6"):r.byId("basemap-gallery").select("basemap_6")},c=t("windBasemapDecision");var b;return b=r.byId("basemap-gallery").getSelected()?r.byId("basemap-gallery").getSelected().id:"topo",void 0===c&&"basemap_6"!==b?(y.show(),u=new i({checked:!1},"rememberBasemapDecision"),p=e(a.byId("acceptBasemapChange"),"click",d),m=e(a.byId("denyBasemapChange"),"click",function(){h(!0)}),y.on("cancel",function(){h(!1)})):"changeBasemap"===c?d():h(!1),g.promise},deactivateWindLayer:function(){var e=h.getLayer(v.id);if(e){h.removeLayer(e),g=void 0,b=void 0;for(var a=y.length-1;a>=0;a--)y[a].remove()}this.toggleLegend(!1)},fetchDataForWindLayer:function(e){s.showLoader(v.mapLoaderContainer,v.mapLoaderId),e&&(v.dataUrl=e),console.log(v.dataUrl);var a=new o,t=new d({url:v.dataUrl,content:{},handleAs:"json"});return t.then(function(e){w=e,a.resolve(!0),s.hideLoader(v.mapLoaderId)},function(e){console.error(e),a.resolve(!1),s.hideLoader(v.mapLoaderId)}),a.promise},redraw:function(){if(g){g._element.height=h.height,g._element.width=h.width,b.stop();var e=h.geographicExtent;setTimeout(function(){b.start([[0,0],[h.width,h.height]],h.width,h.height,[[e.xmin,e.ymin],[e.xmax,e.ymax]])},500)}},toggleLegend:function(e){e?l.set("showWindLegend",!0):l.set("showWindLegend",!1)},supportsCanvas:function(){return!!document.createElement("canvas").getContext}}});