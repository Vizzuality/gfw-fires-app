define(["dojo/Deferred","dijit/registry","esri/request","utils/Helper","utils/RasterLayer","views/map/MapModel","modules/ErrorController","libs/windy"],function(e,t,a,n,r,i,o){var d,s,c,h,u,l,p={dataUrl:"http://suitability-mapper.s3.amazonaws.com/wind/wind-surface-level-gfs-1.0.json.gz",id:"Wind_Direction",opacity:.85,mapLoaderId:"map_loader",mapLoaderContainer:"map-container"};return{setMap:function(e){d=e},toggleWindLayer:function(e){void 0===s&&(s=this.supportsCanvas(),s===!1&&(t.byId("windy-layer-checkbox").set("checked",!1),t.byId("windy-layer-checkbox").set("disabled",!0),o.show(10,"This browser does not support this feature. Visit <a target='_blank' href='http://www.caniuse.com/#search=canvas'>caniuse.com</a> for supported browsers."))),e?this.activateWindLayer():this.deactivateWindLayer()},activateWindLayer:function(){function e(){h=new r(null,{opacity:p.opacity,id:p.id}),d.addLayer(h),c=[],c.push(d.on("extent-change",t.redraw)),c.push(d.on("zoom-start",t.redraw)),c.push(d.on("pan-start",t.redraw)),u=new Windy({canvas:h._element,data:l}),t.redraw(),t.toggleLegend(!0)}var t=this;l?e():this.fetchDataForWindLayer().then(e)},deactivateWindLayer:function(){var e=d.getLayer(p.id);if(e){d.removeLayer(e),h=void 0,u=void 0;for(var t=c.length-1;t>=0;t--)c[t].remove()}this.toggleLegend(!1)},fetchDataForWindLayer:function(){n.showLoader(p.mapLoaderContainer,p.mapLoaderId);var t=new e,r=new a({url:p.dataUrl,content:{},handleAs:"json"});return r.then(function(e){l=e,t.resolve(!0),n.hideLoader(p.mapLoaderId)},function(e){console.error(e),t.resolve(!1),n.hideLoader(p.mapLoaderId)}),t.promise},redraw:function(){if(h){h._element.height=d.height,h._element.width=d.width,u.stop();var e=d.geographicExtent;setTimeout(function(){u.start([[0,0],[d.width,d.height]],d.width,d.height,[[e.xmin,e.ymin],[e.xmax,e.ymax]])},500)}},toggleLegend:function(e){e?i.set("showWindLegend",!0):i.set("showWindLegend",!1)},supportsCanvas:function(){return!!document.createElement("canvas").getContext}}});