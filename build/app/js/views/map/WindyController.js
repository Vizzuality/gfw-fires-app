/*! Global-Forest-Watch-Fires Tue Jul 22 2014 14:53:11 */
define(["dojo/Deferred","dijit/registry","esri/request","utils/Helper","utils/RasterLayer","views/map/MapModel","modules/ErrorController","views/map/LayerController","libs/windy"],function(a,b,c,d,e,f,g,h){var i,j,k,l,m,n,o={dataUrl:"http://suitability-mapper.s3.amazonaws.com/wind/wind-surface-level-gfs-1.0.json.gz",id:"Wind_Direction",opacity:.85,mapLoaderId:"map_loader",mapLoaderContainer:"map-container"};return{setMap:function(a){i=a},toggleWindLayer:function(a){void 0===j&&(j=this.supportsCanvas(),j===!1&&(b.byId("windy-layer-checkbox").set("checked",!1),b.byId("windy-layer-checkbox").set("disabled",!0),g.show(10,"This browser does not support this feature. Visit <a target='_blank' href='http://www.caniuse.com/#search=canvas'>caniuse.com</a> for supported browsers."))),a?(this.activateWindLayer(),h.updateLayersInHash("add",o.id,o.id)):(this.deactivateWindLayer(),h.updateLayersInHash("remove",o.id,o.id))},activateWindLayer:function(){function a(){l=new e(null,{opacity:o.opacity,id:o.id}),i.addLayer(l),k=[],k.push(i.on("extent-change",b.redraw)),k.push(i.on("zoom-start",b.redraw)),k.push(i.on("pan-start",b.redraw)),m=new Windy({canvas:l._element,data:n}),b.redraw(),b.toggleLegend(!0)}var b=this;n?a():this.fetchDataForWindLayer().then(a)},deactivateWindLayer:function(){var a=i.getLayer(o.id);if(a){i.removeLayer(a),l=void 0,m=void 0;for(var b=k.length-1;b>=0;b--)k[b].remove()}this.toggleLegend(!1)},fetchDataForWindLayer:function(){d.showLoader(o.mapLoaderContainer,o.mapLoaderId);var b=new a,e=new c({url:o.dataUrl,content:{},handleAs:"json"});return e.then(function(a){n=a,b.resolve(!0),d.hideLoader(o.mapLoaderId)},function(a){console.error(a),b.resolve(!1),d.hideLoader(o.mapLoaderId)}),b.promise},redraw:function(){if(l){l._element.height=i.height,l._element.width=i.width,m.stop();var a=i.geographicExtent;setTimeout(function(){m.start([[0,0],[i.width,i.height]],i.width,i.height,[[a.xmin,a.ymin],[a.xmax,a.ymax]])},500)}},toggleLegend:function(a){a?f.set("showWindLegend",!0):f.set("showWindLegend",!1)},supportsCanvas:function(){return!!document.createElement("canvas").getContext}}});