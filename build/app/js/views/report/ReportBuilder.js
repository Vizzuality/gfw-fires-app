define(["dojo/dom","dojo/ready","dojo/Deferred","dojo/dom-style","dojo/dom-class","dijit/registry","dojo/promise/all","dojo/_base/array","esri/map","esri/Color","esri/config","esri/layers/ImageParameters","esri/layers/ArcGISDynamicMapServiceLayer","esri/symbols/SimpleFillSymbol","esri/tasks/AlgorithmicColorRamp","esri/tasks/ClassBreaksDefinition","esri/tasks/GenerateRendererParameters","esri/layers/LayerDrawingOptions","esri/tasks/GenerateRendererTask","esri/tasks/query","esri/tasks/QueryTask","views/map/MapConfig","libs/highcharts"],function(e,r,t,i,n,a,o,s,l,c,u,d,f,y,m,b,p,h,g,w,v,F){var M={zoom:5,basemap:"gray",slider:!1,mapcenter:[100,-1.2],adminBoundary:{url:"http://gis-potico.wri.org/arcgis/rest/services/Fires/FIRMS_ASEAN/MapServer",id:"district-bounds",defaultLayers:[2],layerId:2,where:"fire_count > 0",classBreaksField:"fire_count",classBreaksMethod:"natural-breaks",breakCount:5,fromHex:"#fcddd1",toHex:"#930016"},queryUrl:"http://gis-potico.wri.org/arcgis/rest/services/Fires/FIRMS_ASEAN/MapServer",companyConcessionsId:1,confidenceFireId:0};return{init:function(){var e=this;u.defaults.io.proxyUrl=document.location.href.search("staging")>0?F.stagingProxyUrl:F.proxyUrl,Highcharts.setOptions({chart:{style:{fontFamily:"Arial MT Condensed Light"}}}),r(function(){o([e.buildFiresMap(),e.buildDistrictFiresMap(),e.queryDistrictsForFires(),e.queryCompanyConcessions(),e.queryForPeatFires()]).then(function(){e.showReport()})})},buildFiresMap:function(){var e,r,i,n=new t;return i=new l("simple-fires-map",{basemap:M.basemap,zoom:M.zoom,center:M.mapcenter,slider:M.slider}),e=new d,e.format="png32",e.layerIds=F.firesLayer.defaultLayers,e.layerOption=d.LAYER_OPTION_SHOW,r=new f(F.firesLayer.url,{imageParameters:e,id:F.firesLayer.id,visible:!0}),i.addLayer(r),i.on("load",function(){i.disableMapNavigation()}),r.on("load",function(){n.resolve(!0)}),n.promise},buildDistrictFiresMap:function(){function r(r){var t="<table>";s.forEach(r,function(e){t+="<tr><td class='legend-swatch' style='background-color: rgb("+e.symbol.color.r+","+e.symbol.color.g+","+e.symbol.color.b+");'></td>",t+="<td class='legend-label'>"+e.minValue+" - "+e.maxValue+"</td></tr>"}),t+="</table>",e.byId("legend").innerHTML=t}var i,n,a,o,u,w,v,F,I=new t,L=M.adminBoundary,E=[];return F=new l("district-fires-map",{basemap:M.basemap,zoom:M.zoom,center:M.mapcenter,slider:M.slider}),i=new d,i.format="png32",i.layerIds=L.defaultLayers,i.layerOption=d.LAYER_OPTION_SHOW,n=new f(L.url,{imageParameters:i,id:L.id,visible:!0}),u=new b,u.classificationField=L.classBreaksField,u.classificationMethod=L.classBreaksMethod,u.breakCount=L.breakCount,u.baseSymbol=new y,o=new m,o.fromColor=c.fromHex(L.fromHex),o.toColor=c.fromHex(L.toHex),o.algorithm="cie-lab",u.colorRamp=o,a=new p,a.classificationDefinition=u,a.where=L.where,w=new g(L.url+"/"+L.layerId),w.execute(a,function(e){r(e.infos),v=new h,v.renderer=e,E[L.layerId]=v,n.setLayerDrawingOptions(E),F.addLayer(n),n.on("update-end",function(){I.resolve(!0)})},function(){I.resolve(!1)}),F.on("load",function(){F.disableMapNavigation()}),I.promise},queryDistrictsForFires:function(){function r(e){var r="<table class='fires-table'><tr><th>DISTRICT</th><th>PROVINCE</th><th>NUMBER OF FIRE ALERTS</th></tr>";return r+=s.generateTableRows(e,n),r+="</table>"}var i=new v(M.adminBoundary.url+"/"+M.adminBoundary.layerId),n=["NAME_2","NAME_1","fire_count"],a=new t,o=new w,s=this;return o.where="1 = 1",o.returnGeometry=!1,o.outFields=n,o.orderByFields=["fire_count DESC"],i.execute(o,function(t){t.features.length>0&&(e.byId("district-fires-table").innerHTML=r(t.features.slice(0,10)),a.resolve(!0))},function(){a.resolve(!1)}),a.promise},queryCompanyConcessions:function(){function r(r,t,i){var n="<table class='fires-table'><tr><th>NAME</th><th>GROUP, AFFILIATE, OR MAIN BUYER</th><th>NUMBER OF FIRE ALERTS</th></tr>",o=n+f.generateTableRows(r,a.slice(0,3))+"</table>",s=n+f.generateTableRows(t,a.slice(0,3))+"</table>",l=n+f.generateTableRows(i,a.slice(0,3))+"</table>";e.byId("pulpwood-fires-table").innerHTML=o,e.byId("palmoil-fires-table").innerHTML=s,e.byId("logging-fires-table").innerHTML=l}var i,n=new v(M.queryUrl+"/"+M.companyConcessionsId),a=["Name","GROUP_NAME","fire_count","TYPE"],o=new t,l=new w,c=[],u=[],d=[],f=this;return l.where="fire_count IS NOT NULL",l.returnGeometry=!1,l.outFields=a,l.orderByFields=["fire_count DESC"],n.execute(l,function(e){s.every(e.features,function(e){return i=e.attributes.TYPE,"Oil palm concession"===i&&d.length<10?d.push(e):"Wood fiber plantation"===i&&c.length<10?c.push(e):"Logging concession"===i&&u.length<10&&u.push(e),!(d.length>9&&c.length>9&&u.length>9)}),d=s.filter(d,function(e){return 0!==e.attributes.fire_count}),c=s.filter(c,function(e){return 0!==e.attributes.fire_count}),u=s.filter(u,function(e){return 0!==e.attributes.fire_count}),r(c,d,u),o.resolve(!0)},function(){o.resolve(!1)}),o.promise},queryForPeatFires:function(){function e(e,r,t){var i=[];i.push({color:"rgba(184,0,18,1)",name:"Peat",visible:!0,y:r}),i.push({color:"rgba(17,139,187,1)",name:"Non-peat",visible:!0,y:t}),$("#peat-fires-chart").highcharts({chart:{type:"pie"},title:{text:null},yAxis:{title:{text:null}},plotOptions:{pie:{shadow:!1,center:["50%","50%"],showInLegend:!0,dataLabels:{fontSize:"22px"}}},tooltip:{formatter:function(){return Math.round(this.y/e*100)+"% ("+this.y+" fires)"}},credits:{enabled:!1},legend:{enabled:!0,align:"right",layout:"vertical",verticalAlign:"middle"},series:[{name:"Peat Fires",data:i,size:"80%",innerSize:"50%",dataLabels:{distance:-30,color:"black",formatter:function(){return Math.round(this.y/e*100)+"%"}}}]})}var r,i,n,a,o=new v(M.queryUrl+"/"+M.confidenceFireId),l=new t,c=new w,u=new Date;return r=u.getFullYear()+"-"+(u.getMonth()+1)+"-"+(u.getDate()-7)+" "+u.getHours()+":"+u.getMinutes()+":"+u.getSeconds(),c.where="ACQ_DATE > date '"+r+"'",c.returnGeometry=!1,c.outFields=["peat"],o.execute(c,function(r){n=r.features.length,i=0,a=0,s.forEach(r.features,function(e){1===e.attributes.peat?a++:i++}),e(n,a,i),l.resolve(!0)},function(){l.resolve(!1)}),l.promise},generateTableRows:function(e,r){function t(e){return null!==e&&void 0!==e}var i="";return s.forEach(e,function(e){i+="<tr>",s.forEach(r,function(r){i+="<td>"+(t(e.attributes[r])?e.attributes[r]:" - ")+"</td>"}),i+="</tr>"}),i},showReport:function(){i.set("loading-screen","display","none"),document.getElementsByTagName("body")[0].style.overflow="auto"}}});