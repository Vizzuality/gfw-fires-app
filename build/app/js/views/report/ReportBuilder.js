define(["dojo/dom","dojo/ready","dojo/Deferred","dojo/dom-style","dojo/dom-class","dijit/registry","dojo/promise/all","dojo/_base/array","esri/map","esri/Color","esri/config","esri/layers/ImageParameters","esri/layers/ArcGISDynamicMapServiceLayer","esri/symbols/SimpleFillSymbol","esri/tasks/AlgorithmicColorRamp","esri/tasks/ClassBreaksDefinition","esri/tasks/GenerateRendererParameters","esri/layers/LayerDrawingOptions","esri/tasks/GenerateRendererTask","esri/tasks/query","esri/tasks/QueryTask","views/map/MapConfig","esri/request","libs/highcharts"],function(e,t,r,i,a,n,o,s,l,u,c,d,f,h,b,m,p,y,g,w,F,v,D){var C={zoom:5,basemap:"gray",slider:!1,mapcenter:[100,-1.2],adminBoundary:{url:"http://gis-potico.wri.org/arcgis/rest/services/Fires/FIRMS_ASEAN/MapServer",id:"district-bounds",defaultLayers:[2],layerId:2,where:"fire_count > 0",classBreaksField:"fire_count",classBreaksMethod:"natural-breaks",breakCount:5,fromHex:"#fcddd1",toHex:"#930016"},queryUrl:"http://gis-potico.wri.org/arcgis/rest/services/Fires/FIRMS_ASEAN/MapServer",companyConcessionsId:1,confidenceFireId:0,dailyFiresId:5};return D.setRequestPreCallback(function(e){return console.log(e.url,e.content),e.content&&e.content.dynamicLayers,e}),{init:function(){var e=this,r=v.proxies,i=document.location.href,a="/proxy/proxy.ashx";for(var n in r)0==i.indexOf(n)&&(a=r[n]);c.defaults.io.proxyUrl=a,Highcharts.setOptions({chart:{style:{fontFamily:"Arial MT Condensed Light"}}}),t(function(){o([e.buildFiresMap(),e.buildDistrictFiresMap(),e.queryDistrictsForFires(),e.queryCompanyConcessions(),e.queryForPeatFires(),e.queryForSumatraFires(),e.queryForDailyFireData()]).then(function(){e.printReport()})})},buildFiresMap:function(){var e,t,i,a=new r;return i=new l("simple-fires-map",{basemap:C.basemap,zoom:C.zoom,center:C.mapcenter,slider:C.slider}),e=new d,e.format="png32",e.layerIds=v.firesLayer.defaultLayers,e.layerOption=d.LAYER_OPTION_SHOW,t=new f(v.firesLayer.url,{imageParameters:e,id:v.firesLayer.id,visible:!0}),i.addLayer(t),i.on("load",function(){i.disableMapNavigation()}),t.on("load",function(){a.resolve(!0)}),a.promise},buildDistrictFiresMap:function(){function t(t){var r="<table>";s.forEach(t,function(e){r+="<tr><td class='legend-swatch' style='background-color: rgb("+e.symbol.color.r+","+e.symbol.color.g+","+e.symbol.color.b+");'></td>",r+="<td class='legend-label'>"+e.minValue+" - "+e.maxValue+"</td></tr>"}),r+="</table>",e.byId("legend").innerHTML=r}function i(){F=new g(I.url+"/"+I.layerId),F.execute(o,function(e){t(e.infos),v=new y,v.renderer=e,T[I.layerId]=v,n.setLayerDrawingOptions(T),n.on("update-end",function(){M.resolve(!0)})},function(){M.resolve(!1)})}var a,n,o,c,w,F,v,D,M=new r,I=C.adminBoundary,T=[];return D=new l("district-fires-map",{basemap:C.basemap,zoom:C.zoom,center:C.mapcenter,slider:C.slider}),a=new d,a.format="png32",a.layerIds=I.defaultLayers,a.layerOption=d.LAYER_OPTION_SHOW,n=new f(I.url,{imageParameters:a,id:I.id,visible:!0}),w=new m,w.classificationField=I.classBreaksField,w.classificationMethod=I.classBreaksMethod,w.breakCount=I.breakCount,w.baseSymbol=new h,c=new b,c.fromColor=u.fromHex(I.fromHex),c.toColor=u.fromHex(I.toHex),c.algorithm="cie-lab",w.colorRamp=c,o=new p,o.classificationDefinition=w,o.where=I.where,n.on("load",i),D.addLayer(n),D.on("load",function(){D.disableMapNavigation()}),M.promise},queryDistrictsForFires:function(){function t(e){var t="<table class='fires-table'><tr><th>DISTRICT</th><th>PROVINCE</th><th>NUMBER OF FIRE ALERTS</th></tr>";return t+=s.generateTableRows(e,a),t+="</table>"}var i=new F(C.adminBoundary.url+"/"+C.adminBoundary.layerId),a=["NAME_2","NAME_1","fire_count"],n=new r,o=new w,s=this;return o.where="1 = 1",o.returnGeometry=!1,o.outFields=a,o.orderByFields=["fire_count DESC"],i.execute(o,function(r){r.features.length>0&&(e.byId("district-fires-table").innerHTML=t(r.features.slice(0,10)),n.resolve(!0))},function(){n.resolve(!1)}),n.promise},queryCompanyConcessions:function(){function t(t,r,i){var a="<table class='fires-table'><tr><th>NAME</th><th>NUMBER OF FIRE ALERTS</th></tr>",o=a+h.generateTableRows(t,n.slice(0,2))+"</table>",s=a+h.generateTableRows(r,n.slice(0,2))+"</table>",l=a+h.generateTableRows(i,n.slice(0,2))+"</table>",u="There are no fire alerts in pulpwood concessions in the last 7 days.",c="There are no fire alerts in palm oil concessions in the last 7 days.",d="There are no fire alerts in logging concessions in the last 7 days.";e.byId("pulpwood-fires-table").innerHTML=t.length>0?o:'<div class="noFiresTable">'+u+"</div>",e.byId("palmoil-fires-table").innerHTML=r.length>0?s:'<div class="noFiresTable">'+c+"</div>",e.byId("logging-fires-table").innerHTML=i.length>0?l:'<div class="noFiresTable">'+d+"</div>"}var i,a=new F(C.queryUrl+"/"+C.companyConcessionsId),n=["Name","fire_count","TYPE"],o=new r,l=new w,u=new Date,c=[],d=[],f=[],h=this;return u=new Date(u.getFullYear(),u.getMonth(),u.getDate()-7),dateString=u.getFullYear()+"-"+(u.getMonth()+1)+"-"+(u.getDate()-7)+" "+u.getHours()+":"+u.getMinutes()+":"+u.getSeconds(),l.where="fire_count IS NOT NULL",l.returnGeometry=!1,l.outFields=n,l.orderByFields=["fire_count DESC"],a.execute(l,function(e){s.every(e.features,function(e){return i=e.attributes.TYPE,"Oil palm concession"===i&&f.length<10?f.push(e):"Wood fiber plantation"===i&&c.length<10?c.push(e):"Logging concession"===i&&d.length<10&&d.push(e),!(f.length>9&&c.length>9&&d.length>9)}),f=s.filter(f,function(e){return 0!==e.attributes.fire_count}),c=s.filter(c,function(e){return 0!==e.attributes.fire_count}),d=s.filter(d,function(e){return 0!==e.attributes.fire_count}),t(c,f,d),o.resolve(!0)},function(){o.resolve(!1)}),o.promise},queryForPeatFires:function(){var e,t,i,a=new r,n=[],o=this,l=function(r){t=r.features.length,e=0,i=0,s.forEach(r.features,function(t){1===t.attributes.peat?i++:e++}),n.push({color:"rgba(184,0,18,1)",name:"Peat",visible:!0,y:i}),n.push({color:"rgba(17,139,187,1)",name:"Non-peat",visible:!0,y:e}),o.buildPieChart("peat-fires-chart",{data:n,name:"Peat Fires",labelDistance:-25,total:t}),a.resolve(!0)},u=function(){a.resolve(!1)};return o.queryFireData({outFields:["peat"]},l,u),a.promise},queryForSumatraFires:function(){var e,t,i,a,n,o,l,u,c=new r,d=[],f=[],h=this;return o=function(r){u=r.features.length,e=0,t=0,i=0,a=0,n=0,s.forEach(r.features,function(r){1===r.attributes.wdpa?e++:t++,1===r.attributes.logging&&n++,1===r.attributes.palm_oil&&a++,1===r.attributes.pulpwood&&i++}),d.push({color:"rgba(184,0,18,1)",name:"In Protected Areas",visible:!0,y:e}),d.push({color:"rgba(17,139,187,1)",name:"Outside Protected Areas",visible:!0,y:t}),h.buildPieChart("protected-areas-fires-chart",{data:d,name:"Protected Area Fires",labelDistance:-30,total:u}),f.push({color:"rgba(17,139,187,1)",name:"Pulpwood Plantations",visible:!0,y:i}),f.push({color:"rgba(184,0,18,1)",name:"Palm Oil Concessions",visible:!0,y:a}),f.push({color:"rgba(106,0,78,1)",name:"Logging Concessions",visible:!0,y:n}),f.push({color:"rgba(233,153,39,1)",name:"Outside Concessions",visible:!0,y:u-(n+a+i)}),h.buildPieChart("land-use-fires-chart",{data:f,name:"Fires in Concessions",labelDistance:30,total:u}),c.resolve(!0)},l=function(){c.resolve(!1)},h.queryFireData({outFields:["wdpa","pulpwood","palm_oil","logging"],where:"sumatra = 1"},o,l),c.promise},queryForDailyFireData:function(){var e,t,i=new F(C.queryUrl+"/"+C.dailyFiresId),a=new r,n=new w,o=[],l=[];return n.returnGeometry=!1,n.where="1 = 1",n.outFields=["Count, Date"],e=function(e){s.forEach(e.features,function(e){o.push(e.attributes.Date),l.push(e.attributes.Count)}),$("#fire-line-chart").highcharts({chart:{zoomType:"x"},title:{text:null},subtitle:{text:void 0===document.ontouchstart?"Click and drag in the plot area to zoom in":"Pinch the chart to zoom in"},plotOptions:{line:{marker:{enabled:!1}}},xAxis:{categories:o,minTickInterval:20,minRange:30,labels:{rotation:-45}},yAxis:{title:{text:null},plotLines:[{value:0,width:1,color:"#a90016"}]},tooltip:{valueSuffix:""},credits:{enabled:!1},legend:{enabled:!1},series:[{name:"Daily Fires",data:l,color:"#f49f2d"}]})},t=function(e){console.dir(e)},i.execute(n,e,t),a.resolve(!0),a.promise},queryFireData:function(e,t,i){var a,n=new F(C.queryUrl+"/"+C.confidenceFireId),o=(new r,new w),s=new Date;s=new Date(s.getFullYear(),s.getMonth(),s.getDate()-7),a=s.getFullYear()+"-"+(s.getMonth()+1)+"-"+s.getDate()+" "+s.getHours()+":"+s.getMinutes()+":"+s.getSeconds(),o.where=void 0===e.where?"ACQ_DATE > date '"+a+"'":"ACQ_DATE > date '"+a+"' AND "+e.where,o.returnGeometry=e.returnGeometry||!1,o.outFields=e.outFields||["*"],n.execute(o,t,i)},buildPieChart:function(e,t){$("#"+e).highcharts({chart:{type:"pie"},title:{text:null},yAxis:{title:{text:null}},plotOptions:{pie:{shadow:!1,center:["50%","50%"],showInLegend:!0,dataLabels:{fontSize:"22px"}}},tooltip:{formatter:function(){return Math.round(this.y/t.total*100)+"% ("+this.y+" fires)"}},credits:{enabled:!1},legend:{layout:"vertical"},series:[{name:t.name,data:t.data,size:"80%",innerSize:"50%",dataLabels:{distance:t.labelDistance,color:"black",formatter:function(){return Math.round(this.y/t.total*100)+"%"}}}]})},generateTableRows:function(e,t){function r(e){return null!==e&&void 0!==e}var i="";return s.forEach(e,function(e){i+="<tr>",s.forEach(t,function(t){i+="<td>"+(r(e.attributes[t])?e.attributes[t]:" - ")+"</td>"}),i+="</tr>"}),i},printReport:function(){}}});