define(["dojo/dom","dojo/Deferred","dojo/topic","dijit/registry","modules/HashController","modules/EventsController","views/footer/FooterModel","views/map/MapConfig","main/Config","dojo/_base/array","esri/tasks/query","esri/tasks/QueryTask","esri/request"],function(dom,Deferred,topic,registry,HashController,EventsController,FooterModel,MapConfig,MainConfig,arrayUtil,Query,QueryTask,esriRequest){var o={},initialized=!1,viewId="app-footer",gfwFooterLoaded=!1;return o.init=function(){var e=this;initialized||(initialized=!0,require(["dojo/text!views/footer/footer.html","views/footer/FooterModel"],function(t,r){dom.byId(viewId).innerHTML=t+dom.byId(viewId).innerHTML,r.applyBindings(viewId),e.initShareButton();var o=document.createElement("script"),i=document.getElementsByTagName("body")[0];o.setAttribute("src","https://cdn.rawgit.com/simbiotica/gfw_assets/master/src/header-loader.js"),o.setAttribute("id","loader-gfw"),o.setAttribute("data-current",".shape-fire"),i.appendChild(o)}))},o.initShareButton=function(){!function(e,t,r){var o,i=e.getElementsByTagName(t)[0];e.getElementById(r)||(o=e.createElement(t),o.id=r,o.src="https://platform.twitter.com/widgets.js",i.parentNode.insertBefore(o,i))}(document,"script","twitter-wjs"),function(e,t,r){var o,i=e.getElementsByTagName(t)[0];e.getElementById(r)||(o=e.createElement(t),o.id=r,o.src="//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.0",i.parentNode.insertBefore(o,i))}(document,"script","facebook-jssdk")},o.footerSelect=function(data){var selectedItem=data;eval("EventsController."+selectedItem.eventName+"()")},o.subscribeToAlerts=function(){var e=this;require(["dojo/on","dijit/Dialog","dojo/dom-style","dojo/dom-construct","dijit/form/Select","dojox/validate/web","dojo/text!views/footer/emailAlertForm.html"],function(t,r,o,i,s,a,n){function l(){i.destroy(dom.byId("signUpAlertsForm")),d.intlTelInput("destroy"),c.remove(),b.remove(),u.remove(),f.remove()}var u,d,c,b,f,m=new r({title:"Sign up to receive fire alerts!",style:"width: 550px;height: auto;"}),v=n;m.setContent(v),m.show(),FooterModel.applyBindings("signUpAlertsForm"),d=$("#phoneNumberForAlerts"),d.intlTelInput({validationScript:"./app/libs/isValidNumber.js"}),e.getProvinceValues().then(function(r){FooterModel.get("model").provincesAvailableForAlerts(r),e.getDistrictValues().then(function(r){var i=FooterModel.get("model");i.districtsAvailableForAlerts([]),i.subDistrictsAvailableForAlerts([]);var s=FooterModel.get("provincesAvailableForAlerts"),n=new Array;arrayUtil.forEach(s,function(e){n[e.value]=new Array}),arrayUtil.forEach(r,function(e){e.province&&n[e.province].push(e)}),c=t(dom.byId("aoiProvincePicker"),"change",function(e){var t=e.target?e.target.value:e.srcElement.value;i.districtsAvailableForAlerts(n[t]),i.subDistrictsAvailableForAlerts([])}),b=t(dom.byId("aoiDistrictPicker"),"change",function(t){var r;r=t.target?t.target.selectedOptions?t.target.selectedOptions:t.target.value:t.srcElement.value,"NONE"!==r&&e.getSubDistricts(r).then(function(e){i.subDistrictsAvailableForAlerts(e)})}),f=t(dom.byId("aoiSubDistrictPicker"),"change",function(e){var t=!1;e.target.selectedOptions&&(t=e.target.selectedOptions.length>10?!0:!1),"ALL"==e.target.value&&(t=!0),i.showSubDistrictWarning(t?!0:!1)}),u=t(dom.byId("alerts-submit-button"),"click",function(){var t=dom.byId("emailForAlerts").value,r=dom.byId("phoneNumberForAlerts").value,s=!0,n=[];i.errorMessages([]),i.showErrorMessages(!1),"ALL"===dom.byId("aoiSubDistrictPicker").value?arrayUtil.forEach(dom.byId("aoiSubDistrictPicker").options,function(e){"Select All"!==e.innerHTML&&n.push({aoi_id:parseInt(e.value),aoi_name:e.innerHTML})}):arrayUtil.forEach(dom.byId("aoiSubDistrictPicker").options,function(e){e.selected&&n.push({aoi_id:parseInt(e.value),aoi_name:e.innerHTML})}),0===n.length?(o.set("aoiSubDistrictPicker","border","1px solid red"),i.errorMessages.push("You need to select at least one subdistrict."),s=!1):o.set("aoiSubDistrictPicker","border",""),a.isEmailAddress(t)||d.intlTelInput("isValidNumber")?(o.set("phoneNumberForAlerts","border",""),o.set("emailForAlerts","border","")):(s=!1,o.set("emailForAlerts","border","1px solid red"),o.set("phoneNumberForAlerts","border","1px solid red"),i.errorMessages.push("You must at least provide a phone number and/or an email.")),s?(""!==r&&(r=r.replace(/[^\d]/g,""),e.postSubscribeRequest(n,r,"sms").then(function(e){e&&(m.destroy(),l())})),a.isEmailAddress(t)&&e.postSubscribeRequest(n,t,"email").then(function(e){e&&(m.destroy(),l())})):i.showErrorMessages(!0)}),m.on("cancel",l)})})})},o.postSubscribeRequest=function(e,t,r){var o,i=MainConfig.emailSubscribeUrl,s={areas:JSON.stringify(e),msg_addr:t,msg_type:r},a=dom.byId("verifyEmailForAlerts").value,n=new Deferred;return""===a?(dom.byId("alerts-submit-button").innerHTML="Submitting...",o=esriRequest({url:i,content:s,handleAs:"json"},{usePost:!0}),o.then(function(){dom.byId("alerts-submit-button").innerHTML="Submit",alert("You have successfully subscribed, you should start receiving alerts as they come in for your area(s) of interest."),n.resolve(!0)},function(e){dom.byId("alerts-submit-button").innerHTML="Submit",alert("There was an error subcribing at this time. "+e.message),n.resolve(!1)})):n.resolve(!0),n.promise},o.getProvinceValues=function(){var e,t,r=new Deferred,o=new QueryTask(MapConfig.layerForProvinceQuery.url),i=new Query,s=[],a=[];return i.returnGeometry=!1,i.outFields=MapConfig.layerForProvinceQuery.outFields,i.where="1 = 1",o.execute(i,function(o){arrayUtil.forEach(o.features,function(r){t=r.attributes,e=t[MapConfig.layerForProvinceQuery.outFields[0]],-1===arrayUtil.indexOf(a,e)&&(a.push(e),s.push({label:e,value:e}))}),s.sort(function(e,t){return e.label<t.label?-1:e.label>t.label?1:0}),s.unshift({label:"Choose one",value:"NONE",selected:!0}),r.resolve(s)},function(){r.resolve(!1)}),r.promise},o.getDistrictValues=function(){var e,t,r,o=new Deferred,i=new QueryTask(MapConfig.layerForDistrictQuery.url),s=new Query,a=[],n=[];return FooterModel.get("districtsAvailableForAlerts").length>0?o.resolve(!1):(s.returnGeometry=!1,s.outFields=MapConfig.layerForDistrictQuery.outFields,s.where="1 = 1",i.execute(s,function(i){arrayUtil.forEach(i.features,function(o){r=o.attributes,e=r[MapConfig.layerForDistrictQuery.outFields[0]],t=r[MapConfig.layerForDistrictQuery.outFields[1].toUpperCase()],-1===arrayUtil.indexOf(n,e)&&(n.push(e),a.push({label:e,value:e,province:t}))}),a.sort(function(e,t){return e.label<t.label?-1:e.label>t.label?1:0}),a.unshift({label:"Choose one",value:"NONE",selected:!0}),o.resolve(a)},function(){o.resolve(!1)})),o.promise},o.getSubDistricts=function(e){var t,r,o=new Deferred,i=new QueryTask(MapConfig.layerForSubDistrictQuery.url),s=new Query,a=[],n=[];s.returnGeometry=!1,s.outFields=MapConfig.layerForSubDistrictQuery.outFields;var l;if("ALL"===e[0].value)console.log("ALL"),l="1 = 1";else for(var l="DISTRICT = '",u=0;u<e.length;u++)l+=e[u].value,l+=u==e.length-1?"'":"' OR DISTRICT = '";return s.where=l,i.execute(s,function(e){arrayUtil.forEach(e.features,function(e){t=e.attributes,r=t[MapConfig.layerForSubDistrictQuery.outFields[1]],-1===arrayUtil.indexOf(n,r)&&(n.push(r),a.push({label:t[MapConfig.layerForSubDistrictQuery.outFields[0]],value:r}))}),a.sort(function(e,t){return e.label<t.label?-1:e.label>t.label?1:0}),o.resolve(a)},function(){o.resolve(!1)}),o.promise},o});